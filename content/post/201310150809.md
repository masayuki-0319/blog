
---
title: "日本全国避難所データと現在地周辺の避難所地図を公開しました"
date: 2013-10-15T08:09:39+00:00
category : [OpenData]
canonicalurl: http://yut.hatenablog.com/entry/20131015/1381792179
---

## [OpenData] : 日本全国避難所データと現在地周辺の避難所地図を公開しました


<div class="section">
<h4>避難所</h4>

<blockquote>
    <p><a href="http://www.hinanjyo.jp/">防災情報 全国避難所ガイド | ホーム</a> <a href="http://b.hatena.ne.jp/entry/www.hinanjyo.jp/"><img src="http://b.hatena.ne.jp/entry/image/http://www.hinanjyo.jp/" alt="はてなブックマーク - 防災情報 全国避難所ガイド | ホーム" border="0" /></a><br />
<a href="http://crisis.yahoo.co.jp/shelter/map/">避難所マップ - Yahoo!天気・災害</a> <a href="http://b.hatena.ne.jp/entry/crisis.yahoo.co.jp/shelter/map/"><img src="http://b.hatena.ne.jp/entry/image/http://crisis.yahoo.co.jp/shelter/map/" alt="はてなブックマーク - 避難所マップ - Yahoo!天気・災害" border="0" /></a></p><p><a href='https://twitter.com/yutakikuc'>@yutakikuc</a>です。オープンデータへの貢献という大義名分っぽい事を掲げ、避難所データを構造化テキストで作成し、更にはポイントを地図上への<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%C3%A5%D4%A5%F3%A5%B0">マッピング</a>します。避難所というと1st Mediaのアプリや<a class="keyword" href="http://d.hatena.ne.jp/keyword/Yahoo%21">Yahoo!</a>避難所マップに情報が掲載されていますが、それ以外の避難所野良Web等は避難所データが整理されていません。<a class="keyword" href="http://d.hatena.ne.jp/keyword/Yahoo%21">Yahoo!</a>避難所マップも<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C5%D4%C6%BB">都道</a>府県毎に公開／非公開があるようでこちらもデータとしては不十分です。今回僕がデータ作成と簡単な地図<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%C3%A5%D4%A5%F3%A5%B0">マッピング</a>を行うので、これを参考に良いアプリケーションが出てくる事に期待しています。</p>

</blockquote>

</div>
<div class="section">
<h4>作成した避難所データと地図</h4>

<blockquote>
    <p>作成した避難所データは<a class="keyword" href="http://d.hatena.ne.jp/keyword/github">github</a>、それを<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%C3%A5%D4%A5%F3%A5%B0">マッピング</a>した地図をGAEで公開します。地図はGeoLocationAPIを利用して現在地付近の避難所のみを取得します。<span class="deco" style="font-style:italic;">※利用は全て自己責任でお願いいたします。</span></p>

<div class="section">
<h5><a class="keyword" href="http://d.hatena.ne.jp/keyword/github">github</a></h5>
<p><a href="https://github.com/yutakikuchi/Data/tree/master/shelter/pref">Data/shelter/pref at master · yutakikuchi/Data</a> <a href="http://b.hatena.ne.jp/entry/s/github.com/yutakikuchi/Data/tree/master/shelter/pref"><img src="http://b.hatena.ne.jp/entry/image/https://github.com/yutakikuchi/Data/tree/master/shelter/pref" alt="はてなブックマーク - Data/shelter/pref at master · yutakikuchi/Data" border="0" /></a></p>

</div>
<div class="section">
<h5>公開地図</h5>
<p><a href="http://map-labs.appspot.com/shelter">避難所マップ</a> <a href="http://b.hatena.ne.jp/entry/map-labs.appspot.com/shelter"><img src="http://b.hatena.ne.jp/entry/image/http://map-labs.appspot.com/shelter" alt="はてなブックマーク - 避難所マップ" border="0" /></a><br />
<span itemscope itemtype="http://schema.org/Photograph"><a href="http://f.hatena.ne.jp/yutakikuchi/20131014041243" class="hatena-fotolife" itemprop="url"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/y/yutakikuchi/20131014/20131014041243.png" alt="f:id:yutakikuchi:20131014041243p:image" title="f:id:yutakikuchi:20131014041243p:image" class="hatena-fotolife" itemprop="image"></a></span></p>

</div>
</blockquote>

</div>
<div class="section">
<h4>避難所データソース</h4>

<blockquote>
    <p><a href="http://www.kokuminhogo.go.jp/hinan/index.html">都道府県避難施設一覧 - 内閣官房 国民保護ポータルサイト</a> <a href="http://b.hatena.ne.jp/entry/www.kokuminhogo.go.jp/hinan/index.html"><img src="http://b.hatena.ne.jp/entry/image/http://www.kokuminhogo.go.jp/hinan/index.html" alt="はてなブックマーク - 都道府県避難施設一覧 - 内閣官房 国民保護ポータルサイト" border="0" /></a><br />
<a href="http://www.hinanjyo.jp/local/index/id/1.html">1st Mediaの避難所データ</a> <a href="http://b.hatena.ne.jp/entry/www.hinanjyo.jp/local/index/id/1.html"><img src="http://b.hatena.ne.jp/entry/image/http://www.hinanjyo.jp/local/index/id/1.html" alt="はてなブックマーク - " border="0" /></a><br />
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C6%E2%B3%D5%B4%B1%CB%BC">内閣官房</a> 国民保護<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DD%A1%BC%A5%BF%A5%EB%A5%B5%A5%A4%A5%C8">ポータルサイト</a>のデータを利用します。注意として「<span class="deco" style="font-style:italic;">平成22年4月1日現在のデータを参考として掲載しております。</span>」とあるようにデータが最新の物では無いです。上のサイトに掲載されているpdfからtextを抽出し、構造化テキストに変換します。代替のデータソースとしては1st MediaのWebPageに掲載されているデータを引っ張ってくる方法もいいかと思いますが、取り扱いには注意してください。</p>

</blockquote>

</div>
<div class="section">
<h4>避難所構造化テキスト作成</h4>

<blockquote>
    
<div class="section">
<h5>pdftotextを利用した避難所<a class="keyword" href="http://d.hatena.ne.jp/keyword/YAML">YAML</a>ファイルの生成</h5>
<p>まずはpdfからtextに変換する為の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C4%A1%BC%A5%EB">ツール</a>であるpdftotextをCentOS6.4へinstallします。install後に国民保護<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DD%A1%BC%A5%BF%A5%EB%A5%B5%A5%A4%A5%C8">ポータルサイト</a>からpdfファイルをdownloadして、pdftotextコマンドを実行してみます。pdftotextにより標準出力されたデータを見てみるとちゃんと変換されていることが分かりますが、pdf中の表に入力された改行がそのまま改行として出力されています。改行が1つであれルール化できそうですが、2つ以上ある箇所は改行がメイン行の前後に出力されるので、そのようなデータを拾う事はここでは諦めました。拾いたい場合は人の目で判断する必要があると思います。<br />
※<a class="keyword" href="http://d.hatena.ne.jp/keyword/python">python</a>にはpdfをtext変換する<a href="http://pybrary.net/pyPdf/">pyPdf</a> <a href="http://b.hatena.ne.jp/entry/pybrary.net/pyPdf/"><img src="http://b.hatena.ne.jp/entry/image/http://pybrary.net/pyPdf/" alt="はてなブックマーク - pyPdf" border="0" /></a>ライブラリもあるので、そちらを使っても良いと思います。</p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ sudo yum <span class="synStatement">install</span>  poppler-utils <span class="synSpecial">-y</span>
$ wget http://www.kokuminhogo.go.jp/pdf/hinan_hokkaido.pdf
$ pdftotext <span class="synSpecial">-enc</span> UTF<span class="synConstant">-8</span> <span class="synSpecial">-layout</span> <span class="synSpecial">-nopgbrk</span> hinan_hokkaido.pdf - 
 <span class="synConstant">46</span>    円山公園                     札幌市     円山西町<span class="synConstant">8</span>丁目 
                                    宮の森<span class="synConstant">1</span>〜<span class="synConstant">2</span>条<span class="synConstant">14</span>丁目他
 <span class="synConstant">47</span>    旭山記念公園                   札幌市     中央区界川４丁目
                                    中央区中島公園
 <span class="synConstant">48</span>    中島公園                     札幌市     南<span class="synConstant">14</span>条西５丁目
                                    南<span class="synConstant">15</span>条西４丁目
</pre><p><a href="http://developer.yahoo.co.jp/webapi/map/openlocalplatform/v1/geocoder.html">YOLP(地図):Yahoo!ジオコーダAPI - Yahoo!デベロッパーネットワーク</a> <a href="http://b.hatena.ne.jp/entry/developer.yahoo.co.jp/webapi/map/openlocalplatform/v1/geocoder.html"><img src="http://b.hatena.ne.jp/entry/image/http://developer.yahoo.co.jp/webapi/map/openlocalplatform/v1/geocoder.html" alt="はてなブックマーク - YOLP(地図):Yahoo!ジオコーダAPI - Yahoo!デベロッパーネットワーク" border="0" /></a><br />
<a href="https://developers.google.com/maps/documentation/geocoding/?hl=ja">Google Geocoding API - Google Maps API ウェブ サービス ― Google Developers</a> <a href="http://b.hatena.ne.jp/entry/s/developers.google.com/maps/documentation/geocoding/?hl=ja"><img src="http://b.hatena.ne.jp/entry/image/https://developers.google.com/maps/documentation/geocoding/?hl=ja" alt="はてなブックマーク - Google Geocoding API - Google Maps API ウェブ サービス ― Google Developers" border="0" /></a></p><p>次に以下の<a class="keyword" href="http://d.hatena.ne.jp/keyword/Python">Python</a>コードを実行して、各<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C5%D4%C6%BB">都道</a>府県の避難所データを<a class="keyword" href="http://d.hatena.ne.jp/keyword/YAML">YAML</a>に変換します。生成する<a class="keyword" href="http://d.hatena.ne.jp/keyword/YAML">YAML</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A1%BC%A5%BF%B7%C1%BC%B0">データ形式</a>は <span class="deco" style="font-style:italic;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/%C5%D4%C6%BB">都道</a>府県 - 市区町村 - 番地名 - ( 緯度経度 / 場所名[配列] )</span>の4階層になっています。 緯度経度のデータを取得には<a class="keyword" href="http://d.hatena.ne.jp/keyword/Yahoo%21">Yahoo!</a>のジオコーダー<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>を利用しました。<a class="keyword" href="http://d.hatena.ne.jp/keyword/Google">Google</a>のジオコーダーを利用したかったのですが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>へのリクエスト数上限に引っかかり、OVER_QUERY_LIMITというエラーが頻発するので<a class="keyword" href="http://d.hatena.ne.jp/keyword/Yahoo%21">Yahoo!</a>を使いました。</p>
<pre class="hljs python" data-lang="python" data-unlink><span class="synComment">#!/usr/bin/env python</span>
<span class="synComment"># -*- coding: utf-8 -*-</span>
<span class="synComment"># 避難所データの構造化テキスト作成</span>
<span class="synComment"># shelter.pyとして保存する</span>
<span class="synPreProc">import</span> os,sys,time,re,urllib,urllib2,yaml,json,unicodedata,time
url = <span class="synConstant">'http://www.kokuminhogo.go.jp/hinan/index.html'</span>
opener = urllib2.build_opener()
ua = <span class="synConstant">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_6_8) AppleWebKit/534.51.22 (KHTML, like Gecko) Version/5.1.1 Safari/    534.51.22'</span>
referer = <span class="synConstant">'http://www.kokuminhogo.go.jp/'</span>
opener.addheaders = [(<span class="synConstant">'User-Agent'</span>, ua),(<span class="synConstant">'Referer'</span>, referer)]
appid = <span class="synConstant">'Yahoo!'</span> <span class="synComment"># yahooapiのappidをここに定義</span>
<span class="synStatement">try</span>:
   html = <span class="synIdentifier">unicode</span>(opener.<span class="synIdentifier">open</span>(url).read(), <span class="synConstant">'cp932'</span>) 
   <span class="synStatement">if</span> re.<span class="synIdentifier">compile</span>(<span class="synConstant">r'<area shape="rect".*?href="(.*?)" alt="(.*?)"'</span>, re.M).search(html) <span class="synStatement">is</span> <span class="synStatement">not</span> <span class="synIdentifier">None</span>:
  data = re.<span class="synIdentifier">compile</span>(<span class="synConstant">r'<area shape="rect".*?href="(.*?)" alt="(.*?)"'</span>, re.M).findall(html) 
  <span class="synComment"># pdf download</span>
  <span class="synStatement">for</span> line <span class="synStatement">in</span> data:
     <span class="synIdentifier">dict</span> = {}
     os.system(<span class="synConstant">'wget http://www.kokuminhogo.go.jp'</span> + line[<span class="synConstant">0</span>].replace(<span class="synConstant">'..'</span>, <span class="synConstant">''</span>))
     <span class="synComment"># pdftotext</span>
     textfile = line[<span class="synConstant">0</span>].replace(<span class="synConstant">'../pdf/'</span>, <span class="synConstant">''</span>).replace(<span class="synConstant">'.pdf'</span>, <span class="synConstant">'.txt'</span>)
     os.system(<span class="synConstant">"pdftotext -enc UTF-8 -layout -nopgbrk %s - | sed '/^$/d' | sed 's/^ \+//g' | sed 's/ \{2,\}/</span><span class="synSpecial">\t</span><span class="synConstant">/g' | sed 's/ //g' | grep '^[0-9]\+'$'</span><span class="synSpecial">\t</span><span class="synConstant">' | cut -f 2,3,4 | awk '{ print $2%s$3%s$1}' > %s"</span> % (line[<span class="synConstant">0</span>].replace(<span class="synConstant">'../pdf/'</span>, <span class="synConstant">''</span>), <span class="synConstant">'"</span><span class="synSpecial">\t</span><span class="synConstant">"'</span>, <span class="synConstant">'"</span><span class="synSpecial">\t</span><span class="synConstant">"'</span>, textfile))
     f = <span class="synIdentifier">open</span>(textfile, <span class="synConstant">'r'</span>)
     <span class="synStatement">for</span> node <span class="synStatement">in</span> f.readlines():
        (mun,adr,name) = node.rstrip().split(<span class="synConstant">"</span><span class="synSpecial">\t</span><span class="synConstant">"</span>)
        <span class="synStatement">if</span> mun == <span class="synConstant">''</span> <span class="synStatement">or</span> adr == <span class="synConstant">''</span> <span class="synStatement">or</span> name == <span class="synConstant">''</span> <span class="synStatement">or</span> name == <span class="synConstant">'/'</span>:
           <span class="synStatement">continue</span>
        mun = unicodedata.normalize(<span class="synConstant">'NFKC'</span>, <span class="synIdentifier">unicode</span>(mun, <span class="synConstant">'utf-8'</span>))
        adr = unicodedata.normalize(<span class="synConstant">'NFKC'</span>, <span class="synIdentifier">unicode</span>(adr, <span class="synConstant">'utf-8'</span>))
        name = unicodedata.normalize(<span class="synConstant">'NFKC'</span>, <span class="synIdentifier">unicode</span>(name, <span class="synConstant">'utf-8'</span>))
        <span class="synIdentifier">dict</span>.setdefault(line[<span class="synConstant">1</span>], {}).setdefault(mun, {}).setdefault(adr, {}).setdefault(<span class="synConstant">'name'</span>, [] )
        <span class="synComment"># geoencoding</span>
        <span class="synComment">#url = "http://maps.googleapis.com/maps/api/geocode/json?address=%s&sensor=false" %(urllib.quote_plus(mun.encode('utf-8') + adr.encode('utf-8')))</span>
        latlng = <span class="synConstant">''</span>
        <span class="synStatement">try</span>:
           time.sleep(<span class="synConstant">0.2</span>)
           url = <span class="synConstant">'http://geo.search.olp.yahooapis.jp/OpenLocalPlatform/V1/geoCoder?appid=%s&query=%s&output=%s'</span> % (appid, urllib.quote_plus(mun.encode(<span class="synConstant">'utf-8'</span>) + adr.encode(<span class="synConstant">'utf-8'</span>)), <span class="synConstant">'json'</span>)
           res = json.loads(opener.<span class="synIdentifier">open</span>(url).read())
           <span class="synStatement">if</span> (res[<span class="synConstant">'ResultInfo'</span>][<span class="synConstant">'Status'</span>] == <span class="synConstant">200</span> <span class="synStatement">and</span> res[<span class="synConstant">'ResultInfo'</span>][<span class="synConstant">'Count'</span>] > <span class="synConstant">0</span> ):
              (lng,lat) = res[<span class="synConstant">'Feature'</span>][<span class="synConstant">0</span>][<span class="synConstant">'Geometry'</span>][<span class="synConstant">'Coordinates'</span>].split(<span class="synConstant">','</span>)
              latlng = lat + <span class="synConstant">','</span> + lng
           <span class="synIdentifier">dict</span>[line[<span class="synConstant">1</span>]][mun][adr][<span class="synConstant">'latlng'</span>] = latlng
           <span class="synIdentifier">dict</span>[line[<span class="synConstant">1</span>]][mun][adr][<span class="synConstant">'name'</span>].append(name)
        <span class="synStatement">except</span> urllib2.URLError:
           <span class="synIdentifier">dict</span>[line[<span class="synConstant">1</span>]][mun][adr][<span class="synConstant">'latlng'</span>] = latlng
           <span class="synIdentifier">dict</span>[line[<span class="synConstant">1</span>]][mun][adr][<span class="synConstant">'name'</span>].append(name)
           <span class="synStatement">continue</span>
     f.close()
     <span class="synComment"># yaml generator</span>
     savefile = <span class="synIdentifier">open</span>(textfile.replace(<span class="synConstant">'.txt'</span>, <span class="synConstant">''</span>).replace(<span class="synConstant">'hinan_'</span>, <span class="synConstant">''</span>) + <span class="synConstant">'_shelter.yaml'</span>, <span class="synConstant">'w'</span>)
     yaml.safe_dump(<span class="synIdentifier">dict</span>, savefile, default_flow_style=<span class="synIdentifier">False</span>, encoding=<span class="synConstant">'utf8'</span>, allow_unicode=<span class="synIdentifier">True</span>)
<span class="synStatement">except</span> <span class="synType">Exception</span>, e:
exc_type, exc_obj, exc_tb = sys.exc_info()
fname = os.path.split(exc_tb.tb_frame.f_code.co_filename)[<span class="synConstant">1</span>]
<span class="synIdentifier">print</span>(exc_type, fname, exc_tb.tb_lineno) 
</pre><pre class="hljs yaml" data-lang="yaml" data-unlink><span class="synComment"># 都道府県名:</span>
 <span class="synComment"> # 市区町村名:</span>
<span class="synComment"> # 番地名:</span>
   <span class="synComment"> # latlng:</span>
   <span class="synComment"> # name:</span>
   <span class="synComment"> # - 場所名</span>
   <span class="synComment"> # - 場所名</span>

東京:
  あきる野市:
上代継190:
  <span class="synIdentifier">latlng</span><span class="synSpecial">:</span> <span class="synConstant">35.72992747</span>,<span class="synConstant">139.27797845</span>
  <span class="synIdentifier">name</span><span class="synSpecial">:</span>
  <span class="synStatement">- </span>あきる野市立西中学校校庭
  <span class="synStatement">- </span>あきる野市立西中学校体育館
</pre>
</div>
</blockquote>

</div>
<div class="section">
<h4>その他のオープンデータ</h4>

<blockquote>
    <p>以下は過去に様々なサイトからデータを抽出した個人のオープンデータになります。<br />
※<span class="deco" style="font-style:italic;">こちらも利用される場合は全て自己責任でお願いいたします。</span><br />
<a href="http://d.hatena.ne.jp/yutakikuchi/20130318/1363563531">業種別企業の平均年齢と年収の辞書データを公開しました - Yuta.Kikuchiの日記</a> <a href="http://b.hatena.ne.jp/entry/d.hatena.ne.jp/yutakikuchi/20130318/1363563531"><img src="http://b.hatena.ne.jp/entry/image/http://d.hatena.ne.jp/yutakikuchi/20130318/1363563531" alt="はてなブックマーク - 業種別企業の平均年齢と年収の辞書データを公開しました - Yuta.Kikuchiの日記" border="0" /></a><br />
<a href="http://d.hatena.ne.jp/yutakikuchi/20130210/1360456363">業種別企業名辞書データを公開しました - Yuta.Kikuchiの日記</a> <a href="http://b.hatena.ne.jp/entry/d.hatena.ne.jp/yutakikuchi/20130210/1360456363"><img src="http://b.hatena.ne.jp/entry/image/http://d.hatena.ne.jp/yutakikuchi/20130210/1360456363" alt="はてなブックマーク - 業種別企業名辞書データを公開しました - Yuta.Kikuchiの日記" border="0" /></a><br />
<a href="http://d.hatena.ne.jp/yutakikuchi/20130415/1365956662">地域データの構造化テキストを公開しました。 - Yuta.Kikuchiの日記</a> <a href="http://b.hatena.ne.jp/entry/d.hatena.ne.jp/yutakikuchi/20130415/1365956662"><img src="http://b.hatena.ne.jp/entry/image/http://d.hatena.ne.jp/yutakikuchi/20130415/1365956662" alt="はてなブックマーク - 地域データの構造化テキストを公開しました。 - Yuta.Kikuchiの日記" border="0" /></a></p>

</blockquote>

</div>

