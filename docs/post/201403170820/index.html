<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="canonical" href="http://yut.hatenablog.com/entry/20140317/1395012036" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.55.4" />

  <title>SolrのSpatial Searchを試してみた &middot; Y&#39;s note</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://yutakikuchi.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://yutakikuchi.github.io/img/favicon.ico" type="image/x-icon" />

  
    
        <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/my.css">
    
  
  
    
        <script src="https://yutakikuchi.github.io/blog/js/my.js"></script>
    
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://yutakikuchi.github.io/">Y's note</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/yutakikuchi_" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://facebook.com/yuta.kikuchi.007" target="_blank"><i class="fa fa-facebook-square fa-fw"></i>Facebook</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="http://slideshare.net/https://www.slideshare.net/yutakikuchi58/" target="_blank"><i class="fa fa-slideshare fa-fw"></i>SlideShare</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/https://www.linkedin.com/in/%E4%BD%91%E5%A4%AA-%E8%8F%8A%E6%B1%A0-36291a44/" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/yutakikuchi" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2019. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>SolrのSpatial Searchを試してみた</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2014 Mar 17, 08:20</time>
  </div>

  

  

  

</div>

  

<h2 id="検索-solrのspatial-searchを試してみた">[検索] : SolrのSpatial Searchを試してみた</h2>

<p><span itemscope itemtype="http://schema.org/Photograph"><a href="http://f.hatena.ne.jp/yutakikuchi/20140317025607" class="hatena-fotolife" itemprop="url"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/y/yutakikuchi/20140317/20140317025607.jpg" alt="f:id:yutakikuchi:20140317025607j:image:w360" title="f:id:yutakikuchi:20140317025607j:image:w360" class="hatena-fotolife" style="width:360px" itemprop="image"></a></span><br />
</p>

<div class="section">
<h4>前書き</h4>

<blockquote>
    <p>10代の頃は(ゴースト)ライターという職業に憧れていた時期もありました<a href='http://twitter.com/yutakikuc'>@yutakikuc</a>です。<br />
<a href="http://docs.mongodb.org/manual/applications/geospatial-indexes/">Geospatial Indexes and Queries ― MongoDB Manual 2.4.9</a> <a href="http://b.hatena.ne.jp/entry/docs.mongodb.org/manual/applications/geospatial-indexes/"><img src="http://b.hatena.ne.jp/entry/image/http://docs.mongodb.org/manual/applications/geospatial-indexes/" alt="はてなブックマーク - Geospatial Indexes and Queries ― MongoDB Manual 2.4.9" border="0" /></a><br />
<a href="http://dev.mysql.com/doc/refman/4.1/ja/creating-spatial-indexes.html">MySQL :: MySQL 4.1 リファレンスマニュアル :: 10.6.1 空間インデックスの作成</a> <a href="http://b.hatena.ne.jp/entry/dev.mysql.com/doc/refman/4.1/ja/creating-spatial-indexes.html"><img src="http://b.hatena.ne.jp/entry/image/http://dev.mysql.com/doc/refman/4.1/ja/creating-spatial-indexes.html" alt="はてなブックマーク - MySQL :: MySQL 4.1 リファレンスマニュアル :: 10.6.1 空間インデックスの作成" border="0" /></a><br />
位置情報IndexをMongoDBで管理する手法については前に調査済みで、<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>にもSpatialindexはあまり普及していない印象、ということで...今日は検索SolrのSpatial Searchについて調べてみます。最終的にはFessやNutchでWebPageをCrawlingして得た住所データをGeocodingでLat/<a class="keyword" href="http://d.hatena.ne.jp/keyword/Lng">Lng</a>データに変換して自前のServerにIndexingしていく事を考えており、その前段階の作業です。Solrを選ぶ理由ですがSpatial Search以外にもTermVectorでの類似度を算出してくれるMoreLikeThisという機能があり、Lat/<a class="keyword" href="http://d.hatena.ne.jp/keyword/Lng">Lng</a>データの掛け合わせでコンテンツを面白くSuggestすることを考えています。MoreLikeThisについても調査したら書きますね。</p>

</blockquote>

</div>
<div class="section">
<h4>Solr設定</h4>

<blockquote>
    
<div class="section">
<h5><a class="keyword" href="http://d.hatena.ne.jp/keyword/java">java</a>, tomcat6, Solr</h5>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/java">java</a>と<a class="keyword" href="http://d.hatena.ne.jp/keyword/tomcat">tomcat</a>、Solr本体が必要なので以下の手順でInstallです。Solrは2014.3.15現在で最新のV4.7.0を取ってきます。僕が3年程前にSolrを使っていた時はV1.*とかだったので、もう過去の記憶や記録は役立たなさそうですね...</p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ sudo yum <span class="synStatement">install</span> java-1.7.0-openjdk tomcat6 <span class="synSpecial">--enablerepo=remi</span>
$ wget <span class="synStatement">"</span><span class="synConstant">ftp://ftp.riken.jp/net/apache/lucene/solr/4.7.0/solr-4.7.0.tgz</span><span class="synStatement">"</span>
$ tar xf solr-4.7.0.tgz
</pre>
</div>
<div class="section">
<h5>Portfowarding</h5>
<p>Solrのadmin<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C4%A1%BC%A5%EB">ツール</a>に接続する為の設定です。僕の場合は<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mac">Mac</a>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/VirtualBox">VirtualBox</a>を立ち上げ、HostOSからGuestOS(<a class="keyword" href="http://d.hatena.ne.jp/keyword/CentOS">CentOS</a>)に接続してSolrを使っているので<a class="keyword" href="http://d.hatena.ne.jp/keyword/VirtualBox">VirtualBox</a>内のPortfowardingとGuestOS側のFireWallの設定をします。<a class="keyword" href="http://d.hatena.ne.jp/keyword/VirtualBox">VirtualBox</a>では設定=>ネットワーク=>ポートフォワーディングで以下の画面に辿れます。Solrのdefaultportである8983を指定しておきます。※GuestOS側の<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>をifconfigで調べて設定してください。<br />
<span itemscope itemtype="http://schema.org/Photograph"><a href="http://f.hatena.ne.jp/yutakikuchi/20140315125108" class="hatena-fotolife" itemprop="url"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/y/yutakikuchi/20140315/20140315125108.png" alt="f:id:yutakikuchi:20140315125108p:image:w360" title="f:id:yutakikuchi:20140315125108p:image:w360" class="hatena-fotolife" style="width:360px" itemprop="image"></a></span><br />
</p>

</div>
<div class="section">
<h5>Firewall</h5>
<p>下はHostOS側のFirewall設定です。</p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ sudo vi /etc/sysconfig/iptables

-A INPUT <span class="synSpecial">-m</span> state <span class="synSpecial">--state</span> NEW <span class="synSpecial">-m</span> tcp <span class="synSpecial">-p</span> tcp <span class="synSpecial">--dport</span> <span class="synConstant">22</span> <span class="synSpecial">-j</span> ACCEPT
-A INPUT <span class="synSpecial">-m</span> state <span class="synSpecial">--state</span> NEW <span class="synSpecial">-m</span> tcp <span class="synSpecial">-p</span> tcp <span class="synSpecial">--dport</span> <span class="synConstant">80</span> <span class="synSpecial">-j</span> ACCEPT
<span class="synComment">#追加</span>
-A INPUT <span class="synSpecial">-m</span> state <span class="synSpecial">--state</span> NEW <span class="synSpecial">-m</span> tcp <span class="synSpecial">-p</span> tcp <span class="synSpecial">--dport</span> <span class="synConstant">8983</span> <span class="synSpecial">-j</span> ACCEPT

$ sudo service iptables <span class="synStatement">restart</span>
</pre>
</div>
<div class="section">
<h5>Solr-exampleの起動</h5>
<p>Solrのexampleにある管理画面を表示してみます。tarで展開したディレクトリ以下にstart.jarファイルがあるのでそれを実行します。下のコマンドを実行して<a href="http://localhost:8983/solr">http://localhost:8983/solr</a>にアクセスします。start.jarの実行時もそうですが、色々とエラーがでていますが取りあえずは画面を見る事ができます。</p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ <span class="synStatement">cd</span> solr-4.7.0/example
$ java <span class="synSpecial">-jar</span> start.jar
<span class="synConstant">0</span>    <span class="synStatement">[</span>main<span class="synStatement">]</span> INFO  org.eclipse.jetty.server.Server  &#<span class="synConstant">8211</span>; jetty-8.1.10.v20130312
<span class="synConstant">41</span>   <span class="synStatement">[</span>main<span class="synStatement">]</span> INFO  org.eclipse.jetty.deploy.providers.ScanningAppProvider  &#<span class="synConstant">8211</span>; Deployment monitor /home/yuta/work/src/solr/solr-4.7.0/example/contexts at interval <span class="synConstant">0</span>
<span class="synConstant">50</span>   <span class="synStatement">[</span>main<span class="synStatement">]</span> INFO  org.eclipse.jetty.deploy.DeploymentManager  &#<span class="synConstant">8211</span>; Deployable added: /home/yuta/work/src/solr/solr-4.7.0/example/contexts/solr-jetty-context.xml
<span class="synConstant">1872</span> <span class="synStatement">[</span>main<span class="synStatement">]</span> INFO  org.eclipse.jetty.webapp.StandardDescriptorProcessor  &#<span class="synConstant">8211</span>; NO JSP Support <span class="synStatement">for </span>/solr, did not <span class="synStatement">find</span> org.apache.jasper.servlet.JspServlet
(略<span class="synError">)</span>
</pre><p><span itemscope itemtype="http://schema.org/Photograph"><a href="http://f.hatena.ne.jp/yutakikuchi/20140315130239" class="hatena-fotolife" itemprop="url"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/y/yutakikuchi/20140315/20140315130239.png" alt="f:id:yutakikuchi:20140315130239p:image:w480" title="f:id:yutakikuchi:20140315130239p:image:w480" class="hatena-fotolife" style="width:480px" itemprop="image"></a></span><br />
</p>

</div>
<div class="section">
<h5>exampledocsの追加</h5>
<p>展開したSolrのディレクトリにexampledocsがあるのでSolrに追加してみます。<a class="keyword" href="http://d.hatena.ne.jp/keyword/xml">xml</a>の中身を見てみるとPCパーツや電化製品の情報みたいです。post.shを実行するとcollection1という新しいコレクションが生成され、32個のドキュメントが追加されます。indexのデータは<span class="deco" style="font-weight:bold;">solr-4.7.0/example/solr/collection1/data/index</span>に生成されます。</p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ <span class="synStatement">cd</span> solr-4.7.0/example/exampledocs
$ cat vidcard.xml
<span class="synStatement"><</span>add<span class="synStatement">></span>
<span class="synStatement"><</span>doc<span class="synStatement">></span>
  <span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">id</span><span class="synStatement">"></span>EN7800GTX/2DHTV/256M<span class="synStatement"><</span>/field<span class="synStatement">></span>
  <span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">name</span><span class="synStatement">"></span>ASUS Extreme N7800GTX/2DHTV <span class="synPreProc">(</span><span class="synConstant">256</span><span class="synSpecial"> MB</span><span class="synPreProc">)</span><span class="synStatement"><</span>/field<span class="synStatement">></span>
  <span class="synStatement"><</span>!-- Denormalized <span class="synSpecial">--></span>
  <span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">manu</span><span class="synStatement">"></span>ASUS Computer Inc.<span class="synStatement"><</span>/field<span class="synStatement">></span>
  <span class="synStatement"><</span>!-- Join <span class="synSpecial">--></span>
  <span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">manu_id_s</span><span class="synStatement">"></span>asus<span class="synStatement"><</span>/field<span class="synStatement">></span>
  <span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">cat</span><span class="synStatement">"></span>electronics<span class="synStatement"><</span>/field<span class="synStatement">></span>
  <span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">cat</span><span class="synStatement">"></span>graphics card<span class="synStatement"><</span>/field<span class="synStatement">></span>
  <span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">features</span><span class="synStatement">"></span>NVIDIA GeForce <span class="synConstant">7800</span> GTX GPU/VPU clocked at 486MHz<span class="synStatement"><</span>/field<span class="synStatement">></span>
  <span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">features</span><span class="synStatement">"></span>256MB GDDR3 Memory clocked at 1.35GHz<span class="synStatement"><</span>/field<span class="synStatement">></span>
  <span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">features</span><span class="synStatement">"></span>PCI Express x1<span class="synStatement">6<</span>/field<span class="synStatement">></span>
  <span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">features</span><span class="synStatement">"></span>Dual DVI connectors, HDTV out, video input<span class="synStatement"><</span>/field<span class="synStatement">></span>
  <span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">features</span><span class="synStatement">"></span>OpenGL 2.0, DirectX 9.<span class="synStatement">0<</span>/field<span class="synStatement">></span>
  <span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">weight</span><span class="synStatement">"></span><span class="synConstant">16</span><span class="synStatement"><</span>/field<span class="synStatement">></span>
  <span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">price</span><span class="synStatement">"></span>479.9<span class="synStatement">5<</span>/field<span class="synStatement">></span>
  <span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">popularity</span><span class="synStatement">"></span><span class="synConstant">7</span><span class="synStatement"><</span>/field<span class="synStatement">></span>
  <span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">store</span><span class="synStatement">"></span>40.7143,-74.00<span class="synStatement">6<</span>/field<span class="synStatement">></span>
  <span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">inStock</span><span class="synStatement">">false<</span>/field<span class="synStatement">></span>
  <span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">manufacturedate_dt</span><span class="synStatement">"></span><span class="synConstant">2006-02</span>-13T15:<span class="synConstant">26</span>:37Z/DAY<span class="synStatement"><</span>/field<span class="synStatement">></span>
<span class="synStatement"><</span>/doc<span class="synStatement">></span>

$ ./post.sh *.xml
Posting file gb18030-example.xml to http://localhost:<span class="synConstant">8983</span>/solr/update
<span class="synStatement"><</span>?xml <span class="synIdentifier">version</span>=<span class="synStatement">"</span><span class="synConstant">1.0</span><span class="synStatement">"</span> <span class="synIdentifier">encoding</span>=<span class="synStatement">"</span><span class="synConstant">UTF-8</span><span class="synStatement">"</span>?<span class="synStatement">></span>
<span class="synStatement"><</span>response<span class="synStatement">></span>
<span class="synStatement"><</span>lst <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">responseHeader</span><span class="synStatement">"><</span>int <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">status</span><span class="synStatement">"></span><span class="synConstant">0</span><span class="synStatement"><</span>/int<span class="synStatement">><</span>int <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">QTime</span><span class="synStatement">"></span><span class="synConstant">164</span><span class="synStatement"><</span>/int<span class="synStatement">><</span>/lst<span class="synStatement">></span>
<span class="synStatement"><</span>/response<span class="synStatement">></span>
<span class="synPreProc">(</span><span class="synSpecial">略</span><span class="synPreProc">)</span>

$ <span class="synStatement">ls</span> solr-4.7.0/example/solr/collection1/data/index
-rw-rw-<span class="synStatement">r</span>--. <span class="synConstant">1</span> yuta yuta  <span class="synConstant">4928</span>  <span class="synConstant">3</span>月 <span class="synConstant">16</span> <span class="synConstant">00</span>:<span class="synConstant">55</span> <span class="synConstant">2014</span> _0.fdt
-rw-rw-<span class="synStatement">r</span>--. <span class="synConstant">1</span> yuta yuta    <span class="synConstant">45</span>  <span class="synConstant">3</span>月 <span class="synConstant">16</span> <span class="synConstant">00</span>:<span class="synConstant">55</span> <span class="synConstant">2014</span> _0.fdx
-rw-rw-<span class="synStatement">r</span>--. <span class="synConstant">1</span> yuta yuta  <span class="synConstant">2300</span>  <span class="synConstant">3</span>月 <span class="synConstant">16</span> <span class="synConstant">00</span>:<span class="synConstant">55</span> <span class="synConstant">2014</span> _0.fnm
-rw-rw-<span class="synStatement">r</span>--. <span class="synConstant">1</span> yuta yuta   <span class="synConstant">250</span>  <span class="synConstant">3</span>月 <span class="synConstant">16</span> <span class="synConstant">00</span>:<span class="synConstant">55</span> <span class="synConstant">2014</span> _0.nvd
-rw-rw-<span class="synStatement">r</span>--. <span class="synConstant">1</span> yuta yuta   <span class="synConstant">112</span>  <span class="synConstant">3</span>月 <span class="synConstant">16</span> <span class="synConstant">00</span>:<span class="synConstant">55</span> <span class="synConstant">2014</span> _0.nvm
-rw-rw-<span class="synStatement">r</span>--. <span class="synConstant">1</span> yuta yuta   <span class="synConstant">395</span>  <span class="synConstant">3</span>月 <span class="synConstant">16</span> <span class="synConstant">00</span>:<span class="synConstant">55</span> <span class="synConstant">2014</span> _0.si
-rw-rw-<span class="synStatement">r</span>--. <span class="synConstant">1</span> yuta yuta   <span class="synConstant">144</span>  <span class="synConstant">3</span>月 <span class="synConstant">16</span> <span class="synConstant">00</span>:<span class="synConstant">55</span> <span class="synConstant">2014</span> _0.tvd
-rw-rw-<span class="synStatement">r</span>--. <span class="synConstant">1</span> yuta yuta    <span class="synConstant">45</span>  <span class="synConstant">3</span>月 <span class="synConstant">16</span> <span class="synConstant">00</span>:<span class="synConstant">55</span> <span class="synConstant">2014</span> _0.tvx
-rw-rw-<span class="synStatement">r</span>--. <span class="synConstant">1</span> yuta yuta  <span class="synConstant">1047</span>  <span class="synConstant">3</span>月 <span class="synConstant">16</span> <span class="synConstant">00</span>:<span class="synConstant">55</span> <span class="synConstant">2014</span> _0_Lucene41_0.doc
-rw-rw-<span class="synStatement">r</span>--. <span class="synConstant">1</span> yuta yuta    <span class="synConstant">34</span>  <span class="synConstant">3</span>月 <span class="synConstant">16</span> <span class="synConstant">00</span>:<span class="synConstant">55</span> <span class="synConstant">2014</span> _0_Lucene41_0.pay
-rw-rw-<span class="synStatement">r</span>--. <span class="synConstant">1</span> yuta yuta  <span class="synConstant">2204</span>  <span class="synConstant">3</span>月 <span class="synConstant">16</span> <span class="synConstant">00</span>:<span class="synConstant">55</span> <span class="synConstant">2014</span> _0_Lucene41_0.pos
-rw-rw-<span class="synStatement">r</span>--. <span class="synConstant">1</span> yuta yuta <span class="synConstant">14134</span>  <span class="synConstant">3</span>月 <span class="synConstant">16</span> <span class="synConstant">00</span>:<span class="synConstant">55</span> <span class="synConstant">2014</span> _0_Lucene41_0.tim
-rw-rw-<span class="synStatement">r</span>--. <span class="synConstant">1</span> yuta yuta   <span class="synConstant">712</span>  <span class="synConstant">3</span>月 <span class="synConstant">16</span> <span class="synConstant">00</span>:<span class="synConstant">55</span> <span class="synConstant">2014</span> _0_Lucene41_0.tip
-rw-rw-<span class="synStatement">r</span>--. <span class="synConstant">1</span> yuta yuta    <span class="synConstant">20</span>  <span class="synConstant">3</span>月 <span class="synConstant">16</span> <span class="synConstant">00</span>:<span class="synConstant">55</span> <span class="synConstant">2014</span> segments.gen
-rw-rw-<span class="synStatement">r</span>--. <span class="synConstant">1</span> yuta yuta   <span class="synConstant">110</span>  <span class="synConstant">3</span>月 <span class="synConstant">16</span> <span class="synConstant">00</span>:<span class="synConstant">55</span> <span class="synConstant">2014</span> segments_2
-rw-rw-<span class="synStatement">r</span>--. <span class="synConstant">1</span> yuta yuta     <span class="synConstant">0</span>  <span class="synConstant">3</span>月 <span class="synConstant">16</span> <span class="synConstant">00</span>:<span class="synConstant">25</span> <span class="synConstant">2014</span> write.lock
</pre>
</div>
<div class="section">
<h5>query実行</h5>
<p>SolrはREST形式なのでUPDATEやSELECTも基本的には<a class="keyword" href="http://d.hatena.ne.jp/keyword/curl">curl</a>にて行います。solr-4.7.0/example/exampledocsにはtest_utf8.shというテスト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>があるのでこれを参考に実行してみます。test_utf8.shの実行では<a class="keyword" href="http://d.hatena.ne.jp/keyword/ERROR">ERROR</a>:と表示されなければ問題ないと判断できます。test_utf8.sh中に記載されている<a class="keyword" href="http://d.hatena.ne.jp/keyword/curl">curl</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を真似てqueryを<a class="keyword" href="http://d.hatena.ne.jp/keyword/ASUS">ASUS</a>、outputを<a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a>としてSolrからのresponseを確認します。</p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ ./test_utf8.sh 
Solr server is up.
HTTP GET is accepting UTF<span class="synConstant">-8</span>
HTTP POST is accepting UTF<span class="synConstant">-8</span>
HTTP POST defaults to UTF<span class="synConstant">-8</span>
HTTP GET is accepting UTF<span class="synConstant">-8</span> beyond the basic multilingual plane
HTTP POST is accepting UTF<span class="synConstant">-8</span> beyond the basic multilingual plane
HTTP POST + URL params is accepting UTF<span class="synConstant">-8</span> beyond the basic multilingual plane
Response correctly returns UTF<span class="synConstant">-8</span> beyond the basic multilingual plane

$ curl <span class="synStatement">"</span><span class="synConstant">http://localhost:8983/solr/select?q=ASUS&params=explicit&wt=json</span><span class="synStatement">"</span> | python -mjson.tool
<span class="synSpecial">{</span>
<span class="synStatement">"</span><span class="synConstant">response</span><span class="synStatement">"</span>: <span class="synSpecial">{</span>
    <span class="synStatement">"</span><span class="synConstant">docs</span><span class="synStatement">"</span>: <span class="synStatement">[</span>
        <span class="synSpecial">{</span>
            <span class="synStatement">"</span><span class="synConstant">_version_</span><span class="synStatement">"</span>: <span class="synConstant">1462657512030339072</span>, 
            <span class="synStatement">"</span><span class="synConstant">cat</span><span class="synStatement">"</span>: <span class="synStatement">[</span>
                <span class="synStatement">"</span><span class="synConstant">electronics</span><span class="synStatement">"</span>, 
                <span class="synStatement">"</span><span class="synConstant">graphics card</span><span class="synStatement">"</span>
            <span class="synStatement">]</span>, 
            <span class="synStatement">"</span><span class="synConstant">features</span><span class="synStatement">"</span>: <span class="synStatement">[</span>
                <span class="synStatement">"</span><span class="synConstant">NVIDIA GeForce 7800 GTX GPU/VPU clocked at 486MHz</span><span class="synStatement">"</span>, 
                <span class="synStatement">"</span><span class="synConstant">256MB GDDR3 Memory clocked at 1.35GHz</span><span class="synStatement">"</span>, 
                <span class="synStatement">"</span><span class="synConstant">PCI Express x16</span><span class="synStatement">"</span>, 
                <span class="synStatement">"</span><span class="synConstant">Dual DVI connectors, HDTV out, video input</span><span class="synStatement">"</span>, 
                <span class="synStatement">"</span><span class="synConstant">OpenGL 2.0, DirectX 9.0</span><span class="synStatement">"</span>
            <span class="synStatement">]</span>, 
            <span class="synStatement">"</span><span class="synConstant">id</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">EN7800GTX/2DHTV/256M</span><span class="synStatement">"</span>, 
            <span class="synStatement">"</span><span class="synConstant">inStock</span><span class="synStatement">"</span>: <span class="synStatement">false</span>, 
            <span class="synStatement">"</span><span class="synConstant">manu</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">ASUS Computer Inc.</span><span class="synStatement">"</span>, 
            <span class="synStatement">"</span><span class="synConstant">manu_id_s</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">asus</span><span class="synStatement">"</span>, 
            <span class="synStatement">"</span><span class="synConstant">manufacturedate_dt</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">2006-02-13T00:00:00Z</span><span class="synStatement">"</span>, 
            <span class="synStatement">"</span><span class="synConstant">name</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">ASUS Extreme N7800GTX/2DHTV (256 MB)</span><span class="synStatement">"</span>, 
            <span class="synStatement">"</span><span class="synConstant">popularity</span><span class="synStatement">"</span>: <span class="synConstant">7</span>, 
            <span class="synStatement">"</span><span class="synConstant">price</span><span class="synStatement">"</span>: 479.94999999999999, 
            <span class="synStatement">"</span><span class="synConstant">price_c</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">479.95,USD</span><span class="synStatement">"</span>, 
            <span class="synStatement">"</span><span class="synConstant">store</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">40.7143,-74.006</span><span class="synStatement">"</span>, 
            <span class="synStatement">"</span><span class="synConstant">weight</span><span class="synStatement">"</span>: 16.0
        <span class="synSpecial">}</span>
    <span class="synStatement">]</span>, 
    <span class="synStatement">"</span><span class="synConstant">numFound</span><span class="synStatement">"</span>: <span class="synConstant">1</span>, 
    <span class="synStatement">"</span><span class="synConstant">start</span><span class="synStatement">"</span>: <span class="synConstant">0</span>
<span class="synSpecial">}</span>, 
<span class="synStatement">"</span><span class="synConstant">responseHeader</span><span class="synStatement">"</span>: <span class="synSpecial">{</span>
    <span class="synStatement">"</span><span class="synConstant">QTime</span><span class="synStatement">"</span>: <span class="synConstant">1</span>, 
    <span class="synStatement">"</span><span class="synConstant">params</span><span class="synStatement">"</span>: <span class="synSpecial">{</span>
        <span class="synStatement">"</span><span class="synConstant">params</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">explicit</span><span class="synStatement">"</span>, 
        <span class="synStatement">"</span><span class="synConstant">q</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">ASUS</span><span class="synStatement">"</span>, 
        <span class="synStatement">"</span><span class="synConstant">wt</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">json</span><span class="synStatement">"</span>
    <span class="synSpecial">}</span>, 
    <span class="synStatement">"</span><span class="synConstant">status</span><span class="synStatement">"</span>: <span class="synConstant">0</span>
<span class="synSpecial">}</span>
<span class="synSpecial">}</span>
</pre>
</div>
<div class="section">
<h5>設定ファイル</h5>
<p><span class="deco" style="font-weight:bold;">solr-4.7.0/example/solr/collection1/conf/solrconfig.xm</span>lに色々な記述が書かれているのでより深くexampleでのREST仕様を理解したい人は目を通してみると良いかもしれません。solr/selectにアクセスするとsolr.SearchHandlerClassを呼び出すなどの定義が書かれています。その他indexのschemaについては<span class="deco" style="font-weight:bold;">solr-4.7.0/example/solr/collection1/conf/schema.<a class="keyword" href="http://d.hatena.ne.jp/keyword/xml">xml</a></span>で定義されています。bi-gram、tokenizer、filter等の指定がされています。</p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ vi solr-4.7.0/example/solr/collection1/conf/solrconfig.xml

  <span class="synStatement"><</span>requestHandler <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">/select</span><span class="synStatement">"</span> <span class="synIdentifier">class</span>=<span class="synStatement">"</span><span class="synConstant">solr.SearchHandler</span><span class="synStatement">"></span>
<span class="synStatement"><</span>!-- default values <span class="synStatement">for </span>query parameters can be specified, these
     will be overridden by parameters <span class="synStatement">in</span> the request
  <span class="synSpecial">--></span>
 <span class="synStatement"><</span>lst <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">defaults</span><span class="synStatement">"></span>
   <span class="synStatement"><</span>str <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">echoParams</span><span class="synStatement">"></span>explicit<span class="synStatement"><</span>/str<span class="synStatement">></span>
   <span class="synStatement"><</span>int <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">rows</span><span class="synStatement">"></span><span class="synConstant">10</span><span class="synStatement"><</span>/int<span class="synStatement">></span>
   <span class="synStatement"><</span>str <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">df</span><span class="synStatement">"></span>text<span class="synStatement"><</span>/str<span class="synStatement">></span>
 <span class="synStatement"><</span>/lst<span class="synStatement">></span>

<span class="synPreProc">(</span><span class="synSpecial">略</span><span class="synPreProc">)</span>

$ vi solr-4.7.0/example/solr/collection1/conf/schema.xml

<span class="synStatement"><</span>!-- CJK bigram <span class="synPreProc">(</span><span class="synSpecial">see text_ja for a Japanese configuration using morphological analysis</span><span class="synPreProc">)</span> <span class="synSpecial">--></span>
<span class="synStatement"><</span>fieldType <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">text_cjk</span><span class="synStatement">"</span> <span class="synIdentifier">class</span>=<span class="synStatement">"</span><span class="synConstant">solr.TextField</span><span class="synStatement">"</span> <span class="synIdentifier">positionIncrementGap</span>=<span class="synStatement">"</span><span class="synConstant">100</span><span class="synStatement">"></span>
  <span class="synStatement"><</span>analyzer<span class="synStatement">></span>
    <span class="synStatement"><</span>tokenizer <span class="synIdentifier">class</span>=<span class="synStatement">"</span><span class="synConstant">solr.StandardTokenizerFactory</span><span class="synStatement">"</span>/<span class="synStatement">></span>
    <span class="synStatement"><</span>!-- normalize width before bigram, as e.g. half-width dakuten combine  <span class="synSpecial">--></span>
    <span class="synStatement"><</span>filter <span class="synIdentifier">class</span>=<span class="synStatement">"</span><span class="synConstant">solr.CJKWidthFilterFactory</span><span class="synStatement">"</span>/<span class="synStatement">></span>
    <span class="synStatement"><</span>!-- <span class="synStatement">for </span>any non-CJK <span class="synSpecial">--></span>
    <span class="synStatement"><</span>filter <span class="synIdentifier">class</span>=<span class="synStatement">"</span><span class="synConstant">solr.LowerCaseFilterFactory</span><span class="synStatement">"</span>/<span class="synStatement">></span>
    <span class="synStatement"><</span>filter <span class="synIdentifier">class</span>=<span class="synStatement">"</span><span class="synConstant">solr.CJKBigramFilterFactory</span><span class="synStatement">"</span>/<span class="synStatement">></span>
  <span class="synStatement"><</span>/analyzer<span class="synStatement">></span>
<span class="synStatement"><</span>/fieldType<span class="synStatement">></span>
</pre>
</div>
<div class="section">
<h5>solrpy</h5>
<p><a href="https://code.google.com/p/solrpy/">solrpy - Python Solr Module - Google Project Hosting</a> <a href="http://b.hatena.ne.jp/entry/s/code.google.com/p/solrpy/"><img src="http://b.hatena.ne.jp/entry/image/https://code.google.com/p/solrpy/" alt="はてなブックマーク - solrpy - Python Solr Module - Google Project Hosting" border="0" /></a><br />
<a href="https://pythonhosted.org/solrpy/reference.html">Reference ― solrpy v0.9.2 documentation</a> <a href="http://b.hatena.ne.jp/entry/s/pythonhosted.org/solrpy/reference.html"><img src="http://b.hatena.ne.jp/entry/image/https://pythonhosted.org/solrpy/reference.html" alt="はてなブックマーク - Reference ― solrpy v0.9.2 documentation" border="0" /></a><br />
SolrがREST形式ならclient言語は別に何だっていいんですが、僕は<a class="keyword" href="http://d.hatena.ne.jp/keyword/Java">Java</a>より<a class="keyword" href="http://d.hatena.ne.jp/keyword/Python">Python</a>が好きなのでおしゃべりする言語に使用します。solrpyというライブラリがありますが日本語ドキュメントは無いので、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B1%D1%B8%EC%C8%C7">英語版</a>を見ましょう。solrpyには2種類のclassがあってclass solr.Solr(url)、class solr.SolrConnection(url)になります。SolrConnectionの方が記述が分かり易いのですが、Solrの方が新しいという事で以下ではclass solr.Solrを使っています。</p><br />
<p>Solr-exampleのschema.<a class="keyword" href="http://d.hatena.ne.jp/keyword/xml">xml</a>を少し書き換えて配列形式のauthorを登録するような処理を書いてみます。<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%A3%BF%F4">複数</a>のauthorが登録できるようにmultiValued="true"にします。設定しないとsolrpyの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>実行時にsolr.core.SolrException: HTTP code=400, reason=Bad Requestと<a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>が出ます。</p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ sudo easy_install solrpy
<span class="synPreProc">(</span><span class="synSpecial">略</span><span class="synPreProc">)</span>
Installed /usr/lib/python2.6/site-packages/solrpy-0.9.6-py2.6.egg
Processing dependencies <span class="synStatement">for </span>solrpy
Finished processing dependencies <span class="synStatement">for </span>solrpy

<span class="synComment"># 下のtest_solrpy.pyを実行</span>
$ python test_solrpy.py
(略<span class="synError">)</span>
solr.core.SolrException: HTTP <span class="synIdentifier">code</span>=<span class="synConstant">400</span>, <span class="synIdentifier">reason</span>=Bad Requestとerror

<span class="synComment"># errorを回避する為に修正</span>
$ vi solr-4.7.0/example/solr/collection1/conf/schema.xml

<span class="synStatement"><!</span>-- multiValued属性を<span class="synStatement">"</span><span class="synConstant">true</span><span class="synStatement">"</span>に設定 <span class="synSpecial">--></span> 
<span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">author</span><span class="synStatement">"</span> <span class="synStatement">type=</span><span class="synConstant">"text_general"</span> <span class="synIdentifier">indexed</span>=<span class="synStatement">"</span><span class="synConstant">true</span><span class="synStatement">"</span> <span class="synIdentifier">stored</span>=<span class="synStatement">"</span><span class="synConstant">true</span><span class="synStatement">"</span> <span class="synIdentifier">multiValued</span>=<span class="synStatement">"</span><span class="synConstant">true</span><span class="synStatement">"</span>/<span class="synStatement">></span>
<span class="synStatement"><!</span>-- author_sを追加 <span class="synSpecial">--></span> 
<span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">author_s</span><span class="synStatement">"</span> <span class="synStatement">type=</span><span class="synConstant">"text_general"</span> <span class="synIdentifier">indexed</span>=<span class="synStatement">"</span><span class="synConstant">true</span><span class="synStatement">"</span> <span class="synIdentifier">stored</span>=<span class="synStatement">"</span><span class="synConstant">true</span><span class="synStatement">"</span> <span class="synIdentifier">multiValued</span>=<span class="synStatement">"</span><span class="synConstant">true</span><span class="synStatement">"</span>/<span class="synStatement">></span>

<span class="synComment"># solrのrestart</span>
$ java <span class="synSpecial">-jar</span> start.jar

<span class="synComment"># 再度実行</span>
$ python test_solrpy.py 
<span class="synConstant">1</span> <span class="synStatement">[</span>u<span class="synStatement">'</span><span class="synConstant">Lucene in Action</span><span class="synStatement">']</span> <span class="synStatement">[</span>u<span class="synStatement">'</span><span class="synConstant">Erik Hatcher</span><span class="synStatement">'</span>, u<span class="synStatement">'</span><span class="synConstant">Otis Gospodneti\u0107</span><span class="synStatement">']</span>
</pre><pre class="hljs python" data-lang="python" data-unlink><span class="synComment">#!/usr/bin/env python</span>
<span class="synComment">#coding:utf-8</span>
<span class="synComment">#solrpyのテスト</span>

<span class="synPreProc">import</span> solr
<span class="synComment"># add a document to the index</span>
con = solr.Solr(<span class="synConstant">'http://localhost:8983/solr'</span>)
doc ={<span class="synConstant">'id'</span>:<span class="synConstant">1</span>, <span class="synConstant">'title'</span>:<span class="synConstant">u'Lucene in Action'</span>, <span class="synConstant">'author'</span>:[<span class="synConstant">u'Erik Hatcher'</span>, <span class="synConstant">u'Otis Gospodneti〓'</span>]}
con.add(doc,commit=<span class="synIdentifier">True</span>)
<span class="synComment"># do a search</span>
response = con.select(<span class="synConstant">'title:lucene'</span>)
<span class="synStatement">for</span> hit <span class="synStatement">in</span> response.results:
<span class="synIdentifier">print</span> hit[<span class="synConstant">'id'</span>],hit[<span class="synConstant">'title'</span>],hit[<span class="synConstant">'author'</span>]
</pre>
</div>
</blockquote>

</div>
<div class="section">
<h4>Spatial Search</h4>

<blockquote>
    
<div class="section">
<h5>設定</h5>
<p><a href="https://wiki.apache.org/solr/SpatialSearch">SpatialSearch - Solr Wiki</a> <a href="http://b.hatena.ne.jp/entry/s/wiki.apache.org/solr/SpatialSearch"><img src="http://b.hatena.ne.jp/entry/image/https://wiki.apache.org/solr/SpatialSearch" alt="はてなブックマーク - SpatialSearch - Solr Wiki" border="0" /></a><br />
SpatialSearchについては上の<a class="keyword" href="http://d.hatena.ne.jp/keyword/wiki">wiki</a>に詳しく載っています。内容に書かれているschema.<a class="keyword" href="http://d.hatena.ne.jp/keyword/xml">xml</a>のfield name="store"、fieldType name="location"は既にexampleでは定義済みなので追記は不要だと思います。</p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ vi solr-4.7.0/example/solr/collection1/conf/schema.xml

<span class="synComment"># 以下はexampleのfieldTypeにdefaultで記載済み</span>
<span class="synStatement"><</span>field <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">store</span><span class="synStatement">"</span> <span class="synStatement">type="</span><span class="synConstant">location</span><span class="synStatement">"</span> <span class="synIdentifier">indexed</span>=<span class="synStatement">"</span><span class="synConstant">true</span><span class="synStatement">"</span> <span class="synIdentifier">stored</span>=<span class="synStatement">"</span><span class="synConstant">true</span><span class="synStatement">"</span>/<span class="synStatement">></span>
<span class="synStatement"><</span>fieldType <span class="synIdentifier">name</span>=<span class="synStatement">"</span><span class="synConstant">location</span><span class="synStatement">"</span> <span class="synIdentifier">class</span>=<span class="synStatement">"</span><span class="synConstant">solr.LatLonType</span><span class="synStatement">"</span> <span class="synIdentifier">subFieldSuffix</span>=<span class="synStatement">"</span><span class="synConstant">_coordinate</span><span class="synStatement">"</span>/<span class="synStatement">></span>
</pre>
</div>
<div class="section">
<h5>テスト</h5>
<p>post.shにてindex化したデータに対してSpatial Searchを掛けてみると問題なく対象となるデータが抽出出来ている事が確認できます。ちょいとSpatial Searchとして指定するパラメータが複雑ですが纏めると下の表のようになります。</p>

<table>
<tr>
<th> parameter </th>
<th> meaning </th>
</tr>
<tr>
<td> fl </td>
<td> 結果として抽出するfield </td>
</tr>
<tr>
<td> q </td>
<td> query (下では*:*を指定) </td>
</tr>
<tr>
<td> fq </td>
<td> queryのfilter(下では{!geofilt}を指定) </td>
</tr>
<tr>
<td> sfield </td>
<td> Spatial Searchの対象field </td>
</tr>
<tr>
<td> pt </td>
<td> 検索位置のlatlng </td>
</tr>
<tr>
<td> d </td>
<td> ptからの検索対象距離を指定 </td>
</tr>
<tr>
<td> wt </td>
<td> 出力形式 </td>
</tr>
</table><p> </p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ curl <span class="synStatement">"</span><span class="synConstant">http://localhost:8983/solr/select?fl=name,store&q=*%3A*&fq=%7B%21geofilt%7D&sfield=store&pt=45.15,-93.85&d=5&wt=json</span><span class="synStatement">"</span> | python -mjson.tool
<span class="synSpecial">{</span>
<span class="synStatement">"</span><span class="synConstant">response</span><span class="synStatement">"</span>: <span class="synSpecial">{</span>
    <span class="synStatement">"</span><span class="synConstant">docs</span><span class="synStatement">"</span>: <span class="synStatement">[</span>
        <span class="synSpecial">{</span>
            <span class="synStatement">"</span><span class="synConstant">name</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">Maxtor DiamondMax 11 - hard drive - 500 GB - SATA-300</span><span class="synStatement">"</span>, 
            <span class="synStatement">"</span><span class="synConstant">store</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">45.17614,-93.87341</span><span class="synStatement">"</span>
        <span class="synSpecial">}</span>, 
        <span class="synSpecial">{</span>
            <span class="synStatement">"</span><span class="synConstant">name</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">Belkin Mobile Power Cord for iPod w/ Dock</span><span class="synStatement">"</span>, 
            <span class="synStatement">"</span><span class="synConstant">store</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">45.18014,-93.87741</span><span class="synStatement">"</span>
        <span class="synSpecial">}</span>, 
        <span class="synSpecial">{</span>
            <span class="synStatement">"</span><span class="synConstant">name</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">A-DATA V-Series 1GB 184-Pin DDR SDRAM Unbuffered DDR 400 (PC 3200) System Memory - OEM</span><span class="synStatement">"</span>, 
            <span class="synStatement">"</span><span class="synConstant">store</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">45.18414,-93.88141</span><span class="synStatement">"</span>
        <span class="synSpecial">}</span>
    <span class="synStatement">]</span>, 
    <span class="synStatement">"</span><span class="synConstant">numFound</span><span class="synStatement">"</span>: <span class="synConstant">3</span>, 
    <span class="synStatement">"</span><span class="synConstant">start</span><span class="synStatement">"</span>: <span class="synConstant">0</span>
<span class="synSpecial">}</span>, 
<span class="synStatement">"</span><span class="synConstant">responseHeader</span><span class="synStatement">"</span>: <span class="synSpecial">{</span>
    <span class="synStatement">"</span><span class="synConstant">QTime</span><span class="synStatement">"</span>: <span class="synConstant">0</span>, 
    <span class="synStatement">"</span><span class="synConstant">params</span><span class="synStatement">"</span>: <span class="synSpecial">{</span>
        <span class="synStatement">"</span><span class="synConstant">d</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">5</span><span class="synStatement">"</span>, 
        <span class="synStatement">"</span><span class="synConstant">fl</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">name,store</span><span class="synStatement">"</span>, 
        <span class="synStatement">"</span><span class="synConstant">fq</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">{!geofilt}</span><span class="synStatement">"</span>, 
        <span class="synStatement">"</span><span class="synConstant">pt</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">45.15,-93.85</span><span class="synStatement">"</span>, 
        <span class="synStatement">"</span><span class="synConstant">q</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">*:*</span><span class="synStatement">"</span>, 
        <span class="synStatement">"</span><span class="synConstant">sfield</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">store</span><span class="synStatement">"</span>, 
        <span class="synStatement">"</span><span class="synConstant">wt</span><span class="synStatement">"</span>: <span class="synStatement">"</span><span class="synConstant">json</span><span class="synStatement">"</span>
    <span class="synSpecial">}</span>, 
    <span class="synStatement">"</span><span class="synConstant">status</span><span class="synStatement">"</span>: <span class="synConstant">0</span>
<span class="synSpecial">}</span>
<span class="synSpecial">}</span>
</pre>
</div>
<div class="section">
<h5>実用データでテスト</h5>
<p><a href="http://tabelog.com/tokyo/A1301/A130103/13023882/">ソニア - 新橋/お好み焼き [食べログ]</a> <a href="http://b.hatena.ne.jp/entry/tabelog.com/tokyo/A1301/A130103/13023882/"><img src="http://b.hatena.ne.jp/entry/image/http://tabelog.com/tokyo/A1301/A130103/13023882/" alt="はてなブックマーク - ソニア - 新橋/お好み焼き [食べログ]" border="0" /></a><br />
広<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C5%E7%C9%F7">島風</a>お好み焼きがとても美味しい上のお店のデータでテストしてみます。冒頭の写真はお店のお好み焼き(シングルというメニュー)です。新橋/汐留近辺ではとても有名なお店だと思うので近い方は一度行ってみてください。さて、YahooのGeocoderAPIを使ってお店の住所からlatlngを出し、SolrのIndexに格納しSpatialSearchをやってみます。<br />
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BF%A9%A4%D9%A5%ED%A5%B0">食べログ</a>の案内に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BC%AE%CE%B1%B1%D8">汐留駅</a>から372mと書かれており、パラメータd=0.3では抽出不可、d=0.4=抽出可能という点から正確にSpatialSearchが出来たと思います。</p>
<pre class="hljs python" data-lang="python" data-unlink><span class="synComment">#!/usr/bin/env python</span>
<span class="synComment">#coding:utf-8</span>
<span class="synComment">#住所データからSpatial Indexを作成 </span>
<span class="synComment">#latlon.pyとして保存する</span>
<span class="synPreProc">import</span> urllib,urllib2,json,solr
opener = urllib2.build_opener()
ua = <span class="synConstant">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_6_8) AppleWebKit/534.51.22 (KHTML, like Gecko) Version/5.1.1 Safari/    534.51.22'</span>
referer = <span class="synConstant">'http://www.yahoo.co.jp/'</span>
opener.addheaders = [(<span class="synConstant">'User-Agent'</span>, ua),(<span class="synConstant">'Referer'</span>, referer)]
appid = <span class="synConstant">'Yahoo!'</span> <span class="synComment"># yahooapiのappidをここに定義</span>
address = <span class="synConstant">u'東京都港区新橋5-15-1'</span>
<span class="synStatement">try</span>:
url = <span class="synConstant">'http://geo.search.olp.yahooapis.jp/OpenLocalPlatform/V1/geoCoder?appid=%s&query=%s&output=%s'</span> % (appid, urllib.quote_plus(address.encode(<span class="synConstant">'utf-8'</span>)), <span class="synConstant">'json'</span>) 
res = json.loads(opener.<span class="synIdentifier">open</span>(url).read())
<span class="synStatement">if</span> (res[<span class="synConstant">'ResultInfo'</span>][<span class="synConstant">'Status'</span>] == <span class="synConstant">200</span> <span class="synStatement">and</span> res[<span class="synConstant">'ResultInfo'</span>][<span class="synConstant">'Count'</span>] > <span class="synConstant">0</span> ):
    (lng,lat) = res[<span class="synConstant">'Feature'</span>][<span class="synConstant">0</span>][<span class="synConstant">'Geometry'</span>][<span class="synConstant">'Coordinates'</span>].split(<span class="synConstant">','</span>)
    latlng = lat + <span class="synConstant">','</span> + lng 
<span class="synStatement">except</span> urllib2.URLError:
<span class="synIdentifier">print</span> <span class="synConstant">"Error: API"</span>

<span class="synStatement">try</span>:
con = solr.Solr(<span class="synConstant">'http://localhost:8983/solr'</span>)
doc ={<span class="synConstant">'id'</span>:<span class="synConstant">'sonia_latlon'</span>, <span class="synConstant">'name'</span>:<span class="synConstant">u'ソニア'</span>, <span class="synConstant">'store'</span>:latlng}
con.add(doc,commit=<span class="synIdentifier">True</span>)
<span class="synComment">#汐留駅からの0.5KMの距離で計算</span>
response = con.select(<span class="synConstant">'*:*'</span>, <span class="synConstant">'id,name,store'</span>, <span class="synConstant">''</span>, <span class="synConstant">'true'</span>, <span class="synConstant">'id'</span>, <span class="synConstant">'desc'</span>, fq=<span class="synConstant">'{!geofilt}'</span>, sfield=<span class="synConstant">'store'</span>, d=<span class="synConstant">'0.4'</span>, pt=<span class="synConstant">'35.662800,139.760000'</span>)
<span class="synStatement">for</span> hit <span class="synStatement">in</span> response.results:
    <span class="synIdentifier">print</span> hit[<span class="synConstant">'id'</span>], hit[<span class="synConstant">'name'</span>], hit[<span class="synConstant">'store'</span>]
<span class="synStatement">except</span> solr.SolrException:
<span class="synIdentifier">print</span> <span class="synConstant">"Error: Solr"</span>
</pre><pre class="hljs sh" data-lang="sh" data-unlink>$ python latlon.py
sonia_latlon ソニア 35.66223082,139.75596233
</pre>
</div>
</blockquote>

</div>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://yutakikuchi.github.io/post/201402280825/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://yutakikuchi.github.io/post/201402280825/">OpenSSLの暗号処理が爆速な件</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://yutakikuchi.github.io/post/201404010836/">速いよ Java Play Framework</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://yutakikuchi.github.io/post/201404010836/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>

</div>
</div>
<script src="https://yutakikuchi.github.io/js/ui.js"></script>
<script src="https://yutakikuchi.github.io/js/menus.js"></script>


<script>
  
  if (window.location.hostname != "localhost") {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-20616165-3', 'auto');
    ga('send', 'pageview');
  }
</script>





</body>
</html>

