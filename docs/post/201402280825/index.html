<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="canonical" href="http://yut.hatenablog.com/entry/20140228/1393543543" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.55.4" />

  <title>OpenSSLの暗号処理が爆速な件 &middot; Y&#39;s note</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://yutakikuchi.github.io/blog/img/favicon.ico" type="image/x-icon" />

  
    
        <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/my.css">
    
  
  
    
        <script src="https://yutakikuchi.github.io/blog/js/my.js"></script>
    
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://yutakikuchi.github.io/blog/">Y's note</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/yutakikuchi_" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://facebook.com/yuta.kikuchi.007" target="_blank"><i class="fa fa-facebook-square fa-fw"></i>Facebook</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="http://slideshare.net/https://www.slideshare.net/yutakikuchi58/" target="_blank"><i class="fa fa-slideshare fa-fw"></i>SlideShare</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/https://www.linkedin.com/in/%E4%BD%91%E5%A4%AA-%E8%8F%8A%E6%B1%A0-36291a44/" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/yutakikuchi" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2019. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>OpenSSLの暗号処理が爆速な件</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2014 Feb 28, 08:25</time>
  </div>

  

  

  

</div>

  

<h2 id="c-opensslの暗号処理が爆速な件">[C] : OpenSSLの暗号処理が爆速な件</h2>

<p><div class="amazlet-box"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4274065731/yutakikuchi-22/"><img src="http://ecx.images-amazon.com/images/I/515K64RSM1L._SL160_.jpg" class="hatena-asin-detail-image" alt="OpenSSL―暗号・PKI・SSL/TLSライブラリの詳細―" title="OpenSSL―暗号・PKI・SSL/TLSライブラリの詳細―"></a><div class="hatena-asin-detail-info"><p class="hatena-asin-detail-title"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4274065731/yutakikuchi-22/">OpenSSL―暗号・PKI・SSL/TLSライブラリの詳細―</a></p><ul><li><span class="hatena-asin-detail-label">作者:</span> John Viega,Matt Messier,Pravir Chandra,<a class="keyword" href="http://d.hatena.ne.jp/keyword/%E3%B7%C6%A3%B9%A7">齋藤孝</a>道</li><li><span class="hatena-asin-detail-label">出版社/メーカー:</span> <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AA%A1%BC%A5%E0%BC%D2">オーム社</a></li><li><span class="hatena-asin-detail-label">発売日:</span> 2004/08</li><li><span class="hatena-asin-detail-label">メディア:</span> 単行本</li><li><span class="hatena-asin-detail-label">購入</span>: 4人 <span class="hatena-asin-detail-label">クリック</span>: 89回</li><li><a href="http://d.hatena.ne.jp/asin/4274065731/yutakikuchi-22" target="_blank">この商品を含むブログ (25件) を見る</a></li></ul></div><div class="hatena-asin-detail-foot"></div></div></p>

<div class="section">
<h4>目次</h4>

<blockquote>
    
<ol>
<li>OpenSSLによる暗号</li>
<li>実行環境</li>
<li>OpenSSLによる暗号化速度</li>
<li>ECBと<a class="keyword" href="http://d.hatena.ne.jp/keyword/CBC">CBC</a>の違い</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>
<ul>
<li>OpenSSLと<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mcrypt">Mcrypt</a>関数のalgorithms比較</li>
<li>OpenSSLと<a class="keyword" href="http://d.hatena.ne.jp/keyword/mcrypt">mcrypt</a>関数のDES,AESの速度比較</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Mcrypt">Mcrypt</a>のゼロpaddingの癖</li>
</ul></li>
<li>C
<ul>
<li>DES暗号</li>
<li>AES暗号</li>
<li>OpenSSLと<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mcrypt">Mcrypt</a>のDES,AESの速度比較</li>
</ul></li>
</ol>
</blockquote>

</div>
<div class="section">
<h4>OpenSSLによる暗号</h4>

<blockquote>
    <p><a href="http://www.infoscience.co.jp/technical/openssl/">OpenSSL日本語サイト: The Open Source toolkit for SSL/TLS</a> <a href="http://b.hatena.ne.jp/entry/www.infoscience.co.jp/technical/openssl/"><img src="http://b.hatena.ne.jp/entry/image/http://www.infoscience.co.jp/technical/openssl/" alt="はてなブックマーク - OpenSSL日本語サイト: The Open Source toolkit for SSL/TLS" border="0" /></a><br />
あどてくやっている<a href='http://twitter.com/yutakikuc'>@yutakikuc</a>です。<br />
今日は<span class="deco" style="font-weight:bold;">OpenSSLの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B6%A6%C4%CC%B8%B0%B0%C5%B9%E6">共通鍵暗号</a></span>について調査した内容を纏めます。OpenSSLについて特に<span class="deco" style="font-weight:bold;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/C%B8%C0%B8%EC">C言語</a>での日本語ドキュメントが少なく</span>、あったとしても内容が古くてあまり参考にならなかったりするので色々とサンプルを上げて行きます。<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>について記載します。<br />
結論を先に書いておくと<span class="deco" style="color:#FF0000;font-weight:bold;">C,<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>ともに<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mcrypt">Mcrypt</a>では無くOpenSSLを使って暗号化した方が処理効率がはるかに向上します。</span>以下がECBモードで100万回の暗号化/復号化処理時間(sec)の表になります。速度以外の点としては<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mcrypt">Mcrypt</a>はPadding(後述)の仕様が厄介です。みなさん、OpenSSLを使いましょう！<span class="deco" style="color:#FF0000;font-weight:bold;">※下で挙げている<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a>にはほとんど<a class="keyword" href="http://d.hatena.ne.jp/keyword/Error">Error</a>処理が書いていないので、コピペする人はその辺に気をつけてくださいね。</span>コードは<a class="keyword" href="http://d.hatena.ne.jp/keyword/github">github</a>にも上げたのでご自由にどうぞ。<br />
<a href="https://github.com/yutakikuchi/Crypto/tree/master/openssl">Crypto/openssl at master · yutakikuchi/Crypto</a> <a href="http://b.hatena.ne.jp/entry/s/github.com/yutakikuchi/Crypto/tree/master/openssl"><img src="http://b.hatena.ne.jp/entry/image/https://github.com/yutakikuchi/Crypto/tree/master/openssl" alt="はてなブックマーク - Crypto/openssl at master · yutakikuchi/Crypto" border="0" /></a><br />
</p>

<table>
<tr>
<th> 暗号ライブラリ </th>
<th> 暗号<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a> </th>
<th> 言語 </th>
<th> 実行回数 </th>
<th> 暗号化処理時間 </th>
<th> 復号化処理時間 </th>
<th> 備考 </th>
</tr>
<tr>
<td> OpenSSL </td>
<td> DES-ECB </td>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a> </td>
<td> 1000000 </td>
<td>1.7591309 </td>
<td> 1.9514858 </td>
<td> <span class="deco" style="font-weight:bold;color:#FF0000;">爆速</span> </td>
</tr>
<tr>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/Mcrypt">Mcrypt</a> </td>
<td> DES-ECB </td>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a> </td>
<td> 1000000 </td>
<td>231.3662681 </td>
<td> 218.4248890 </td>
<td> 爆遅 </td>
</tr>
<tr>
<td> OpenSSL </td>
<td> AES-128-ECB </td>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a> </td>
<td> 1000000 </td>
<td> 1.1707689　</td>
<td> 1.51384592 </td>
<td> <span class="deco" style="font-weight:bold;color:#FF0000;">爆速</span> </td>
</tr>
<tr>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/Mcrypt">Mcrypt</a> </td>
<td> AES-128-ECB </td>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a> </td>
<td> 1000000 </td>
<td> 93.1640918 </td>
<td> 86.3522748 </td>
<td> 爆遅 </td>
</tr>
<tr>
<td> OpenSSL </td>
<td> DES-ECB </td>
<td> C </td>
<td> 1000000 </td>
<td> 1.160 </td>
<td> 1.240 </td>
<td> <span class="deco" style="font-weight:bold;color:#FF0000;">爆速</span> </td>
</tr>
<tr>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/Mcrypt">Mcrypt</a> </td>
<td> DES-ECB </td>
<td> C </td>
<td> 1000000 </td>
<td> 214.830 </td>
<td> 194.970 </td>
<td> 爆遅 </td>
</tr>
<tr>
<td> OpenSSL </td>
<td> AES-128-ECB  </td>
<td> C </td>
<td>  1000000 </td>
<td> 0.620 </td>
<td> 0.720 </td>
<td> <span class="deco" style="font-weight:bold;color:#FF0000;">爆速</span> </td>
</tr>
<tr>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/Mcrypt">Mcrypt</a> </td>
<td> AES-128-ECB  </td>
<td> C </td>
<td>  1000000 </td>
<td> 62.850 </td>
<td>  62.430 </td>
<td> 爆遅 </td>
</tr>
</table>
</blockquote>

</div>
<div class="section">
<h4>実行環境</h4>

<blockquote>
    <p>このドキュメントは以下の環境およびパッケージで実行しています。</p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ cat /etc/system-release 
CentOS release 6.4 <span class="synPreProc">(</span><span class="synSpecial">Final</span><span class="synPreProc">)</span>

$ uname <span class="synSpecial">-a</span>                                                   
Linux localhost.localdomain 2.6.32-358.el6.x86_64 <span class="synComment">#1 SMP Fri Feb 22 00:31:26 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux</span>

$ <span class="synStatement">rpm</span> <span class="synSpecial">-qa</span> | <span class="synStatement">grep</span> <span class="synStatement">"</span><span class="synConstant">openssl</span><span class="synStatement">"</span>
<span class="synStatement">rpm</span> <span class="synSpecial">-qa</span> | <span class="synStatement">grep</span> <span class="synSpecial">-i</span> <span class="synStatement">"</span><span class="synConstant">openssl</span><span class="synStatement">"</span>
openssl-1.0.1e-16.el6_5.4.x86_64
openssl-devel-1.0.1e-16.el6_5.4.x86_64
pyOpenSSL-0.10-2.el6.x86_64
openssl098e-0.9.8e-17.el6.centos.2.x86_64

$ <span class="synStatement">rpm</span> <span class="synSpecial">-qa</span> | <span class="synStatement">grep</span> <span class="synStatement">"</span><span class="synConstant">php</span><span class="synStatement">"</span>
php-cli-5.4.25-2.el6.remi.x86_64
php-mcrypt-5.4.25-2.el6.remi.x86_64
php-common-5.4.25-2.el6.remi.x86_64
php-5.4.25-2.el6.remi.x86_64

$ <span class="synStatement">rpm</span> <span class="synSpecial">-qa</span> | <span class="synStatement">grep</span> <span class="synStatement">"</span><span class="synConstant">python</span><span class="synStatement">"</span>
python-libs-2.6.6-52.el6.x86_64
python-iniparse-0.3.1-2.1.el6.noarch
python-pycurl-7.19.0-8.el6.x86_64
newt-python-0.52.11-3.el6.x86_64
python-2.6.6-52.el6.x86_64
python-devel-2.6.6-52.el6.x86_64
python-setuptools-0.6.10-3.el6.noarch
<span class="synStatement">rpm</span>-python-4.8.0-32.el6.x86_64
python-urlgrabber-3.9.1-8.el6.noarch
</pre>
</blockquote>

</div>
<div class="section">
<h4>OpenSSLによる暗号化速度</h4>

<blockquote>
    <p>DES,3DES,AESあたりがよく使われる<span class="deco" style="font-weight:bold;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/%B6%A6%C4%CC%B8%B0%B0%C5%B9%E6">共通鍵暗号</a>方式の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a></span>だと思いますが、それぞれどの程度の速度で処理されているかをopensslコマンドにより比較する事が出来ます。3秒間にそれぞれの固定サイズのデータを何回暗号化出来るかというspeed勝負です。DESの暗号化強度が不安なのでより強度の高いAESが開発されたという歴史の流れがありますが、<span class="deco" style="color:#FF0000;font-weight:bold;">処理速度はDESよりAES-128の方が速い</span>という結果になります。(僕の環境ではAES-128とAES-192がDESより速いという結果。DESはkey長が8Byte(64bit)、AESは16Byte(128bit)/24Byte(192bit)/32Byte(258bit)なのでAESの方が遅いと予想されがちですが、AES-256だけがDESより遅くなりました。）<span class="deco" style="color:#FF0000;font-weight:bold;">3DESは名前の通りDESの3倍近く遅いですね。</span><br />
一番下の表は1secあたりの処理<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AD%A5%ED%A5%D0%A5%A4%A5%C8">キロバイト</a>数を計算したものになります。</p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ openssl speed des aes
Doing des cbc <span class="synStatement">for </span>3s on <span class="synConstant">16</span> size blocks: <span class="synConstant">9642571</span> des cbc<span class="synStatement">'</span><span class="synConstant">s in 2.98s</span>
<span class="synConstant">Doing des cbc for 3s on 64 size blocks: 2527420 des cbc</span><span class="synStatement">'</span>s <span class="synStatement">in</span> 2.99s
Doing des cbc <span class="synStatement">for </span>3s on <span class="synConstant">256</span> size blocks: <span class="synConstant">592201</span> des cbc<span class="synStatement">'</span><span class="synConstant">s in 2.98s</span>
<span class="synConstant">Doing des cbc for 3s on 1024 size blocks: 122972 des cbc</span><span class="synStatement">'</span>s <span class="synStatement">in</span> 2.93s
Doing des cbc <span class="synStatement">for </span>3s on <span class="synConstant">8192</span> size blocks: <span class="synConstant">16906</span> des cbc<span class="synStatement">'</span><span class="synConstant">s in 2.97s</span>
<span class="synConstant">Doing des ede3 for 3s on 16 size blocks: 3467602 des ede3</span><span class="synStatement">'</span>s <span class="synStatement">in</span> 2.98s
Doing des ede3 <span class="synStatement">for </span>3s on <span class="synConstant">64</span> size blocks: <span class="synConstant">910272</span> des ede3<span class="synStatement">'</span><span class="synConstant">s in 2.98s</span>
<span class="synConstant">Doing des ede3 for 3s on 256 size blocks: 192319 des ede3</span><span class="synStatement">'</span>s <span class="synStatement">in</span> 2.97s
Doing des ede3 <span class="synStatement">for </span>3s on <span class="synConstant">1024</span> size blocks: <span class="synConstant">49983</span> des ede3<span class="synStatement">'</span><span class="synConstant">s in 2.96s</span>
<span class="synConstant">Doing des ede3 for 3s on 8192 size blocks: 5577 des ede3</span><span class="synStatement">'</span>s <span class="synStatement">in</span> 2.98s
Doing aes<span class="synConstant">-128</span> cbc <span class="synStatement">for </span>3s on <span class="synConstant">16</span> size blocks: <span class="synConstant">13118363</span> aes<span class="synConstant">-128</span> cbc<span class="synStatement">'</span><span class="synConstant">s in 2.96s</span>
<span class="synConstant">Doing aes-128 cbc for 3s on 64 size blocks: 3854938 aes-128 cbc</span><span class="synStatement">'</span>s <span class="synStatement">in</span> 2.98s
Doing aes<span class="synConstant">-128</span> cbc <span class="synStatement">for </span>3s on <span class="synConstant">256</span> size blocks: <span class="synConstant">939551</span> aes<span class="synConstant">-128</span> cbc<span class="synStatement">'</span><span class="synConstant">s in 2.97s</span>
<span class="synConstant">Doing aes-128 cbc for 3s on 1024 size blocks: 509362 aes-128 cbc</span><span class="synStatement">'</span>s <span class="synStatement">in</span> 2.97s
Doing aes<span class="synConstant">-128</span> cbc <span class="synStatement">for </span>3s on <span class="synConstant">8192</span> size blocks: <span class="synConstant">59653</span> aes<span class="synConstant">-128</span> cbc<span class="synStatement">'</span><span class="synConstant">s in 2.97s</span>
<span class="synConstant">Doing aes-192 cbc for 3s on 16 size blocks: 10306361 aes-192 cbc</span><span class="synStatement">'</span>s <span class="synStatement">in</span> 2.83s
Doing aes<span class="synConstant">-192</span> cbc <span class="synStatement">for </span>3s on <span class="synConstant">64</span> size blocks: <span class="synConstant">3184489</span> aes<span class="synConstant">-192</span> cbc<span class="synStatement">'</span><span class="synConstant">s in 2.97s</span>
<span class="synConstant">Doing aes-192 cbc for 3s on 256 size blocks: 757061 aes-192 cbc</span><span class="synStatement">'</span>s <span class="synStatement">in</span> 2.97s
Doing aes<span class="synConstant">-192</span> cbc <span class="synStatement">for </span>3s on <span class="synConstant">1024</span> size blocks: <span class="synConstant">428066</span> aes<span class="synConstant">-192</span> cbc<span class="synStatement">'</span><span class="synConstant">s in 2.97s</span>
<span class="synConstant">Doing aes-192 cbc for 3s on 8192 size blocks: 37443 aes-192 cbc</span><span class="synStatement">'</span>s <span class="synStatement">in</span> 2.97s
Doing aes<span class="synConstant">-256</span> cbc <span class="synStatement">for </span>3s on <span class="synConstant">16</span> size blocks: <span class="synConstant">4759675</span> aes<span class="synConstant">-256</span> cbc<span class="synStatement">'</span><span class="synConstant">s in 3.02s</span>
<span class="synConstant">Doing aes-256 cbc for 3s on 64 size blocks: 2045784 aes-256 cbc</span><span class="synStatement">'</span>s <span class="synStatement">in</span> 2.97s
Doing aes<span class="synConstant">-256</span> cbc <span class="synStatement">for </span>3s on <span class="synConstant">256</span> size blocks: <span class="synConstant">541610</span> aes<span class="synConstant">-256</span> cbc<span class="synStatement">'</span><span class="synConstant">s in 2.97s</span>
<span class="synConstant">Doing aes-256 cbc for 3s on 1024 size blocks: 315557 aes-256 cbc</span><span class="synStatement">'</span>s <span class="synStatement">in</span> 2.98s
Doing aes<span class="synConstant">-256</span> cbc <span class="synStatement">for </span>3s on <span class="synConstant">8192</span> size blocks: <span class="synConstant">46577</span> aes<span class="synConstant">-256</span> cbc<span class="synStatement">'</span><span class="synConstant">s in 2.96s</span>

<span class="synConstant">(略)</span>

<span class="synConstant">The </span><span class="synStatement">'</span>numbers<span class="synStatement">'</span><span class="synConstant"> are in 1000s of bytes per second processed.</span>
<span class="synConstant">type                  16 bytes        64 bytes       256 bytes      1024 bytes    8192 bytes</span>
<span class="synConstant">des cbc             51772.19k    54098.62k    50873.64k    42977.25k    46630.96k</span>
<span class="synConstant">des ede3           18618.00k    19549.47k    16576.99k    17291.42k    15331.14k</span>
<span class="synConstant">aes-128 cbc      70910.07k    82790.61k    80984.87k   175618.41k   164537.84k</span>
<span class="synConstant">aes-192 cbc      58269.18k    68621.99k    65255.09k   147589.09k   103277.12k</span>
<span class="synConstant">aes-256 cbc      25216.82k    44084.23k    46684.23k   108433.01k   128904.99k</span>
</pre>
</blockquote>

</div>
<div class="section">
<h4>ECBと<a class="keyword" href="http://d.hatena.ne.jp/keyword/CBC">CBC</a>の違い</h4>

<blockquote>
    <p><a href="http://www.triplefalcon.com/Lexicon/Encryption-Block-Mode-1.htm">ブロック暗号モード(block cipher mode)</a> <a href="http://b.hatena.ne.jp/entry/www.triplefalcon.com/Lexicon/Encryption-Block-Mode-1.htm"><img src="http://b.hatena.ne.jp/entry/image/http://www.triplefalcon.com/Lexicon/Encryption-Block-Mode-1.htm" alt="はてなブックマーク - ブロック暗号モード(block cipher mode)" border="0" /></a><br />
上のサイトに詳しく書いてあります。ECBは平文を固定ブロックに分割して1ブロック毎に暗号化を行い連結して暗号文を作成する。<a class="keyword" href="http://d.hatena.ne.jp/keyword/CBC">CBC</a>も平文を固定ブロックに分割し暗号化を行いますが、前回の暗号結果が次回の暗号結果にも連鎖して利用される方式になります。<a class="keyword" href="http://d.hatena.ne.jp/keyword/CBC">CBC</a>は前回の結果を反映するため、初回の暗号結果としてIV(初期ベクトル)を必要とします。<a class="keyword" href="http://d.hatena.ne.jp/keyword/CBC">CBC</a>モードを選択している時にプログラム上でIVが無いと怒られるのはこの為ですね。</p>

</blockquote>

</div>
<div class="section">
<h4><a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a></h4>

<blockquote>
    
<div class="section">
<h5>OpenSSLと<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mcrypt">Mcrypt</a>関数のalgorithms比較</h5>
<p>まずはサポートされている暗号化<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>ですが、<span class="deco" style="color:#FF0000;font-weight:bold;">圧倒的にOpenSSLの方が充実しています。</span>以下のコマンドを叩いていただければ表示されます。※OpenSSLは重複している暗号<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>も含まれます。</p>
<pre class="hljs sh" data-lang="sh" data-unlink>
<span class="synComment">#openssl</span>
$ php <span class="synSpecial">-r</span> <span class="synStatement">"</span><span class="synConstant">print_r(openssl_get_cipher_methods());</span><span class="synStatement">"</span>
Array
<span class="synPreProc">(</span>
<span class="synSpecial">    [</span><span class="synConstant">0</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> AES</span><span class="synConstant">-128</span><span class="synSpecial">-CBC</span>
<span class="synSpecial">    [</span><span class="synConstant">1</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> AES</span><span class="synConstant">-128</span><span class="synSpecial">-CFB</span>
<span class="synSpecial">    [</span><span class="synConstant">2</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> AES</span><span class="synConstant">-128</span><span class="synSpecial">-CFB1</span>
<span class="synSpecial">    [</span><span class="synConstant">3</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> AES</span><span class="synConstant">-128</span><span class="synSpecial">-CFB8</span>
<span class="synSpecial">    [</span><span class="synConstant">4</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> AES</span><span class="synConstant">-128</span><span class="synSpecial">-CTR</span>
<span class="synSpecial">    [</span><span class="synConstant">5</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> AES</span><span class="synConstant">-128</span><span class="synSpecial">-ECB</span>
<span class="synSpecial">    [</span><span class="synConstant">6</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> AES</span><span class="synConstant">-128</span><span class="synSpecial">-OFB</span>
<span class="synSpecial">    [</span><span class="synConstant">7</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> AES</span><span class="synConstant">-128</span><span class="synSpecial">-XTS</span>
<span class="synSpecial">    [</span><span class="synConstant">8</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> AES</span><span class="synConstant">-192</span><span class="synSpecial">-CBC</span>
<span class="synSpecial">    [</span><span class="synConstant">9</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> AES</span><span class="synConstant">-192</span><span class="synSpecial">-CFB</span>
<span class="synSpecial">    [</span><span class="synConstant">10</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> AES</span><span class="synConstant">-192</span><span class="synSpecial">-CFB1</span>
<span class="synSpecial"> </span><span class="synPreProc">(</span><span class="synSpecial">略</span><span class="synPreProc">)</span>
<span class="synSpecial">    [</span><span class="synConstant">165</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> rc4</span>
<span class="synSpecial">    [</span><span class="synConstant">166</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> rc4</span><span class="synConstant">-40</span>
<span class="synSpecial">    [</span><span class="synConstant">167</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> rc4-hmac-md5</span>
<span class="synSpecial">    [</span><span class="synConstant">168</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> seed-cbc</span>
<span class="synSpecial">    [</span><span class="synConstant">169</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> seed-cfb</span>
<span class="synSpecial">    [</span><span class="synConstant">170</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> seed-ecb</span>
<span class="synSpecial">    [</span><span class="synConstant">171</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> seed-ofb</span>

<span class="synPreProc">)</span>

<span class="synComment">#mcrypt</span>
$ php <span class="synSpecial">-r</span> <span class="synStatement">'</span><span class="synConstant">print_r(mcrypt_list_algorithms());</span><span class="synStatement">'</span>                          
Array
<span class="synPreProc">(</span>
<span class="synSpecial">    [</span><span class="synConstant">0</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> cast</span><span class="synConstant">-128</span>
<span class="synSpecial">    [</span><span class="synConstant">1</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> gost</span>
<span class="synSpecial">    [</span><span class="synConstant">2</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> rijndael</span><span class="synConstant">-128</span>
<span class="synSpecial">    [</span><span class="synConstant">3</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> twofish</span>
<span class="synSpecial">    [</span><span class="synConstant">4</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> arcfour</span>
<span class="synSpecial">    [</span><span class="synConstant">5</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> cast</span><span class="synConstant">-256</span>
<span class="synSpecial">    [</span><span class="synConstant">6</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> loki97</span>
<span class="synSpecial">    [</span><span class="synConstant">7</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> rijndael</span><span class="synConstant">-192</span>
<span class="synSpecial">    [</span><span class="synConstant">8</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> saferplus</span>
<span class="synSpecial">    [</span><span class="synConstant">9</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> wake</span>
<span class="synSpecial">    [</span><span class="synConstant">10</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> blowfish-compat</span>
<span class="synSpecial">    [</span><span class="synConstant">11</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> des</span>
<span class="synSpecial">    [</span><span class="synConstant">12</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> rijndael</span><span class="synConstant">-256</span>
<span class="synSpecial">    [</span><span class="synConstant">13</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> serpent</span>
<span class="synSpecial">    [</span><span class="synConstant">14</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> xtea</span>
<span class="synSpecial">    [</span><span class="synConstant">15</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> blowfish</span>
<span class="synSpecial">    [</span><span class="synConstant">16</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> enigma</span>
<span class="synSpecial">    [</span><span class="synConstant">17</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> rc2</span>
<span class="synSpecial">    [</span><span class="synConstant">18</span><span class="synSpecial">] </span><span class="synStatement">=></span><span class="synSpecial"> tripledes</span>
<span class="synPreProc">)</span>
</pre>
</div>
<div class="section">
<h5>OpenSSLと<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mcrypt">Mcrypt</a>関数のDES,AESの速度比較</h5>
<p>まずはDESの速度比較です。IVを必要としないECBモードで実行します。結果は<span class="deco" style="color:#FF0000;font-weight:bold;">OpenSSLの圧勝でした。<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mcrypt">Mcrypt</a>は遅い！</span>encryptで131倍、decryptで111倍も時間が掛かって今います。今<a class="keyword" href="http://d.hatena.ne.jp/keyword/mcrypt">mcrypt</a>使って頻繁にDES暗号化処理をしている人は乗り換えした方が良いレベルですね。</p>
<pre class="hljs php" data-lang="php" data-unlink><span class="synSpecial"><?php</span>

<span class="synStatement">$</span><span class="synIdentifier">n</span> <span class="synStatement">=</span> <span class="synConstant">1000000</span>;
<span class="synStatement">$</span><span class="synIdentifier">message</span> <span class="synStatement">=</span> '<span class="synConstant">魔法少女まどか☆マギカ</span>';
<span class="synStatement">$</span><span class="synIdentifier">key</span> <span class="synStatement">=</span> '<span class="synConstant">Soul Gem</span>';
<span class="synStatement">$</span><span class="synIdentifier">method</span> <span class="synStatement">=</span> '<span class="synConstant">DES-ECB</span>';

<span class="synComment">//openssl</span>
<span class="synStatement">$</span><span class="synIdentifier">start</span> <span class="synStatement">=</span> <span class="synIdentifier">microtime</span><span class="synSpecial">(</span><span class="synConstant">true</span><span class="synSpecial">)</span>;
<span class="synStatement">for</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">i</span><span class="synStatement">=</span><span class="synConstant">0</span>; <span class="synStatement">$</span><span class="synIdentifier">i</span><span class="synStatement"><$</span><span class="synIdentifier">n</span>; <span class="synStatement">++$</span><span class="synIdentifier">i</span><span class="synSpecial">){</span>
  <span class="synStatement">$</span><span class="synIdentifier">crypto</span> <span class="synStatement">=</span> openssl_encrypt<span class="synSpecial">(</span> <span class="synStatement">$</span><span class="synIdentifier">message</span>, <span class="synStatement">$</span><span class="synIdentifier">method</span>, <span class="synStatement">$</span><span class="synIdentifier">key</span> <span class="synSpecial">)</span>;
<span class="synSpecial">}</span>
<span class="synPreProc">echo</span> "<span class="synConstant">encrypt message = </span><span class="synSpecial">{</span><span class="synStatement">$</span><span class="synIdentifier">crypto</span><span class="synSpecial">}</span><span class="synConstant"> </span><span class="synSpecial">\n</span>";
<span class="synPreProc">echo</span> "<span class="synConstant">openssl </span><span class="synSpecial">{</span><span class="synStatement">$</span><span class="synIdentifier">n</span><span class="synSpecial">}</span><span class="synConstant"> encrypt time = </span>" <span class="synStatement">.</span> <span class="synSpecial">(</span> <span class="synIdentifier">microtime</span><span class="synSpecial">(</span><span class="synConstant">true</span><span class="synSpecial">)</span> <span class="synStatement">-</span> <span class="synStatement">$</span><span class="synIdentifier">start</span> <span class="synSpecial">)</span> <span class="synStatement">.</span> "<span class="synSpecial">\n</span>";

<span class="synStatement">$</span><span class="synIdentifier">start</span> <span class="synStatement">=</span> <span class="synIdentifier">microtime</span><span class="synSpecial">(</span><span class="synConstant">true</span><span class="synSpecial">)</span>;
<span class="synStatement">for</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">i</span><span class="synStatement">=</span><span class="synConstant">0</span>; <span class="synStatement">$</span><span class="synIdentifier">i</span><span class="synStatement"><$</span><span class="synIdentifier">n</span>; <span class="synStatement">++$</span><span class="synIdentifier">i</span><span class="synSpecial">){</span>
  <span class="synStatement">$</span><span class="synIdentifier">message</span> <span class="synStatement">=</span> openssl_decrypt<span class="synSpecial">(</span> <span class="synStatement">$</span><span class="synIdentifier">crypto</span>, <span class="synStatement">$</span><span class="synIdentifier">method</span>, <span class="synStatement">$</span><span class="synIdentifier">key</span> <span class="synSpecial">)</span>;
<span class="synSpecial">}</span>
<span class="synPreProc">echo</span> "<span class="synConstant">decrypt message = </span><span class="synSpecial">{</span><span class="synStatement">$</span><span class="synIdentifier">message</span><span class="synSpecial">}</span><span class="synConstant"> </span><span class="synSpecial">\n</span>";
<span class="synPreProc">echo</span> "<span class="synConstant">openssl </span><span class="synSpecial">{</span><span class="synStatement">$</span><span class="synIdentifier">n</span><span class="synSpecial">}</span><span class="synConstant"> decrypt time = </span>" <span class="synStatement">.</span> <span class="synSpecial">(</span> <span class="synIdentifier">microtime</span><span class="synSpecial">(</span><span class="synConstant">true</span><span class="synSpecial">)</span> <span class="synStatement">-</span> <span class="synStatement">$</span><span class="synIdentifier">start</span> <span class="synSpecial">)</span> <span class="synStatement">.</span> "<span class="synSpecial">\n</span>";

<span class="synComment">//mcrypto</span>
<span class="synStatement">$</span><span class="synIdentifier">start</span> <span class="synStatement">=</span> <span class="synIdentifier">microtime</span><span class="synSpecial">(</span><span class="synConstant">true</span><span class="synSpecial">)</span>;
<span class="synStatement">for</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">i</span><span class="synStatement">=</span><span class="synConstant">0</span>; <span class="synStatement">$</span><span class="synIdentifier">i</span><span class="synStatement"><$</span><span class="synIdentifier">n</span>; <span class="synStatement">++$</span><span class="synIdentifier">i</span><span class="synSpecial">){</span>
  <span class="synStatement">$</span><span class="synIdentifier">crypto</span> <span class="synStatement">=</span> <span class="synIdentifier">base64_encode</span><span class="synSpecial">(</span><span class="synIdentifier">mcrypt_encrypt</span><span class="synSpecial">(</span>MCRYPT_DES, <span class="synStatement">$</span><span class="synIdentifier">key</span>, <span class="synStatement">$</span><span class="synIdentifier">message</span>, MCRYPT_MODE_ECB<span class="synSpecial">))</span>;
<span class="synSpecial">}</span>
<span class="synPreProc">echo</span> "<span class="synConstant">encrypt message = </span><span class="synSpecial">{</span><span class="synStatement">$</span><span class="synIdentifier">crypto</span><span class="synSpecial">}</span><span class="synConstant"> </span><span class="synSpecial">\n</span>";
<span class="synPreProc">echo</span> "<span class="synConstant">mcrypt </span><span class="synSpecial">{</span><span class="synStatement">$</span><span class="synIdentifier">n</span><span class="synSpecial">}</span><span class="synConstant"> encrypt time = </span>" <span class="synStatement">.</span> <span class="synSpecial">(</span> <span class="synIdentifier">microtime</span><span class="synSpecial">(</span><span class="synConstant">true</span><span class="synSpecial">)</span> <span class="synStatement">-</span> <span class="synStatement">$</span><span class="synIdentifier">start</span> <span class="synSpecial">)</span> <span class="synStatement">.</span> "<span class="synSpecial">\n</span>";

<span class="synStatement">$</span><span class="synIdentifier">start</span> <span class="synStatement">=</span> <span class="synIdentifier">microtime</span><span class="synSpecial">(</span><span class="synConstant">true</span><span class="synSpecial">)</span>;
<span class="synStatement">for</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">i</span><span class="synStatement">=</span><span class="synConstant">0</span>; <span class="synStatement">$</span><span class="synIdentifier">i</span><span class="synStatement"><$</span><span class="synIdentifier">n</span>; <span class="synStatement">++$</span><span class="synIdentifier">i</span><span class="synSpecial">){</span>
  <span class="synStatement">$</span><span class="synIdentifier">message</span> <span class="synStatement">=</span> <span class="synIdentifier">mcrypt_decrypt</span><span class="synSpecial">(</span>MCRYPT_DES, <span class="synStatement">$</span><span class="synIdentifier">key</span>, <span class="synIdentifier">base64_decode</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">crypto</span><span class="synSpecial">)</span>, MCRYPT_MODE_ECB<span class="synSpecial">)</span>;
<span class="synSpecial">}</span>

<span class="synPreProc">echo</span> "<span class="synConstant">decrypt message = </span><span class="synSpecial">{</span><span class="synStatement">$</span><span class="synIdentifier">message</span><span class="synSpecial">}</span><span class="synConstant"> </span><span class="synSpecial">\n</span>";
<span class="synPreProc">echo</span> "<span class="synConstant">mcrypt </span><span class="synSpecial">{</span><span class="synStatement">$</span><span class="synIdentifier">n</span><span class="synSpecial">}</span><span class="synConstant"> decrypt time = </span>" <span class="synStatement">.</span> <span class="synSpecial">(</span> <span class="synIdentifier">microtime</span><span class="synSpecial">(</span><span class="synConstant">true</span><span class="synSpecial">)</span> <span class="synStatement">-</span> <span class="synStatement">$</span><span class="synIdentifier">start</span> <span class="synSpecial">)</span> <span class="synStatement">.</span> "<span class="synSpecial">\n</span>";
</pre><pre class="hljs sh" data-lang="sh" data-unlink>$ php des.php
encrypt message <span class="synStatement">=</span> s3TrEokf/<span class="synIdentifier">1xTgoHIimEtUi8s5hNgultndusqMud+XGa0KXi6EbHF4w</span>=<span class="synStatement">=</span> 
openssl <span class="synConstant">1000000</span> encrypt <span class="synStatement">time</span> <span class="synStatement">=</span> 1.7591309547424
decrypt message <span class="synStatement">=</span> 魔法少女まどか☆マギカ 
openssl <span class="synConstant">1000000</span> decrypt <span class="synStatement">time</span> <span class="synStatement">=</span> 1.9514858722687
encrypt message <span class="synStatement">=</span> s3TrEokf/<span class="synIdentifier">1xTgoHIimEtUi8s5hNgultndusqMud+XGZW+smvwY2mXw</span>=<span class="synStatement">=</span> 
mcrypt <span class="synConstant">1000000</span> encrypt <span class="synStatement">time</span> <span class="synStatement">=</span> 231.36626815796
decrypt message <span class="synStatement">=</span> 魔法少女まどか☆マギカ 
mcrypt <span class="synConstant">1000000</span> decrypt <span class="synStatement">time</span> <span class="synStatement">=</span> 218.42488908768
</pre><p>次にAES-128-ECBで比較します。<span class="deco" style="color:#FF0000;font-weight:bold;">結果はDES同様にOpenSSLの圧勝でした。</span>encryptで79倍、decryptで57倍速度に差が出ています。<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mcrypt">Mcrypt</a>は何故そんなにも重いんでしょうか...前職でめっちゃ<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mcrypt">Mcrypt</a>に頼っていたコードを今から書き換えたい...</p>
<pre class="hljs php" data-lang="php" data-unlink><span class="synSpecial"><?php</span>

<span class="synStatement">$</span><span class="synIdentifier">n</span> <span class="synStatement">=</span> <span class="synConstant">1000000</span>;
<span class="synStatement">$</span><span class="synIdentifier">message</span> <span class="synStatement">=</span> '<span class="synConstant">魔法少女まどか☆マギカ</span>';
<span class="synStatement">$</span><span class="synIdentifier">key</span> <span class="synStatement">=</span> '<span class="synConstant">Soul GemSoul Gem</span>';
<span class="synStatement">$</span><span class="synIdentifier">method</span> <span class="synStatement">=</span> '<span class="synConstant">AES-128-ECB</span>';

<span class="synComment">//openssl</span>
<span class="synStatement">$</span><span class="synIdentifier">start</span> <span class="synStatement">=</span> <span class="synIdentifier">microtime</span><span class="synSpecial">(</span><span class="synConstant">true</span><span class="synSpecial">)</span>;
<span class="synStatement">for</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">i</span><span class="synStatement">=</span><span class="synConstant">0</span>; <span class="synStatement">$</span><span class="synIdentifier">i</span><span class="synStatement"><$</span><span class="synIdentifier">n</span>; <span class="synStatement">++$</span><span class="synIdentifier">i</span><span class="synSpecial">){</span>
  <span class="synStatement">$</span><span class="synIdentifier">crypto</span> <span class="synStatement">=</span> openssl_encrypt<span class="synSpecial">(</span> <span class="synStatement">$</span><span class="synIdentifier">message</span>, <span class="synStatement">$</span><span class="synIdentifier">method</span>, <span class="synStatement">$</span><span class="synIdentifier">key</span> <span class="synSpecial">)</span>;
<span class="synSpecial">}</span>
<span class="synPreProc">echo</span> "<span class="synConstant">encrypt message = </span><span class="synSpecial">{</span><span class="synStatement">$</span><span class="synIdentifier">crypto</span><span class="synSpecial">}</span><span class="synConstant"> </span><span class="synSpecial">\n</span>";
<span class="synPreProc">echo</span> "<span class="synConstant">openssl </span><span class="synSpecial">{</span><span class="synStatement">$</span><span class="synIdentifier">n</span><span class="synSpecial">}</span><span class="synConstant"> encrypt time = </span>" <span class="synStatement">.</span> <span class="synSpecial">(</span> <span class="synIdentifier">microtime</span><span class="synSpecial">(</span><span class="synConstant">true</span><span class="synSpecial">)</span> <span class="synStatement">-</span> <span class="synStatement">$</span><span class="synIdentifier">start</span> <span class="synSpecial">)</span> <span class="synStatement">.</span> "<span class="synSpecial">\n</span>";

<span class="synStatement">$</span><span class="synIdentifier">start</span> <span class="synStatement">=</span> <span class="synIdentifier">microtime</span><span class="synSpecial">(</span><span class="synConstant">true</span><span class="synSpecial">)</span>;
<span class="synStatement">for</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">i</span><span class="synStatement">=</span><span class="synConstant">0</span>; <span class="synStatement">$</span><span class="synIdentifier">i</span><span class="synStatement"><$</span><span class="synIdentifier">n</span>; <span class="synStatement">++$</span><span class="synIdentifier">i</span><span class="synSpecial">){</span>
  <span class="synStatement">$</span><span class="synIdentifier">message</span> <span class="synStatement">=</span> openssl_decrypt<span class="synSpecial">(</span> <span class="synStatement">$</span><span class="synIdentifier">crypto</span>, <span class="synStatement">$</span><span class="synIdentifier">method</span>, <span class="synStatement">$</span><span class="synIdentifier">key</span> <span class="synSpecial">)</span>;
<span class="synSpecial">}</span>
<span class="synPreProc">echo</span> "<span class="synConstant">decrypt message = </span><span class="synSpecial">{</span><span class="synStatement">$</span><span class="synIdentifier">message</span><span class="synSpecial">}</span><span class="synConstant"> </span><span class="synSpecial">\n</span>";
<span class="synPreProc">echo</span> "<span class="synConstant">openssl </span><span class="synSpecial">{</span><span class="synStatement">$</span><span class="synIdentifier">n</span><span class="synSpecial">}</span><span class="synConstant"> decrypt time = </span>" <span class="synStatement">.</span> <span class="synSpecial">(</span> <span class="synIdentifier">microtime</span><span class="synSpecial">(</span><span class="synConstant">true</span><span class="synSpecial">)</span> <span class="synStatement">-</span> <span class="synStatement">$</span><span class="synIdentifier">start</span> <span class="synSpecial">)</span> <span class="synStatement">.</span> "<span class="synSpecial">\n</span>";

<span class="synComment">//mcrypto</span>
<span class="synStatement">$</span><span class="synIdentifier">start</span> <span class="synStatement">=</span> <span class="synIdentifier">microtime</span><span class="synSpecial">(</span><span class="synConstant">true</span><span class="synSpecial">)</span>;
<span class="synStatement">for</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">i</span><span class="synStatement">=</span><span class="synConstant">0</span>; <span class="synStatement">$</span><span class="synIdentifier">i</span><span class="synStatement"><$</span><span class="synIdentifier">n</span>; <span class="synStatement">++$</span><span class="synIdentifier">i</span><span class="synSpecial">){</span>
  <span class="synStatement">$</span><span class="synIdentifier">crypto</span> <span class="synStatement">=</span> <span class="synIdentifier">base64_encode</span><span class="synSpecial">(</span><span class="synIdentifier">mcrypt_encrypt</span><span class="synSpecial">(</span>MCRYPT_RIJNDAEL_128, <span class="synStatement">$</span><span class="synIdentifier">key</span>, <span class="synStatement">$</span><span class="synIdentifier">message</span>, MCRYPT_MODE_ECB<span class="synSpecial">))</span>;
<span class="synSpecial">}</span>
<span class="synPreProc">echo</span> "<span class="synConstant">encrypt message = </span><span class="synSpecial">{</span><span class="synStatement">$</span><span class="synIdentifier">crypto</span><span class="synSpecial">}</span><span class="synConstant"> </span><span class="synSpecial">\n</span>";
<span class="synPreProc">echo</span> "<span class="synConstant">mcrypt </span><span class="synSpecial">{</span><span class="synStatement">$</span><span class="synIdentifier">n</span><span class="synSpecial">}</span><span class="synConstant"> encrypt time = </span>" <span class="synStatement">.</span> <span class="synSpecial">(</span> <span class="synIdentifier">microtime</span><span class="synSpecial">(</span><span class="synConstant">true</span><span class="synSpecial">)</span> <span class="synStatement">-</span> <span class="synStatement">$</span><span class="synIdentifier">start</span> <span class="synSpecial">)</span> <span class="synStatement">.</span> "<span class="synSpecial">\n</span>";

<span class="synStatement">$</span><span class="synIdentifier">start</span> <span class="synStatement">=</span> <span class="synIdentifier">microtime</span><span class="synSpecial">(</span><span class="synConstant">true</span><span class="synSpecial">)</span>;
<span class="synStatement">for</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">i</span><span class="synStatement">=</span><span class="synConstant">0</span>; <span class="synStatement">$</span><span class="synIdentifier">i</span><span class="synStatement"><$</span><span class="synIdentifier">n</span>; <span class="synStatement">++$</span><span class="synIdentifier">i</span><span class="synSpecial">){</span>
  <span class="synStatement">$</span><span class="synIdentifier">message</span> <span class="synStatement">=</span> <span class="synIdentifier">mcrypt_decrypt</span><span class="synSpecial">(</span>MCRYPT_RIJNDAEL_128, <span class="synStatement">$</span><span class="synIdentifier">key</span>, <span class="synIdentifier">base64_decode</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">crypto</span><span class="synSpecial">)</span>, MCRYPT_MODE_ECB<span class="synSpecial">)</span>;
<span class="synSpecial">}</span>
<span class="synPreProc">echo</span> "<span class="synConstant">decrypt message = </span><span class="synSpecial">{</span><span class="synStatement">$</span><span class="synIdentifier">message</span><span class="synSpecial">}</span><span class="synConstant"> </span><span class="synSpecial">\n</span>";
<span class="synPreProc">echo</span> "<span class="synConstant">mcrypt </span><span class="synSpecial">{</span><span class="synStatement">$</span><span class="synIdentifier">n</span><span class="synSpecial">}</span><span class="synConstant"> decrypt time = </span>" <span class="synStatement">.</span> <span class="synSpecial">(</span> <span class="synIdentifier">microtime</span><span class="synSpecial">(</span><span class="synConstant">true</span><span class="synSpecial">)</span> <span class="synStatement">-</span> <span class="synStatement">$</span><span class="synIdentifier">start</span> <span class="synSpecial">)</span> <span class="synStatement">.</span> "<span class="synSpecial">\n</span>";
</pre><pre class="hljs sh" data-lang="sh" data-unlink>$ php aes.php 
encrypt message <span class="synStatement">=</span> jkSF8YDL4Bi/JDC6z/5aoosGSBRqcEeRri2ZH5Qs+PMb+HceqdCgV5iMH/DziDzB 
openssl <span class="synConstant">1000000</span> encrypt <span class="synStatement">time</span> <span class="synStatement">=</span> 1.1707689762115
decrypt message <span class="synStatement">=</span> 魔法少女まどか☆マギカ 
openssl <span class="synConstant">1000000</span> decrypt <span class="synStatement">time</span> <span class="synStatement">=</span> 1.5138459205627
encrypt message <span class="synStatement">=</span> jkSF8YDL4Bi/JDC6z/5aoosGSBRqcEeRri2ZH5Qs+PPPZdMXB4Zn5TSdDI1WVm86 
mcrypt <span class="synConstant">1000000</span> encrypt <span class="synStatement">time</span> <span class="synStatement">=</span> 93.164091825485
decrypt message <span class="synStatement">=</span> 魔法少女まどか☆マギカ 
mcrypt <span class="synConstant">1000000</span> decrypt <span class="synStatement">time</span> <span class="synStatement">=</span> 86.352274894714
</pre>
</div>
<div class="section">
<h5><a class="keyword" href="http://d.hatena.ne.jp/keyword/mcrypt">mcrypt</a>のゼロpaddingの癖</h5>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/mcrypt">mcrypt</a>関数は処理速度が遅いだけではなく、暗号化をする際に文字列を固定ブロック長に分割するのですが、<span class="deco" style="color:#FF0000;font-weight:bold;">分割後に足りないByte数を埋め合せるPadding処理をNULLで行うという癖</span>があります。上の例も実はopensslと<a class="keyword" href="http://d.hatena.ne.jp/keyword/mcrypt">mcrypt</a>で生成された暗号化文に差異が発生しています。暗号化には通常は<a class="keyword" href="http://d.hatena.ne.jp/keyword/pkcs">pkcs</a>#5というPaddingが使われる事が多いです。<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/mcrypt">mcrypt</a>で暗号化、復号化を他言語で行おうとするとこのPaddingの違いによりエラーが出る場合があるので注意が必要です。通常は<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/mcrypt">mcrypt</a>に自前でpkcs5_pad、pkcs5_unpadの関数を用意してencrypt前にブロック長に対して不足している長さを特定の文字で埋めるpaddingを先に行います。以下はそのサンプルです。この実行でopensslとmcyrptで暗号化文の差異が発生しなくなります。</p>
<pre class="hljs php" data-lang="php" data-unlink><span class="synSpecial"><?php</span>

<span class="synPreProc">function</span> pkcs5_pad<span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">text</span>, <span class="synStatement">$</span><span class="synIdentifier">blocksize</span><span class="synSpecial">)</span> <span class="synSpecial">{</span> 
<span class="synStatement">$</span><span class="synIdentifier">pad</span> <span class="synStatement">=</span> <span class="synStatement">$</span><span class="synIdentifier">blocksize</span> <span class="synStatement">-</span> <span class="synSpecial">(</span><span class="synIdentifier">strlen</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">text</span><span class="synSpecial">)</span> <span class="synStatement">%</span> <span class="synStatement">$</span><span class="synIdentifier">blocksize</span><span class="synSpecial">)</span>; 
<span class="synStatement">return</span> <span class="synStatement">$</span><span class="synIdentifier">text</span> <span class="synStatement">.</span> <span class="synIdentifier">str_repeat</span><span class="synSpecial">(</span><span class="synIdentifier">chr</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">pad</span><span class="synSpecial">)</span>, <span class="synStatement">$</span><span class="synIdentifier">pad</span><span class="synSpecial">)</span>; 
<span class="synSpecial">}</span>
<span class="synPreProc">function</span> pkcs5_unpad<span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">text</span><span class="synSpecial">)</span> <span class="synSpecial">{</span> 
<span class="synStatement">$</span><span class="synIdentifier">pad</span> <span class="synStatement">=</span> <span class="synIdentifier">ord</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">text</span><span class="synSpecial">{</span><span class="synIdentifier">strlen</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">text</span><span class="synSpecial">)</span><span class="synConstant">-1</span><span class="synSpecial">})</span>; 
<span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">pad</span> <span class="synStatement">></span> <span class="synIdentifier">strlen</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">text</span><span class="synSpecial">))</span> <span class="synStatement">return</span> <span class="synConstant">false</span>; 
<span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synIdentifier">strspn</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">text</span>, <span class="synIdentifier">chr</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">pad</span><span class="synSpecial">)</span>, <span class="synIdentifier">strlen</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">text</span><span class="synSpecial">)</span> <span class="synStatement">-</span> <span class="synStatement">$</span><span class="synIdentifier">pad</span><span class="synSpecial">)</span> <span class="synStatement">!=</span> <span class="synStatement">$</span><span class="synIdentifier">pad</span><span class="synSpecial">)</span> <span class="synStatement">return</span> <span class="synConstant">false</span>; 
<span class="synStatement">return</span> <span class="synIdentifier">substr</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">text</span>, <span class="synConstant">0</span>, <span class="synConstant">-1</span> <span class="synStatement">*</span> <span class="synStatement">$</span><span class="synIdentifier">pad</span><span class="synSpecial">)</span>; 
<span class="synSpecial">}</span>  

<span class="synStatement">$</span><span class="synIdentifier">message</span> <span class="synStatement">=</span> '<span class="synConstant">魔法少女まどか☆マギカ</span>';
<span class="synStatement">$</span><span class="synIdentifier">key</span> <span class="synStatement">=</span> '<span class="synConstant">Soul Gem</span>';

<span class="synStatement">$</span><span class="synIdentifier">encrypt</span> <span class="synStatement">=</span> <span class="synIdentifier">base64_encode</span><span class="synSpecial">(</span><span class="synIdentifier">mcrypt_encrypt</span><span class="synSpecial">(</span>MCRYPT_DES, <span class="synStatement">$</span><span class="synIdentifier">key</span>, pkcs5_pad<span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">message</span>, <span class="synIdentifier">mcrypt_get_block_size</span><span class="synSpecial">(</span>MCRYPT_DES, '<span class="synConstant">ecb</span>'<span class="synSpecial">))</span>, MCRYPT_MODE_ECB<span class="synSpecial">))</span>;
<span class="synPreProc">echo</span> "<span class="synConstant">encrypt message = </span><span class="synSpecial">{</span><span class="synStatement">$</span><span class="synIdentifier">encrypt</span><span class="synSpecial">}</span><span class="synConstant"> </span><span class="synSpecial">\n</span>";
<span class="synStatement">$</span><span class="synIdentifier">message</span> <span class="synStatement">=</span> pkcs5_unpad<span class="synSpecial">(</span><span class="synIdentifier">mcrypt_decrypt</span><span class="synSpecial">(</span>MCRYPT_DES, <span class="synStatement">$</span><span class="synIdentifier">key</span>, <span class="synIdentifier">base64_decode</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">encrypt</span><span class="synSpecial">)</span>, MCRYPT_MODE_ECB<span class="synSpecial">))</span>;
<span class="synPreProc">echo</span> "<span class="synConstant">decrypt message = </span><span class="synSpecial">{</span><span class="synStatement">$</span><span class="synIdentifier">message</span><span class="synSpecial">}</span><span class="synConstant"> </span><span class="synSpecial">\n</span>";
</pre><pre class="hljs sh" data-lang="sh" data-unlink>$ php mcrypt_des.php 
encrypt message <span class="synStatement">=</span> s3TrEokf/<span class="synIdentifier">1xTgoHIimEtUi8s5hNgultndusqMud+XGa0KXi6EbHF4w</span>=<span class="synStatement">=</span> 
decrypt message <span class="synStatement">=</span> 魔法少女まどか☆マギカ
</pre>
</div>
</blockquote>

</div>
<div class="section">
<h4>C</h4>

<blockquote>
    
<div class="section">
<h5>DES,AES暗号</h5>
<p>OpenSSLの暗号化をCで実装した日本語ドキュメントがあまりにも少ないので<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a>を残す事を目的として書きます。opensslのevp.hとbio.hを使って暗号化/復号化/<a class="keyword" href="http://d.hatena.ne.jp/keyword/Base64">Base64</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%F3%A5%B3%A1%BC%A5%C9">エンコード</a>処理を行います。具体的な処理はint main関数の中に記載していますが、EVP_CIPHER_CTX_init:初期化、EVP_EncryptInit_ex:暗号化<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>とkey指定、EVP_EncryptUpdate:暗号化、EVP_EncryptFinal_ex:ブロック長を超えたデータの調整、EVP_CIPHER_CTX_cleanup:お掃除のような処理になります。Decryptはその逆になります。他言語よりコード量が多いですが、まぁCなのでそこはしようがないです。<br />
<a class="keyword" href="http://d.hatena.ne.jp/keyword/CBC">CBC</a>モードでもIVが必要とされるぐらいで他の処理は基本的にECB暗号と同じ処理になります。下のコードでは復号時にIVが分かっている事を前提に記載していますが、一般的な利用の場合は別途IVの共有が必要になります。IVをRAND_bytes関数にてblocksizeと同じ長さのランダム文字列を生成しています。RAND_bytes関数を利用するにはopenssl/rand.hをincludeします。<a class="keyword" href="http://d.hatena.ne.jp/keyword/base64">base64</a>系の処理は上と同じなので省略します。<br />
<span class="deco" style="font-weight:bold;color:#FF0000;">※現在原因を調査中ですがBIOを使った<a class="keyword" href="http://d.hatena.ne.jp/keyword/base64">base64</a>_encode,<a class="keyword" href="http://d.hatena.ne.jp/keyword/base64">base64</a>_decodeのコストがとてつもなく大きいので、下のサンプルは注意して使ってください。</span></p>
<pre class="hljs c" data-lang="c" data-unlink><span class="synPreProc">#include </span><span class="synConstant"><string.h></span>
<span class="synPreProc">#include </span><span class="synConstant"><stdio.h></span>
<span class="synPreProc">#include </span><span class="synConstant"><stdlib.h></span>
<span class="synPreProc">#include </span><span class="synConstant"><math.h></span>
<span class="synPreProc">#include </span><span class="synConstant"><openssl/evp.h></span>
<span class="synPreProc">#include </span><span class="synConstant"><openssl/bio.h></span>
<span class="synPreProc">#include </span><span class="synConstant"><openssl/rand.h></span>
<span class="synPreProc">#define ITERATION </span><span class="synConstant">1000000</span>

<span class="synType">int</span> base64_encode(<span class="synType">const</span> <span class="synType">char</span> *message, <span class="synType">char</span> **buffer) {
BIO *bio, *b64;
<span class="synType">FILE</span>* stream;
<span class="synType">int</span> encodedSize = <span class="synConstant">4</span>*ceil((<span class="synType">double</span>)strlen(message)/<span class="synConstant">3</span>);
*buffer = (<span class="synType">char</span> *)malloc(encodedSize+<span class="synConstant">1</span>);
stream = fmemopen(*buffer, encodedSize+<span class="synConstant">1</span>, <span class="synConstant">"w"</span>);
b64 = BIO_new(BIO_f_base64());
bio = BIO_new_fp(stream, BIO_NOCLOSE);
bio = BIO_push(b64, bio);
BIO_set_flags(bio, BIO_FLAGS_BASE64_NO_NL);
BIO_write(bio, message, strlen(message));
BIO_flush(bio);
BIO_free_all(bio);
fclose(stream);
<span class="synStatement">return</span> <span class="synConstant">0</span>;
}

<span class="synType">int</span> calc_decode_length(<span class="synType">const</span> <span class="synType">char</span> *b64input) {
<span class="synType">int</span> len = strlen(b64input);
<span class="synType">int</span> padding = <span class="synConstant">0</span>;
<span class="synStatement">if</span> (b64input[len-<span class="synConstant">1</span>] == <span class="synConstant">'='</span> && b64input[len-<span class="synConstant">2</span>] == <span class="synConstant">'='</span>) {
    padding = <span class="synConstant">2</span>;
} <span class="synStatement">else</span> <span class="synStatement">if</span> (b64input[len-<span class="synConstant">1</span>] == <span class="synConstant">'='</span>) { 
    padding = <span class="synConstant">1</span>;
}
<span class="synStatement">return</span> (<span class="synType">int</span>)len*<span class="synConstant">0.75</span> - padding;
}

<span class="synType">int</span> base64_decode(<span class="synType">char</span> *b64message, <span class="synType">char</span> **buffer) {
BIO *bio, *b64;
<span class="synType">int</span> decodeLen = calc_decode_length(b64message),len = <span class="synConstant">0</span>;
*buffer = (<span class="synType">char</span>*)malloc(decodeLen+<span class="synConstant">1</span>);
<span class="synType">FILE</span>* stream = fmemopen(b64message, strlen(b64message), <span class="synConstant">"r"</span>);
b64 = BIO_new(BIO_f_base64());
bio = BIO_new_fp(stream, BIO_NOCLOSE);
bio = BIO_push(b64, bio);
BIO_set_flags(bio, BIO_FLAGS_BASE64_NO_NL);
len = BIO_read(bio, *buffer, strlen(b64message));
(*buffer)[len] = <span class="synSpecial">'\0'</span>;
BIO_free_all(bio);
fclose(stream);
<span class="synStatement">return</span> <span class="synConstant">0</span>;
}

<span class="synType">int</span> create_iv(<span class="synType">unsigned</span> <span class="synType">char</span> **iv, <span class="synType">size_t</span> blocksize) {
*iv = calloc(blocksize+<span class="synConstant">1</span>, <span class="synStatement">sizeof</span>(<span class="synType">char</span>));
RAND_bytes(*iv, blocksize);
}

<span class="synType">int</span> openssl_encrypt(EVP_CIPHER_CTX *ctx, <span class="synType">const</span> EVP_CIPHER *method, <span class="synType">unsigned</span> <span class="synType">char</span> *key, <span class="synType">unsigned</span> <span class="synType">char</span> *iv, <span class="synType">const</span> <span class="synType">char</span> *message, <span class="synType">unsigned</span> <span class="synType">char</span> **cipher, <span class="synType">unsigned</span> <span class="synType">int</span> cipher_len) {
<span class="synType">unsigned</span> <span class="synType">int</span> out_len=<span class="synConstant">0</span>;
EVP_CIPHER_CTX_init(ctx);
EVP_EncryptInit_ex(ctx,method,<span class="synConstant">NULL</span>,(<span class="synType">unsigned</span> <span class="synType">char</span> *)key, iv);
EVP_EncryptUpdate(ctx,(<span class="synType">unsigned</span> <span class="synType">char</span> *)*cipher,&cipher_len,(<span class="synType">unsigned</span> <span class="synType">char</span> *)message,strlen(message));
EVP_EncryptFinal_ex(ctx,(<span class="synType">unsigned</span> <span class="synType">char</span> *)(*cipher+cipher_len),&out_len);
EVP_CIPHER_CTX_cleanup(ctx);
<span class="synStatement">return</span> <span class="synConstant">0</span>;
}

<span class="synType">int</span> openssl_decrypt(EVP_CIPHER_CTX *ctx, <span class="synType">const</span> EVP_CIPHER *method, <span class="synType">unsigned</span> <span class="synType">char</span> *key, <span class="synType">unsigned</span> <span class="synType">char</span> *iv, <span class="synType">char</span> *dectext, <span class="synType">unsigned</span> <span class="synType">char</span> **plain, <span class="synType">unsigned</span> <span class="synType">int</span> plain_len) {
<span class="synType">unsigned</span> <span class="synType">int</span> out_len=<span class="synConstant">0</span>;
EVP_CIPHER_CTX_init(ctx);
EVP_DecryptInit_ex(ctx,method,<span class="synConstant">NULL</span>,(<span class="synType">unsigned</span> <span class="synType">char</span> *)key,iv);
EVP_DecryptUpdate(ctx,(<span class="synType">unsigned</span> <span class="synType">char</span> *)*plain,&plain_len,(<span class="synType">unsigned</span> <span class="synType">char</span> *)dectext,strlen(dectext));
EVP_DecryptFinal_ex(ctx,(<span class="synType">unsigned</span> <span class="synType">char</span> *)(*plain+plain_len),&out_len);
EVP_CIPHER_CTX_cleanup(ctx);
<span class="synStatement">return</span> <span class="synConstant">0</span>;
}

<span class="synType">int</span> main(<span class="synType">int</span> argc,<span class="synType">char</span> *argv[]){

EVP_CIPHER_CTX ctx;
<span class="synType">unsigned</span> <span class="synType">char</span> *iv, *cipher, *plain, *key=<span class="synConstant">"Soul Gem"</span>, *message=<span class="synConstant">"魔法少女まどか☆マギカ"</span>;
<span class="synType">unsigned</span> <span class="synType">int</span> blocksize = <span class="synConstant">8</span>, cipher_len, plain_len, i;
<span class="synType">char</span> *enctext, *dectext;

<span class="synComment">//dec-ecb-encrypt</span>
cipher_len=strlen(message)+EVP_MAX_BLOCK_LENGTH;
cipher=(<span class="synType">unsigned</span> <span class="synType">char</span> *)calloc(cipher_len,<span class="synStatement">sizeof</span>(<span class="synType">char</span>));
openssl_encrypt(&ctx, EVP_des_ecb(), key, <span class="synConstant">NULL</span>, message, &cipher, cipher_len);
base64_encode( (<span class="synType">const</span> <span class="synType">char</span> *)cipher, &enctext ); 
printf( <span class="synConstant">"dec-ecb-encrypt message = </span><span class="synSpecial">%s\n</span><span class="synConstant">"</span>, enctext );
free(cipher);

<span class="synComment">//des-ecb-decrypt</span>
base64_decode(enctext, &dectext);
plain_len=strlen(dectext)+EVP_MAX_BLOCK_LENGTH;
plain=(<span class="synType">unsigned</span> <span class="synType">char</span> *)calloc(plain_len,<span class="synStatement">sizeof</span>(<span class="synType">char</span>));
openssl_decrypt(&ctx, EVP_des_ecb(), key, <span class="synConstant">NULL</span>, dectext, &plain, plain_len); 
printf( <span class="synConstant">"dec-ecb-decrypt message = </span><span class="synSpecial">%s\n</span><span class="synConstant">"</span>, plain );
free(plain);

<span class="synComment">//iv生成</span>
create_iv(&iv, blocksize);

<span class="synComment">//des-cbc-encrypt</span>
cipher_len=strlen(message)+EVP_MAX_BLOCK_LENGTH;
cipher=(<span class="synType">unsigned</span> <span class="synType">char</span> *)calloc(cipher_len,<span class="synStatement">sizeof</span>(<span class="synType">char</span>));
openssl_encrypt(&ctx, EVP_des_cbc(), key, iv, message, &cipher, cipher_len);
base64_encode( (<span class="synType">const</span> <span class="synType">char</span> *)cipher, &enctext ); 
printf( <span class="synConstant">"dec-cbc-encrypt message = </span><span class="synSpecial">%s\n</span><span class="synConstant">"</span>, enctext );
free(cipher);
cipher = <span class="synSpecial">'\0'</span>;

<span class="synComment">//dec-cbc-decrypt</span>
base64_decode(enctext, &dectext);
plain_len=strlen(dectext)+EVP_MAX_BLOCK_LENGTH;
plain=(<span class="synType">unsigned</span> <span class="synType">char</span> *)calloc(plain_len,<span class="synStatement">sizeof</span>(<span class="synType">char</span>));
openssl_decrypt(&ctx, EVP_des_cbc(), key, iv, dectext, &plain, plain_len); 
printf( <span class="synConstant">"dec-cbc-decrypt message = </span><span class="synSpecial">%s\n</span><span class="synConstant">"</span>, plain );
free(plain);
free(iv);
<span class="synStatement">return</span> <span class="synConstant">0</span>;
}
</pre><pre class="hljs sh" data-lang="sh" data-unlink>$ gcc <span class="synSpecial">-lm</span> <span class="synSpecial">-I</span>/usr/include/openssl <span class="synSpecial">-L</span>/usr/lib64 <span class="synSpecial">-lcrypto</span> openssl_des.c <span class="synSpecial">-o</span> openssl_des
$ ./openssl_des
dec-ecb-encrypt message <span class="synStatement">=</span> s3TrEokf/<span class="synIdentifier">1xTgoHIimEtUi8s5hNgultndusqMud+XGa0KXi6EbHF4w</span>=<span class="synStatement">=</span>
dec-ecb-decrypt message <span class="synStatement">=</span> 魔法少女まどか☆マギカ
dec-cbc-encrypt message <span class="synStatement">=</span> <span class="synIdentifier">C7ZA6Br7+b6Bv33cOkUSbpJA6SDtVOygKAQNzPDn0OSWzgZnnwzYYQ</span>=<span class="synStatement">=</span>
dec-cbc-decrypt message <span class="synStatement">=</span> 魔法少女まどか☆マギカ
</pre>
</div>
<div class="section">
<h5>AES暗号</h5>
<p>基本的に上のDESコードと同じになります。DESからの変更は暗号化<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>名と、必要なkey長に応じたByte数を確保します。ここではAES-ECBの128bitモード(16Byte)の例を書きます。256bitモード(32Byte)の場合も<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>名の数値とblocksizeを書き換えるぐらいで対応できます。main関数以外の処理は上と同じなので省略します。</p>
<pre class="hljs c" data-lang="c" data-unlink><span class="synType">int</span> main(<span class="synType">int</span> argc,<span class="synType">char</span> *argv[]){

EVP_CIPHER_CTX ctx;
<span class="synType">unsigned</span> <span class="synType">char</span> *iv, *cipher, *plain, *key=<span class="synConstant">"Soul GemSoul Gem"</span>, *message=<span class="synConstant">"魔法少女まどか☆マギカ"</span>;
<span class="synType">unsigned</span> <span class="synType">int</span> blocksize = <span class="synConstant">16</span>, cipher_len, plain_len, i;
<span class="synType">char</span> *enctext, *dectext;

<span class="synComment">//aes-ecb-encrypt</span>
cipher_len=strlen(message)+EVP_MAX_BLOCK_LENGTH;
cipher=(<span class="synType">unsigned</span> <span class="synType">char</span> *)calloc(cipher_len,<span class="synStatement">sizeof</span>(<span class="synType">char</span>));
openssl_encrypt(&ctx, EVP_aes_128_ecb(), key, <span class="synConstant">NULL</span>, message, &cipher, cipher_len);
base64_encode( (<span class="synType">const</span> <span class="synType">char</span> *)cipher, &enctext ); 
printf( <span class="synConstant">"aes-ecb-encrypt message = </span><span class="synSpecial">%s\n</span><span class="synConstant">"</span>, enctext );
free(cipher);

<span class="synComment">//aes-ecb-decrypt</span>
base64_decode(enctext, &dectext);
plain_len=strlen(dectext)+EVP_MAX_BLOCK_LENGTH;
plain=(<span class="synType">unsigned</span> <span class="synType">char</span> *)calloc(plain_len,<span class="synStatement">sizeof</span>(<span class="synType">char</span>));
openssl_decrypt(&ctx, EVP_aes_128_ecb(), key, <span class="synConstant">NULL</span>, dectext, &plain, plain_len); 
printf( <span class="synConstant">"aes-ecb-decrypt message = </span><span class="synSpecial">%s\n</span><span class="synConstant">"</span>, plain );
free(plain);

<span class="synComment">//iv生成</span>
create_iv(&iv, blocksize);

<span class="synComment">//aes-ecb-encrypt</span>
cipher_len=strlen(message)+EVP_MAX_BLOCK_LENGTH;
cipher=(<span class="synType">unsigned</span> <span class="synType">char</span> *)calloc(cipher_len,<span class="synStatement">sizeof</span>(<span class="synType">char</span>));
openssl_encrypt(&ctx, EVP_aes_128_cbc(), key, iv, message, &cipher, cipher_len);
base64_encode( (<span class="synType">const</span> <span class="synType">char</span> *)cipher, &enctext ); 
printf( <span class="synConstant">"aes-cbc-encrypt message = </span><span class="synSpecial">%s\n</span><span class="synConstant">"</span>, enctext );
free(cipher);

<span class="synComment">//aes-ecb-decrypt</span>
base64_decode(enctext, &dectext);
plain_len=strlen(dectext)+EVP_MAX_BLOCK_LENGTH;
plain=(<span class="synType">unsigned</span> <span class="synType">char</span> *)calloc(plain_len,<span class="synStatement">sizeof</span>(<span class="synType">char</span>));
openssl_decrypt(&ctx, EVP_aes_128_cbc(), key, iv, dectext, &plain, plain_len); 
printf( <span class="synConstant">"aes-cbc-decrypt message = </span><span class="synSpecial">%s\n</span><span class="synConstant">"</span>, plain );
free(plain);

<span class="synComment">//free</span>
free(iv);
<span class="synStatement">return</span> <span class="synConstant">0</span>;
}
</pre><pre class="hljs sh" data-lang="sh" data-unlink>$ gcc <span class="synSpecial">-lm</span> <span class="synSpecial">-I</span>/usr/include/openssl <span class="synSpecial">-L</span>/usr/lib64 <span class="synSpecial">-lcrypto</span> openssl_aes.c <span class="synSpecial">-o</span> openssl_aes
$ ./openssl_aes
aes-ecb-encrypt message <span class="synStatement">=</span> jkSF8YDL4Bi/JDC6z/5aoosGSBRqcEeRri2ZH5Qs+PMb+HceqdCgV5iMH/DziDzB
aes-ecb-decrypt message <span class="synStatement">=</span> 魔法少女まどか☆マギカ
aes-cbc-encrypt message <span class="synStatement">=</span> ruD0dtX9DBV3Agy+WMLRg5kpHxQJiLFEmxxKXyG26YC60xuTIqBPf7ta41oSUccc
aes-cbc-decrypt message <span class="synStatement">=</span> 魔法少女まどか☆マギカ
</pre>
</div>
<div class="section">
<h5>OpenSSLと<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mcrypt">Mcrypt</a>のDES,AESの速度比較</h5>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>同様にCでも<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mcrypt">Mcrypt</a>を使って暗号化をする事ができます。<a class="keyword" href="http://d.hatena.ne.jp/keyword/mcrypt">mcrypt</a>関数の方がopensslよりも直感的に使い易く少ないコード量で実現できますが、例のごとくPaddingがイケてないので下ではPaddingをpkcs5にするようコードを加えています。速度の評価ですがDES-ECBの暗号化で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mcrypt">Mcrypt</a>の方が185倍、復号化で157倍、AES-ECBの暗号化で101倍、復号化で86倍も遅い事が分かりました。</p>
<pre class="hljs c" data-lang="c" data-unlink><span class="synPreProc">#include </span><span class="synConstant"><string.h></span>
<span class="synPreProc">#include </span><span class="synConstant"><stdio.h></span>
<span class="synPreProc">#include </span><span class="synConstant"><stdlib.h></span>
<span class="synPreProc">#include </span><span class="synConstant"><math.h></span>
<span class="synPreProc">#include </span><span class="synConstant"><mcrypt.h></span>
<span class="synPreProc">#include </span><span class="synConstant"><time.h></span>
<span class="synPreProc">#include </span><span class="synConstant"><openssl/evp.h></span>
<span class="synPreProc">#include </span><span class="synConstant"><openssl/bio.h></span>
<span class="synPreProc">#include </span><span class="synConstant"><openssl/rand.h></span>
<span class="synPreProc">#define ITERATION </span><span class="synConstant">1000000</span>

<span class="synType">int</span> base64_encode(<span class="synType">const</span> <span class="synType">char</span> *message, <span class="synType">char</span> **buffer) {
BIO *bio, *b64;
<span class="synType">FILE</span>* stream;
<span class="synType">int</span> encodedSize = <span class="synConstant">4</span>*ceil((<span class="synType">double</span>)strlen(message)/<span class="synConstant">3</span>);
*buffer = (<span class="synType">char</span> *)malloc(encodedSize+<span class="synConstant">1</span>);
stream = fmemopen(*buffer, encodedSize+<span class="synConstant">1</span>, <span class="synConstant">"w"</span>);
b64 = BIO_new(BIO_f_base64());
bio = BIO_new_fp(stream, BIO_NOCLOSE);
bio = BIO_push(b64, bio);
BIO_set_flags(bio, BIO_FLAGS_BASE64_NO_NL);
BIO_write(bio, message, strlen(message));
BIO_flush(bio);
BIO_free_all(bio);
fclose(stream);
<span class="synStatement">return</span> <span class="synConstant">0</span>;
}

<span class="synType">int</span> calc_decode_length(<span class="synType">const</span> <span class="synType">char</span> *b64input) {
<span class="synType">int</span> len = strlen(b64input);
<span class="synType">int</span> padding = <span class="synConstant">0</span>;
<span class="synStatement">if</span> (b64input[len-<span class="synConstant">1</span>] == <span class="synConstant">'='</span> && b64input[len-<span class="synConstant">2</span>] == <span class="synConstant">'='</span>) {
    padding = <span class="synConstant">2</span>;
} <span class="synStatement">else</span> <span class="synStatement">if</span> (b64input[len-<span class="synConstant">1</span>] == <span class="synConstant">'='</span>) { 
    padding = <span class="synConstant">1</span>;
}
<span class="synStatement">return</span> (<span class="synType">int</span>)len*<span class="synConstant">0.75</span> - padding;
}

<span class="synType">int</span> base64_decode(<span class="synType">char</span> *b64message, <span class="synType">char</span> **buffer) {
BIO *bio, *b64;
<span class="synType">int</span> decodeLen = calc_decode_length(b64message),len = <span class="synConstant">0</span>;
*buffer = (<span class="synType">char</span>*)malloc(decodeLen+<span class="synConstant">1</span>);
<span class="synType">FILE</span>* stream = fmemopen(b64message, strlen(b64message), <span class="synConstant">"r"</span>);
b64 = BIO_new(BIO_f_base64());
bio = BIO_new_fp(stream, BIO_NOCLOSE);
bio = BIO_push(b64, bio);
BIO_set_flags(bio, BIO_FLAGS_BASE64_NO_NL);
len = BIO_read(bio, *buffer, strlen(b64message));
(*buffer)[len] = <span class="synSpecial">'\0'</span>;
BIO_free_all(bio);
fclose(stream);
<span class="synStatement">return</span> <span class="synConstant">0</span>;
}

<span class="synType">int</span> create_iv(<span class="synType">unsigned</span> <span class="synType">char</span> **iv, <span class="synType">size_t</span> blocksize) {
*iv = calloc(blocksize+<span class="synConstant">1</span>, <span class="synStatement">sizeof</span>(<span class="synType">char</span>));
RAND_bytes(*iv, blocksize);
<span class="synStatement">return</span> <span class="synConstant">0</span>;
}

<span class="synType">int</span> openssl_encrypt(EVP_CIPHER_CTX *ctx, <span class="synType">const</span> EVP_CIPHER *method, <span class="synType">unsigned</span> <span class="synType">char</span> *key, <span class="synType">unsigned</span> <span class="synType">char</span> *iv, <span class="synType">const</span> <span class="synType">char</span> *message, <span class="synType">unsigned</span> <span class="synType">char</span> **cipher, <span class="synType">unsigned</span> <span class="synType">int</span> cipher_len) {
<span class="synType">unsigned</span> <span class="synType">int</span> out_len=<span class="synConstant">0</span>;
EVP_CIPHER_CTX_init(ctx);
EVP_EncryptInit_ex(ctx,method,<span class="synConstant">NULL</span>,(<span class="synType">unsigned</span> <span class="synType">char</span> *)key, iv);
EVP_EncryptUpdate(ctx,(<span class="synType">unsigned</span> <span class="synType">char</span> *)*cipher,&cipher_len,(<span class="synType">unsigned</span> <span class="synType">char</span> *)message,strlen(message));
EVP_EncryptFinal_ex(ctx,(<span class="synType">unsigned</span> <span class="synType">char</span> *)(*cipher+cipher_len),&out_len);
EVP_CIPHER_CTX_cleanup(ctx);
<span class="synStatement">return</span> <span class="synConstant">0</span>;
}

<span class="synType">int</span> openssl_decrypt(EVP_CIPHER_CTX *ctx, <span class="synType">const</span> EVP_CIPHER *method, <span class="synType">unsigned</span> <span class="synType">char</span> *key, <span class="synType">unsigned</span> <span class="synType">char</span> *iv, <span class="synType">char</span> *dectext, <span class="synType">unsigned</span> <span class="synType">char</span> **plain, <span class="synType">unsigned</span> <span class="synType">int</span> plain_len) {
<span class="synType">unsigned</span> <span class="synType">int</span> out_len=<span class="synConstant">0</span>;
EVP_CIPHER_CTX_init(ctx);
EVP_DecryptInit_ex(ctx,method,<span class="synConstant">NULL</span>,(<span class="synType">unsigned</span> <span class="synType">char</span> *)key,iv);
EVP_DecryptUpdate(ctx,(<span class="synType">unsigned</span> <span class="synType">char</span> *)*plain,&plain_len,(<span class="synType">unsigned</span> <span class="synType">char</span> *)dectext,strlen(dectext));
EVP_DecryptFinal_ex(ctx,(<span class="synType">unsigned</span> <span class="synType">char</span> *)(*plain+plain_len),&out_len);
EVP_CIPHER_CTX_cleanup(ctx);
<span class="synStatement">return</span> <span class="synConstant">0</span>;
}

<span class="synType">int</span> *mcrypt_encrypt(<span class="synType">unsigned</span> <span class="synType">char</span> *method, <span class="synType">unsigned</span> <span class="synType">char</span> *mode, <span class="synType">unsigned</span> <span class="synType">char</span> *key, <span class="synType">unsigned</span> <span class="synType">char</span> *cipher, <span class="synType">unsigned</span> <span class="synType">int</span> cipher_len) {
MCRYPT td = mcrypt_module_open(method, <span class="synConstant">NULL</span>, mode, <span class="synConstant">NULL</span>);
mcrypt_generic_init(td, (<span class="synType">void</span> *)key, strlen(key), <span class="synConstant">NULL</span>);
mcrypt_generic(td, cipher, cipher_len);
mcrypt_generic_deinit(td);
mcrypt_module_close(td);
<span class="synStatement">return</span> <span class="synConstant">0</span>;
}

<span class="synType">int</span> *mcrypt_decrypt(<span class="synType">unsigned</span> <span class="synType">char</span> *method, <span class="synType">unsigned</span> <span class="synType">char</span> *mode, <span class="synType">unsigned</span> <span class="synType">char</span> *key, <span class="synType">unsigned</span> <span class="synType">char</span> *plain, <span class="synType">unsigned</span> <span class="synType">int</span> plain_len) {
MCRYPT td = mcrypt_module_open(method, <span class="synConstant">NULL</span>, mode, <span class="synConstant">NULL</span>);
mcrypt_generic_init(td, (<span class="synType">void</span> *)key, strlen(key), <span class="synConstant">NULL</span>);
mdecrypt_generic(td, plain, plain_len);
mcrypt_generic_deinit(td);
mcrypt_module_close(td);
<span class="synStatement">return</span> <span class="synConstant">0</span>;
}

<span class="synType">int</span> *pkcs5_padding(<span class="synType">unsigned</span> <span class="synType">char</span> **cipher, <span class="synType">unsigned</span> <span class="synType">int</span> mod, <span class="synType">const</span> <span class="synType">char</span> *message, <span class="synType">unsigned</span> <span class="synType">int</span> blocksize) {
<span class="synStatement">if</span>( mod != <span class="synConstant">0</span> ) {
    <span class="synType">unsigned</span> <span class="synType">int</span> pad = blocksize - mod, i;
    <span class="synType">char</span> p[<span class="synConstant">1</span>];
    sprintf(p, <span class="synConstant">"</span><span class="synSpecial">%c</span><span class="synConstant">"</span>, pad);
    <span class="synStatement">for</span>(i=<span class="synConstant">0</span>; i<pad; i++) {
        strcat(*cipher, p);
    }
}
<span class="synStatement">return</span> <span class="synConstant">0</span>;
}

<span class="synType">int</span> *pkcs5_unpadding(<span class="synType">unsigned</span> <span class="synType">char</span> **plain, <span class="synType">unsigned</span> <span class="synType">int</span> plain_len) {
<span class="synType">unsigned</span> <span class="synType">char</span> dp[<span class="synConstant">1</span>], int_dp[<span class="synConstant">1</span>];
sprintf(dp, <span class="synConstant">"</span><span class="synSpecial">%c</span><span class="synConstant">"</span>, *(*plain + plain_len -<span class="synConstant">1</span>));
sprintf(int_dp, <span class="synConstant">"</span><span class="synSpecial">%d</span><span class="synConstant">"</span>, *dp);
<span class="synType">int</span> j = atoi(int_dp);
<span class="synStatement">if</span>(dp != <span class="synConstant">NULL</span> && j != <span class="synConstant">0</span>) {
    <span class="synStatement">if</span>(j < plain_len) {
        <span class="synType">int</span> i;
        <span class="synStatement">for</span>(i=plain_len - j; i<plain_len; i++) {
            *(*plain + i) = <span class="synSpecial">'\0'</span>;
        }
    }
}
<span class="synStatement">return</span> <span class="synConstant">0</span>;
}

<span class="synType">int</span> main(<span class="synType">int</span> argc,<span class="synType">char</span> *argv[]){

EVP_CIPHER_CTX ctx;
<span class="synType">unsigned</span> <span class="synType">char</span> *iv, *cipher, *plain, *key=<span class="synConstant">"Soul Gem"</span>, *message=<span class="synConstant">"魔法少女まどか☆マギカ"</span>;
<span class="synType">unsigned</span> <span class="synType">int</span> blocksize = <span class="synConstant">8</span>, cipher_len, plain_len, mod, i, j;
<span class="synType">char</span> *enctext, *dectext;
<span class="synType">clock_t</span> start, end;

<span class="synComment">//dec-ecb-encrypt</span>
cipher_len=strlen(message)+EVP_MAX_BLOCK_LENGTH;
cipher=(<span class="synType">unsigned</span> <span class="synType">char</span> *)calloc(cipher_len+<span class="synConstant">1</span>,<span class="synStatement">sizeof</span>(<span class="synType">char</span>));
start = clock();
<span class="synStatement">for</span>(i=<span class="synConstant">0</span>; i<ITERATION; ++i){
    openssl_encrypt(&ctx, EVP_des_ecb(), key, <span class="synConstant">NULL</span>, message, &cipher, cipher_len);
}
base64_encode((<span class="synType">const</span> <span class="synType">char</span> *)cipher, &enctext);
end = clock();
printf(<span class="synConstant">"dec-ecb-encrypt message = </span><span class="synSpecial">%s\n</span><span class="synConstant">"</span>, enctext);
printf(<span class="synConstant">"openssl </span><span class="synSpecial">%d</span><span class="synConstant"> encrypt time = </span><span class="synSpecial">%8.7f\n</span><span class="synConstant">"</span>, ITERATION, (<span class="synType">double</span>)(end-start)/<span class="synConstant">CLOCKS_PER_SEC</span>);
free(cipher);
cipher = <span class="synSpecial">'\0'</span>;

<span class="synComment">//des-ecb-decrypt</span>
base64_decode(enctext, &dectext);
plain_len=strlen(dectext)+EVP_MAX_BLOCK_LENGTH;
plain=(<span class="synType">unsigned</span> <span class="synType">char</span> *)calloc(plain_len+<span class="synConstant">1</span>,<span class="synStatement">sizeof</span>(<span class="synType">char</span>));
start = clock();
<span class="synStatement">for</span>(i=<span class="synConstant">0</span>; i<ITERATION; ++i){
    openssl_decrypt(&ctx, EVP_des_ecb(), key, <span class="synConstant">NULL</span>, dectext, &plain, plain_len);
}
end = clock();
printf(<span class="synConstant">"dec-ecb-decrypt message = </span><span class="synSpecial">%s\n</span><span class="synConstant">"</span>, plain );
printf(<span class="synConstant">"openssl </span><span class="synSpecial">%d</span><span class="synConstant"> decrypt time = </span><span class="synSpecial">%8.7f\n</span><span class="synConstant">"</span>, ITERATION, (<span class="synType">double</span>)(end-start)/<span class="synConstant">CLOCKS_PER_SEC</span>);
free(plain);
plain = <span class="synSpecial">'\0'</span>;

blocksize = <span class="synConstant">16</span>;
key = <span class="synConstant">"Soul GemSoul Gem"</span>;

<span class="synComment">//aes-ecb-encrypt</span>
cipher_len=strlen(message)+EVP_MAX_BLOCK_LENGTH;
cipher=(<span class="synType">unsigned</span> <span class="synType">char</span> *)calloc(cipher_len+<span class="synConstant">1</span>,<span class="synStatement">sizeof</span>(<span class="synType">char</span>));
start = clock();
<span class="synStatement">for</span>(i=<span class="synConstant">0</span>; i<ITERATION; ++i){
    openssl_encrypt(&ctx, EVP_aes_128_ecb(), key, <span class="synConstant">NULL</span>, message, &cipher, cipher_len);
}
base64_encode((<span class="synType">const</span> <span class="synType">char</span> *)cipher, &enctext);
end = clock();
printf(<span class="synConstant">"aes-ecb-encrypt message = </span><span class="synSpecial">%s\n</span><span class="synConstant">"</span>, enctext);
printf(<span class="synConstant">"openssl </span><span class="synSpecial">%d</span><span class="synConstant"> encrypt time = </span><span class="synSpecial">%8.7f\n</span><span class="synConstant">"</span>, ITERATION, (<span class="synType">double</span>)(end-start)/<span class="synConstant">CLOCKS_PER_SEC</span>);
free(cipher);
cipher = <span class="synSpecial">'\0'</span>;

<span class="synComment">//aes-ecb-decrypt</span>
base64_decode(enctext, &dectext);
plain_len=strlen(dectext)+EVP_MAX_BLOCK_LENGTH;
plain=(<span class="synType">unsigned</span> <span class="synType">char</span> *)calloc(plain_len+<span class="synConstant">1</span>,<span class="synStatement">sizeof</span>(<span class="synType">char</span>));
start = clock();
<span class="synStatement">for</span>(i=<span class="synConstant">0</span>; i<ITERATION; ++i){
    openssl_decrypt(&ctx, EVP_aes_128_ecb(), key, <span class="synConstant">NULL</span>, dectext, &plain, plain_len);
}
end = clock();
printf(<span class="synConstant">"aes-ecb-decrypt message = </span><span class="synSpecial">%s\n</span><span class="synConstant">"</span>, plain );
printf(<span class="synConstant">"openssl </span><span class="synSpecial">%d</span><span class="synConstant"> decrypt time = </span><span class="synSpecial">%8.7f\n</span><span class="synConstant">"</span>, ITERATION, (<span class="synType">double</span>)(end-start)/<span class="synConstant">CLOCKS_PER_SEC</span>);
free(plain);
plain = <span class="synSpecial">'\0'</span>;

blocksize = <span class="synConstant">8</span>;
key = <span class="synConstant">"Soul Gem"</span>;

<span class="synComment">//des-cbc-encrypt</span>
mod = strlen(message) % blocksize;
cipher_len = strlen(message) + ( blocksize - mod );
cipher = (<span class="synType">char</span> *)calloc(cipher_len+<span class="synConstant">1</span>, <span class="synStatement">sizeof</span>(<span class="synType">char</span>));
start = clock();
<span class="synStatement">for</span>(i=<span class="synConstant">0</span>; i<ITERATION; ++i){
    strcpy(cipher, message);
    pkcs5_padding(&cipher, mod, message, blocksize);
    mcrypt_encrypt(MCRYPT_DES, MCRYPT_ECB, key, cipher, strlen(cipher));
}
end = clock();
base64_encode( (<span class="synType">const</span> <span class="synType">char</span> *)cipher, &enctext );
printf(<span class="synConstant">"des-ecb-encrypt message = </span><span class="synSpecial">%s\n</span><span class="synConstant">"</span>, enctext);
printf(<span class="synConstant">"mcrypt </span><span class="synSpecial">%d</span><span class="synConstant"> encrypt time = </span><span class="synSpecial">%8.7f\n</span><span class="synConstant">"</span>, ITERATION, (<span class="synType">double</span>)(end-start)/<span class="synConstant">CLOCKS_PER_SEC</span>);

free(cipher);
cipher = <span class="synSpecial">'\0'</span>;

<span class="synComment">//dec-cbc-decrypt</span>
base64_decode(enctext, &dectext);
plain_len = strlen(dectext);
plain = (<span class="synType">char</span> *)calloc(plain_len+<span class="synConstant">1</span>, <span class="synStatement">sizeof</span>(<span class="synType">char</span>));
start = clock();
<span class="synStatement">for</span>(i=<span class="synConstant">0</span>; i<ITERATION; ++i){
    strcpy(plain,dectext);
    mcrypt_decrypt(MCRYPT_DES, MCRYPT_ECB, key, plain, strlen(plain));
    pkcs5_unpadding(&plain, strlen(plain));
}

end = clock();
printf(<span class="synConstant">"des-ecb-decrypt message = </span><span class="synSpecial">%s\n</span><span class="synConstant">"</span>, plain);
printf(<span class="synConstant">"mcrypt </span><span class="synSpecial">%d</span><span class="synConstant"> decrypt time = </span><span class="synSpecial">%8.7f\n</span><span class="synConstant">"</span>, ITERATION, (<span class="synType">double</span>)(end-start)/<span class="synConstant">CLOCKS_PER_SEC</span>);

free(plain);
plain = <span class="synSpecial">'\0'</span>;

blocksize = <span class="synConstant">16</span>;
key = <span class="synConstant">"Soul GemSoul Gem"</span>;
mod = strlen(message) % blocksize;
cipher_len = strlen(message) + ( blocksize - mod );
cipher = (<span class="synType">char</span> *)calloc(cipher_len+<span class="synConstant">1</span>, <span class="synStatement">sizeof</span>(<span class="synType">char</span>));

<span class="synComment">//aes-ecb-encrypt</span>
start = clock();
<span class="synStatement">for</span>(i=<span class="synConstant">0</span>; i<ITERATION; ++i){
    strcpy(cipher, message);
    pkcs5_padding(&cipher, mod, message, blocksize);
    mcrypt_encrypt(MCRYPT_RIJNDAEL_128, MCRYPT_ECB, key, cipher, strlen(cipher));
}
end = clock();
base64_encode((<span class="synType">const</span> <span class="synType">char</span> *)cipher, &enctext);
printf(<span class="synConstant">"aes-ecb-encrypt message = </span><span class="synSpecial">%s\n</span><span class="synConstant">"</span>, enctext);
printf(<span class="synConstant">"mcrypt </span><span class="synSpecial">%d</span><span class="synConstant"> encrypt time = </span><span class="synSpecial">%8.7f\n</span><span class="synConstant">"</span>, ITERATION, (<span class="synType">double</span>)(end-start)/<span class="synConstant">CLOCKS_PER_SEC</span>);
free(cipher);
cipher = <span class="synSpecial">'\0'</span>;

<span class="synComment">//aes-ecb-decrypt</span>
base64_decode(enctext, &dectext);
plain_len = strlen(dectext);
plain = (<span class="synType">char</span> *)calloc(plain_len+<span class="synConstant">1</span>, <span class="synStatement">sizeof</span>(<span class="synType">char</span>));
start = clock();
<span class="synStatement">for</span>(i=<span class="synConstant">0</span>; i<ITERATION; ++i){
    strcpy(plain,dectext);
    mcrypt_decrypt(MCRYPT_RIJNDAEL_128, MCRYPT_ECB, key, plain, strlen(plain));
    pkcs5_unpadding(&plain, strlen(plain));
}

end = clock();
printf(<span class="synConstant">"aes-ecb-decrypt message = </span><span class="synSpecial">%s\n</span><span class="synConstant">"</span>, plain);
printf(<span class="synConstant">"mcrypt </span><span class="synSpecial">%d</span><span class="synConstant"> decrypt time = </span><span class="synSpecial">%8.7f\n</span><span class="synConstant">"</span>, ITERATION, (<span class="synType">double</span>)(end-start)/<span class="synConstant">CLOCKS_PER_SEC</span>);
free(plain);
plain = <span class="synSpecial">'\0'</span>;
<span class="synStatement">return</span> <span class="synConstant">0</span>;
}
</pre><pre class="hljs sh" data-lang="sh" data-unlink>$ gcc <span class="synSpecial">-lm</span> <span class="synSpecial">-I</span>/usr/include/openssl <span class="synSpecial">-L</span>/usr/lib64 <span class="synSpecial">-lcrypto</span> <span class="synSpecial">-lmcrypt</span> openssl_vs_mcrypt.c <span class="synSpecial">-o</span> openssl_vs_mcrypt
$ ./openssl_vs_mcrypt
dec-ecb-encrypt message <span class="synStatement">=</span> s3TrEokf/<span class="synIdentifier">1xTgoHIimEtUi8s5hNgultndusqMud+XGa0KXi6EbHF4w</span>=<span class="synStatement">=</span>
openssl <span class="synConstant">1000000</span> encrypt <span class="synStatement">time</span> <span class="synStatement">=</span> 1.1600000
dec-ecb-decrypt message <span class="synStatement">=</span> 魔法少女まどか☆マギカ
openssl <span class="synConstant">1000000</span> decrypt <span class="synStatement">time</span> <span class="synStatement">=</span> 1.2400000
aes-ecb-encrypt message <span class="synStatement">=</span> jkSF8YDL4Bi/JDC6z/5aoosGSBRqcEeRri2ZH5Qs+PMb+HceqdCgV5iMH/DziDzB
openssl <span class="synConstant">1000000</span> encrypt <span class="synStatement">time</span> <span class="synStatement">=</span> 0.6200000
aes-ecb-decrypt message <span class="synStatement">=</span> 魔法少女まどか☆マギカ
openssl <span class="synConstant">1000000</span> decrypt <span class="synStatement">time</span> <span class="synStatement">=</span> 0.7200000
des-ecb-encrypt message <span class="synStatement">=</span> s3TrEokf/1xTgoHIimEtUi8s5hNgultndusqMud+XGar
mcrypt <span class="synConstant">1000000</span> encrypt <span class="synStatement">time</span> <span class="synStatement">=</span> 214.8300000
des-ecb-decrypt message <span class="synStatement">=</span> 魔法少女まどか☆マギカ
mcrypt <span class="synConstant">1000000</span> decrypt <span class="synStatement">time</span> <span class="synStatement">=</span> 194.9700000
aes-ecb-encrypt message <span class="synStatement">=</span> jkSF8YDL4Bi/JDC6z/5aoosGSBRqcEeRri2ZH5Qs+POr
mcrypt <span class="synConstant">1000000</span> encrypt <span class="synStatement">time</span> <span class="synStatement">=</span> 62.8500000
aes-ecb-decrypt message <span class="synStatement">=</span> 魔法少女まどか☆マギカ
mcrypt <span class="synConstant">1000000</span> decrypt <span class="synStatement">time</span> <span class="synStatement">=</span> 62.4300000
</pre>
</div>
</blockquote>

</div>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://yutakikuchi.github.io/blog/post/201402170828/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://yutakikuchi.github.io/blog/post/201402170828/">【男の浪漫】身長、体重およびスリーサイズを素性とした「アレ」のサイズを推定する実験</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://yutakikuchi.github.io/blog/post/201403170820/">SolrのSpatial Searchを試してみた</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://yutakikuchi.github.io/blog/post/201403170820/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>

</div>
</div>
<script src="https://yutakikuchi.github.io/blog/js/ui.js"></script>
<script src="https://yutakikuchi.github.io/blog/js/menus.js"></script>


<script>
  
  if (window.location.hostname != "localhost") {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-20616165-3', 'auto');
    ga('send', 'pageview');
  }
</script>





</body>
</html>

