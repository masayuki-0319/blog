<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="canonical" href="http://yut.hatenablog.com/entry/20120129/1327810052" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.55.4" />

  <title>InnoDBの設計とインデックスを意識したサロゲートキーと複合プライマリキーの比較 &middot; Y&#39;s note</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://yutakikuchi.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://yutakikuchi.github.io/img/favicon.ico" type="image/x-icon" />

  
    
        <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/my.css">
    
  
  
    
        <script src="https://yutakikuchi.github.io/blog/js/my.js"></script>
    
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://yutakikuchi.github.io/">Y's note</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/yutakikuchi_" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://facebook.com/yuta.kikuchi.007" target="_blank"><i class="fa fa-facebook-square fa-fw"></i>Facebook</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="http://slideshare.net/https://www.slideshare.net/yutakikuchi58/" target="_blank"><i class="fa fa-slideshare fa-fw"></i>SlideShare</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/https://www.linkedin.com/in/%E4%BD%91%E5%A4%AA-%E8%8F%8A%E6%B1%A0-36291a44/" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/yutakikuchi" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2019. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>InnoDBの設計とインデックスを意識したサロゲートキーと複合プライマリキーの比較</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2012 Jan 29, 13:07</time>
  </div>

  

  

  

</div>

  

<h2 id="mysql-innodbの設計とインデックスを意識したサロゲートキーと複合プライマリキーの比較">[Mysql] : InnoDBの設計とインデックスを意識したサロゲートキーと複合プライマリキーの比較</h2>

<p><div class="amazlet-box"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4873114268/yutakikuchi-22/"><img src="http://ecx.images-amazon.com/images/I/51ifm2PPAaL._SL160_.jpg" class="hatena-asin-detail-image" alt="実践ハイパフォーマンスMySQL 第2版" title="実践ハイパフォーマンスMySQL 第2版"></a><div class="hatena-asin-detail-info"><p class="hatena-asin-detail-title"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4873114268/yutakikuchi-22/">実践ハイパフォーマンスMySQL 第2版</a></p><ul><li><span class="hatena-asin-detail-label">作者:</span> Baron Schwartz,Peter Zaitsev,Vadim Tkachenko,Jeremy D. Zawodny,Arjen Lentz,Derek J. Balling,<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B0%CB%C6%A3%C4%BE%CC%E9">伊藤直也</a>(監訳),田中慎司(監訳),吉川英興(監訳),<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B3%F4%BC%B0%B2%F1%BC%D2%A5%AF%A5%A4%A1%BC%A5%D7">株式会社クイープ</a></li><li><span class="hatena-asin-detail-label">出版社/メーカー:</span> <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AA%A5%E9%A5%A4%A5%EA%A1%BC%A5%B8%A5%E3%A5%D1%A5%F3">オライリージャパン</a></li><li><span class="hatena-asin-detail-label">発売日:</span> 2009/12/14</li><li><span class="hatena-asin-detail-label">メディア:</span> 大型本</li><li><span class="hatena-asin-detail-label">購入</span>: 17人 <span class="hatena-asin-detail-label">クリック</span>: 373回</li><li><a href="http://d.hatena.ne.jp/asin/4873114268/yutakikuchi-22" target="_blank">この商品を含むブログ (46件) を見る</a></li></ul></div><div class="hatena-asin-detail-foot"></div></div></p>

<div class="section">
<h4>概要</h4>

<blockquote>
    <p>この記事では<a class="keyword" href="http://d.hatena.ne.jp/keyword/InnoDB">InnoDB</a>を使用する上での<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AF%A5%E9%A5%B9%A5%BF">クラスタ</a>インデックスを意識した<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%ED%A5%B2%A1%BC%A5%C8%A5%AD%A1%BC">サロゲートキー</a>と複合主キーの比較をパフォーマンスの観点から行います。<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%ED%A5%B2%A1%BC%A5%C8%A5%AD%A1%BC">サロゲートキー</a>か複合キーのどちらを使うべきかは様々な議論がなされているようにケースバイケースといったところで自分は納得しています。ここでは自分の実現したいテーブル設計と利用目的を明確にしてそのケースに合うのはどちらかという検証をしたいと思います。ちなみに今までの業務では<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%ED%A5%B2%A1%BC%A5%C8">サロゲート</a>を使う事がほとんどでした。理由としては参加したPJのほとんどで元々のテーブルが全部<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%ED%A5%B2%A1%BC%A5%C8">サロゲート</a>であること、また自分で設計する時も主キー管理に面倒なことを考えなくて済むからという理由で<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%ED%A5%B2%A1%BC%A5%C8">サロゲート</a>を使用していました。(使用している<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D5%A5%EC%A1%BC%A5%E0%A5%EF%A1%BC%A5%AF">フレームワーク</a>の制限で<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%ED%A5%B2%A1%BC%A5%C8">サロゲート</a>を使用しないといけないということはありませんでした。)今までパフォーマンスを求められる箇所のDB設計を担当しておらず勉強不足が否めないので、今回検証してみることにしました。間違い等あればどんどんご指摘ください。宜しくお願いいたします。以下初めにこの記事で利用するキーの名前の定義をしておきます。</p>

<div class="section">
<h5>キーの定義</h5>

<table>
<tr>
<th> 名前 </th>
<th> 意味 </th>
</tr>
<tr>
<td> ナチュラルキー(自然キー) </td>
<td> システムの外部から入力される値に対するキー。</td>
<td> </td>
</tr>
<tr>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%ED%A5%B2%A1%BC%A5%C8%A5%AD%A1%BC">サロゲートキー</a>(代替キー) </td>
<td> 自動生成される連番キーで主にプライマリーに利用されるが、値としては意味を持たない。</td>
</tr>
<tr>
<td> プライマリキー(主キー) </td>
<td> テーブル内の行を一意とするための識別子。</td>
</tr>
<tr>
<td> 複合プライマリキー(複合主キー) </td>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%A3%BF%F4">複数</a>のナチュラルキーにて構成されるプライマリキー </td>
<td> </td>
</tr>
<tr>
<td> ユニークキー(一意キー) </td>
<td> NULL以外をユニークとするキー。</td>
</tr>
<tr>
<td> 複合ユニークキー </td>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%A3%BF%F4">複数</a>のカラムでユニークを意味するキー。</td>
</tr>
</table>
</div>
</blockquote>

</div>
<div class="section">
<h4>実現したい内容</h4>

<blockquote>
    <p>商品販売を行う携帯サービスを展開する時に 「どのユーザ」が「どの商品」を「どの携帯電話」で利用しているかという状況の履歴を管理するテーブルを作成します。データとしてはユーザ、商品、携帯電話の値それぞれがデータの意味としては一意となりますが履歴のテーブルであるため3つ揃って一つのユニークな履歴となります。（3つの値を持つ同じ履歴レコードは他には存在しない状況）テーブルとして必要な情報を以下にまとめます。</p>

<table>
<tr>
<th> 必要な項目 </th>
<th> 説明 </th>
</tr>
<tr>
<td> ユーザID </td>
<td> ユーザを識別する値。データの重複は無い </td>
</tr>
<tr>
<td> 商品ID </td>
<td> 商品を識別する値。データの重複は無い </td>
</tr>
<tr>
<td> 携帯端末ID </td>
<td> 携帯端末を識別する値。データの重複は無い </td>
</tr>
<tr>
<td> ダウンロード日時 </td>
<td> ユーザが商品を携帯端末にダウンロードした日時 </td>
</tr>
</table><p>このデータの管理を今回は<a class="keyword" href="http://d.hatena.ne.jp/keyword/InnoDB">InnoDB</a>で行います。<a class="keyword" href="http://d.hatena.ne.jp/keyword/InnoDB">InnoDB</a>を選択している理由は重要な顧客情報であるため<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>を使ったcommit/rollbakを行いたい事と一部外部キー制約を利用する事によります。データの挿入は一回限りですがユーザがどの商品をどれだけの端末で利用しているかを調べるためにSELECTを多く使用します。記事で検証したいのは<a class="keyword" href="http://d.hatena.ne.jp/keyword/InnoDB">InnoDB</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AF%A5%E9%A5%B9%A5%BF">クラスタ</a>インデックスです。<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AF%A5%E9%A5%B9%A5%BF">クラスタ</a>インデックスについては以前記事を書いたのでそちらを参照してください。<a href="http://d.hatena.ne.jp/yutakikuchi/20120122/1327214127">実践 ハイパフォーマンスMySQL(第2版)を斜め読みして前半の重要なポイントだけをまとめてみた - Yuta.Kikuchiの日記</a> <a href="http://b.hatena.ne.jp/entry/d.hatena.ne.jp/yutakikuchi/20120122/1327214127"><img src="http://b.hatena.ne.jp/entry/image/http://d.hatena.ne.jp/yutakikuchi/20120122/1327214127" alt="はてなブックマーク - 実践 ハイパフォーマンスMySQL(第2版)を斜め読みして前半の重要なポイントだけをまとめてみた - Yuta.Kikuchiの日記" border="0" /></a>調査のポイントとしてはINSERTの段階でどれだけインデックスが近接し効率よくSELECTされるかを<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%ED%A5%B2%A1%BC%A5%C8">サロゲート</a>と複合プライマリでの比較をします。</p>

</blockquote>

</div>
<div class="section">
<h4>テーブル/インデックスの設計</h4>

<blockquote>
    <p>今回の検証の中心は<a class="keyword" href="http://d.hatena.ne.jp/keyword/InnoDB">InnoDB</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AF%A5%E9%A5%B9%A5%BF">クラスタ</a>インデックスで上のケースを実現したい時には<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%ED%A5%B2%A1%BC%A5%C8">サロゲート</a>と複合プライマリのどちらが適しているかという事です。そこでそれぞれのテーブルとインデックスの設計を行います。</p>

<div class="section">
<h5><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%ED%A5%B2%A1%BC%A5%C8">サロゲート</a>方式</h5>
<p>DownloadテーブルにDownload_idという意味を持たない一意のキーをプライマリとして指定しています。SELECTを行うのはDownloadテーブルだけですがとりあえず関係しそうな外部テーブルの参照状態も表します。<br />
<span itemscope itemtype="http://schema.org/Photograph"><a href="http://f.hatena.ne.jp/yutakikuchi/20120128223845" class="hatena-fotolife" itemprop="url"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/y/yutakikuchi/20120128/20120128223845.png" alt="f:id:yutakikuchi:20120128223845p:image" title="f:id:yutakikuchi:20120128223845p:image" class="hatena-fotolife" itemprop="image"></a></span><br />
</p>
<pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">SET</span> @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=<span class="synConstant">0</span>;
<span class="synStatement">SET</span> @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=<span class="synConstant">0</span>;
<span class="synStatement">SET</span> @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=<span class="synConstant">'TRADITIONAL'</span>;

<span class="synStatement">CREATE</span> SCHEMA <span class="synSpecial">IF</span> <span class="synStatement">NOT</span> <span class="synStatement">EXISTS</span> `mydb` <span class="synSpecial">DEFAULT</span> <span class="synType">CHARACTER</span> <span class="synStatement">SET</span> latin1 COLLATE latin1_swedish_ci ;
USE `mydb` ;

<span class="synComment">-- -----------------------------------------------------</span>
<span class="synComment">-- Table `mydb`.`User`</span>
<span class="synComment">-- -----------------------------------------------------</span>
<span class="synStatement">CREATE</span>  <span class="synSpecial">TABLE</span> <span class="synSpecial">IF</span> <span class="synStatement">NOT</span> <span class="synStatement">EXISTS</span> `mydb`.`<span class="synSpecial">User</span>` (
  `user_id` INT <span class="synStatement">NOT</span> <span class="synSpecial">NULL</span> ,
  `User_name` <span class="synType">VARCHAR</span>(<span class="synConstant">20</span>) <span class="synSpecial">NULL</span> ,
  `User_age` INT <span class="synSpecial">NULL</span> ,
  PRIMARY KEY (`user_id`) )
ENGINE = InnoDB
<span class="synSpecial">DEFAULT</span> <span class="synType">CHARACTER</span> <span class="synStatement">SET</span> = utf8;


<span class="synComment">-- -----------------------------------------------------</span>
<span class="synComment">-- Table `mydb`.`Production`</span>
<span class="synComment">-- -----------------------------------------------------</span>
<span class="synStatement">CREATE</span>  <span class="synSpecial">TABLE</span> <span class="synSpecial">IF</span> <span class="synStatement">NOT</span> <span class="synStatement">EXISTS</span> `mydb`.`Production` (
  `production_id` INT <span class="synStatement">NOT</span> <span class="synSpecial">NULL</span> ,
  `Production_name` <span class="synType">VARCHAR</span>(<span class="synConstant">20</span>) <span class="synSpecial">NULL</span> ,
  `Production_price` INT <span class="synSpecial">NULL</span> ,
  PRIMARY KEY (`production_id`) )
ENGINE = InnoDB
<span class="synSpecial">DEFAULT</span> <span class="synType">CHARACTER</span> <span class="synStatement">SET</span> = utf8;


<span class="synComment">-- -----------------------------------------------------</span>
<span class="synComment">-- Table `mydb`.`Download`</span>
<span class="synComment">-- -----------------------------------------------------</span>
<span class="synStatement">CREATE</span>  <span class="synSpecial">TABLE</span> <span class="synSpecial">IF</span> <span class="synStatement">NOT</span> <span class="synStatement">EXISTS</span> `mydb`.`Download` (
  `Download_id` INT <span class="synStatement">NOT</span> <span class="synSpecial">NULL</span> AUTO_INCREMENT ,
  `user_id` INT <span class="synStatement">NOT</span> <span class="synSpecial">NULL</span> ,
  `production_id` INT <span class="synStatement">NOT</span> <span class="synSpecial">NULL</span> ,
  `device_id` <span class="synType">VARCHAR</span>(<span class="synConstant">45</span>) <span class="synStatement">NOT</span> <span class="synSpecial">NULL</span> ,
  `download_date` DATETIME <span class="synStatement">NOT</span> <span class="synSpecial">NULL</span> <span class="synSpecial">DEFAULT</span> <span class="synConstant">'0000-00-00 00:00:00'</span> ,
  PRIMARY KEY (`Download_id`) ,
  <span class="synSpecial">INDEX</span> `device` (`user_id` <span class="synSpecial">ASC</span>, `production_id` <span class="synSpecial">ASC</span>, `device_id` <span class="synSpecial">ASC</span>) ,
  CONSTRAINT `fk_Download_User`
FOREIGN KEY (`user_id` )
REFERENCES `mydb`.`<span class="synSpecial">User</span>` (`user_id` )
<span class="synSpecial">ON</span> <span class="synStatement">DELETE</span> NO ACTION
<span class="synSpecial">ON</span> <span class="synStatement">UPDATE</span> NO ACTION,
  CONSTRAINT `fk_Download_Production1`
FOREIGN KEY (`production_id` )
REFERENCES `mydb`.`Production` (`production_id` )
<span class="synSpecial">ON</span> <span class="synStatement">DELETE</span> NO ACTION
<span class="synSpecial">ON</span> <span class="synStatement">UPDATE</span> NO ACTION)
ENGINE = InnoDB
<span class="synSpecial">DEFAULT</span> <span class="synType">CHARACTER</span> <span class="synStatement">SET</span> = utf8;
<span class="synStatement">SET</span> SQL_MODE=@OLD_SQL_MODE;
<span class="synStatement">SET</span> FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
<span class="synStatement">SET</span> UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;
</pre>
</div>
<div class="section">
<h5>複合プライマリ方式</h5>
<p>Downloadテーブルのuser_id、production_id、device_idを複合プライマリキーとして利用しています。<br />
<span itemscope itemtype="http://schema.org/Photograph"><a href="http://f.hatena.ne.jp/yutakikuchi/20120128225440" class="hatena-fotolife" itemprop="url"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/y/yutakikuchi/20120128/20120128225440.png" alt="f:id:yutakikuchi:20120128225440p:image" title="f:id:yutakikuchi:20120128225440p:image" class="hatena-fotolife" itemprop="image"></a></span></p>
<pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">SET</span> @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=<span class="synConstant">0</span>;
<span class="synStatement">SET</span> @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=<span class="synConstant">0</span>;
<span class="synStatement">SET</span> @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=<span class="synConstant">'TRADITIONAL'</span>;

<span class="synStatement">CREATE</span> SCHEMA <span class="synSpecial">IF</span> <span class="synStatement">NOT</span> <span class="synStatement">EXISTS</span> `mydb` <span class="synSpecial">DEFAULT</span> <span class="synType">CHARACTER</span> <span class="synStatement">SET</span> latin1 COLLATE latin1_swedish_ci ;
USE `mydb` ;

<span class="synComment">-- -----------------------------------------------------</span>
<span class="synComment">-- Table `mydb`.`User`</span>
<span class="synComment">-- -----------------------------------------------------</span>
<span class="synStatement">CREATE</span>  <span class="synSpecial">TABLE</span> <span class="synSpecial">IF</span> <span class="synStatement">NOT</span> <span class="synStatement">EXISTS</span> `mydb`.`<span class="synSpecial">User</span>` (
  `user_id` INT <span class="synStatement">NOT</span> <span class="synSpecial">NULL</span> ,
  `User_name` <span class="synType">VARCHAR</span>(<span class="synConstant">20</span>) <span class="synSpecial">NULL</span> ,
  `User_age` INT <span class="synSpecial">NULL</span> ,
  PRIMARY KEY (`user_id`) )
ENGINE = InnoDB
<span class="synSpecial">DEFAULT</span> <span class="synType">CHARACTER</span> <span class="synStatement">SET</span> = utf8;


<span class="synComment">-- -----------------------------------------------------</span>
<span class="synComment">-- Table `mydb`.`Production`</span>
<span class="synComment">-- -----------------------------------------------------</span>
<span class="synStatement">CREATE</span>  <span class="synSpecial">TABLE</span> <span class="synSpecial">IF</span> <span class="synStatement">NOT</span> <span class="synStatement">EXISTS</span> `mydb`.`Production` (
  `production_id` INT <span class="synStatement">NOT</span> <span class="synSpecial">NULL</span> ,
  `Production_name` <span class="synType">VARCHAR</span>(<span class="synConstant">20</span>) <span class="synSpecial">NULL</span> ,
  `Production_price` INT <span class="synSpecial">NULL</span> ,
  PRIMARY KEY (`production_id`) )
ENGINE = InnoDB
<span class="synSpecial">DEFAULT</span> <span class="synType">CHARACTER</span> <span class="synStatement">SET</span> = utf8;


<span class="synComment">-- -----------------------------------------------------</span>
<span class="synComment">-- Table `mydb`.`Download`</span>
<span class="synComment">-- -----------------------------------------------------</span>
<span class="synStatement">CREATE</span>  <span class="synSpecial">TABLE</span> <span class="synSpecial">IF</span> <span class="synStatement">NOT</span> <span class="synStatement">EXISTS</span> `mydb`.`Download` (
  `user_id` INT <span class="synStatement">NOT</span> <span class="synSpecial">NULL</span> ,
  `production_id` INT <span class="synStatement">NOT</span> <span class="synSpecial">NULL</span> ,
  `device_id` <span class="synType">VARCHAR</span>(<span class="synConstant">45</span>) <span class="synStatement">NOT</span> <span class="synSpecial">NULL</span> ,
  `download_date` DATETIME <span class="synStatement">NOT</span> <span class="synSpecial">NULL</span> <span class="synSpecial">DEFAULT</span> <span class="synConstant">'0000-00-00 00:00:00'</span> ,
  PRIMARY KEY (`user_id`, `production_id`, `device_id`) ,
  <span class="synSpecial">INDEX</span> `device` (`user_id` <span class="synSpecial">ASC</span>, `production_id` <span class="synSpecial">ASC</span>, `device_id` <span class="synSpecial">ASC</span>) ,
  CONSTRAINT `fk_Download_User`
FOREIGN KEY (`user_id` )
REFERENCES `mydb`.`<span class="synSpecial">User</span>` (`user_id` )
<span class="synSpecial">ON</span> <span class="synStatement">DELETE</span> NO ACTION
<span class="synSpecial">ON</span> <span class="synStatement">UPDATE</span> NO ACTION,
  CONSTRAINT `fk_Download_Production1`
FOREIGN KEY (`production_id` )
REFERENCES `mydb`.`Production` (`production_id` )
<span class="synSpecial">ON</span> <span class="synStatement">DELETE</span> NO ACTION
<span class="synSpecial">ON</span> <span class="synStatement">UPDATE</span> NO ACTION)
ENGINE = InnoDB
<span class="synSpecial">DEFAULT</span> <span class="synType">CHARACTER</span> <span class="synStatement">SET</span> = utf8;
<span class="synStatement">SET</span> SQL_MODE=@OLD_SQL_MODE;
<span class="synStatement">SET</span> FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
<span class="synStatement">SET</span> UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;
</pre>
</div>
</blockquote>

</div>
<div class="section">
<h4>SELECTパフォーマンス検証</h4>

<blockquote>
    
<div class="section">
<h5>実行環境</h5>
<pre class="hljs sql" data-lang="sql" data-unlink>mysql> <span class="synStatement">SELECT</span> VERSION();
+<span class="synComment">------------+</span>
| VERSION()  |
+<span class="synComment">------------+</span>
| <span class="synConstant">5.1</span>.<span class="synConstant">39</span>-log |
+<span class="synComment">------------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

iMac.local <span class="synConstant">10.8</span>.<span class="synConstant">0</span> Darwin Kernel Version <span class="synConstant">10.8</span>.<span class="synConstant">0</span> xnu<span class="synConstant">-1504</span>.<span class="synConstant">15.3</span>~<span class="synConstant">1</span>/RELEASE_I386 i386
</pre>
</div>
<div class="section">
<h5>query_cacheの設定</h5>
<p>ONにしています。また一度SELECTを実行するとqueryをキャッシュするので次の実行は高速に返却します。Qcache_queries_in_cacheに格納されているものを返す。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>mysql> SHOW VARIABLES <span class="synStatement">LIKE</span> <span class="synConstant">'%query_cache%'</span>;
+<span class="synComment">------------------------------+----------+</span>
| Variable_name                | Value    |
+<span class="synComment">------------------------------+----------+</span>
| have_query_cache             | YES      |
| query_cache_limit            | <span class="synConstant">1048576</span>  |
| query_cache_min_res_unit     | <span class="synConstant">4096</span>     |
| query_cache_size             | <span class="synConstant">16777216</span> |
| query_cache_type             | <span class="synSpecial">ON</span>       |
| query_cache_wlock_invalidate | OFF      |
+<span class="synComment">------------------------------+----------+</span>
<span class="synConstant">6</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16765312</span> |
| Qcache_hits             | <span class="synConstant">1</span>        |
| Qcache_inserts          | <span class="synConstant">2</span>        |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">2</span>        |
| Qcache_queries_in_cache | <span class="synConstant">2</span>        |
| Qcache_total_blocks     | <span class="synConstant">7</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)
</pre>
</div>
<div class="section">
<h5>使用するクエリ</h5>
<p>使用するクエリは以下のものです。取得するカラムに処理的には無駄なものが入っていますが分かりやすくデータを表示するために利用します。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>// Pattern1 : ユーザがどの商品をどの端末で利用しているか
<span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = XXXXX;
// Pattern2 : ユーザが指定商品をどの端末で利用しているか
<span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = XXXXX <span class="synStatement">AND</span> production_id = YYYYY;
// Pattern3 : 指定商品を指定端末で利用しているユーザがいるか
<span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> production_id = YYYYY <span class="synStatement">AND</span> device_id = ZZZZZ;
// Pattern4 : ユーザが指定端末で利用している商品はどれか
<span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = XXXXX <span class="synStatement">AND</span> device_id = ZZZZZ;
// Pattern5 : ユーザが指定商品を指定端末で利用しているかどうか
<span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = XXXXX <span class="synStatement">AND</span> production_id = YYYYY <span class="synStatement">AND</span> device_id = ZZZZZ;
// Pattern6 : Pattern2の数をCOUNTしてみる
<span class="synStatement">SELECT</span> COUNT(device_id) <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = XXXXX <span class="synStatement">AND</span> production_id = YYYYY;
</pre>
</div>
<div class="section">
<h5>テストデータの導入</h5>
<p>以下のテストデータを10万件入稿します。本来ならば本番稼働と同じ形式のデータを入れたいのですが時間がかかるため乱数でINSERTします。データとして発生させるパターンを指定ユーザで網羅すると以下のようになります。</p>

<ul>
<li>指定ユーザが異なる商品を同じ端末で利用</li>
<li>指定ユーザが同じ商品を異なる端末で利用</li>
</ul><pre class="hljs php" data-lang="php" data-unlink><span class="synSpecial"><?php</span>
<span class="synStatement">$</span><span class="synIdentifier">con</span> <span class="synStatement">=</span> @<span class="synIdentifier">mysql_connect</span><span class="synSpecial">(</span> '<span class="synConstant">localhost:3306:/tmp/mysql.sock</span>', '<span class="synConstant">root</span>', '' <span class="synSpecial">)</span>;
<span class="synStatement">if</span><span class="synSpecial">(</span> <span class="synStatement">!$</span><span class="synIdentifier">con</span> <span class="synSpecial">)</span> <span class="synSpecial">{</span> 
<span class="synStatement">die</span><span class="synSpecial">(</span> "<span class="synConstant">disconnect </span>" <span class="synStatement">.</span>  <span class="synIdentifier">mysql_error</span><span class="synSpecial">()</span> <span class="synSpecial">)</span>;
<span class="synSpecial">}</span>
<span class="synStatement">for</span><span class="synSpecial">(</span> <span class="synStatement">$</span><span class="synIdentifier">i</span><span class="synStatement">=</span><span class="synConstant">0</span>; <span class="synStatement">$</span><span class="synIdentifier">i</span><span class="synStatement"><</span><span class="synConstant">100000</span>; <span class="synStatement">$</span><span class="synIdentifier">i</span><span class="synStatement">++</span> <span class="synSpecial">)</span> <span class="synSpecial">{</span> 
<span class="synStatement">$</span><span class="synIdentifier">user_id</span> <span class="synStatement">=</span> <span class="synIdentifier">rand</span><span class="synSpecial">(</span> <span class="synConstant">1</span>, <span class="synConstant">100000</span> <span class="synSpecial">)</span>;
<span class="synStatement">$</span><span class="synIdentifier">production_id</span> <span class="synStatement">=</span> <span class="synIdentifier">rand</span><span class="synSpecial">(</span> <span class="synConstant">1</span>, <span class="synConstant">2000</span> <span class="synSpecial">)</span>;
<span class="synStatement">$</span><span class="synIdentifier">device_id</span> <span class="synStatement">=</span> <span class="synIdentifier">rand</span><span class="synSpecial">(</span> <span class="synConstant">1</span>, <span class="synConstant">2000000</span> <span class="synSpecial">)</span>;
<span class="synStatement">if</span><span class="synSpecial">(</span> <span class="synStatement">$</span><span class="synIdentifier">i</span> <span class="synStatement">==</span> <span class="synConstant">30000</span> <span class="synSpecial">)</span> <span class="synSpecial">{</span>
    <span class="synStatement">$</span><span class="synIdentifier">user_id</span> <span class="synStatement">=</span> <span class="synConstant">20000</span>;
    <span class="synStatement">$</span><span class="synIdentifier">production_id</span> <span class="synStatement">=</span> <span class="synConstant">5</span>;
    <span class="synStatement">$</span><span class="synIdentifier">device_id</span> <span class="synStatement">=</span> <span class="synConstant">123456789</span>;
<span class="synSpecial">}</span>
<span class="synStatement">if</span><span class="synSpecial">(</span> <span class="synStatement">$</span><span class="synIdentifier">i</span> <span class="synStatement">==</span> <span class="synConstant">60000</span> <span class="synSpecial">)</span> <span class="synSpecial">{</span>
    <span class="synStatement">$</span><span class="synIdentifier">user_id</span> <span class="synStatement">=</span> <span class="synConstant">20000</span>;
    <span class="synStatement">$</span><span class="synIdentifier">production_id</span> <span class="synStatement">=</span> <span class="synConstant">10</span>;
    <span class="synStatement">$</span><span class="synIdentifier">device_id</span> <span class="synStatement">=</span> <span class="synConstant">123456789</span>;
<span class="synSpecial">}</span>
<span class="synStatement">if</span><span class="synSpecial">(</span> <span class="synStatement">$</span><span class="synIdentifier">i</span> <span class="synStatement">==</span> <span class="synConstant">90000</span> <span class="synSpecial">)</span> <span class="synSpecial">{</span>
    <span class="synStatement">$</span><span class="synIdentifier">user_id</span> <span class="synStatement">=</span> <span class="synConstant">20000</span>;
    <span class="synStatement">$</span><span class="synIdentifier">production_id</span> <span class="synStatement">=</span> <span class="synConstant">10</span>;
    <span class="synStatement">$</span><span class="synIdentifier">device_id</span> <span class="synStatement">=</span> <span class="synConstant">987654321</span>;
<span class="synSpecial">}</span>
<span class="synIdentifier">mysql_query</span><span class="synSpecial">(</span> '<span class="synConstant">INSERT INTO User( user_id ) VALUES( </span>' <span class="synStatement">.</span> <span class="synStatement">$</span><span class="synIdentifier">user_id</span> <span class="synStatement">.</span> '<span class="synConstant">)</span>'<span class="synSpecial">)</span>;
<span class="synIdentifier">mysql_query</span><span class="synSpecial">(</span> '<span class="synConstant">INSERT INTO Production( production_id ) VALUES( </span>' <span class="synStatement">.</span> <span class="synStatement">$</span><span class="synIdentifier">production_id</span> <span class="synStatement">.</span> '<span class="synConstant">)</span>'<span class="synSpecial">)</span>; 
<span class="synIdentifier">mysql_query</span><span class="synSpecial">(</span> '<span class="synConstant">INSERT INTO Download( user_id,production_id,device_id,download_date) VALUES( </span>' <span class="synStatement">.</span> <span class="synStatement">$</span><span class="synIdentifier">user_id</span> <span class="synStatement">.</span> '<span class="synConstant">, </span>' <span class="synStatement">.</span> <span class="synStatement">$</span><span class="synIdentifier">production_id</span> <span class="synStatement">.</span> '<span class="synConstant">,</span>' <span class="synStatement">.</span> <span class="synStatement">$</span><span class="synIdentifier">device_id</span> <span class="synStatement">.</span> '<span class="synConstant">, NOW() )</span>'<span class="synSpecial">)</span>;
<span class="synSpecial">}</span>   
</pre>
</div>
<div class="section">
<h5><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%ED%A5%B2%A1%BC%A5%C8">サロゲート</a>方式</h5>
<p>explain結果で基本的には指定した複合indexが使われて検索が出来ていることが分かりますがuser_idを指定しないとdeviceという名前のindexが使われないので注意が必要です。user_idを指定しない場合のindexが必要であれば別途作成が必要になります。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>Pattern1 : 
mysql> <span class="synStatement">EXPLAIN</span> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span>;
+<span class="synComment">----+-------------+----------+------+---------------+--------+---------+-------+------+-------------+</span>
| id | select_type | <span class="synSpecial">table</span>    | <span class="synSpecial">type</span> | possible_keys | key    | key_len | ref   | <span class="synSpecial">rows</span> | Extra       |
+<span class="synComment">----+-------------+----------+------+---------------+--------+---------+-------+------+-------------+</span>
|  <span class="synConstant">1</span> | SIMPLE      | Download | ref  | device        | device | <span class="synConstant">4</span>       | const |    <span class="synConstant">3</span> | <span class="synSpecial">Using</span> <span class="synSpecial">index</span> |
+<span class="synComment">----+-------------+----------+------+---------------+--------+---------+-------+------+-------------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

Pattern2 : 
mysql> <span class="synStatement">EXPLAIN</span> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> production_id = <span class="synConstant">10</span>;
+<span class="synComment">----+-------------+----------+------+--------------------------------+--------+---------+-------------+------+-------------+</span>
| id | select_type | <span class="synSpecial">table</span>    | <span class="synSpecial">type</span> | possible_keys                  | key    | key_len | ref         | <span class="synSpecial">rows</span> | Extra       |
+<span class="synComment">----+-------------+----------+------+--------------------------------+--------+---------+-------------+------+-------------+</span>
|  <span class="synConstant">1</span> | SIMPLE      | Download | ref  | device,fk_Download_Production1 | device | <span class="synConstant">8</span>       | const,const |    <span class="synConstant">2</span> | <span class="synSpecial">Using</span> <span class="synSpecial">index</span> |
+<span class="synComment">----+-------------+----------+------+--------------------------------+--------+---------+-------------+------+-------------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

Pattern3 : 
mysql> <span class="synStatement">EXPLAIN</span> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> production_id = <span class="synConstant">10</span> <span class="synStatement">AND</span> device_id = <span class="synConstant">123456789</span>;
+<span class="synComment">----+-------------+----------+------+-------------------------+-------------------------+---------+-------+------+-------------+</span>
| id | select_type | <span class="synSpecial">table</span>    | <span class="synSpecial">type</span> | possible_keys           | key                     | key_len | ref   | <span class="synSpecial">rows</span> | Extra       |
+<span class="synComment">----+-------------+----------+------+-------------------------+-------------------------+---------+-------+------+-------------+</span>
|  <span class="synConstant">1</span> | SIMPLE      | Download | ref  | fk_Download_Production1 | fk_Download_Production1 | <span class="synConstant">4</span>       | const |   <span class="synConstant">44</span> | <span class="synSpecial">Using</span> <span class="synSpecial">where</span> |
+<span class="synComment">----+-------------+----------+------+-------------------------+-------------------------+---------+-------+------+-------------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

Pattern4 : 
mysql> <span class="synStatement">EXPLAIN</span> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> device_id = <span class="synConstant">123456789</span>;
+<span class="synComment">----+-------------+----------+------+---------------+--------+---------+-------+------+--------------------------+</span>
| id | select_type | <span class="synSpecial">table</span>    | <span class="synSpecial">type</span> | possible_keys | key    | key_len | ref   | <span class="synSpecial">rows</span> | Extra                    |
+<span class="synComment">----+-------------+----------+------+---------------+--------+---------+-------+------+--------------------------+</span>
|  <span class="synConstant">1</span> | SIMPLE      | Download | ref  | device        | device | <span class="synConstant">4</span>       | const |    <span class="synConstant">3</span> | <span class="synSpecial">Using</span> <span class="synSpecial">where</span>; <span class="synSpecial">Using</span> <span class="synSpecial">index</span> |
+<span class="synComment">----+-------------+----------+------+---------------+--------+---------+-------+------+--------------------------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

Pattern5 : 
mysql> <span class="synStatement">EXPLAIN</span> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> production_id = <span class="synConstant">10</span> <span class="synStatement">AND</span> device_id = <span class="synConstant">123456789</span>;
+<span class="synComment">----+-------------+----------+------+--------------------------------+--------+---------+-------------+------+--------------------------+</span>
| id | select_type | <span class="synSpecial">table</span>    | <span class="synSpecial">type</span> | possible_keys                  | key    | key_len | ref         | <span class="synSpecial">rows</span> | Extra                    |
+<span class="synComment">----+-------------+----------+------+--------------------------------+--------+---------+-------------+------+--------------------------+</span>
|  <span class="synConstant">1</span> | SIMPLE      | Download | ref  | device,fk_Download_Production1 | device | <span class="synConstant">8</span>       | const,const |    <span class="synConstant">1</span> | <span class="synSpecial">Using</span> <span class="synSpecial">where</span>; <span class="synSpecial">Using</span> <span class="synSpecial">index</span> |
+<span class="synComment">----+-------------+----------+------+--------------------------------+--------+---------+-------------+------+--------------------------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">10</span> sec)

Pattern6 :
mysql> <span class="synStatement">EXPLAIN</span> <span class="synStatement">SELECT</span> COUNT( device_id ) <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> production_id = <span class="synConstant">10</span>;
+<span class="synComment">----+-------------+----------+------+--------------------------------+--------+---------+-------------+------+-------------+</span>
| id | select_type | <span class="synSpecial">table</span>    | <span class="synSpecial">type</span> | possible_keys                  | key    | key_len | ref         | <span class="synSpecial">rows</span> | Extra       |
+<span class="synComment">----+-------------+----------+------+--------------------------------+--------+---------+-------------+------+-------------+</span>
|  <span class="synConstant">1</span> | SIMPLE      | Download | ref  | device,fk_Download_Production1 | device | <span class="synConstant">8</span>       | const,const |    <span class="synConstant">2</span> | <span class="synSpecial">Using</span> <span class="synSpecial">index</span> |
+<span class="synComment">----+-------------+----------+------+--------------------------------+--------+---------+-------------+------+-------------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)
</pre><p>SELECTをそれぞれ実行してtimeを算出します。若干面倒ですがquery_cacheを毎回削除してからSELECTの実行具合を確認します。どれも高速に処理が進みます。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16768384</span> |
| Qcache_hits             | <span class="synConstant">0</span>        |
| Qcache_inserts          | <span class="synConstant">0</span>        |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">0</span>        |
| Qcache_queries_in_cache | <span class="synConstant">0</span>        |
| Qcache_total_blocks     | <span class="synConstant">1</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span>;
+<span class="synComment">---------+---------------+-----------+</span>
| user_id | production_id | device_id |
+<span class="synComment">---------+---------------+-----------+</span>
|   <span class="synConstant">20000</span> |             <span class="synConstant">5</span> | <span class="synConstant">123456789</span> |
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">123456789</span> |
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">987654321</span> |
+<span class="synComment">---------+---------------+-----------+</span>
<span class="synConstant">3</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">01</span> sec)

mysql> RESET QUERY CACHE;
Query OK, <span class="synConstant">0</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16768384</span> |
| Qcache_hits             | <span class="synConstant">0</span>        |
| Qcache_inserts          | <span class="synConstant">1</span>        |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">0</span>        |
| Qcache_queries_in_cache | <span class="synConstant">0</span>        |
| Qcache_total_blocks     | <span class="synConstant">1</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> production_id = <span class="synConstant">10</span>;
+<span class="synComment">---------+---------------+-----------+</span>
| user_id | production_id | device_id |
+<span class="synComment">---------+---------------+-----------+</span>
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">123456789</span> |
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">987654321</span> |
+<span class="synComment">---------+---------------+-----------+</span>
<span class="synConstant">2</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16766848</span> |
| Qcache_hits             | <span class="synConstant">0</span>        |
| Qcache_inserts          | <span class="synConstant">2</span>        |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">0</span>        |
| Qcache_queries_in_cache | <span class="synConstant">1</span>        |
| Qcache_total_blocks     | <span class="synConstant">4</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> RESET QUERY CACHE;
Query OK, <span class="synConstant">0</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16768384</span> |
| Qcache_hits             | <span class="synConstant">0</span>        |
| Qcache_inserts          | <span class="synConstant">2</span>        |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">0</span>        |
| Qcache_queries_in_cache | <span class="synConstant">0</span>        |
| Qcache_total_blocks     | <span class="synConstant">1</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql>  <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> production_id = <span class="synConstant">10</span> <span class="synStatement">AND</span> device_id = <span class="synConstant">123456789</span>;
+<span class="synComment">---------+---------------+-----------+</span>
| user_id | production_id | device_id |
+<span class="synComment">---------+---------------+-----------+</span>
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">123456789</span> |
+<span class="synComment">---------+---------------+-----------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">01</span> sec)

mysql> RESET QUERY CACHE;Query OK, <span class="synConstant">0</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16768384</span> |
| Qcache_hits             | <span class="synConstant">0</span>        |
| Qcache_inserts          | <span class="synConstant">3</span>        |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">0</span>        |
| Qcache_queries_in_cache | <span class="synConstant">0</span>        |
| Qcache_total_blocks     | <span class="synConstant">1</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> device_id = <span class="synConstant">123456789</span>;
+<span class="synComment">---------+---------------+-----------+</span>
| user_id | production_id | device_id |
+<span class="synComment">---------+---------------+-----------+</span>
|   <span class="synConstant">20000</span> |             <span class="synConstant">5</span> | <span class="synConstant">123456789</span> |
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">123456789</span> |
+<span class="synComment">---------+---------------+-----------+</span>
<span class="synConstant">2</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> RESET QUERY CACHE;
Query OK, <span class="synConstant">0</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16768384</span> |
| Qcache_hits             | <span class="synConstant">0</span>        |
| Qcache_inserts          | <span class="synConstant">4</span>        |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">0</span>        |
| Qcache_queries_in_cache | <span class="synConstant">0</span>        |
| Qcache_total_blocks     | <span class="synConstant">1</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> production_id = <span class="synConstant">10</span> <span class="synStatement">AND</span> device_id = <span class="synConstant">123456789</span>;
+<span class="synComment">---------+---------------+-----------+</span>
| user_id | production_id | device_id |
+<span class="synComment">---------+---------------+-----------+</span>
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">123456789</span> |
+<span class="synComment">---------+---------------+-----------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> RESET QUERY CACHE;
Query OK, <span class="synConstant">0</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16768384</span> |
| Qcache_hits             | <span class="synConstant">5</span>        |
| Qcache_inserts          | <span class="synConstant">24</span>       |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">7</span>        |
| Qcache_queries_in_cache | <span class="synConstant">0</span>        |
| Qcache_total_blocks     | <span class="synConstant">1</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> <span class="synStatement">SELECT</span> COUNT( device_id ) <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> production_id = <span class="synConstant">10</span>;
+<span class="synComment">--------------------+</span>
| COUNT( device_id ) |
+<span class="synComment">--------------------+</span>
|                  <span class="synConstant">4</span> |
+<span class="synComment">--------------------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">01</span> sec)
</pre><p>試しにINDEXを削除して挙動を確認します。少々面倒ですが外部KEY制約を解除しないとINDEXが削除できないのでそこからやります。INDEX無しのWHERE句参照でもそこそこ早く処理が進んでいるようです。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>mysql> <span class="synStatement">ALTER</span> <span class="synSpecial">TABLE</span> Download <span class="synStatement">DROP</span> FOREIGN KEY fk_Download_Production1;
Query OK, <span class="synConstant">100000</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">3</span>.<span class="synConstant">09</span> sec)
Records: <span class="synConstant">100000</span>  Duplicates: <span class="synConstant">0</span>  Warnings: <span class="synConstant">0</span>

mysql> <span class="synStatement">ALTER</span> <span class="synSpecial">TABLE</span> Download <span class="synStatement">DROP</span> FOREIGN KEY fk_Download_User;
Query OK, <span class="synConstant">100000</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">3</span>.<span class="synConstant">30</span> sec)
Records: <span class="synConstant">100000</span>  Duplicates: <span class="synConstant">0</span>  Warnings: <span class="synConstant">0</span>

mysql> <span class="synStatement">DROP</span> <span class="synSpecial">INDEX</span> device <span class="synSpecial">ON</span> download;
Query OK, <span class="synConstant">100000</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">1</span>.<span class="synConstant">20</span> sec)
Records: <span class="synConstant">100000</span>  Duplicates: <span class="synConstant">0</span>  Warnings: <span class="synConstant">0</span>

mysql> <span class="synStatement">DROP</span> <span class="synSpecial">INDEX</span> fk_Download_Production1 <span class="synSpecial">ON</span> download;
Query OK, <span class="synConstant">100000</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">0</span>.<span class="synConstant">83</span> sec)
Records: <span class="synConstant">100000</span>  Duplicates: <span class="synConstant">0</span>  Warnings: <span class="synConstant">0</span>

mysql> RESET QUERY CACHE;Query OK, <span class="synConstant">0</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16768384</span> |
| Qcache_hits             | <span class="synConstant">0</span>        |
| Qcache_inserts          | <span class="synConstant">10</span>       |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">1</span>        |
| Qcache_queries_in_cache | <span class="synConstant">0</span>        |
| Qcache_total_blocks     | <span class="synConstant">1</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span>;
+<span class="synComment">---------+---------------+-----------+</span>
| user_id | production_id | device_id |
+<span class="synComment">---------+---------------+-----------+</span>
|   <span class="synConstant">20000</span> |             <span class="synConstant">5</span> | <span class="synConstant">123456789</span> |
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">123456789</span> |
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">987654321</span> |
+<span class="synComment">---------+---------------+-----------+</span>
<span class="synConstant">3</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">04</span> sec)

mysql> RESET QUERY CACHE;
Query OK, <span class="synConstant">0</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16768384</span> |
| Qcache_hits             | <span class="synConstant">0</span>        |
| Qcache_inserts          | <span class="synConstant">11</span>       |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">1</span>        |
| Qcache_queries_in_cache | <span class="synConstant">0</span>        |
| Qcache_total_blocks     | <span class="synConstant">1</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> production_id = <span class="synConstant">10</span>;
+<span class="synComment">---------+---------------+-----------+</span>
| user_id | production_id | device_id |
+<span class="synComment">---------+---------------+-----------+</span>
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">123456789</span> |
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">987654321</span> |
+<span class="synComment">---------+---------------+-----------+</span>
<span class="synConstant">2</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">05</span> sec)

mysql> RESET QUERY CACHE;
Query OK, <span class="synConstant">0</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">0</span>.<span class="synConstant">01</span> sec)

mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16768384</span> |
| Qcache_hits             | <span class="synConstant">0</span>        |
| Qcache_inserts          | <span class="synConstant">12</span>       |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">1</span>        |
| Qcache_queries_in_cache | <span class="synConstant">0</span>        |
| Qcache_total_blocks     | <span class="synConstant">1</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> production_id = <span class="synConstant">10</span> <span class="synStatement">AND</span> device_id = <span class="synConstant">123456789</span>;
+<span class="synComment">---------+---------------+-----------+</span>
| user_id | production_id | device_id |
+<span class="synComment">---------+---------------+-----------+</span>
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">123456789</span> |
+<span class="synComment">---------+---------------+-----------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">04</span> sec)

mysql> RESET QUERY CACHE;
Query OK, <span class="synConstant">0</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16768384</span> |
| Qcache_hits             | <span class="synConstant">0</span>        |
| Qcache_inserts          | <span class="synConstant">13</span>       |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">1</span>        |
| Qcache_queries_in_cache | <span class="synConstant">0</span>        |
| Qcache_total_blocks     | <span class="synConstant">1</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> device_id = <span class="synConstant">123456789</span>;
+<span class="synComment">---------+---------------+-----------+</span>
| user_id | production_id | device_id |
+<span class="synComment">---------+---------------+-----------+</span>
|   <span class="synConstant">20000</span> |             <span class="synConstant">5</span> | <span class="synConstant">123456789</span> |
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">123456789</span> |
+<span class="synComment">---------+---------------+-----------+</span>
<span class="synConstant">2</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">05</span> sec)

mysql> RESET QUERY CACHE;Query OK, <span class="synConstant">0</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16768384</span> |
| Qcache_hits             | <span class="synConstant">0</span>        |
| Qcache_inserts          | <span class="synConstant">14</span>       |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">1</span>        |
| Qcache_queries_in_cache | <span class="synConstant">0</span>        |
| Qcache_total_blocks     | <span class="synConstant">1</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> production_id = <span class="synConstant">10</span> <span class="synStatement">AND</span> device_id = <span class="synConstant">123456789</span>;
+<span class="synComment">---------+---------------+-----------+</span>
| user_id | production_id | device_id |
+<span class="synComment">---------+---------------+-----------+</span>
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">123456789</span> |
+<span class="synComment">---------+---------------+-----------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">04</span> sec)

mysql> RESET QUERY CACHE;
Query OK, <span class="synConstant">0</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16768384</span> |
| Qcache_hits             | <span class="synConstant">5</span>        |
| Qcache_inserts          | <span class="synConstant">23</span>       |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">2</span>        |
| Qcache_queries_in_cache | <span class="synConstant">0</span>        |
| Qcache_total_blocks     | <span class="synConstant">1</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> <span class="synStatement">SELECT</span> COUNT( device_id ) <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> production_id = <span class="synConstant">10</span>;
+<span class="synComment">--------------------+</span>
| COUNT( device_id ) |
+<span class="synComment">--------------------+</span>
|                  <span class="synConstant">4</span> |
+<span class="synComment">--------------------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">04</span> sec)
</pre>
</div>
<div class="section">
<h5>複合プライマリ方式</h5>
<p>explain結果 PRIMARYで検索が出来ていることが分かります。上のschema定義ではindexを張ってしまったがPRIMARY検索が出来ているようであれば不要なように思います。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>Pattern1 : 
mysql> <span class="synStatement">EXPLAIN</span> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span>;
+<span class="synComment">----+-------------+----------+------+----------------+---------+---------+-------+------+-------------+</span>
| id | select_type | <span class="synSpecial">table</span>    | <span class="synSpecial">type</span> | possible_keys  | key     | key_len | ref   | <span class="synSpecial">rows</span> | Extra       |
+<span class="synComment">----+-------------+----------+------+----------------+---------+---------+-------+------+-------------+</span>
|  <span class="synConstant">1</span> | SIMPLE      | Download | ref  | PRIMARY,device | PRIMARY | <span class="synConstant">4</span>       | const |    <span class="synConstant">4</span> | <span class="synSpecial">Using</span> <span class="synSpecial">index</span> |
+<span class="synComment">----+-------------+----------+------+----------------+---------+---------+-------+------+-------------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

Pattern2 : 
mysql> <span class="synStatement">EXPLAIN</span> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> production_id = <span class="synConstant">10</span>;
+<span class="synComment">----+-------------+----------+------+----------------------------------------+--------+---------+-------------+------+-------------+</span>
| id | select_type | <span class="synSpecial">table</span>    | <span class="synSpecial">type</span> | possible_keys                          | key    | key_len | ref         | <span class="synSpecial">rows</span> | Extra       |
+<span class="synComment">----+-------------+----------+------+----------------------------------------+--------+---------+-------------+------+-------------+</span>
|  <span class="synConstant">1</span> | SIMPLE      | Download | ref  | PRIMARY,device,fk_Download_Production1 | device | <span class="synConstant">8</span>       | const,const |    <span class="synConstant">2</span> | <span class="synSpecial">Using</span> <span class="synSpecial">index</span> |
+<span class="synComment">----+-------------+----------+------+----------------------------------------+--------+---------+-------------+------+-------------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

Pattern3 : 
mysql> <span class="synStatement">EXPLAIN</span> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> production_id = <span class="synConstant">10</span> <span class="synStatement">AND</span> device_id = <span class="synConstant">123456789</span>;
+<span class="synComment">----+-------------+----------+------+-------------------------+-------------------------+---------+-------+------+--------------------------+</span>
| id | select_type | <span class="synSpecial">table</span>    | <span class="synSpecial">type</span> | possible_keys           | key                     | key_len | ref   | <span class="synSpecial">rows</span> | Extra                    |
+<span class="synComment">----+-------------+----------+------+-------------------------+-------------------------+---------+-------+------+--------------------------+</span>
|  <span class="synConstant">1</span> | SIMPLE      | Download | ref  | fk_Download_Production1 | fk_Download_Production1 | <span class="synConstant">4</span>       | const |   <span class="synConstant">59</span> | <span class="synSpecial">Using</span> <span class="synSpecial">where</span>; <span class="synSpecial">Using</span> <span class="synSpecial">index</span> |
+<span class="synComment">----+-------------+----------+------+-------------------------+-------------------------+---------+-------+------+--------------------------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

Pattern4 : 
mysql> <span class="synStatement">EXPLAIN</span> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> device_id = <span class="synConstant">123456789</span>;
+<span class="synComment">----+-------------+----------+------+----------------+---------+---------+-------+------+--------------------------+</span>
| id | select_type | <span class="synSpecial">table</span>    | <span class="synSpecial">type</span> | possible_keys  | key     | key_len | ref   | <span class="synSpecial">rows</span> | Extra                    |
+<span class="synComment">----+-------------+----------+------+----------------+---------+---------+-------+------+--------------------------+</span>
|  <span class="synConstant">1</span> | SIMPLE      | Download | ref  | PRIMARY,device | PRIMARY | <span class="synConstant">4</span>       | const |    <span class="synConstant">4</span> | <span class="synSpecial">Using</span> <span class="synSpecial">where</span>; <span class="synSpecial">Using</span> <span class="synSpecial">index</span> |
+<span class="synComment">----+-------------+----------+------+----------------+---------+---------+-------+------+--------------------------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

Pattern5 : 
mysql> <span class="synStatement">EXPLAIN</span> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> production_id = <span class="synConstant">10</span> <span class="synStatement">AND</span> device_id = <span class="synConstant">123456789</span>;
+<span class="synComment">----+-------------+----------+------+----------------------------------------+--------+---------+-------------+------+--------------------------+</span>
| id | select_type | <span class="synSpecial">table</span>    | <span class="synSpecial">type</span> | possible_keys                          | key    | key_len | ref         | <span class="synSpecial">rows</span> | Extra                    |
+<span class="synComment">----+-------------+----------+------+----------------------------------------+--------+---------+-------------+------+--------------------------+</span>
|  <span class="synConstant">1</span> | SIMPLE      | Download | ref  | PRIMARY,device,fk_Download_Production1 | device | <span class="synConstant">8</span>       | const,const |    <span class="synConstant">2</span> | <span class="synSpecial">Using</span> <span class="synSpecial">where</span>; <span class="synSpecial">Using</span> <span class="synSpecial">index</span> |
+<span class="synComment">----+-------------+----------+------+----------------------------------------+--------+---------+-------------+------+--------------------------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> <span class="synStatement">EXPLAIN</span> <span class="synStatement">SELECT</span> COUNT( device_id ) <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> production_id = <span class="synConstant">10</span>;
+<span class="synComment">----+-------------+----------+------+----------------------------------------+---------+---------+-------------+------+-------------+</span>
| id | select_type | <span class="synSpecial">table</span>    | <span class="synSpecial">type</span> | possible_keys                          | key     | key_len | ref         | <span class="synSpecial">rows</span> | Extra       |
+<span class="synComment">----+-------------+----------+------+----------------------------------------+---------+---------+-------------+------+-------------+</span>
|  <span class="synConstant">1</span> | SIMPLE      | Download | ref  | PRIMARY,device,fk_Download_Production1 | PRIMARY | <span class="synConstant">8</span>       | const,const |    <span class="synConstant">3</span> | <span class="synSpecial">Using</span> <span class="synSpecial">index</span> |
+<span class="synComment">----+-------------+----------+------+----------------------------------------+---------+---------+-------------+------+-------------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)
</pre><p>同様にSELECTを実行します。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>mysql> RESET QUERY CACHE;
Query OK, <span class="synConstant">0</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16768384</span> |
| Qcache_hits             | <span class="synConstant">0</span>        |
| Qcache_inserts          | <span class="synConstant">5</span>        |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">0</span>        |
| Qcache_queries_in_cache | <span class="synConstant">0</span>        |
| Qcache_total_blocks     | <span class="synConstant">1</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span>;
+<span class="synComment">---------+---------------+-----------+</span>
| user_id | production_id | device_id |
+<span class="synComment">---------+---------------+-----------+</span>
|   <span class="synConstant">20000</span> |             <span class="synConstant">5</span> | <span class="synConstant">123456789</span> |
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">123456789</span> |
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">987654321</span> |
|   <span class="synConstant">20000</span> |           <span class="synConstant">494</span> | <span class="synConstant">1714311</span>   |
+<span class="synComment">---------+---------------+-----------+</span>
<span class="synConstant">4</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">01</span> sec)

mysql> RESET QUERY CACHE;
Query OK, <span class="synConstant">0</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16768384</span> |
| Qcache_hits             | <span class="synConstant">0</span>        |
| Qcache_inserts          | <span class="synConstant">6</span>        |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">0</span>        |
| Qcache_queries_in_cache | <span class="synConstant">0</span>        |
| Qcache_total_blocks     | <span class="synConstant">1</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> production_id = <span class="synConstant">10</span>;
+<span class="synComment">---------+---------------+-----------+</span>
| user_id | production_id | device_id |
+<span class="synComment">---------+---------------+-----------+</span>
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">123456789</span> |
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">987654321</span> |
+<span class="synComment">---------+---------------+-----------+</span>
<span class="synConstant">2</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> RESET QUERY CACHE;
Query OK, <span class="synConstant">0</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16768384</span> |
| Qcache_hits             | <span class="synConstant">0</span>        |
| Qcache_inserts          | <span class="synConstant">7</span>        |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">0</span>        |
| Qcache_queries_in_cache | <span class="synConstant">0</span>        |
| Qcache_total_blocks     | <span class="synConstant">1</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> production_id = <span class="synConstant">10</span> <span class="synStatement">AND</span> device_id = <span class="synConstant">123456789</span>;
+<span class="synComment">---------+---------------+-----------+</span>
| user_id | production_id | device_id |
+<span class="synComment">---------+---------------+-----------+</span>
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">123456789</span> |
+<span class="synComment">---------+---------------+-----------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> RESET QUERY CACHE;Query OK, <span class="synConstant">0</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16768384</span> |
| Qcache_hits             | <span class="synConstant">0</span>        |
| Qcache_inserts          | <span class="synConstant">8</span>        |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">0</span>        |
| Qcache_queries_in_cache | <span class="synConstant">0</span>        |
| Qcache_total_blocks     | <span class="synConstant">1</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> device_id = <span class="synConstant">123456789</span>;
+<span class="synComment">---------+---------------+-----------+</span>
| user_id | production_id | device_id |
+<span class="synComment">---------+---------------+-----------+</span>
|   <span class="synConstant">20000</span> |             <span class="synConstant">5</span> | <span class="synConstant">123456789</span> |
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">123456789</span> |
+<span class="synComment">---------+---------------+-----------+</span>
<span class="synConstant">2</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> RESET QUERY CACHE;
Query OK, <span class="synConstant">0</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16768384</span> |
| Qcache_hits             | <span class="synConstant">0</span>        |
| Qcache_inserts          | <span class="synConstant">9</span>        |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">0</span>        |
| Qcache_queries_in_cache | <span class="synConstant">0</span>        |
| Qcache_total_blocks     | <span class="synConstant">1</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> <span class="synStatement">SELECT</span> user_id,production_id,device_id <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> production_id = <span class="synConstant">10</span> <span class="synStatement">AND</span> device_id = <span class="synConstant">123456789</span>;
+<span class="synComment">---------+---------------+-----------+</span>
| user_id | production_id | device_id |
+<span class="synComment">---------+---------------+-----------+</span>
|   <span class="synConstant">20000</span> |            <span class="synConstant">10</span> | <span class="synConstant">123456789</span> |
+<span class="synComment">---------+---------------+-----------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> RESET QUERY CACHE;Query OK, <span class="synConstant">0</span> <span class="synSpecial">rows</span> affected (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> SHOW STATUS <span class="synStatement">LIKE</span> <span class="synConstant">'%Qcache%'</span>;
+<span class="synComment">-------------------------+----------+</span>
| Variable_name           | Value    |
+<span class="synComment">-------------------------+----------+</span>
| Qcache_free_blocks      | <span class="synConstant">1</span>        |
| Qcache_free_memory      | <span class="synConstant">16768384</span> |
| Qcache_hits             | <span class="synConstant">5</span>        |
| Qcache_inserts          | <span class="synConstant">22</span>       |
| Qcache_lowmem_prunes    | <span class="synConstant">0</span>        |
| Qcache_not_cached       | <span class="synConstant">2</span>        |
| Qcache_queries_in_cache | <span class="synConstant">0</span>        |
| Qcache_total_blocks     | <span class="synConstant">1</span>        |
+<span class="synComment">-------------------------+----------+</span>
<span class="synConstant">8</span> <span class="synSpecial">rows</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)

mysql> <span class="synStatement">SELECT</span> COUNT( device_id ) <span class="synSpecial">FROM</span> Download <span class="synSpecial">WHERE</span> user_id = <span class="synConstant">20000</span> <span class="synStatement">AND</span> production_id = <span class="synConstant">10</span>;
+<span class="synComment">--------------------+</span>
| COUNT( device_id ) |
+<span class="synComment">--------------------+</span>
|                  <span class="synConstant">3</span> |
+<span class="synComment">--------------------+</span>
<span class="synConstant">1</span> <span class="synSpecial">row</span> <span class="synStatement">in</span> <span class="synStatement">set</span> (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)
</pre>
</div>
</blockquote>

</div>
<div class="section">
<h4>検証内容</h4>

<blockquote>
    
<ul>
<li>上のテーブル<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AD%A1%BC%A5%DE">スキーマ</a>である場合<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%ED%A5%B2%A1%BC%A5%C8">サロゲート</a>でも複合プライマリでもINDEXを適切に張れば高速に動作する事が分かります。この例だけで考えると<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%ED%A5%B2%A1%BC%A5%C8">サロゲート</a>を直接条件指定することが無いので複合プライマリーの設定の方が良いように思います。理由は無駄なデータとINDEXを持たなくて済む事と検索にPRIMARYを利用できるという点です。更にレコードをuser_id、production_id、device_idの3つの掛け合わせで一意としたい場合、誤ってアプリケーションが同じデータをINSERTしても自動的にエラーにしてくれます。<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%ED%A5%B2%A1%BC%A5%C8">サロゲート</a>だと今のところDB設定で<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%A3%BF%F4">複数</a>レコード挿入をOKとしているので、アプリケーション側でちゃんと制御してあげる必要が出てしまいます。これを回避するのであれば複合ユニークキーを利用する手段もありますが、それを使うのであれば今回のキー選択は複合主キーを利用すべきということも言えると思います。</li>
<li>INDEXと話が変わりますが複合主キーの場合はUPSERT構文が利用できます。これは何かというとINSERT構文にUPDATE構文も掛け合わせる事が可能で、コードとしても無駄なSELECTを挟まずに済むために処理がすっきりします。<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%ED%A5%B2%A1%BC%A5%C8">サロゲート</a>方式でもこの構文を記述する事ができますが今のテーブルschemaだと同一レコードとしての更新ができないのでレコードが増えてしまいますしデータの定義が異なってしまいます。</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">INSERT</span> <span class="synSpecial">INTO</span> Download( user_id,production_id,device_id,download_date ) <span class="synSpecial">VALUES</span>( <span class="synConstant">20000</span>, <span class="synConstant">10</span>, <span class="synConstant">123456789</span>, NOW() ) <span class="synSpecial">ON</span> DUPLICATE KEY <span class="synStatement">UPDATE</span> download_date = NOW();
</pre>
</blockquote>

</div>
<div class="section">
<h4>リンク</h4>

<blockquote>
    
<ul>
<li><a href="http://ja.wikipedia.org/wiki/主キー">主キー</a></li>
<li><a href="http://www.shift-the-oracle.com/constraint/">整合性制約</a></li>
</ul>
</blockquote>

</div>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://yutakikuchi.github.io/post/201201240753/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://yutakikuchi.github.io/post/201201240753/">PHPにおける時間表記のISO-8061、DATE_ATOM、DATE_RFC3309、DATE_W3Cの違いは何か</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://yutakikuchi.github.io/post/201202050219/">PHPのHash/暗号化関数の使用方法まとめ</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://yutakikuchi.github.io/post/201202050219/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>

</div>
</div>
<script src="https://yutakikuchi.github.io/js/ui.js"></script>
<script src="https://yutakikuchi.github.io/js/menus.js"></script>


<script>
  
  if (window.location.hostname != "localhost") {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-20616165-3', 'auto');
    ga('send', 'pageview');
  }
</script>





</body>
</html>

