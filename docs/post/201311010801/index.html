<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="canonical" href="http://yut.hatenablog.com/entry/20131101/1383260489" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.55.4" />

  <title>C&#43;&#43;でApache Moduleを書きたい人へのTutorial &middot; Y&#39;s note</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://yutakikuchi.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://yutakikuchi.github.io/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://yutakikuchi.github.io/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://yutakikuchi.github.io/img/favicon.ico" type="image/x-icon" />

  
    
        <link rel="stylesheet" href="https://yutakikuchi.github.io/css/my.css">
    
  
  
    
        <script src="https://yutakikuchi.github.io/js/my.js"></script>
    
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://yutakikuchi.github.io/">Y's note</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/yutakikuchi_" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://facebook.com/yuta.kikuchi.007" target="_blank"><i class="fa fa-facebook-square fa-fw"></i>Facebook</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="http://slideshare.net/https://www.slideshare.net/yutakikuchi58/" target="_blank"><i class="fa fa-slideshare fa-fw"></i>SlideShare</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/https://www.linkedin.com/in/%E4%BD%91%E5%A4%AA-%E8%8F%8A%E6%B1%A0-36291a44/" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/yutakikuchi" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2019. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>C&#43;&#43;でApache Moduleを書きたい人へのTutorial</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2013 Nov 01, 08:01</time>
  </div>

  

  

  

</div>

  

<h2 id="c-c-でapache-moduleを書きたい人へのtutorial">[C++] : C++でApache Moduleを書きたい人へのTutorial</h2>

<div class="section">
<h4><a class="keyword" href="http://d.hatena.ne.jp/keyword/C%2B%2B">C++</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a> Module Tutorial</h4>

<blockquote>
    <p>あどさーばー作っています<a href='https://twitter.com/yutakikuc'>@yutakikuc</a>です。<br />
広告配信等の処理高速化の実現手段としてCを使って<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>/NginxのModuleレイヤーで処理を書く事があります。<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>/NginxのModuleは<span class="deco" style="color:#FF0000;font-weight:bold;">Cを基本</span>としているんですが、char*の処理は面倒でstringにしたい、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CF%A2%C1%DB%C7%DB%CE%F3">連想配列</a>でデータを管理し易くしたい、その他<a class="keyword" href="http://d.hatena.ne.jp/keyword/C%2B%2B">C++</a>にしか無いライブラリを使いたいといった<span class="deco" style="color:#FF0000;font-weight:bold;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/C%2B%2B">C++</a>への欲求</span>が出てきてしまいます。ぐぐっても<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a> Moduleを<a class="keyword" href="http://d.hatena.ne.jp/keyword/C%2B%2B">C++</a>で実現している人って結構少なく、おそらく一般的には<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a> Moduleにそんな複雑な処理を書く要件や期待なんて無いんだろうなと想像はしていますが、このエントリーでは<a class="keyword" href="http://d.hatena.ne.jp/keyword/C%2B%2B">C++</a>で書いてみます(笑)。</p><br />
<p><a href="http://wolfgang.groogroo.com/apache-cplusplus/">Apache API C++ Cookbook</a> <a href="http://b.hatena.ne.jp/entry/wolfgang.groogroo.com/apache-cplusplus/"><img src="http://b.hatena.ne.jp/entry/image/http://wolfgang.groogroo.com/apache-cplusplus/" alt="はてなブックマーク - Apache API C++ Cookbook" border="0" /></a><br />
<a href="http://www.codeproject.com/Articles/491909/Apache-2-x-Modules-In-Cplusplus-Part-1">Apache 2.x Modules In C++ (Part 1) - CodeProject</a> <a href="http://b.hatena.ne.jp/entry/www.codeproject.com/Articles/491909/Apache-2-x-Modules-In-Cplusplus-Part-1"><img src="http://b.hatena.ne.jp/entry/image/http://www.codeproject.com/Articles/491909/Apache-2-x-Modules-In-Cplusplus-Part-1" alt="はてなブックマーク - Apache 2.x Modules In C++ (Part 1) - CodeProject" border="0" /></a><br />
1つ目のサイトの「A <a class="keyword" href="http://d.hatena.ne.jp/keyword/Basic">Basic</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/C%2B%2B">C++</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a> Module Example」にExampleが載っているんですが内容が素晴らしく古くて使い物にならなかったり、2つ目のサイトは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Makefile">Makefile</a>の説明がよく分からないんで、僕がTutorial作ってみます。</p>

</blockquote>

</div>
<div class="section">
<h4><a class="keyword" href="http://d.hatena.ne.jp/keyword/C%2B%2B">C++</a> Source & <a class="keyword" href="http://d.hatena.ne.jp/keyword/Makefile">Makefile</a></h4>

<blockquote>
    
<div class="section">
<h5>Tutorial File</h5>
<p><a href="https://github.com/yutakikuchi/CPlus/tree/master/apache_module/tutorial">CPlus/apache_module/tutorial at master · yutakikuchi/CPlus</a> <a href="http://b.hatena.ne.jp/entry/s/github.com/yutakikuchi/CPlus/tree/master/apache_module/tutorial"><img src="http://b.hatena.ne.jp/entry/image/https://github.com/yutakikuchi/CPlus/tree/master/apache_module/tutorial" alt="はてなブックマーク - CPlus/apache_module/tutorial at master · yutakikuchi/CPlus" border="0" /></a><br />
下で使うTutorialの内容を置いておきました。</p>

</div>
<div class="section">
<h5>Package Install</h5>
<p>今回の<a class="keyword" href="http://d.hatena.ne.jp/keyword/C%2B%2B">C++</a> ApacheModule作成はCentOS6.4 <a class="keyword" href="http://d.hatena.ne.jp/keyword/x86">x86</a>_64でやっています。<br />
先に開発に必要なパッケージをInstallしておきましょう。</p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ sudo yum <span class="synStatement">install</span> httpd httpd-devel make gcc gcc-c++ <span class="synSpecial">-y</span>
$ tree
.
├── Makefile
└── mod_cpphello.cpp

<span class="synConstant">0</span> directories, <span class="synConstant">2</span> files
</pre>
</div>
<div class="section">
<h5><a class="keyword" href="http://d.hatena.ne.jp/keyword/C%2B%2B">C++</a> Source</h5>
<p>先に<a class="keyword" href="http://d.hatena.ne.jp/keyword/C%2B%2B">C++</a>のSourceを書きます。<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B3%C8%C4%A5%BB%D2">拡張子</a>はmod_cpphello.cppのように.cppとします。下のSourceは単純にHTMLの出力に「こんにちは！」というString型を埋め込むだけのものです。<a class="keyword" href="http://d.hatena.ne.jp/keyword/C%2B%2B">C++</a>記述によりstd::stringが使えるようになっているのが分かると思います。ポイントはmoduleの宣言をCでやるよとextern "C"で宣言することで使えるようになります。<a href="http://wolfgang.groogroo.com/apache-cplusplus/mod_cpphello/mod_cpphello.cpp">mod_cpphello.cpp</a> <a href="http://b.hatena.ne.jp/entry/wolfgang.groogroo.com/apache-cplusplus/mod_cpphello/mod_cpphello.cpp"><img src="http://b.hatena.ne.jp/entry/image/http://wolfgang.groogroo.com/apache-cplusplus/mod_cpphello/mod_cpphello.cpp" alt="はてなブックマーク - " border="0" /></a>ここのSampleがかなり奇麗にまとまったと思います。</p>
<pre class="hljs cpp" data-lang="cpp" data-unlink><span class="synPreProc">#include </span><span class="synConstant">"ap_config.h"</span>
<span class="synPreProc">#include </span><span class="synConstant">"apr.h"</span>
<span class="synPreProc">#include </span><span class="synConstant">"apr_lib.h"</span>
<span class="synPreProc">#include </span><span class="synConstant">"apr_strings.h"</span>
<span class="synPreProc">#include </span><span class="synConstant">"apr_network_io.h"</span>
<span class="synPreProc">#include </span><span class="synConstant">"apr_want.h"</span>
<span class="synPreProc">#include </span><span class="synConstant">"httpd.h"</span>
<span class="synPreProc">#include </span><span class="synConstant">"http_config.h"</span>
<span class="synPreProc">#include </span><span class="synConstant">"http_core.h"</span>
<span class="synPreProc">#include </span><span class="synConstant">"http_request.h"</span>
<span class="synPreProc">#include </span><span class="synConstant">"http_protocol.h"</span>
<span class="synPreProc">#include </span><span class="synConstant"><string></span>

<span class="synType">extern</span> <span class="synConstant">"C"</span> module AP_MODULE_DECLARE_DATA cpphello_module;

<span class="synType">typedef</span> <span class="synType">struct</span> {
<span class="synType">char</span> *hellomessage;
} cpphello_dir_config;

<span class="synType">static</span> <span class="synType">void</span> *cpphello_create_dir_config(apr_pool_t *p, <span class="synType">char</span> *path)
{
cpphello_dir_config *cfg = (cpphello_dir_config *)apr_pcalloc(p, <span class="synStatement">sizeof</span>(cpphello_dir_config));
cfg->hellomessage = (<span class="synType">char</span> *)<span class="synConstant">"こんにちは！"</span>;
<span class="synStatement">return</span> cfg;
}

<span class="synType">static</span> <span class="synType">int</span> cpphello_handler(request_rec *r)
{
cpphello_dir_config *cfg = (cpphello_dir_config *) ap_get_module_config(r->per_dir_config, &cpphello_module);
std::string messagetosend = std::string(<span class="synConstant">"<html><p>"</span>) + std::string(cfg->hellomessage) + std::string(<span class="synConstant">"</p></html></span><span class="synSpecial">\n</span><span class="synConstant">"</span>);
r->content_type = <span class="synConstant">"text/html"</span>;
<span class="synStatement">if</span> (!r->header_only) {
  ap_rputs(messagetosend.c_str(), r);
}
<span class="synStatement">return</span> OK;
}

<span class="synType">static</span> <span class="synType">void</span> register_hooks(apr_pool_t *p)
{
  ap_hook_fixups(cpphello_handler,<span class="synConstant">NULL</span>,<span class="synConstant">NULL</span>,APR_HOOK_MIDDLE);
}

<span class="synType">extern</span> <span class="synConstant">"C"</span> {
module AP_MODULE_DECLARE_DATA cpphello_module = {
STANDARD20_MODULE_STUFF,
cpphello_create_dir_config,
<span class="synConstant">NULL</span>,
<span class="synConstant">NULL</span>,
<span class="synConstant">NULL</span>,
<span class="synConstant">NULL</span>,
register_hooks
};
};
</pre>
</div>
<div class="section">
<h5><a class="keyword" href="http://d.hatena.ne.jp/keyword/Makefile">Makefile</a></h5>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Makefile">Makefile</a>のポイントはg++を使う事と、ap系のheaderファイルを読み込む為の-I/usr/include/apr-1/を記述する事です。下の記述を書いたらsudo gmake reloadと打ち込むと上のmod_cpphello.cppのcompile、install、<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>.confへの書き込み、<a class="keyword" href="http://d.hatena.ne.jp/keyword/apache">apache</a> restartの全てをやってくれます。<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>.confへの書き込みは最初の1回だけで問題ありませんが、手動でやると忘れてしまう事が多いので(apxs -aのオプションを忘れる)注意してください。</p>
<pre class="hljs sh" data-lang="sh" data-unlink><span class="synComment">##</span>
<span class="synComment">##  Makefile -- Build procedure for fast3lpoad Apache module</span>
<span class="synComment">##</span>
<span class="synComment">##  This is a C++ module so things have to be handled a little differently.</span>

<span class="synComment">#   the used tools</span>
<span class="synIdentifier">APXS</span>=apxs
<span class="synIdentifier">APACHECTL</span>=apachectl

<span class="synComment"># Get all of apxs's internal values.</span>
<span class="synIdentifier">APXS_CC</span>=<span class="synSpecial">`$</span><span class="synStatement">(</span><span class="synSpecial">APXS</span><span class="synStatement">)</span><span class="synSpecial"> -q CC`</span>   
<span class="synIdentifier">APXS_TARGET</span>=<span class="synSpecial">`$</span><span class="synStatement">(</span><span class="synSpecial">APXS</span><span class="synStatement">)</span><span class="synSpecial"> -q TARGET`</span>   
<span class="synIdentifier">APXS_CFLAGS</span>=<span class="synSpecial">`$</span><span class="synStatement">(</span><span class="synSpecial">APXS</span><span class="synStatement">)</span><span class="synSpecial"> -q CFLAGS`</span>   
<span class="synIdentifier">APXS_SBINDIR</span>=<span class="synSpecial">`$</span><span class="synStatement">(</span><span class="synSpecial">APXS</span><span class="synStatement">)</span><span class="synSpecial"> -q SBINDIR`</span>   
<span class="synIdentifier">APXS_CFLAGS_SHLIB</span>=<span class="synSpecial">`$</span><span class="synStatement">(</span><span class="synSpecial">APXS</span><span class="synStatement">)</span><span class="synSpecial"> -q CFLAGS_SHLIB`</span>   
<span class="synIdentifier">APXS_INCLUDEDIR</span>=<span class="synSpecial">`$</span><span class="synStatement">(</span><span class="synSpecial">APXS</span><span class="synStatement">)</span><span class="synSpecial"> -q INCLUDEDIR`</span>   
<span class="synIdentifier">APXS_LD_SHLIB</span>=<span class="synSpecial">`$</span><span class="synStatement">(</span><span class="synSpecial">APXS</span><span class="synStatement">)</span><span class="synSpecial"> -q LD_SHLIB`</span>
<span class="synIdentifier">APXS_LIBEXECDIR</span>=<span class="synSpecial">`$</span><span class="synStatement">(</span><span class="synSpecial">APXS</span><span class="synStatement">)</span><span class="synSpecial"> -q LIBEXECDIR`</span>
<span class="synIdentifier">APXS_LDFLAGS_SHLIB</span>=<span class="synSpecial">`$</span><span class="synStatement">(</span><span class="synSpecial">APXS</span><span class="synStatement">)</span><span class="synSpecial"> -q LDFLAGS_SHLIB`</span>
<span class="synIdentifier">APXS_SYSCONFDIR</span>=<span class="synSpecial">`$</span><span class="synStatement">(</span><span class="synSpecial">APXS</span><span class="synStatement">)</span><span class="synSpecial"> -q SYSCONFDIR`</span>
<span class="synIdentifier">APXS_LIBS_SHLIB</span>=<span class="synSpecial">`$</span><span class="synStatement">(</span><span class="synSpecial">APXS</span><span class="synStatement">)</span><span class="synSpecial"> -q LIBS_SHLIB`</span>

<span class="synComment">#   the default target</span>
all: mod_cpphello.so

<span class="synComment"># compile the shared object file. use g++ instead of letting apxs call</span>
<span class="synComment"># ld so we end up with the right c++ stuff. We do this in two steps,</span>
<span class="synComment"># compile and link.</span>

<span class="synComment"># compile</span>
mod_cpphello.o: mod_cpphello.cpp
g++ <span class="synSpecial">-c</span> <span class="synSpecial">-fPIC</span> <span class="synSpecial">-I</span><span class="synPreProc">$(</span><span class="synSpecial">APXS_INCLUDEDIR</span><span class="synPreProc">)</span> <span class="synSpecial">-I</span>/usr/include/apr<span class="synConstant">-1</span>/ <span class="synPreProc">$(</span><span class="synSpecial">APXS_CFLAGS</span><span class="synPreProc">)</span> <span class="synPreProc">$(</span><span class="synSpecial">APXS_CFLAGS_SHLIB</span><span class="synPreProc">)</span> <span class="synSpecial">-Wall</span> <span class="synSpecial">-o</span> <span class="synPreProc">$@</span> $<span class="synStatement"><</span> 

<span class="synComment"># link</span>
mod_cpphello.so: mod_cpphello.o 
g++ <span class="synSpecial">-fPIC</span> <span class="synSpecial">-shared</span> <span class="synSpecial">-o</span> <span class="synPreProc">$@</span> $<span class="synStatement"><</span> <span class="synPreProc">$(</span><span class="synSpecial">APXS_LIBS_SHLIB</span><span class="synPreProc">)</span>

<span class="synComment"># install the shared object file into Apache </span>
<span class="synStatement">install</span>: all
<span class="synPreProc">$(</span><span class="synSpecial">APXS</span><span class="synPreProc">)</span> <span class="synSpecial">-i</span> <span class="synSpecial">-a</span> <span class="synSpecial">-n</span> <span class="synStatement">'</span><span class="synConstant">cpphello</span><span class="synStatement">'</span> mod_cpphello.so

<span class="synComment"># display the apxs variables</span>
check_apxs_vars:
@<span class="synStatement">echo</span><span class="synConstant"> APXS_CC </span><span class="synPreProc">$(</span><span class="synSpecial">APXS_CC</span><span class="synPreProc">)</span>;<span class="synStatement">\</span>
<span class="synStatement">echo</span><span class="synConstant"> APXS_TARGET </span><span class="synPreProc">$(</span><span class="synSpecial">APXS_TARGET</span><span class="synPreProc">)</span>;<span class="synStatement">\</span>
<span class="synStatement">echo</span><span class="synConstant"> APXS_CFLAGS </span><span class="synPreProc">$(</span><span class="synSpecial">APXS_CFLAGS</span><span class="synPreProc">)</span>;<span class="synStatement">\</span>
<span class="synStatement">echo</span><span class="synConstant"> APXS_SBINDIR </span><span class="synPreProc">$(</span><span class="synSpecial">APXS_SBINDIR</span><span class="synPreProc">)</span>;<span class="synStatement">\</span>
<span class="synStatement">echo</span><span class="synConstant"> APXS_CFLAGS_SHLIB </span><span class="synPreProc">$(</span><span class="synSpecial">APXS_CFLAGS_SHLIB</span><span class="synPreProc">)</span>;<span class="synStatement">\</span>
<span class="synStatement">echo</span><span class="synConstant"> APXS_INCLUDEDIR </span><span class="synPreProc">$(</span><span class="synSpecial">APXS_INCLUDEDIR</span><span class="synPreProc">)</span>;<span class="synStatement">\</span>
<span class="synStatement">echo</span><span class="synConstant"> APXS_LD_SHLIB </span><span class="synPreProc">$(</span><span class="synSpecial">APXS_LD_SHLIB</span><span class="synPreProc">)</span>;<span class="synStatement">\</span>
<span class="synStatement">echo</span><span class="synConstant"> APXS_LIBEXECDIR </span><span class="synPreProc">$(</span><span class="synSpecial">APXS_LIBEXECDIR</span><span class="synPreProc">)</span>;<span class="synStatement">\</span>
<span class="synStatement">echo</span><span class="synConstant"> APXS_LDFLAGS_SHLIB </span><span class="synPreProc">$(</span><span class="synSpecial">APXS_LDFLAGS_SHLIB</span><span class="synPreProc">)</span>;<span class="synStatement">\</span>
<span class="synStatement">echo</span><span class="synConstant"> APXS_SYSCONFDIR </span><span class="synPreProc">$(</span><span class="synSpecial">APXS_SYSCONFDIR</span><span class="synPreProc">)</span>;<span class="synStatement">\</span>
<span class="synStatement">echo</span><span class="synConstant"> APXS_LIBS_SHLIB </span><span class="synPreProc">$(</span><span class="synSpecial">APXS_LIBS_SHLIB</span><span class="synPreProc">)</span>

<span class="synComment">#   cleanup</span>
clean:
<span class="synSpecial">-rm</span> <span class="synSpecial">-f</span> *.so *.o *~

<span class="synComment">#   install and activate shared object by reloading Apache to</span>
<span class="synComment">#   force a reload of the shared object file</span>
<span class="synStatement">reload</span>: <span class="synStatement">install</span> <span class="synStatement">restart</span>

<span class="synComment">#   the general Apache start/restart/stop</span>
<span class="synComment">#   procedures</span>
<span class="synStatement">start</span>:
<span class="synPreProc">$(</span><span class="synSpecial">APACHECTL</span><span class="synPreProc">)</span> <span class="synStatement">start</span>
<span class="synStatement">restart</span>:
<span class="synPreProc">$(</span><span class="synSpecial">APACHECTL</span><span class="synPreProc">)</span> <span class="synStatement">restart</span>
<span class="synStatement">stop</span>:
<span class="synPreProc">$(</span><span class="synSpecial">APACHECTL</span><span class="synPreProc">)</span> <span class="synStatement">stop</span>
</pre><p>最後に<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>の設定ファイルの確認と<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>のPathにアクセスしてみて、「こんにちは！」が表示されている事を見てみます。<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>.confについてはLoadModule cpphello_moduleが自動追加、<a class="keyword" href="http://d.hatena.ne.jp/keyword/curl">curl</a>を実行してみると「こんにちは！」のHTMLが確かに取得できました。これでstd::stringがちゃんと使えている事が分かりましたね。</p><p>これを参考に<a class="keyword" href="http://d.hatena.ne.jp/keyword/C%2B%2B">C++</a>でも<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a> Moduleを作ってみてください。</p>
<pre class="hljs zsh" data-lang="zsh" data-unlink>$ sudo gmake reload
/usr/lib64/httpd/build/instdso.sh SH_LIBTOOL=<span class="synConstant">'/usr/lib64/apr-1/build/libtool'</span> mod_cpphello.so /usr/lib64/httpd/modules
/usr/lib64/apr-1/build/libtool --mode=install cp mod_cpphello.so /usr/lib64/httpd/modules/
libtool: install: cp mod_cpphello.so /usr/lib64/httpd/modules/mod_cpphello.so
Warning!  dlname not found <span class="synStatement">in</span> /usr/lib64/httpd/modules/mod_cpphello.so.
Assuming installing a .so rather than a libtool archive.
chmod <span class="synConstant">755</span> /usr/lib64/httpd/modules/mod_cpphello.so
[activating module <span class="synPreProc">`cpphello</span><span class="synConstant">' in /etc/httpd/conf/httpd.conf]</span>
<span class="synConstant">apachectl restart</span>

<span class="synConstant">$ grep "cpphello" /etc/httpd/conf/httpd.conf</span>
<span class="synConstant">LoadModule cpphello_module    /usr/lib64/httpd/modules/mod_cpphello.so</span>

<span class="synConstant">$ sudo touch /var/www/html/hello_world</span>

<span class="synConstant">$ curl -i "http://localhost/hello_world"</span>
<span class="synConstant">HTTP/1.1 200 OK</span>
<span class="synConstant">Date: Thu, 31 Oct 2013 18:17:14 GMT</span>
<span class="synConstant">Server: Apache/2.2.15 (CentOS)</span>
<span class="synConstant">Last-Modified: Thu, 31 Oct 2013 18:03:36 GMT</span>
<span class="synConstant">ETag: "2601eb-0-4ea0d44d23aa2"</span>
<span class="synConstant">Accept-Ranges: bytes</span>
<span class="synConstant">Content-Length: 39</span>
<span class="synConstant">Connection: close</span>
<span class="synConstant">Content-Type: text/html; charset=UTF-8</span>

<span class="synConstant"><html><p>こんにちは！</p></html></span>
</pre>
</div>
</blockquote>
<p><div class="amazlet-box"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4774117994/yutakikuchi-22/"><img src="http://ecx.images-amazon.com/images/I/51NAAYPX54L._SL160_.jpg" class="hatena-asin-detail-image" alt="Apacheモジュール プログラミングガイド (Advanced Server‐side programmingシリーズ)" title="Apacheモジュール プログラミングガイド (Advanced Server‐side programmingシリーズ)"></a><div class="hatena-asin-detail-info"><p class="hatena-asin-detail-title"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4774117994/yutakikuchi-22/">Apacheモジュール プログラミングガイド (Advanced Server‐side programmingシリーズ)</a></p><ul><li><span class="hatena-asin-detail-label">作者:</span> 小山浩之</li><li><span class="hatena-asin-detail-label">出版社/メーカー:</span> <a class="keyword" href="http://d.hatena.ne.jp/keyword/%B5%BB%BD%D1%C9%BE%CF%C0%BC%D2">技術評論社</a></li><li><span class="hatena-asin-detail-label">発売日:</span> 2003/08/01</li><li><span class="hatena-asin-detail-label">メディア:</span> 単行本</li><li><span class="hatena-asin-detail-label">購入</span>: 1人 <span class="hatena-asin-detail-label">クリック</span>: 81回</li><li><a href="http://d.hatena.ne.jp/asin/4774117994/yutakikuchi-22" target="_blank">この商品を含むブログ (25件) を見る</a></li></ul></div><div class="hatena-asin-detail-foot"></div></div></p>

</div>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://yutakikuchi.github.io/post/201310150809/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://yutakikuchi.github.io/post/201310150809/">日本全国避難所データと現在地周辺の避難所地図を公開しました</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://yutakikuchi.github.io/post/201311050826/">スケジュールの仮登録を神速で管理できる「Cu-hacker」がセクシー過ぎる件</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://yutakikuchi.github.io/post/201311050826/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>

</div>
</div>
<script src="https://yutakikuchi.github.io/js/ui.js"></script>
<script src="https://yutakikuchi.github.io/js/menus.js"></script>


<script>
  
  if (window.location.hostname != "localhost") {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-20616165-3', 'auto');
    ga('send', 'pageview');
  }
</script>





</body>
</html>

