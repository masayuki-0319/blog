<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="canonical" href="http://yut.hatenablog.com/entry/20131206/1386285876" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.55.4" />

  <title>Redisにマルチプロセスで接続する時に気をつけたい事 &middot; Y&#39;s note</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://yutakikuchi.github.io/blog/img/favicon.ico" type="image/x-icon" />

  
    
        <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/my.css">
    
  
  
    
        <script src="https://yutakikuchi.github.io/blog/js/my.js"></script>
    
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://yutakikuchi.github.io/blog/">Y's note</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/yutakikuchi_" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://facebook.com/yuta.kikuchi.007" target="_blank"><i class="fa fa-facebook-square fa-fw"></i>Facebook</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="http://slideshare.net/https://www.slideshare.net/yutakikuchi58/" target="_blank"><i class="fa fa-slideshare fa-fw"></i>SlideShare</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/https://www.linkedin.com/in/%E4%BD%91%E5%A4%AA-%E8%8F%8A%E6%B1%A0-36291a44/" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/yutakikuchi" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2019. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Redisにマルチプロセスで接続する時に気をつけたい事</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2013 Dec 06, 08:24</time>
  </div>

  

  

  

</div>

  

<h2 id="redis-redisにマルチプロセスで接続する時に気をつけたい事">[Redis] : Redisにマルチプロセスで接続する時に気をつけたい事</h2>

<p><div class="amazlet-box"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/1617290858/yutakikuchi-22/"><img src="http://ecx.images-amazon.com/images/I/41Hdh0BzKsL._SL160_.jpg" class="hatena-asin-detail-image" alt="Redis in Action" title="Redis in Action"></a><div class="hatena-asin-detail-info"><p class="hatena-asin-detail-title"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/1617290858/yutakikuchi-22/">Redis in Action</a></p><ul><li><span class="hatena-asin-detail-label">作者:</span> Josiah L. Carlson,Salvatore Sanfilippo</li><li><span class="hatena-asin-detail-label">出版社/メーカー:</span> Manning Pubns Co</li><li><span class="hatena-asin-detail-label">発売日:</span> 2013/06/25</li><li><span class="hatena-asin-detail-label">メディア:</span> ペーパーバック</li><li> <span class="hatena-asin-detail-label">クリック</span>: 1回</li><li><a href="http://d.hatena.ne.jp/asin/1617290858/yutakikuchi-22" target="_blank">この商品を含むブログを見る</a></li></ul></div><div class="hatena-asin-detail-foot"></div></div></p>

<div class="section">
<h4>Redis</h4>

<blockquote>
    <p>広告配信やっています<a href='https://twitter.com/yutakikuc'>@yutakikuc</a>です。<br />
Redisの内部処理が1スレッドで受けているようなので、マルチプロセスからRedisに書き込み処理を大量に流した時にどうなるのかを検証してみました。言語はCを、Libraryはhiredisを使います。<a href="https://github.com/redis/hiredis">redis/hiredis</a> <a href="http://b.hatena.ne.jp/entry/s/github.com/redis/hiredis"><img src="http://b.hatena.ne.jp/entry/image/https://github.com/redis/hiredis" alt="はてなブックマーク - redis/hiredis" border="0" /></a><br />
hiredisを使って単一プロセスで実行した場合と、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a> Moduleにhiredisを組み込んでマルチプロセスの実行状態で検証します。検証機はCentOS6.4です。</p>

</blockquote>

</div>
<div class="section">
<h4>hiredis</h4>

<blockquote>
    
<div class="section">
<h5>Redisのinstall、version確認、起動</h5>
<p>RedisのVersionは2.4.10です。</p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ sudo yum <span class="synStatement">install</span> redis <span class="synSpecial">-y</span>

$ redis-server <span class="synSpecial">-v</span>
Redis server version 2.4.10 <span class="synPreProc">(</span><span class="synConstant">00000000</span><span class="synSpecial">:</span><span class="synConstant">0</span><span class="synPreProc">)</span>

$ sudo chkconfig <span class="synSpecial">--add</span> redis

$ sudo /etc/init.d/redis <span class="synStatement">start</span>
</pre>
</div>
<div class="section">
<h5>hiredisのinstallとテストプログラム</h5>
<p>hiredisのinstall後に単純にHashをincrbyするプログラムを実行してみます。まずはプロセス内で単純に指定回数incrbyを繰り返します。今回は指定回数を1万としたので、かなり高速に書き込みが完了している事が分かると思います。実行後にはredis-<a class="keyword" href="http://d.hatena.ne.jp/keyword/cli">cli</a>で書き込みが出来ているかを確認します。</p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ sudo yum <span class="synStatement">install</span> hiredis hiredis-devel <span class="synSpecial">-y</span>

$ gcc <span class="synSpecial">-I</span>/usr/include/hiredis  <span class="synSpecial">-L</span>/usr/lib64 <span class="synSpecial">-lhiredis</span> redis-test.c <span class="synSpecial">-o</span> redis-<span class="synStatement">test</span>

$ <span class="synStatement">time</span> ./redis-<span class="synStatement">test</span>
./redis-<span class="synStatement">test</span>  0.04s user 0.25s system <span class="synConstant">48</span>% cpu 0.592 total

$ redis-cli HGET foo bar
<span class="synStatement">"</span><span class="synConstant">10000</span><span class="synStatement">"</span>
</pre><pre class="hljs c" data-lang="c" data-unlink><span class="synPreProc">#include </span><span class="synConstant"><stdio.h></span>
<span class="synPreProc">#include </span><span class="synConstant"><hiredis.h></span>
<span class="synPreProc">#include </span><span class="synConstant"><assert.h></span>

<span class="synPreProc">#define IP </span><span class="synConstant">"127.0.0.1"</span>
<span class="synPreProc">#define PORT </span><span class="synConstant">6379</span>
<span class="synPreProc">#define COUNT </span><span class="synConstant">10000</span>

<span class="synType">int</span> main(){
redisContext *c = redisConnect(IP, PORT);
<span class="synStatement">if</span> (c != <span class="synConstant">NULL</span> && c->err) {
    printf(<span class="synConstant">"Error: </span><span class="synSpecial">%s\n</span><span class="synConstant">"</span>, c->errstr);
    <span class="synStatement">return</span> <span class="synConstant">1</span>;
}
<span class="synType">unsigned</span> <span class="synType">int</span> i=<span class="synConstant">0</span>;
<span class="synStatement">for</span>(; i<COUNT; i++) {
    redisReply *reply;
    reply = redisCommand(c,<span class="synConstant">"HINCRBY foo bar 1"</span>);
    <span class="synStatement">if</span>(reply){ 
        freeReplyObject(reply);
    }
}
redisFree(c);
<span class="synStatement">return</span> <span class="synConstant">0</span>;
}
</pre>
</div>
</blockquote>

</div>
<div class="section">
<h4><a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a> Moduleへの組み込み</h4>

<blockquote>
    
<div class="section">
<h5>Moduleを入れる前のPerformance</h5>
<p>Redisに接続する<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a> Moduleを入れる前のPerformanceを見てみます。4,5年前に購入したPCで試しているのでさほどSpeedが出ていませんが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>のSampleページ表示で並列10/合計1万のab<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D9%A5%F3%A5%C1%A5%DE%A1%BC%A5%AF">ベンチマーク</a>の場合、<span class="deco" style="font-weight:bold;">2065.80rps</span>となりました。</p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ cat /proc/meminfo 
MemTotal:        <span class="synConstant">2327156</span> kB
MemFree:         <span class="synConstant">2058828</span> kB
Buffers:           <span class="synConstant">21396</span> kB
Cached:            <span class="synConstant">94164</span> kB
SwapCached:            <span class="synConstant">0</span> kB

$ ab <span class="synSpecial">-n</span> <span class="synConstant">10000</span> <span class="synSpecial">-c</span> <span class="synConstant">10</span> <span class="synStatement">"</span><span class="synConstant">http://localhost/</span><span class="synStatement">"</span>

Concurrency Level:      <span class="synConstant">10</span>
Time taken <span class="synStatement">for </span>tests:   4.841 seconds
Complete requests:      <span class="synConstant">10000</span>
Failed requests:        <span class="synConstant">0</span>
Write errors:           <span class="synConstant">0</span>
Non-2xx responses:      <span class="synConstant">10006</span>
Total transferred:      <span class="synConstant">52401422</span> bytes
HTML transferred:       <span class="synConstant">50420234</span> bytes
Requests per second:    2065.80 <span class="synStatement">[</span>#/sec<span class="synStatement">]</span> <span class="synStatement">(</span>mean<span class="synStatement">)</span>
Time per request:       4.841 <span class="synStatement">[</span>ms<span class="synStatement">]</span> <span class="synStatement">(</span>mean<span class="synStatement">)</span>
Time per request:       0.484 <span class="synStatement">[</span>ms<span class="synStatement">]</span> <span class="synStatement">(</span>mean, across all concurrent requests<span class="synStatement">)</span>
Transfer rate:          10571.35 <span class="synStatement">[</span>Kbytes/sec<span class="synStatement">]</span> received

Connection Times <span class="synStatement">(</span>ms<span class="synStatement">)</span>
          min  mean<span class="synStatement">[</span>+/-sd<span class="synStatement">]</span> median   max
Connect:        <span class="synConstant">0</span>    <span class="synConstant">2</span>   1.4      <span class="synConstant">2</span>      <span class="synConstant">32</span>
Processing:     <span class="synConstant">1</span>    <span class="synConstant">3</span>   1.9      <span class="synConstant">2</span>      <span class="synConstant">64</span>
Waiting:        <span class="synConstant">0</span>    <span class="synConstant">2</span>   1.5      <span class="synConstant">2</span>      <span class="synConstant">36</span>
Total:          <span class="synConstant">2</span>    <span class="synConstant">5</span>   2.4      <span class="synConstant">4</span>      <span class="synConstant">67</span>
</pre>
</div>
<div class="section">
<h5><a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a> ModuleからRedisへの書き込み</h5>
<p>次にRedisに接続する為の<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a> Moduleを入れて行きます。まずは接続設定を<a class="keyword" href="http://d.hatena.ne.jp/keyword/apache">apache</a>の設定ファイルに記述します。ここでは新たにredis.confを用意しました。<br />
次にRedisに接続する為のmod_redisという自作Moduleを入れて行きます。apxsコマンドで入れて、<a class="keyword" href="http://d.hatena.ne.jp/keyword/apache">apache</a>をrestartします。<br />
一回<a class="keyword" href="http://d.hatena.ne.jp/keyword/curl">curl</a>で接続してみてRedisの<span class="deco" style="font-weight:bold;">Permission denied</span>で怒られたら<span class="deco" style="font-weight:bold;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>_can_network_connect=1</span>設定して上げましょう。</p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ sudo vim /etc/httpd/conf.d/redis.conf
RedisHost 127.0.0.1
RedisPort <span class="synConstant">6379</span>

$ sudo apxs <span class="synSpecial">-i</span> <span class="synSpecial">-a</span> <span class="synSpecial">-c</span> <span class="synSpecial">-I</span>/usr/include/hiredis <span class="synSpecial">-L</span>/usr/lib64 <span class="synSpecial">-lhiredis</span> mod_redis.c
$ sudo /etc/init.d/httpd <span class="synStatement">restart</span>
$ curl <span class="synStatement">"</span><span class="synConstant">http://localhost/redis</span><span class="synStatement">"</span>  
<span class="synStatement">[</span>Fri Dec <span class="synConstant">06</span> <span class="synConstant">01</span>:<span class="synConstant">15</span>:<span class="synConstant">43</span> <span class="synConstant">2013</span><span class="synStatement">]</span> <span class="synStatement">[</span>error<span class="synStatement">]</span> <span class="synStatement">[</span>client ::<span class="synConstant">1</span><span class="synStatement">]</span> Redis Connection Error : Permission denied

$ sudo /usr/sbin/setsebool <span class="synIdentifier">httpd_can_network_connect</span>=<span class="synConstant">1</span>
</pre><pre class="hljs c" data-lang="c" data-unlink><span class="synPreProc">#include </span><span class="synConstant">"httpd.h"</span>
<span class="synPreProc">#include </span><span class="synConstant">"http_config.h"</span>
<span class="synPreProc">#include </span><span class="synConstant">"http_protocol.h"</span>
<span class="synPreProc">#include </span><span class="synConstant">"apr_hash.h"</span>
<span class="synPreProc">#include </span><span class="synConstant">"apr_tables.h"</span>
<span class="synPreProc">#include </span><span class="synConstant">"apr_strings.h"</span>
<span class="synPreProc">#include </span><span class="synConstant">"ap_config.h"</span>
<span class="synPreProc">#include </span><span class="synConstant">"util_script.h"</span>
<span class="synPreProc">#include </span><span class="synConstant">"http_log.h"</span>
<span class="synPreProc">#include </span><span class="synConstant">"hiredis.h"</span>

<span class="synType">typedef</span> <span class="synType">struct</span> {
  <span class="synType">int</span> port;
  <span class="synType">char</span> *host;
} redis_env;

module AP_MODULE_DECLARE_DATA redis_module;

<span class="synType">static</span> <span class="synType">int</span> redis_handler(request_rec *r) {
  redis_env *db = ap_get_module_config(r->per_dir_config, &redis_module);
  redisContext *c = redisConnect(db->host, db->port);
  <span class="synStatement">if</span> (c != <span class="synConstant">NULL</span> && c->err) {
ap_log_rerror(APLOG_MARK, APLOG_ERR, <span class="synConstant">0</span>, r, <span class="synConstant">"Redis Connection Error : </span><span class="synSpecial">%s</span><span class="synConstant">"</span>, c->errstr);
<span class="synStatement">return</span> DECLINED;
  }
  redisReply *reply;
  reply = redisCommand(c,<span class="synConstant">"HINCRBY foo bar 1"</span>);
  <span class="synStatement">if</span>(reply){ 
    freeReplyObject(reply);
  }
  reply = redisCommand(c,<span class="synConstant">"QUIT"</span>);
  <span class="synStatement">if</span>(reply){ 
    freeReplyObject(reply);
  }
  redisFree(c);
  <span class="synStatement">return</span> OK;
}

<span class="synType">static</span> <span class="synType">void</span> *make_redis_dir(apr_pool_t *p, <span class="synType">char</span> *d) {
  redis_env *db;
  db = (redis_env *) apr_pcalloc(p, <span class="synStatement">sizeof</span>(redis_env));
  <span class="synStatement">return</span> db;
}

<span class="synType">static</span> <span class="synType">const</span> <span class="synType">char</span> *set_redis_host(cmd_parms *cmd, <span class="synType">void</span> *mconfig, <span class="synType">const</span> <span class="synType">char</span> *name) {
  redis_env *db;
  db = (redis_env *) mconfig;
  db->host = ap_getword_conf(cmd->pool, &name);
  <span class="synStatement">return</span> <span class="synConstant">NULL</span>;
}

<span class="synType">static</span> <span class="synType">const</span> <span class="synType">char</span> *set_redis_port(cmd_parms *cmd, <span class="synType">void</span> *mconfig, <span class="synType">const</span> <span class="synType">char</span> *port) {
  redis_env *db;
  db = (redis_env *) mconfig;
  <span class="synType">char</span> *p;
  p = ap_getword_conf(cmd->pool, &port);
  db->port = atoi(p);
  <span class="synStatement">return</span> <span class="synConstant">NULL</span>;
}

<span class="synType">static</span> <span class="synType">const</span> command_rec redis_conf_cmds[] = {
  AP_INIT_TAKE1(<span class="synConstant">"RedisHost"</span>, set_redis_host, <span class="synConstant">NULL</span>, OR_FILEINFO, <span class="synConstant">"redis hostname"</span>),
  AP_INIT_TAKE1(<span class="synConstant">"RedisPort"</span>, set_redis_port, <span class="synConstant">NULL</span>, OR_FILEINFO, <span class="synConstant">"redis port"</span>),
  {<span class="synConstant">NULL</span>}
};

<span class="synType">static</span> <span class="synType">void</span> redis_register_hooks(apr_pool_t *p) {
ap_hook_handler(redis_handler, <span class="synConstant">NULL</span>, <span class="synConstant">NULL</span>, APR_HOOK_MIDDLE);
}

module AP_MODULE_DECLARE_DATA redis_module = {
STANDARD20_MODULE_STUFF, 
make_redis_dir,        <span class="synComment">/* create per-dir    config structures */</span>
<span class="synConstant">NULL</span>,                  <span class="synComment">/* merge  per-dir    config structures */</span>
<span class="synConstant">NULL</span>,                  <span class="synComment">/* create per-server config structures */</span>
<span class="synConstant">NULL</span>,                  <span class="synComment">/* merge  per-server config structures */</span>
redis_conf_cmds,       <span class="synComment">/* table of config file commands       */</span>
redis_register_hooks   <span class="synComment">/* register hooks                      */</span>
};
</pre>
</div>
<div class="section">
<h5>Moduleを入れた後のPerfomanceテスト</h5>
<p>RedisModuleを入れた後のPerformanceテストをしてみます。上と同様に並列10/合計1万のab<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D9%A5%F3%A5%C1%A5%DE%A1%BC%A5%AF">ベンチマーク</a>で実行した場合、<span class="deco" style="font-weight:bold;">726.98rps</span>となりました。実行後にRedisのHashの値も10000に更新されています。</p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ ab <span class="synSpecial">-n</span> <span class="synConstant">10000</span> <span class="synSpecial">-c</span> <span class="synConstant">10</span> <span class="synStatement">"</span><span class="synConstant">http://localhost/redis</span><span class="synStatement">"</span>
Concurrency Level:      <span class="synConstant">10</span>
Time taken <span class="synStatement">for </span>tests:   13.756 seconds
Complete requests:      <span class="synConstant">10000</span>
Failed requests:        <span class="synConstant">0</span>
Write errors:           <span class="synConstant">0</span>
Total transferred:      <span class="synConstant">1670000</span> bytes
HTML transferred:       <span class="synConstant">0</span> bytes
Requests per second:    726.98 <span class="synStatement">[</span>#/sec<span class="synStatement">]</span> <span class="synStatement">(</span>mean<span class="synStatement">)</span>
Time per request:       13.756 <span class="synStatement">[</span>ms<span class="synStatement">]</span> <span class="synStatement">(</span>mean<span class="synStatement">)</span>
Time per request:       1.376 <span class="synStatement">[</span>ms<span class="synStatement">]</span> <span class="synStatement">(</span>mean, across all concurrent requests<span class="synStatement">)</span>
Transfer rate:          118.56 <span class="synStatement">[</span>Kbytes/sec<span class="synStatement">]</span> received

Connection Times <span class="synStatement">(</span>ms<span class="synStatement">)</span>
          min  mean<span class="synStatement">[</span>+/-sd<span class="synStatement">]</span> median   max
Connect:        <span class="synConstant">0</span>    <span class="synConstant">3</span>   4.7      <span class="synConstant">2</span>      <span class="synConstant">76</span>
Processing:     <span class="synConstant">1</span>   <span class="synConstant">11</span>  10.3      <span class="synConstant">8</span>     <span class="synConstant">228</span>
Waiting:        <span class="synConstant">0</span>    <span class="synConstant">9</span>   9.2      <span class="synConstant">7</span>     <span class="synConstant">211</span>
Total:          <span class="synConstant">1</span>   <span class="synConstant">14</span>  11.0     <span class="synConstant">11</span>     <span class="synConstant">228</span>

$ redis-cli HGET foo bar  
<span class="synStatement">"</span><span class="synConstant">10000</span><span class="synStatement">"</span>
</pre><p>もう少しRedisをいじめてみます。上のab<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を更に繰り返し10回実行してみます。そうするとFailed Requestが多発し<span class="deco" style="font-weight:bold;">226.90rps</span>までパフォーマンスが落ちています。この原因はRedisへの接続で<span class="deco" style="font-weight:bold;">TIME_WAIT</span>が大量に発生しているので、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>がRedisとの接続エラーを返しているためと思われます。<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>_logを見てもRedis Connection <a class="keyword" href="http://d.hatena.ne.jp/keyword/Error">Error</a> : <span class="deco" style="font-weight:bold;">Cannot assign requested address</span>のように記載されているのでConnectionErrorである事は間違いないと思います。</p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ <span class="synStatement">for </span>i <span class="synStatement">in</span> <span class="synSpecial">{</span>1..10<span class="synSpecial">}</span>
<span class="synStatement">do</span>
ab <span class="synStatement">-n</span> <span class="synConstant">10000</span> <span class="synStatement">-c</span> <span class="synConstant">10</span> <span class="synStatement">"</span><span class="synConstant">http://localhost/redis</span><span class="synStatement">"</span>
<span class="synStatement">done</span>

Concurrency Level:      <span class="synConstant">10</span>
Time taken <span class="synStatement">for </span>tests:   44.073 seconds
Complete requests:      <span class="synConstant">10000</span>
Failed requests:        <span class="synConstant">2619</span>
   <span class="synStatement">(</span>Connect: <span class="synConstant">0</span>, Receive: <span class="synConstant">0</span>, Length: <span class="synConstant">2619</span>, Exceptions: <span class="synConstant">0</span><span class="synStatement">)</span>
Write errors:           <span class="synConstant">0</span>
Total transferred:      <span class="synConstant">2015708</span> bytes
HTML transferred:       <span class="synConstant">81189</span> bytes
Requests per second:    226.90 <span class="synStatement">[</span>#/sec<span class="synStatement">]</span> <span class="synStatement">(</span>mean<span class="synStatement">)</span>
Time per request:       44.073 <span class="synStatement">[</span>ms<span class="synStatement">]</span> <span class="synStatement">(</span>mean<span class="synStatement">)</span>
Time per request:       4.407 <span class="synStatement">[</span>ms<span class="synStatement">]</span> <span class="synStatement">(</span>mean, across all concurrent requests<span class="synStatement">)</span>
Transfer rate:          44.66 <span class="synStatement">[</span>Kbytes/sec<span class="synStatement">]</span> received

Connection Times <span class="synStatement">(</span>ms<span class="synStatement">)</span>
          min  mean<span class="synStatement">[</span>+/-sd<span class="synStatement">]</span> median   max
Connect:        <span class="synConstant">0</span>    <span class="synConstant">4</span>   8.5      <span class="synConstant">0</span>      <span class="synConstant">75</span>
Processing:     <span class="synConstant">1</span>   <span class="synConstant">40</span>  49.0     <span class="synConstant">18</span>    <span class="synConstant">1188</span>
Waiting:        <span class="synConstant">0</span>   <span class="synConstant">36</span>  46.7     <span class="synConstant">16</span>    <span class="synConstant">1096</span>
Total:          <span class="synConstant">2</span>   <span class="synConstant">44</span>  51.1     <span class="synConstant">21</span>    <span class="synConstant">1188</span>

$ netstat <span class="synStatement">|</span> <span class="synStatement">grep</span> <span class="synStatement">"</span><span class="synConstant">localhost:6379</span><span class="synStatement">"</span> 
tcp        <span class="synConstant">0</span>      <span class="synConstant">0</span> localhost:<span class="synConstant">37067</span>             localhost:<span class="synConstant">6379</span>              TIME_WAIT   
tcp        <span class="synConstant">0</span>      <span class="synConstant">0</span> localhost:<span class="synConstant">37730</span>             localhost:<span class="synConstant">6379</span>              TIME_WAIT   
tcp        <span class="synConstant">0</span>      <span class="synConstant">0</span> localhost:<span class="synConstant">45624</span>             localhost:<span class="synConstant">6379</span>              TIME_WAIT   
tcp        <span class="synConstant">0</span>      <span class="synConstant">0</span> localhost:<span class="synConstant">52429</span>             localhost:<span class="synConstant">6379</span>              TIME_WAIT

$ netstat <span class="synStatement">|</span> <span class="synStatement">grep</span> <span class="synStatement">"</span><span class="synConstant">localhost:6379</span><span class="synStatement">"</span> <span class="synStatement">|</span> <span class="synStatement">grep</span> TIME_WAIT <span class="synStatement">|</span> wc <span class="synStatement">-l</span>
<span class="synConstant">19309</span>

$ <span class="synStatement">tail</span> <span class="synStatement">-f</span> /var/log/httpd/error_log
<span class="synStatement">[</span>Fri Dec <span class="synConstant">06</span> <span class="synConstant">00</span>:<span class="synConstant">42</span>:<span class="synConstant">17</span> <span class="synConstant">2013</span><span class="synStatement">]</span> <span class="synStatement">[</span>error<span class="synStatement">]</span> <span class="synStatement">[</span>client ::<span class="synConstant">1</span><span class="synStatement">]</span> Redis Connection Error : Cannot assign requested address
<span class="synStatement">[</span>Fri Dec <span class="synConstant">06</span> <span class="synConstant">00</span>:<span class="synConstant">42</span>:<span class="synConstant">17</span> <span class="synConstant">2013</span><span class="synStatement">]</span> <span class="synStatement">[</span>error<span class="synStatement">]</span> <span class="synStatement">[</span>client ::<span class="synConstant">1</span><span class="synStatement">]</span> Redis Connection Error : Cannot assign requested address
<span class="synStatement">[</span>Fri Dec <span class="synConstant">06</span> <span class="synConstant">00</span>:<span class="synConstant">42</span>:<span class="synConstant">17</span> <span class="synConstant">2013</span><span class="synStatement">]</span> <span class="synStatement">[</span>error<span class="synStatement">]</span> <span class="synStatement">[</span>client ::<span class="synConstant">1</span><span class="synStatement">]</span> Redis Connection Error : Cannot assign requested address
<span class="synStatement">[</span>Fri Dec <span class="synConstant">06</span> <span class="synConstant">00</span>:<span class="synConstant">42</span>:<span class="synConstant">17</span> <span class="synConstant">2013</span><span class="synStatement">]</span> <span class="synStatement">[</span>error<span class="synStatement">]</span> <span class="synStatement">[</span>client ::<span class="synConstant">1</span><span class="synStatement">]</span> Redis Connection Error : Cannot assign requested address
<span class="synStatement">[</span>Fri Dec <span class="synConstant">06</span> <span class="synConstant">00</span>:<span class="synConstant">42</span>:<span class="synConstant">17</span> <span class="synConstant">2013</span><span class="synStatement">]</span> <span class="synStatement">[</span>error<span class="synStatement">]</span> <span class="synStatement">[</span>client ::<span class="synConstant">1</span><span class="synStatement">]</span> Redis Connection Error : Cannot assign requested address
</pre>
</div>
<div class="section">
<h5>Cannot assign requested addressの原因を探る</h5>
<p>straceを使ってredis-serverの内部処理とCannot assign requested addressが発生している時にどんな処理が行われているのかを見てみます。結論としては良く分からず...。Redisのメモリからbackground saveでdiskに移す時が怪しいと思っていたんですが、どうやらあまり関係無かったようです。同じようにredis-<a class="keyword" href="http://d.hatena.ne.jp/keyword/cli">cli</a> slowlog getでslow queryを取得してstraceのlogと照らし合わせてみましたが、これといって変な処理は入っていませんでした。単純にmemoryを大量に消費した時の問題か...この辺り詳しい方教えて頂けると助かります。</p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ sudo strace <span class="synSpecial">-t</span> <span class="synSpecial">-f</span> <span class="synSpecial">-p</span> <span class="synSpecial">`pgrep redis-server`</span> <span class="synStatement">></span> redis-log <span class="synConstant">2</span><span class="synStatement">>&1</span>

$ <span class="synStatement">tail</span> <span class="synSpecial">-f</span> /var/log/httpd/error_log
<span class="synStatement">[</span>Fri Dec <span class="synConstant">06</span> <span class="synConstant">01</span>:<span class="synConstant">32</span>:<span class="synConstant">15</span> <span class="synConstant">2013</span><span class="synStatement">]</span> <span class="synStatement">[</span>error<span class="synStatement">]</span> <span class="synStatement">[</span>client ::<span class="synConstant">1</span><span class="synStatement">]</span> Redis Connection Error : Cannot assign requested address

$ <span class="synStatement">grep</span> <span class="synStatement">"</span><span class="synConstant">01:32:15</span><span class="synStatement">"</span> redis-log | vim -
<span class="synStatement">[</span>pid  <span class="synConstant">1393</span><span class="synStatement">]</span> <span class="synConstant">01</span>:<span class="synConstant">32</span>:<span class="synConstant">15</span> <span class="synStatement">read</span><span class="synPreProc">(</span><span class="synConstant">9</span><span class="synSpecial">, </span><span class="synStatement">"</span><span class="synConstant">*1</span><span class="synSpecial">\r\n</span><span class="synPreProc">$4</span><span class="synSpecial">\r\n</span><span class="synConstant">QUIT</span><span class="synSpecial">\r\n</span><span class="synStatement">"</span><span class="synSpecial">, </span><span class="synConstant">16384</span><span class="synPreProc">)</span> <span class="synStatement">=</span> <span class="synConstant">14</span>
<span class="synStatement">[</span>pid  <span class="synConstant">1393</span><span class="synStatement">]</span> <span class="synConstant">01</span>:<span class="synConstant">32</span>:<span class="synConstant">15</span> epoll_ctl<span class="synPreProc">(</span><span class="synConstant">3</span><span class="synSpecial">, EPOLL_CTL_MOD, </span><span class="synConstant">9</span><span class="synSpecial">, {EPOLLIN</span><span class="synStatement">|</span><span class="synSpecial">EPOLLOUT, {</span><span class="synIdentifier">u32</span>=<span class="synConstant">9</span><span class="synSpecial">, </span><span class="synIdentifier">u64</span>=<span class="synConstant">9</span><span class="synSpecial">}}</span><span class="synPreProc">)</span> <span class="synStatement">=</span> <span class="synConstant">0</span> 
<span class="synStatement">[</span>pid  <span class="synConstant">1393</span><span class="synStatement">]</span> <span class="synConstant">01</span>:<span class="synConstant">32</span>:<span class="synConstant">15</span> write<span class="synPreProc">(</span><span class="synConstant">6</span><span class="synSpecial">, </span><span class="synStatement">"</span><span class="synConstant">:932884</span><span class="synSpecial">\r\n</span><span class="synStatement">"</span><span class="synSpecial">, </span><span class="synConstant">9</span><span class="synPreProc">)</span> <span class="synStatement">=</span> <span class="synConstant">9</span> 
<span class="synStatement">[</span>pid  <span class="synConstant">1393</span><span class="synStatement">]</span> <span class="synConstant">01</span>:<span class="synConstant">32</span>:<span class="synConstant">15</span> epoll_ctl<span class="synPreProc">(</span><span class="synConstant">3</span><span class="synSpecial">, EPOLL_CTL_MOD, </span><span class="synConstant">6</span><span class="synSpecial">, {EPOLLIN, {</span><span class="synIdentifier">u32</span>=<span class="synConstant">6</span><span class="synSpecial">, </span><span class="synIdentifier">u64</span>=<span class="synConstant">6</span><span class="synSpecial">}}</span><span class="synPreProc">)</span> <span class="synStatement">=</span> <span class="synConstant">0</span> 
<span class="synStatement">[</span>pid  <span class="synConstant">1393</span><span class="synStatement">]</span> <span class="synConstant">01</span>:<span class="synConstant">32</span>:<span class="synConstant">15</span> <span class="synStatement">read</span><span class="synPreProc">(</span><span class="synConstant">5</span><span class="synSpecial">, </span><span class="synStatement">"</span><span class="synConstant">*4</span><span class="synSpecial">\r\n</span><span class="synPreProc">$7</span><span class="synSpecial">\r\n</span><span class="synConstant">HINCRBY</span><span class="synSpecial">\r\n</span><span class="synPreProc">$3</span><span class="synSpecial">\r\n</span><span class="synConstant">foo</span><span class="synSpecial">\r\n</span><span class="synPreProc">$3</span><span class="synSpecial">\r\n</span><span class="synConstant">ba</span><span class="synStatement">"</span><span class="synSpecial">..., </span><span class="synConstant">16384</span><span class="synPreProc">)</span> <span class="synStatement">=</span> <span class="synConstant">42</span>
<span class="synStatement">[</span>pid  <span class="synConstant">1393</span><span class="synStatement">]</span> <span class="synConstant">01</span>:<span class="synConstant">32</span>:<span class="synConstant">15</span> epoll_ctl<span class="synPreProc">(</span><span class="synConstant">3</span><span class="synSpecial">, EPOLL_CTL_MOD, </span><span class="synConstant">5</span><span class="synSpecial">, {EPOLLIN</span><span class="synStatement">|</span><span class="synSpecial">EPOLLOUT, {</span><span class="synIdentifier">u32</span>=<span class="synConstant">5</span><span class="synSpecial">, </span><span class="synIdentifier">u64</span>=<span class="synConstant">5</span><span class="synSpecial">}}</span><span class="synPreProc">)</span> <span class="synStatement">=</span> <span class="synConstant">0</span> 
<span class="synStatement">[</span>pid  <span class="synConstant">1393</span><span class="synStatement">]</span> <span class="synConstant">01</span>:<span class="synConstant">32</span>:<span class="synConstant">15</span> epoll_wait<span class="synPreProc">(</span><span class="synConstant">3</span><span class="synSpecial">, {{EPOLLIN, {</span><span class="synIdentifier">u32</span>=<span class="synConstant">4</span><span class="synSpecial">, </span><span class="synIdentifier">u64</span>=<span class="synConstant">4</span><span class="synSpecial">}}, {EPOLLOUT, {</span><span class="synIdentifier">u32</span>=<span class="synConstant">9</span><span class="synSpecial">, </span><span class="synIdentifier">u64</span>=<span class="synConstant">9</span><span class="synSpecial">}}, {EPOLLIN, {</span><span class="synIdentifier">u32</span>=<span class="synConstant">6</span><span class="synSpecial">, </span><span class="synIdentifier">u64</span>=<span class="synConstant">6</span><span class="synSpecial">}}, {EPOLLOUT, {</span><span class="synIdentifier">u32</span>=<span class="synConstant">5</span><span class="synSpecial">, </span><span class="synIdentifier">u64</span>=<span class="synConstant">5</span><span class="synSpecial">}}, {EPOLLIN, {</span><span class="synIdentifier">u32</span>=<span class="synConstant">7</span><span class="synSpecial">, </span><span class="synIdentifier">u64</span>=<span class="synConstant">7</span><span class="synSpecial">}}}, </span><span class="synConstant">10240</span><span class="synSpecial">, </span><span class="synConstant">98</span><span class="synPreProc">)</span> <span class="synStatement">=</span> <span class="synConstant">5</span> 
<span class="synStatement">[</span>pid  <span class="synConstant">1393</span><span class="synStatement">]</span> <span class="synConstant">01</span>:<span class="synConstant">32</span>:<span class="synConstant">15</span> accept<span class="synPreProc">(</span><span class="synConstant">4</span><span class="synSpecial">, {</span><span class="synIdentifier">sa_family</span>=<span class="synSpecial">AF_INET, </span><span class="synIdentifier">sin_port</span>=<span class="synSpecial">htons</span><span class="synPreProc">(</span><span class="synConstant">35569</span><span class="synPreProc">)</span><span class="synSpecial">, </span><span class="synIdentifier">sin_addr</span>=<span class="synSpecial">inet_addr</span><span class="synPreProc">(</span><span class="synStatement">"</span><span class="synConstant">127.0.0.1</span><span class="synStatement">"</span><span class="synPreProc">)</span><span class="synSpecial">}, [</span><span class="synConstant">16</span><span class="synSpecial">]</span><span class="synPreProc">)</span> <span class="synStatement">=</span> <span class="synConstant">8</span> 
<span class="synStatement">[</span>pid  <span class="synConstant">1393</span><span class="synStatement">]</span> <span class="synConstant">01</span>:<span class="synConstant">32</span>:<span class="synConstant">15</span> fcntl<span class="synPreProc">(</span><span class="synConstant">8</span><span class="synSpecial">, F_GETFL</span><span class="synPreProc">)</span>  <span class="synStatement">=</span> 0x2 <span class="synPreProc">(</span><span class="synSpecial">flags O_RDWR</span><span class="synPreProc">)</span>
<span class="synStatement">[</span>pid  <span class="synConstant">1393</span><span class="synStatement">]</span> <span class="synConstant">01</span>:<span class="synConstant">32</span>:<span class="synConstant">15</span> fcntl<span class="synPreProc">(</span><span class="synConstant">8</span><span class="synSpecial">, F_SETFL, O_RDWR</span><span class="synStatement">|</span><span class="synSpecial">O_NONBLOCK</span><span class="synPreProc">)</span> <span class="synStatement">=</span> <span class="synConstant">0</span> 
<span class="synStatement">[</span>pid  <span class="synConstant">1393</span><span class="synStatement">]</span> <span class="synConstant">01</span>:<span class="synConstant">32</span>:<span class="synConstant">15</span> setsockopt<span class="synPreProc">(</span><span class="synConstant">8</span><span class="synSpecial">, SOL_TCP, TCP_NODELAY, [</span><span class="synConstant">1</span><span class="synSpecial">], </span><span class="synConstant">4</span><span class="synPreProc">)</span> <span class="synStatement">=</span> <span class="synConstant">0</span> 
<span class="synStatement">[</span>pid  <span class="synConstant">1393</span><span class="synStatement">]</span> <span class="synConstant">01</span>:<span class="synConstant">32</span>:<span class="synConstant">15</span> epoll_ctl<span class="synPreProc">(</span><span class="synConstant">3</span><span class="synSpecial">, EPOLL_CTL_ADD, </span><span class="synConstant">8</span><span class="synSpecial">, {EPOLLIN, {</span><span class="synIdentifier">u32</span>=<span class="synConstant">8</span><span class="synSpecial">, </span><span class="synIdentifier">u64</span>=<span class="synConstant">8</span><span class="synSpecial">}}</span><span class="synPreProc">)</span> <span class="synStatement">=</span> <span class="synConstant">0</span> 
<span class="synStatement">[</span>pid  <span class="synConstant">1393</span><span class="synStatement">]</span> <span class="synConstant">01</span>:<span class="synConstant">32</span>:<span class="synConstant">15</span> write<span class="synPreProc">(</span><span class="synConstant">9</span><span class="synSpecial">, </span><span class="synStatement">"</span><span class="synConstant">+OK</span><span class="synSpecial">\r\n</span><span class="synStatement">"</span><span class="synSpecial">, </span><span class="synConstant">5</span><span class="synPreProc">)</span> <span class="synStatement">=</span> <span class="synConstant">5</span> 
<span class="synStatement">[</span>pid  <span class="synConstant">1393</span><span class="synStatement">]</span> <span class="synConstant">01</span>:<span class="synConstant">32</span>:<span class="synConstant">15</span> epoll_ctl<span class="synPreProc">(</span><span class="synConstant">3</span><span class="synSpecial">, EPOLL_CTL_MOD, </span><span class="synConstant">9</span><span class="synSpecial">, {EPOLLIN, {</span><span class="synIdentifier">u32</span>=<span class="synConstant">9</span><span class="synSpecial">, </span><span class="synIdentifier">u64</span>=<span class="synConstant">9</span><span class="synSpecial">}}</span><span class="synPreProc">)</span> <span class="synStatement">=</span> <span class="synConstant">0</span> 
<span class="synStatement">[</span>pid  <span class="synConstant">1393</span><span class="synStatement">]</span> <span class="synConstant">01</span>:<span class="synConstant">32</span>:<span class="synConstant">15</span> epoll_ctl<span class="synPreProc">(</span><span class="synConstant">3</span><span class="synSpecial">, EPOLL_CTL_DEL, </span><span class="synConstant">9</span><span class="synSpecial">, {</span><span class="synConstant">0</span><span class="synSpecial">, {</span><span class="synIdentifier">u32</span>=<span class="synConstant">9</span><span class="synSpecial">, </span><span class="synIdentifier">u64</span>=<span class="synConstant">9</span><span class="synSpecial">}}</span><span class="synPreProc">)</span> <span class="synStatement">=</span> <span class="synConstant">0</span> 
<span class="synStatement">[</span>pid  <span class="synConstant">1393</span><span class="synStatement">]</span> <span class="synConstant">01</span>:<span class="synConstant">32</span>:<span class="synConstant">15</span> close<span class="synPreProc">(</span><span class="synConstant">9</span><span class="synPreProc">)</span>           <span class="synStatement">=</span> <span class="synConstant">0</span> 


$ redis-cli slowlog get
 <span class="synConstant">1</span><span class="synError">)</span> <span class="synConstant">1</span><span class="synError">)</span> <span class="synPreProc">(</span><span class="synStatement">integer</span><span class="synPreProc">)</span> <span class="synConstant">69</span>
<span class="synConstant">2</span><span class="synError">)</span> <span class="synPreProc">(</span><span class="synStatement">integer</span><span class="synPreProc">)</span> <span class="synConstant">1386261178</span>
<span class="synConstant">3</span><span class="synError">)</span> <span class="synPreProc">(</span><span class="synStatement">integer</span><span class="synPreProc">)</span> <span class="synConstant">67530</span>
<span class="synConstant">4</span><span class="synError">)</span> <span class="synConstant">1</span><span class="synError">)</span> <span class="synStatement">"</span><span class="synConstant">HINCRBY</span><span class="synStatement">"</span>
   <span class="synConstant">2</span><span class="synError">)</span> <span class="synStatement">"</span><span class="synConstant">foo</span><span class="synStatement">"</span>
   <span class="synConstant">3</span><span class="synError">)</span> <span class="synStatement">"</span><span class="synConstant">bar</span><span class="synStatement">"</span>
   <span class="synConstant">4</span><span class="synError">)</span> <span class="synStatement">"</span><span class="synConstant">1</span><span class="synStatement">"</span>
 <span class="synConstant">2</span><span class="synError">)</span> <span class="synConstant">1</span><span class="synError">)</span> <span class="synPreProc">(</span><span class="synStatement">integer</span><span class="synPreProc">)</span> <span class="synConstant">68</span>
<span class="synConstant">2</span><span class="synError">)</span> <span class="synPreProc">(</span><span class="synStatement">integer</span><span class="synPreProc">)</span> <span class="synConstant">1386261168</span>
<span class="synConstant">3</span><span class="synError">)</span> <span class="synPreProc">(</span><span class="synStatement">integer</span><span class="synPreProc">)</span> <span class="synConstant">14837</span>
<span class="synConstant">4</span><span class="synError">)</span> <span class="synConstant">1</span><span class="synError">)</span> <span class="synStatement">"</span><span class="synConstant">HINCRBY</span><span class="synStatement">"</span>
   <span class="synConstant">2</span><span class="synError">)</span> <span class="synStatement">"</span><span class="synConstant">foo</span><span class="synStatement">"</span>
   <span class="synConstant">3</span><span class="synError">)</span> <span class="synStatement">"</span><span class="synConstant">bar</span><span class="synStatement">"</span>
   <span class="synConstant">4</span><span class="synError">)</span> <span class="synStatement">"</span><span class="synConstant">1</span><span class="synStatement">"</span>
</pre>
</div>
<div class="section">
<h5>どうやって問題を解決するか？</h5>
<p>僕が思いついたのは<span class="deco" style="font-weight:bold;">1.<a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a>のKernel設定を修正する</span>、<span class="deco" style="font-weight:bold;">2.<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a> Module内でmutexによりConnectionを共有する</span>、<span class="deco" style="font-weight:bold;">3.Redisの設定ファイルを修正してチューニング</span>するの３つです。2.は既にmod_redisがやっています。<a href="https://github.com/sneakybeaky/mod_redis">sneakybeaky/mod_redis</a> <a href="http://b.hatena.ne.jp/entry/s/github.com/sneakybeaky/mod_redis"><img src="http://b.hatena.ne.jp/entry/image/https://github.com/sneakybeaky/mod_redis" alt="はてなブックマーク - sneakybeaky/mod_redis" border="0" /></a> 3.はRedisの運用を細かくやってみないとできなそうな気がしたので、ここでは1の例を紹介します。</p><br />
<p>net.<a class="keyword" href="http://d.hatena.ne.jp/keyword/ipv4">ipv4</a>.<a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a>_tw_recycleというsysctlのパラメータを1に設定します。このパラメータは高速にSocketのRecycle処理をしてくれます。<span class="deco" style="font-weight:bold;">ただし導入する時は注意してください</span>。同一IPからのアクセスは直ぐにSocketを解放してしまう可能性があるためです。十分なテストをしてから導入しましょう。</p><br />
<p>今回は導入した結果、<span class="deco" style="font-weight:bold;">Failed requestsが無くなり</span>、<span class="deco" style="font-weight:bold;">Cannot assign requested addressが<a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>_logに表示されなくなり</span>、<span class="deco" style="font-weight:bold;">更にrpsも1912.64まで上がる</span>という非常に効果の良い設定となりました。実行結果もRequest数に従った登録結果になっています。</p><br />
<p>今回の件とはあまり関係ありませんが、その他kernel関係の設定で<a class="keyword" href="http://d.hatena.ne.jp/keyword/vm">vm</a>.overcommit_memory=1のように設定するとbackground save時にmemoryの問題が回避される等の事例があるので、時間がある時に検証してみたいと思います。<a href="http://qiita.com/y_matsuwitter/items/4fc43a53d2ac24f7783e">Redisを使う時は見積の二倍の容量必要だよね、という話 - Qiita [キータ]</a> <a href="http://b.hatena.ne.jp/entry/qiita.com/y_matsuwitter/items/4fc43a53d2ac24f7783e"><img src="http://b.hatena.ne.jp/entry/image/http://qiita.com/y_matsuwitter/items/4fc43a53d2ac24f7783e" alt="はてなブックマーク - Redisを使う時は見積の二倍の容量必要だよね、という話 - Qiita [キータ]" border="0" /></a></p>
<pre class="hljs sh" data-lang="sh" data-unlink>$ sudo vim /etc/sysctl.conf
net.ipv4.tcp_tw_recycle <span class="synStatement">=</span> <span class="synConstant">1</span>

$ sudo sysctl <span class="synSpecial">-p</span>

$ <span class="synStatement">for </span>i <span class="synStatement">in</span> <span class="synSpecial">{</span>1..10<span class="synSpecial">}</span>
<span class="synStatement">do</span>
ab <span class="synStatement">-n</span> <span class="synConstant">10000</span> <span class="synStatement">-c</span> <span class="synConstant">10</span> <span class="synStatement">"</span><span class="synConstant">http://localhost/redis</span><span class="synStatement">"</span>
<span class="synStatement">done</span>

Concurrency Level:      <span class="synConstant">10</span>
Time taken <span class="synStatement">for </span>tests:   5.228 seconds
Complete requests:      <span class="synConstant">10000</span>
Failed requests:        <span class="synConstant">0</span>
Write errors:           <span class="synConstant">0</span>
Total transferred:      <span class="synConstant">1670835</span> bytes
HTML transferred:       <span class="synConstant">0</span> bytes
Requests per second:    1912.64 <span class="synStatement">[</span>#/sec<span class="synStatement">]</span> <span class="synStatement">(</span>mean<span class="synStatement">)</span>
Time per request:       5.228 <span class="synStatement">[</span>ms<span class="synStatement">]</span> <span class="synStatement">(</span>mean<span class="synStatement">)</span>
Time per request:       0.523 <span class="synStatement">[</span>ms<span class="synStatement">]</span> <span class="synStatement">(</span>mean, across all concurrent requests<span class="synStatement">)</span>
Transfer rate:          312.08 <span class="synStatement">[</span>Kbytes/sec<span class="synStatement">]</span> received

Connection Times <span class="synStatement">(</span>ms<span class="synStatement">)</span>
          min  mean<span class="synStatement">[</span>+/-sd<span class="synStatement">]</span> median   max
Connect:        <span class="synConstant">0</span>    <span class="synConstant">2</span>   1.9      <span class="synConstant">2</span>      <span class="synConstant">23</span>
Processing:     <span class="synConstant">1</span>    <span class="synConstant">5</span>   3.6      <span class="synConstant">4</span>     <span class="synConstant">131</span>
Waiting:        <span class="synConstant">0</span>    <span class="synConstant">4</span>   3.3      <span class="synConstant">3</span>     <span class="synConstant">105</span>
Total:          <span class="synConstant">1</span>    <span class="synConstant">7</span>   3.5      <span class="synConstant">7</span>     <span class="synConstant">134</span>

$ redis-cli HGET foo bar 
<span class="synStatement">"</span><span class="synConstant">100039</span><span class="synStatement">"</span>
</pre>
</div>
</blockquote>

</div>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://yutakikuchi.github.io/blog/post/201311220824/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://yutakikuchi.github.io/blog/post/201311220824/">Apache ModuleでRequest ParameterをParseしてDBからデータを取得する</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://yutakikuchi.github.io/blog/post/201312110756/">「DSP/RTBオーディエンスターゲティング入門」読了</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://yutakikuchi.github.io/blog/post/201312110756/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>

</div>
</div>
<script src="https://yutakikuchi.github.io/blog/js/ui.js"></script>
<script src="https://yutakikuchi.github.io/blog/js/menus.js"></script>


<script>
  
  if (window.location.hostname != "localhost") {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-20616165-3', 'auto');
    ga('send', 'pageview');
  }
</script>





</body>
</html>

