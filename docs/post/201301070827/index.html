<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="canonical" href="http://yut.hatenablog.com/entry/20130107/1357514830" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.55.4" />

  <title>10分でHadoop-Pigの基本文法を理解する &middot; Y&#39;s note</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://yutakikuchi.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://yutakikuchi.github.io/img/favicon.ico" type="image/x-icon" />

  
    
        <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/my.css">
    
  
  
    
        <script src="https://yutakikuchi.github.io/blog/js/my.js"></script>
    
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://yutakikuchi.github.io/">Y's note</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/yutakikuchi_" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://facebook.com/yuta.kikuchi.007" target="_blank"><i class="fa fa-facebook-square fa-fw"></i>Facebook</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="http://slideshare.net/https://www.slideshare.net/yutakikuchi58/" target="_blank"><i class="fa fa-slideshare fa-fw"></i>SlideShare</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/https://www.linkedin.com/in/%E4%BD%91%E5%A4%AA-%E8%8F%8A%E6%B1%A0-36291a44/" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/yutakikuchi" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2019. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>10分でHadoop-Pigの基本文法を理解する</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2013 Jan 07, 08:27</time>
  </div>

  

  

  

</div>

  

<h2 id="hadoop-10分でhadoop-pigの基本文法を理解する">[Hadoop] : 10分でHadoop-Pigの基本文法を理解する</h2>

<p><div class="amazlet-box"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4873115124/yutakikuchi-22/"><img src="http://ecx.images-amazon.com/images/I/51Nb6sehnIL._SL160_.jpg" class="hatena-asin-detail-image" alt="Hadoop MapReduce デザインパターン ―MapReduceによる大規模テキストデータ処理" title="Hadoop MapReduce デザインパターン ―MapReduceによる大規模テキストデータ処理"></a><div class="hatena-asin-detail-info"><p class="hatena-asin-detail-title"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4873115124/yutakikuchi-22/">Hadoop MapReduce デザインパターン ―MapReduceによる大規模テキストデータ処理</a></p><ul><li><span class="hatena-asin-detail-label">作者:</span> Jimmy Lin,Chris Dyer,神林飛志,野村直之,玉川竜司</li><li><span class="hatena-asin-detail-label">出版社/メーカー:</span> <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AA%A5%E9%A5%A4%A5%EA%A1%BC%A5%B8%A5%E3%A5%D1%A5%F3">オライリージャパン</a></li><li><span class="hatena-asin-detail-label">発売日:</span> 2011/10/01</li><li><span class="hatena-asin-detail-label">メディア:</span> 大型本</li><li><span class="hatena-asin-detail-label">購入</span>: 4人 <span class="hatena-asin-detail-label">クリック</span>: 254回</li><li><a href="http://d.hatena.ne.jp/asin/4873115124/yutakikuchi-22" target="_blank">この商品を含むブログ (16件) を見る</a></li></ul></div><div class="hatena-asin-detail-foot"></div></div></p>

<div class="section">
<h4>はじめに</h4>

<blockquote>
    <p>年末から使い続けているPigについて勉強した事をまとめていきます。主に以下のDocumentを参照しています。PigのDocumentでLatinを日本語で詳しく紹介しているものが見当たらなかったので、そういった目的でこの記事を参照されている方のお役に立てれば光栄です。</p>

<ul>
<li><a href="http://pig.apache.org/docs/r0.10.0/start.html">Getting Started</a> <a href="http://b.hatena.ne.jp/entry/pig.apache.org/docs/r0.10.0/start.html"><img src="http://b.hatena.ne.jp/entry/image/http://pig.apache.org/docs/r0.10.0/start.html" alt="はてなブックマーク - Getting Started" border="0" /></a></li>
<li><a href="http://pig.apache.org/docs/r0.10.0/basic.html">Pig Latin Basics</a> <a href="http://b.hatena.ne.jp/entry/pig.apache.org/docs/r0.10.0/basic.html"><img src="http://b.hatena.ne.jp/entry/image/http://pig.apache.org/docs/r0.10.0/basic.html" alt="はてなブックマーク - Pig Latin Basics" border="0" /></a></li>
<li><a href="https://cwiki.apache.org/confluence/display/PIG/PigTutorial">PigTutorial - Apache Pig - Apache Software Foundation</a> <a href="http://b.hatena.ne.jp/entry/s/cwiki.apache.org/confluence/display/PIG/PigTutorial"><img src="http://b.hatena.ne.jp/entry/image/https://cwiki.apache.org/confluence/display/PIG/PigTutorial" alt="はてなブックマーク - PigTutorial - Apache Pig - Apache Software Foundation" border="0" /></a></li>
<li><a href="http://s3-ap-northeast-1.amazonaws.com/pig.doc.ja/basic.html">Pig Latin の基本</a> <a href="http://b.hatena.ne.jp/entry/s3-ap-northeast-1.amazonaws.com/pig.doc.ja/basic.html"><img src="http://b.hatena.ne.jp/entry/image/http://s3-ap-northeast-1.amazonaws.com/pig.doc.ja/basic.html" alt="はてなブックマーク - Pig Latin の基本" border="0" /></a></li>
<li><a href="http://d.hatena.ne.jp/yutakikuchi/20121229/1356759173">Hadoop Oozie設定からPigのPythonUDFを利用するまでのまとめ - Yuta.Kikuchiの日記</a> <a href="http://b.hatena.ne.jp/entry/d.hatena.ne.jp/yutakikuchi/20121229/1356759173"><img src="http://b.hatena.ne.jp/entry/image/http://d.hatena.ne.jp/yutakikuchi/20121229/1356759173" alt="はてなブックマーク - Hadoop Oozie設定からPigのPythonUDFを利用するまでのまとめ - Yuta.Kikuchiの日記" border="0" /></a></li>
<li><a href="http://d.hatena.ne.jp/yutakikuchi/20121217/1355700637">PigでHadoopをより便利に使う！PigでのMapReduceまとめ - Yuta.Kikuchiの日記</a> <a href="http://b.hatena.ne.jp/entry/d.hatena.ne.jp/yutakikuchi/20121217/1355700637"><img src="http://b.hatena.ne.jp/entry/image/http://d.hatena.ne.jp/yutakikuchi/20121217/1355700637" alt="はてなブックマーク - PigでHadoopをより便利に使う！PigでのMapReduceまとめ - Yuta.Kikuchiの日記" border="0" /></a></li>
</ul>
</blockquote>

</div>
<div class="section">
<h4>Pig Tutorial</h4>

<blockquote>
    
<div class="section">
<h5>tutorial.tar.gzのdownloadとscriptの実行</h5>
<p>tutorialのサンプルファイルが入っているtutorial.tar.gzをdownloadして解凍します。解凍したら作成されるディレクトリに移動します。試しにlocalmodeでscript1-local.pigを実行してみます。実行すると結果のディレクトリがlocalに作成されて中身を確認する事ができます。実行したサンプルはexecite-small.logという検索Queryログをtab区切りでparseして、Queryのngramを抽出します。抽出したngramの頻度に対してscoreを付けて、頻度の高いngramを出力しています。では以下では文法を確認して行きます。</p>
<pre class="code" data-lang="" data-unlink>$ wget -O  tutorial.tar.gz "https://cwiki.apache.org/confluence/download/attachments/27822259/pigtutorial.tar.gz?version=1&modificationDate=1311188529000"
$ tar xzf  tutorial.tar.gz
$ cd pigtmp
$ ls 
-rw-r--r--. 1 yuta yuta 204K  7月 21 04:01 2011 excite-small.log
-rw-r--r--. 1 yuta yuta  10M  7月 21 04:01 2011 excite.log.bz2
-rw-r--r--. 1 yuta yuta  11M  7月 21 04:01 2011 pig.jar
-rw-r--r--. 1 yuta yuta 3.8K  7月 21 04:01 2011 script1-hadoop.pig
-rw-r--r--. 1 yuta yuta 3.8K  7月 21 04:01 2011 script1-local.pig
-rw-r--r--. 1 yuta yuta 3.5K  7月 21 04:01 2011 script2-hadoop.pig
-rw-r--r--. 1 yuta yuta 3.4K  7月 21 04:01 2011 script2-local.pig
-rw-r--r--. 1 yuta yuta  11K  7月 21 04:01 2011 tutorial.jar
$ pig -x local script1-local.pig
2013-01-05 03:32:08,341 [main] INFO  org.apache.pig.Main - Logging error messages to: /home/yuta/scripts/pigtmp/pig_1357324328284.log
2013-01-05 03:32:08,621 [main] INFO  org.apache.pig.backend.hadoop.executionengine.HExecutionEngine - Connecting to hadoop file system at: file:///
2013-01-05 03:32:09,203 [main] WARN  org.apache.pig.PigServer - Encountered Warning USING_OVERLOADED_FUNCTION 3 time(s).
2013-01-05 03:32:09,205 [main] INFO  org.apache.pig.tools.pigstats.ScriptState - Pig features used in the script: GROUP_BY,ORDER_BY,DISTINCT,FILTER
(略)

$ cat script1-local-results/part-r-00000 
07  new 2.4494897427831788  2   1.1428571428571426
08  pictures    2.04939015319192    3   1.4999999999999998
08  computer    2.4494897427831788  2   1.1428571428571426
08  s   2.545584412271571   3   1.3636363636363635
10  free    2.2657896674010605  4   1.923076923076923
10  to  2.6457513110645903  2   1.125
10  pics    2.794002794004192   3   1.3076923076923075
10  school  2.828427124746189   2   1.1111111111111114
11  pictures    2.04939015319192    3   1.4999999999999998
11  in  2.1572774865200244  3   1.4285714285714284
13  the 3.1309398305840723  6   1.9375
14  music   2.1105794120443453  4   1.6666666666666667
14  city    2.2360679774997902  2   1.1666666666666665
14  university  2.412090756622109   3   1.4000000000000001
15  adult   2.8284271247461903  2   1.1111111111111112
17  chat    2.9104275004359965  3   1.2857142857142854
19  in  2.1572774865200244  3   1.4285714285714284
19  car 2.23606797749979    3   1.3333333333333333</pre>
</div>
<div class="section">
<h5>データ型について</h5>
<p><a href="http://pig.apache.org/docs/r0.10.0/basic.html">Pig Latin Basics</a> <a href="http://b.hatena.ne.jp/entry/pig.apache.org/docs/r0.10.0/basic.html"><img src="http://b.hatena.ne.jp/entry/image/http://pig.apache.org/docs/r0.10.0/basic.html" alt="はてなブックマーク - Pig Latin Basics" border="0" /></a><br />
Pigで扱うデータ型をLOAD時(後で説明)に定義する事ができます。以下はPigのデータ型ですので、よく覚えておくと良いと思います。<br />
Simple Types</p>

<table>
<tr>
<th> データ型 </th>
<th> 意味 </th>
<th> 例 </th>
</tr>
<tr>
<td> int </td>
<td> 符号付き32Bit整数 </td>
<td> 10 </td>
</tr>
<tr>
<td> long </td>
<td> 符号付き64Bit整数 </td>
<td> Data:10L or 10l Display:10L </td>
</tr>
<tr>
<td> float </td>
<td> 32bit<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C9%E2%C6%B0%BE%AE%BF%F4">浮動小数</a>点型 </td>
<td> Data:10.5F or 10.5f or 10.5e2f or 10.5E2F  Display: 10.5F or 1050.0F </td>
</tr>
<tr>
<td> double </td>
<td> 64bit<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C9%E2%C6%B0%BE%AE%BF%F4">浮動小数</a>点型 </td>
<td> Data:10.5 or 10.5e2 or 10.5E2 Display: 10.5 or 1050.0 </td>
</tr>
<tr>
<td> chararray </td>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/UTF-8">UTF-8</a>形式のstring(character array) </td>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/hello%20world">hello world</a> </td>
</tr>
<tr>
<td> bytearray </td>
<td> blob型のデータ </td>
<td> binary </td>
</tr>
<tr>
<td> boolean  </td>
<td> boolean </td>
<td> true / false </td>
</tr>
</table><p>Complex Types</p>

<table>
<tr>
<th> データ型 </th>
<th> 意味 </th>
<th> 例 </th>
</tr>
<tr>
<td> tuple </td>
<td> データ項目の組み合わせ </td>
<td> (19,2) </td>
</tr>
<tr>
<td> bag </td>
<td> tupleの組み合わせ </td>
<td> {(19,2), (18,1)} </td>
</tr>
<tr>
<td> map </td>
<td> 辞書データ。key/value </td>
<td> [open#<a class="keyword" href="http://d.hatena.ne.jp/keyword/apache">apache</a>] </td>
</tr>
</table><p>※ tuple,bag,fieldという単語が良く出てきますが、関係はbag > tuple > fieldというものになっている事をイメージしてもらえれば問題ないと思います。</p>

</div>
<div class="section">
<h5>PigScriptからUDFを使うためには<span class="deco" style="color:#FF0000;">REGISTER</span>で登録する</h5>
<p>PigScriptからorg.<a class="keyword" href="http://d.hatena.ne.jp/keyword/apache">apache</a>.pig.tutorial.NonURLDetector(query)のような不要なqueryを除外するような独自に定義した関数郡のjarファイルを登録するためには<span class="deco" style="color:#FF0000;">REGISTER</span>を使います。ちなみにtutorial.jarにはNonURLDetector以外にも以下のようなclassファイルが含まれています。また<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a>も<a class="keyword" href="http://d.hatena.ne.jp/keyword/hadoop">hadoop</a>-pigパッケージに含まれているので確認することができます。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>REGISTER ./tutorial.jar;
<span class="synType">raw</span> = LOAD <span class="synConstant">'excite-small.log'</span> <span class="synSpecial">USING</span> PigStorage(<span class="synConstant">'\t'</span>) <span class="synSpecial">AS</span> (<span class="synSpecial">user</span>, time, query);
clean1 = FILTER <span class="synType">raw</span> <span class="synSpecial">BY</span> org.apache.pig.tutorial.NonURLDetector(query);
</pre><pre class="code" data-lang="" data-unlink>$ zipinfo tutorial.jar 
Archive:  tutorial.jar
Zip file size: 10725 bytes, number of entries: 13
drwxr-xr-x  2.0 unx        0 bx stor 11-Jul-20 12:01 META-INF/
-rw-r--r--  2.0 unx      107 b- defN 11-Jul-20 12:01 META-INF/MANIFEST.MF
drwxr-xr-x  2.0 unx        0 b- stor 11-Jul-20 12:01 org/
drwxr-xr-x  2.0 unx        0 b- stor 11-Jul-20 12:01 org/apache/
drwxr-xr-x  2.0 unx        0 b- stor 11-Jul-20 12:01 org/apache/pig/
drwxr-xr-x  2.0 unx        0 b- stor 11-Jul-20 12:01 org/apache/pig/tutorial/
-rw-r--r--  2.0 unx     2201 b- defN 11-Jul-20 12:01 org/apache/pig/tutorial/ExtractHour.class
-rw-r--r--  2.0 unx     3283 b- defN 11-Jul-20 12:01 org/apache/pig/tutorial/NGramGenerator.class
-rw-r--r--  2.0 unx     2302 b- defN 11-Jul-20 12:01 org/apache/pig/tutorial/NonURLDetector.class
-rw-r--r--  2.0 unx     3728 b- defN 11-Jul-20 12:01 org/apache/pig/tutorial/ScoreGenerator.class
-rw-r--r--  2.0 unx     2163 b- defN 11-Jul-20 12:01 org/apache/pig/tutorial/ToLower.class
-rw-r--r--  2.0 unx     4044 b- defN 11-Jul-20 12:01 org/apache/pig/tutorial/TutorialTest.class
-rw-r--r--  2.0 unx     1114 b- defN 11-Jul-20 12:01 org/apache/pig/tutorial/TutorialUtil.class
13 files, 18942 bytes uncompressed, 8953 bytes compressed:  52.7%</pre><pre class="hljs java" data-lang="java" data-unlink>$ repoquery -l hadoop-pig | grep NonURLDetector                                               
/usr/share/doc/pig-<span class="synConstant">0.8.1</span>+<span class="synConstant">28.39</span>/examples/src/org/apache/pig/tutorial/NonURLDetector.java
$ cat /usr/share/doc/pig-<span class="synConstant">0.8.1</span>+<span class="synConstant">28.39</span>/examples/src/org/apache/pig/tutorial/NonURLDetector.java
<span class="synPreProc">package</span> org.apache.pig.tutorial;

<span class="synPreProc">import</span> java.io.IOException;
<span class="synPreProc">import</span> java.util.regex.Matcher;
<span class="synPreProc">import</span> java.util.regex.Pattern;
<span class="synPreProc">import</span> java.util.List;
<span class="synPreProc">import</span> java.util.ArrayList;

<span class="synPreProc">import</span> org.apache.pig.FilterFunc;
<span class="synPreProc">import</span> org.apache.pig.FuncSpec;
<span class="synPreProc">import</span> org.apache.pig.data.Tuple;
<span class="synPreProc">import</span> org.apache.pig.impl.logicalLayer.schema.Schema;
<span class="synPreProc">import</span> org.apache.pig.data.DataType;
<span class="synPreProc">import</span> org.apache.pig.impl.logicalLayer.FrontendException;

<span class="synComment">/**</span>
<span class="synComment"> *</span><span class="synSpecial"> This function removes search queries that are URLs (as defined by _urlPattern).</span>
<span class="synComment"> * This function also removes empty queries.</span>
<span class="synComment"> */</span>
<span class="synType">public</span> <span class="synType">class</span> NonURLDetector <span class="synType">extends</span> FilterFunc {

  <span class="synType">private</span> Pattern _urlPattern = Pattern.compile(<span class="synConstant">"^[</span><span class="synSpecial">\"</span><span class="synConstant">]?(http[:|;])|(https[:|;])|(www</span><span class="synSpecial">\\</span><span class="synConstant">.)"</span>);
  
  <span class="synType">public</span> Boolean exec(Tuple arg0) <span class="synType">throws</span> IOException {
  <span class="synStatement">if</span> (arg0 == <span class="synConstant">null</span> || arg0.size() == <span class="synConstant">0</span>)
      <span class="synStatement">return</span> <span class="synConstant">false</span>;

String query; 
<span class="synStatement">try</span>{
    query = (String)arg0.get(<span class="synConstant">0</span>);
    <span class="synStatement">if</span>(query == <span class="synConstant">null</span>)
        <span class="synStatement">return</span> <span class="synConstant">false</span>;
    query = query.trim();
}<span class="synStatement">catch</span>(Exception e){
    System.err.println(<span class="synConstant">"NonURLDetector: failed to process input; error - "</span> + e.getMessage());
    <span class="synStatement">return</span> <span class="synConstant">false</span>;
}

<span class="synStatement">if</span> (query.equals(<span class="synConstant">""</span>)) {
  <span class="synStatement">return</span> <span class="synConstant">false</span>;
}
Matcher m = _urlPattern.matcher(query);
<span class="synStatement">if</span> (m.find()) {
  <span class="synStatement">return</span> <span class="synConstant">false</span>;
}
<span class="synStatement">return</span> <span class="synConstant">true</span>;
  }
  
  <span class="synComment">/* (non-Javadoc)</span>
<span class="synComment">   * @see org.apache.pig.EvalFunc#getArgToFuncMapping()</span>
<span class="synComment">   * This is needed to make sure that both bytearrays and chararrays can be passed as arguments</span>
<span class="synComment">   */</span>
  <span class="synPreProc">@Override</span>
  <span class="synType">public</span> List<FuncSpec> getArgToFuncMapping() <span class="synType">throws</span> FrontendException {
  List<FuncSpec> funcList = <span class="synStatement">new</span> ArrayList<FuncSpec>();
  funcList.add(<span class="synStatement">new</span> FuncSpec(<span class="synType">this</span>.getClass().getName(), <span class="synStatement">new</span> Schema(<span class="synStatement">new</span> Schema.FieldSchema(<span class="synConstant">null</span>, DataType.CHARARRAY))));

  <span class="synStatement">return</span> funcList;
  }

}
</pre>
</div>
<div class="section">
<h5><span class="deco" style="color:#FF0000;">LOAD</span>でデータの読み込み、<span class="deco" style="color:#FF0000;">USING</span>でデータParserを指定、<span class="deco" style="color:#FF0000;">AS</span>で変数としてのデータをaliasで定義</h5>
<p>今回Queryの元データ集計を行うためのファイルは以下のようなタブ区切りでデータが保存されています。まずはデータを読み込むために<span class="deco" style="color:#FF0000;">LOAD</span> 'ファイル名'でデータを呼び出します。呼び出したデータをパースしてカラム変数に格納するために<span class="deco" style="color:#FF0000;">USING</span>と<span class="deco" style="color:#FF0000;">AS</span>を使います。PigStorage関数の引数にparseするためのdelimiterを入れます。tutorialの例では'\t'と入れていますが、defaultは'\t'なので入れなくても動きます。PigStorageClassについては以下のリンク先を参照すると良いと思います。<a href="http://pig.apache.org/docs/r0.10.0/api/org/apache/pig/builtin/PigStorage.html">PigStorage (Pig 0.10.0 API)</a> <a href="http://b.hatena.ne.jp/entry/pig.apache.org/docs/r0.10.0/api/org/apache/pig/builtin/PigStorage.html"><img src="http://b.hatena.ne.jp/entry/image/http://pig.apache.org/docs/r0.10.0/api/org/apache/pig/builtin/PigStorage.html" alt="はてなブックマーク - PigStorage (Pig 0.10.0 API)" border="0" /></a> ASはdelimiterによって分離されたデータ項目をカラム順に格納します。ASを使わないということも出来ます。カラムのaliasを持たない場合は$0,$1,$2のように<span class="deco" style="color:#FF0000;">$とカラム番号名</span>で参照することになります。ASの中ではデータ型の定義が可能です。user:chararrayのように指定します。chararrayは上で説明した文字列型の事です。</p>
<pre class="code" data-lang="" data-unlink>2A9EABFB35F5B954    970916105432    +md foods +proteins
BED75271605EBD0C    970916001949    yahoo chat
BED75271605EBD0C    970916001954    yahoo chat
BED75271605EBD0C    970916003523    yahoo chat
BED75271605EBD0C    970916011322    yahoo search
BED75271605EBD0C    970916011404    yahoo chat
BED75271605EBD0C    970916011422    yahoo chat
BED75271605EBD0C    970916012756    yahoo caht</pre><pre class="hljs sql" data-lang="sql" data-unlink><span class="synType">raw</span> = LOAD <span class="synConstant">'excite-small.log'</span> <span class="synSpecial">USING</span> PigStorage(<span class="synConstant">'\t'</span>) <span class="synSpecial">AS</span> (<span class="synSpecial">user</span>, time, query);
<span class="synType">raw</span> = LOAD <span class="synConstant">'excite-small.log'</span> <span class="synSpecial">USING</span> PigStorage(<span class="synConstant">'\t'</span>) <span class="synComment">-- カラム名を指定しないので参照する時は$0,$1,$2</span>
<span class="synType">raw</span> = LOAD <span class="synConstant">'excite-small.log'</span> <span class="synSpecial">USING</span> PigStorage(<span class="synConstant">'\t'</span>) <span class="synSpecial">AS</span> (<span class="synSpecial">user</span>: chararray, time: chararray, query: chararray); <span class="synComment">-- データ型を指定</span>
</pre>
</div>
<div class="section">
<h5>格納されているデータを確認する場合は<span class="deco" style="color:#FF0000;">DUMP</span>を利用する</h5>
<p>格納されている変数のデータを確認するには<span class="deco" style="color:#FF0000;">DUMP</span>を利用します。単純にDUMP 変数名;として指定するだけです。DUMPは<span class="deco" style="color:#FF0000;">LOAD</span>、<span class="deco" style="color:#FF0000;">FILTER</span>、<span class="deco" style="color:#FF0000;">FOREACH</span>などによって生成された結果の変数に対してはデータの出力が可能ですが、DUMP 変数名.AS<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A5%E9%A5%E0%CC%BE">カラム名</a>;といった指定で特定のカラムのみを出力することができません。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>DUMP <span class="synType">raw</span>;
<span class="synComment">-- DUMP raw.user -- 失敗する例</span>
</pre><pre class="code" data-lang="" data-unlink>(0158F8ACC570947D,970916162130,wu tang clan)
(0158F8ACC570947D,970916162623,doggumentary)
(0158F8ACC570947D,970916163639,control machete)
(06878125BE78B42C,970916183900,how to make ecstacy)
(06878125BE78B42C,970916184804,jdun@scuc.edu.au)
(06878125BE78B42C,970916185100,tborges@inetminas.estaminas.com.br)
(B0C1B6DC7370F24B,970916090623,hhtp://www.yale.edu/opa.)
(1432F28A749F7BE6,970916220548,nesticle 0.40 download)
(1432F28A749F7BE6,970916221400,nes rom)
(1432F28A749F7BE6,970916221804,double dragon 3 rom)
(1432F28A749F7BE6,970916221859,emuland)
(98F5BBD3754D292F,970916082614,powwow.com)
(98F5BBD3754D292F,970916082616,powwow.com)
(98F5BBD3754D292F,970916082713,powwow.com tribal )
(C5D01E05FF9CA265,970916155706,mary lou allgood)
(C5D01E05FF9CA265,970916155729,mary lou allgood)
(DB38E7AF26F3AD9A,970916114356,microsoft excel)</pre>
</div>
<div class="section">
<h5>不要なデータを削除するためには<span class="deco" style="color:#FF0000;">FILTER</span>を使う</h5>
<p>条件を指定して不要なデータ行を削除するために<span class="deco" style="color:#FF0000;">FILTER</span>を利用します。下のサンプルではUDFで定義されたorg.<a class="keyword" href="http://d.hatena.ne.jp/keyword/apache">apache</a>.pig.tutorial.NonURLDetector(query)を利用してqueryが空またはURL形式で無い場合は変数に格納するという処理をしています。UDFの中では単純にTrue/Falseをreturnするだけです。もっと簡単な例だと空かどうかの判定だけであればquery != ''のように指定することもできます。文字列比較では<span class="deco" style="color:#FF0000;">eq</span>という<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B1%E9%BB%BB%BB%D2">演算子</a>で一致を確認することができます。eqは==と等価です。しかし不一致の<span class="deco" style="color:#FF0000;">ne</span>は使えません。またFILTERは数値演算も可能です。BY score > 2.0のように指定するとできます。更に便利なことにFILTERには<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C0%B5%B5%AC%C9%BD%B8%BD">正規表現</a>も使え、指定には<span class="deco" style="color:#FF0000;">MATCHES</span>を利用します。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>clean1 = FILTER <span class="synType">raw</span> <span class="synSpecial">BY</span> org.apache.pig.tutorial.NonURLDetector(query);
clean2 = FILTER <span class="synType">raw</span> <span class="synSpecial">BY</span> query != <span class="synConstant">''</span>;
clean2 = FILTER <span class="synType">raw</span> <span class="synSpecial">BY</span> query eq <span class="synConstant">''</span>;
clean2 = FILTER <span class="synType">raw</span> <span class="synSpecial">BY</span> query == <span class="synConstant">''</span>;
<span class="synComment">-- clean2 = FILTER raw BY query eq ''; -- 指定できない</span>
clean2 = FILTER <span class="synType">raw</span> <span class="synSpecial">BY</span> query MATCHES <span class="synConstant">'.*university.*'</span>;
filtered_uniq_frequency = FILTER uniq_frequency3 <span class="synSpecial">BY</span> score > <span class="synConstant">2.0</span>;
</pre>
</div>
<div class="section">
<h5>カラムデータに対して繰り返し処理を加えたい場合は<span class="deco" style="color:#FF0000;">FOREACH</span>を利用する</h5>
<p>抽出された行のカラムに対して特定の処理を繰り返し加えたい場合は<span class="deco" style="color:#FF0000;">FOREACH 変数名 GENERATE</span>を利用します。下ではURLや空をFILTERした行に対して、queryを小文字に変換し、timeを検索時間に変換し、ngramに分割したデータがタプル形式になっているので、それをフラット化するために<span class="deco" style="color:#FF0000;">FLATTEN</span>を使っています。tutorialの例ではFOREACHを3行使っていて面倒なので、1行にまとめてしまうことも出来ます。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>clean1 = FILTER <span class="synType">raw</span> <span class="synSpecial">BY</span> org.apache.pig.tutorial.NonURLDetector(query);
clean2 = FOREACH clean1 GENERATE <span class="synSpecial">user</span>, time, org.apache.pig.tutorial.ToLower(query) <span class="synSpecial">AS</span> query;
houred = FOREACH clean2 GENERATE <span class="synSpecial">user</span>, org.apache.pig.tutorial.ExtractHour(time) <span class="synSpecial">AS</span> hour, query;
ngramed1 = FOREACH houred GENERATE <span class="synSpecial">user</span>, hour, FLATTEN(org.apache.pig.tutorial.NGramGenerator(query)) <span class="synSpecial">AS</span> ngram;
DUMP ngramed1;

<span class="synComment">-- 上のFOREACHを1行でまとめる</span>
ngramed1 = FOREACH clean1 GENERATE <span class="synSpecial">user</span>, org.apache.pig.tutorial.ExtractHour( time ) <span class="synSpecial">AS</span> hour, FLATTEN( org.apache.pig.tutorial.NGramGenerator( org.apache.pig.tutorial.ToLower( query ) ) ) <span class="synSpecial">AS</span> ngram;
</pre><pre class="code" data-lang="" data-unlink>-- フラット化されたデータ
(C5D01E05FF9CA265,15,allgood)
(C5D01E05FF9CA265,15,lou allgood)
(C5D01E05FF9CA265,15,lou)
(C5D01E05FF9CA265,15,mary)
(C5D01E05FF9CA265,15,mary lou)
(C5D01E05FF9CA265,15,allgood)
(C5D01E05FF9CA265,15,lou allgood)
(C5D01E05FF9CA265,15,lou)
(C5D01E05FF9CA265,15,mary)
(C5D01E05FF9CA265,15,mary lou)
(DB38E7AF26F3AD9A,11,excel)
(DB38E7AF26F3AD9A,11,microsoft excel)
(DB38E7AF26F3AD9A,11,microsoft)

-- フラット化されていないデータ
(98F5BBD3754D292F,08,{(com),(powwow com),(powwow)})
(98F5BBD3754D292F,08,{(com),(powwow com),(powwow)})
(98F5BBD3754D292F,08,{(com),(powwow com),(tribal),(powwow),(com tribal)})
(C5D01E05FF9CA265,15,{(allgood),(lou allgood),(lou),(mary),(mary lou)})
(C5D01E05FF9CA265,15,{(allgood),(lou allgood),(lou),(mary),(mary lou)})
(DB38E7AF26F3AD9A,11,{(excel),(microsoft excel),(microsoft)})</pre>
</div>
<div class="section">
<h5>重複された行を削除しUniqしたい場合は<span class="deco" style="color:#FF0000;">DISTINCT</span>を使う</h5>
<p>重複された行を削除したい場合は<span class="deco" style="color:#FF0000;">DISTINCT</span>を利用します。<a class="keyword" href="http://d.hatena.ne.jp/keyword/RDBMS">RDBMS</a>を使っている人なら馴染みある機能だと思います。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>ngramed2 = <span class="synStatement">DISTINCT</span> ngramed1;
DUMP ngramed2;
</pre><pre class="code" data-lang="" data-unlink>(FFA4F354D3948CFB,05,big cocks)
(FFA4F354D3948CFB,06,big)
(FFA4F354D3948CFB,06,cocks)
(FFA4F354D3948CFB,06,big cocks)
(FFCA848089F3BA8C,10,manson)
(FFCA848089F3BA8C,10,marilyn)
(FFCA848089F3BA8C,10,marilyn manson)</pre>
</div>
<div class="section">
<h5>データのグループ化をしたい場合は<span class="deco" style="color:#FF0000;">GROUP</span>を使う</h5>
<p>特定の条件でデータのグループ化をしたい場合は<span class="deco" style="color:#FF0000;">GROUP</span>を利用します。下の例では検索時間,ngramの二つでuserのListをGROUPとして1行で出力しています。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>hour_frequency1 = <span class="synSpecial">GROUP</span> ngramed2 <span class="synSpecial">BY</span> (ngram, hour);
DUMP hour_frequency1;
</pre><pre class="code" data-lang="" data-unlink>((university,11),{(752FE259E734662C,11,university),(1C29DA34960DE1A9,11,university)})
((university,13),{(0E10DD8EB5EEB192,13,university),(C983FC6A580A67D4,13,university)})
((university,14),{(0D49AC0B76523A18,14,university),(6946DDFE6F9050F5,14,university),(C983FC6A580A67D4,14,university)})</pre>
</div>
<div class="section">
<h5>データの個数をカウントする場合は<span class="deco" style="color:#FF0000;">COUNT</span>を使う</h5>
<p>データの個数をカウントするには<span class="deco" style="color:#FF0000;">COUNT</span>を利用します。下の例では上でGROUP化されたデータのタプル数をカウントする例になります。(ngram,hour)のカラムが$0、GROUP化された(user,hour,ngram)カラムが$1に相当し、COUNT($1)の式によって((university,14),{(0D49AC0B76523A18,14,university),(6946DDFE6F9050F5,14,university),(C983FC6A580A67D4,14,university)})が(university,14,3)として3つカウントされます。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>hour_frequency2 = FOREACH hour_frequency1 GENERATE flatten($<span class="synConstant">0</span>), COUNT($<span class="synConstant">1</span>) <span class="synSpecial">as</span> count;
DUMP hour_frequency2;
</pre><pre class="code" data-lang="" data-unlink>(universita,09,1)
(university,01,1)
(university,06,1)
(university,09,1)
(university,10,1)
(university,11,2)
(university,13,2)
(university,14,3)
(university,15,1)
(university,19,1)
(university,21,1)
(univiristy,06,1)</pre>
</div>
<div class="section">
<h5>一つの項目だけでグループ化</h5>
<p>ここもGROUPの使い方の説明です。事前にグループ化されたデータをngramだけで再度グループ化しています。よくやってしまう間違いとしてBY ngram;と指定しまうことです。hour_frequency2にはngramという項目がありません。hour_frequency1でgroupされたngramが存在しているだけなので、group::ngramと指定します。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>uniq_frequency1 = <span class="synSpecial">GROUP</span> hour_frequency2 <span class="synSpecial">BY</span> <span class="synSpecial">group</span>::ngram;
<span class="synComment">-- uniq_frequency1 = GROUP hour_frequency2 BY group::ngram; -- 良くやる間違い</span>
DUMP uniq_frequency1;
</pre><pre class="code" data-lang="" data-unlink>(universita,{(universita,09,1)})
(university,{(university,14,3),(university,01,1),(university,06,1),(university,09,1),(university,10,1),(university,11,2),(university,13,2),(university,15,1),(university,19,1),(university,21,1)})
(univiristy,{(univiristy,06,1)})</pre>
</div>
<div class="section">
<h5>指定したカラムでソートしたい場合は<span class="deco" style="color:#FF0000;">ORDER</span>を使う</h5>
<p>特定のカラムでデータをソートしたい場合は<span class="deco" style="color:#FF0000;">ORDER</span>を利用します。DISTINCTと同様に<a class="keyword" href="http://d.hatena.ne.jp/keyword/RDBMS">RDBMS</a>にもある機能ですね。下の例ではngramのscore化されたデータをFILTERにてscore > 2.0の行を抽出し、hour/scoreの項目でソートをした結果を格納しています。ORDER BYは<a class="keyword" href="http://d.hatena.ne.jp/keyword/ASC">ASC</a>で昇順、DESCで降順にソートすることができます。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>uniq_frequency3 = FOREACH uniq_frequency2 GENERATE $<span class="synConstant">1</span> <span class="synSpecial">as</span> hour, $<span class="synConstant">0</span> <span class="synSpecial">as</span> ngram, $<span class="synConstant">2</span> <span class="synSpecial">as</span> score, $<span class="synConstant">3</span> <span class="synSpecial">as</span> count, $<span class="synConstant">4</span> <span class="synSpecial">as</span> mean;
filtered_uniq_frequency = FILTER uniq_frequency3 <span class="synSpecial">BY</span> score > <span class="synConstant">2.0</span>;
ordered_uniq_frequency = <span class="synSpecial">ORDER</span> filtered_uniq_frequency <span class="synSpecial">BY</span> hour, score; <span class="synComment">-- 昇順ソート</span>
ordered_uniq_frequency = <span class="synSpecial">ORDER</span> filtered_uniq_frequency <span class="synSpecial">BY</span> hour <span class="synSpecial">DESC</span>; <span class="synComment">-- 降順ソート</span>
</pre><pre class="code" data-lang="" data-unlink>-- DESC
(19,in,2.1572774865200244,3,1.4285714285714284)
(19,car,2.23606797749979,3,1.3333333333333333)
(17,chat,2.9104275004359965,3,1.2857142857142854)
(15,adult,2.8284271247461903,2,1.1111111111111112)
(14,music,2.1105794120443453,4,1.6666666666666667)
(14,city,2.2360679774997902,2,1.1666666666666665)
(14,university,2.412090756622109,3,1.4000000000000001)
(13,the,3.1309398305840723,6,1.9375)
(11,in,2.1572774865200244,3,1.4285714285714284)
(11,pictures,2.04939015319192,3,1.4999999999999998)
(10,free,2.2657896674010605,4,1.923076923076923)
(10,to,2.6457513110645903,2,1.125)
(10,pics,2.794002794004192,3,1.3076923076923075)
(10,school,2.828427124746189,2,1.1111111111111114)
(08,computer,2.4494897427831788,2,1.1428571428571426)
(08,pictures,2.04939015319192,3,1.4999999999999998)
(08,s,2.545584412271571,3,1.3636363636363635)
(07,new,2.4494897427831788,2,1.1428571428571426)</pre>
</div>
<div class="section">
<h5>データの結合には<span class="deco" style="color:#FF0000;">JOIN</span>を使う</h5>
<p>二つの変数間のデータを結合するには<span class="deco" style="color:#FF0000;">JOIN</span>を利用します。JOINには内部結合(INNER)と外部結合等(LEFT,RIGHT,FULL)の種類があり、何も指定しない場合は内部結合になります。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>same = JOIN hour00 <span class="synSpecial">BY</span> $<span class="synConstant">0</span>, hour12 <span class="synSpecial">BY</span> $<span class="synConstant">0</span>; <span class="synComment">-- 内部結合</span>
same = JOIN hour00 <span class="synSpecial">BY</span> $<span class="synConstant">0</span> LEFT, hour12 <span class="synSpecial">BY</span> $<span class="synConstant">0</span>; <span class="synComment">-- 左外部結合</span>
same = JOIN hour00 <span class="synSpecial">BY</span> $<span class="synConstant">0</span> RIGHT, hour12 <span class="synSpecial">BY</span> $<span class="synConstant">0</span>; <span class="synComment">-- 右外部結合</span>
same = JOIN hour00 <span class="synSpecial">BY</span> $<span class="synConstant">0</span> FULL, hour12 <span class="synSpecial">BY</span> $<span class="synConstant">0</span>; <span class="synComment">-- 全外部結合</span>
</pre><pre class="code" data-lang="" data-unlink>-- JOIN RIGHT
(,,,applied technologies,12,1)
(,,,horoscope benmcnenly,12,1)
(,,,providers california,12,1)
(,,,snowboarding kirkwood,12,1)
(,,,snowboarding kurkwood,12,1)
(,,,instrument instruments,12,1)
(,,,vietnam telecommunications,12,1)</pre>
</div>
<div class="section">
<h5>データを保存したい場合は<span class="deco" style="color:#FF0000;">STORE</span>を使う</h5>
<p>Pigで実行したデータをファイルに保存したい場合は<span class="deco" style="color:#FF0000;">STORE</span>を利用します。STOREもLOADと同様にUSINGでデータのparserを指定することが出来ます。下の例ではPigStorageを指定しているのでtab区切りのデータ保存になります。INTOで指定するのは結果を保存するディレクトリです。ディレクトリの中にpart-r-00000というファイルができるので、それが出力結果になります。結果は一番上で実行した<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>の結果になります。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>STORE ordered_uniq_frequency <span class="synSpecial">INTO</span> <span class="synConstant">'script1-local-results'</span> <span class="synSpecial">USING</span> PigStorage();
</pre>
</div>
</blockquote>

</div>
<div class="section">
<h4>Advanced</h4>

<blockquote>
    <p>以下ではtutorialに載っていない更なる応用例を記載します。入力サンプルのデータを変更して以下のタブ区切りで定義されているstudentデータを使います。データを変えたのは以下のページと結果を比較しやすくするためです。すいません。<a href="http://pig.apache.org/docs/r0.10.0/basic.html">Pig Latin Basics</a> <a href="http://b.hatena.ne.jp/entry/pig.apache.org/docs/r0.10.0/basic.html"><img src="http://b.hatena.ne.jp/entry/image/http://pig.apache.org/docs/r0.10.0/basic.html" alt="はてなブックマーク - Pig Latin Basics" border="0" /></a></p>
<pre class="code" data-lang="" data-unlink>John  18 4.0F
Mary  19 3.8F
Bill  20 3.9F
Joe   18 3.8F</pre>
<div class="section">
<h5>変数のデータ型を調べる時は<span class="deco" style="color:#FF0000;">DESCRIBE</span>を使う</h5>
<p>DESCRIBEは変数のデータ型を出力します。FLATTEN等の処理を入れる時にデータ型を確認するために利用すると便利です。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>raw1 = LOAD <span class="synConstant">'student'</span> <span class="synSpecial">USING</span> PigStorage() <span class="synSpecial">AS</span> (name:chararray, age:int, gpa:<span class="synType">float</span>);
DESCRIBE raw1;
</pre><pre class="code" data-lang="" data-unlink>raw: {name: chararray,age: int,gpa: float}</pre>
</div>
<div class="section">
<h5>2つ以上の変数をグループ化する時は<span class="deco" style="color:#FF0000;">COGROUP</span>を使う</h5>
<p>2つ以上の変数をグループ化したい時は<span class="deco" style="color:#FF0000;">COGROUP</span>を利用します。データや使い方の形式はGROUPと同じです。下では3つの変数をCOGROUPしています。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>raw1 = LOAD <span class="synConstant">'student'</span> <span class="synSpecial">USING</span> PigStorage() <span class="synSpecial">AS</span> (name:chararray, age:int, gpa:<span class="synType">float</span>);
raw2 = LOAD <span class="synConstant">'student'</span> <span class="synSpecial">USING</span> PigStorage() <span class="synSpecial">AS</span> (name:chararray, age:int, gpa:<span class="synType">float</span>);
raw3 = LOAD <span class="synConstant">'student'</span> <span class="synSpecial">USING</span> PigStorage() <span class="synSpecial">AS</span> (name:chararray, age:int, gpa:<span class="synType">float</span>);
filter_raw2 = FILTER raw2 <span class="synSpecial">BY</span> age == <span class="synConstant">18</span>;
co_data = COGROUP raw1 <span class="synSpecial">BY</span> age, filter_raw2 <span class="synSpecial">BY</span> age, raw3 <span class="synSpecial">BY</span> age;
DUMP co_data; 
</pre><pre class="code" data-lang="" data-unlink>(18,{(John,18,4.0),(Joe,18,3.8)},{(John,18,4.0),(Joe,18,3.8)},{(John,18,4.0),(Joe,18,3.8)})
(19,{(Mary,19,3.8)},{},{(Mary,19,3.8)})
(20,{(Bill,20,3.9)},{},{(Bill,20,3.9)})</pre>
</div>
<div class="section">
<h5>データの組み合わせを全て取得する時は<span class="deco" style="color:#FF0000;">CROSS</span>を使う</h5>
<p>2つ以上の変数の組み合わせを全て取得したい時は<span class="deco" style="color:#FF0000;">CROSS</span>を利用します。全ての組み合わせを作るので処理が凄く重くなるようなので注意して使うといいと思います。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>raw1 = LOAD <span class="synConstant">'student'</span> <span class="synSpecial">USING</span> PigStorage() <span class="synSpecial">AS</span> (name:chararray, age:int, gpa:<span class="synType">float</span>);
raw2 = LOAD <span class="synConstant">'student'</span> <span class="synSpecial">USING</span> PigStorage() <span class="synSpecial">AS</span> (name:chararray, age:int, gpa:<span class="synType">float</span>);
filter_raw2 = FILTER raw2 <span class="synSpecial">BY</span> age == <span class="synConstant">18</span>;
cross_data = CROSS raw1, filter_raw2;
DUMP cross_data; 
</pre><pre class="code" data-lang="" data-unlink>(John,18,4.0,Joe,18,3.8)
(John,18,4.0,John,18,4.0)
(Mary,19,3.8,Joe,18,3.8)
(Mary,19,3.8,John,18,4.0)
(Joe,18,3.8,Joe,18,3.8)
(Joe,18,3.8,John,18,4.0)
(Bill,20,3.9,Joe,18,3.8)
(Bill,20,3.9,John,18,4.0)</pre>
</div>
<div class="section">
<h5>2つのデータの統合は<span class="deco" style="color:#FF0000;">UNION</span>を使う</h5>
<p>2つ以上の変数を統合したい場合は<span class="deco" style="color:#FF0000;">UNION</span>を利用します。CROSSと違いUNIOは単純なデータの追加になります。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>raw1 = LOAD <span class="synConstant">'student'</span> <span class="synSpecial">USING</span> PigStorage() <span class="synSpecial">AS</span> (name:chararray, age:int, gpa:<span class="synType">float</span>);
raw2 = LOAD <span class="synConstant">'student'</span> <span class="synSpecial">USING</span> PigStorage() <span class="synSpecial">AS</span> (name:chararray, age:int, gpa:<span class="synType">float</span>);
filter_raw2 = FILTER raw2 <span class="synSpecial">BY</span> age == <span class="synConstant">18</span>;
union_data = <span class="synStatement">UNION</span> raw1, filter_raw2;
DUMP union_data;
</pre><pre class="code" data-lang="" data-unlink>(John,18,4.0)
(Mary,19,3.8)
(Bill,20,3.9)
(Joe,18,3.8)
(John,18,4.0)
(Joe,18,3.8)</pre>
</div>
<div class="section">
<h5>結果の個数を絞りたい時は<span class="deco" style="color:#FF0000;">LIMIT</span>を使う</h5>
<p>ORDER BYとの組み合わせで取得したい結果を絞りたい時は<span class="deco" style="color:#FF0000;">LIMIT</span>を利用します。単純に変数に対して個数を設定するだけです。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>raw1 = LOAD <span class="synConstant">'student'</span> <span class="synSpecial">USING</span> PigStorage() <span class="synSpecial">AS</span> (name:chararray, age:int, gpa:<span class="synType">float</span>);
raw2 = LOAD <span class="synConstant">'student'</span> <span class="synSpecial">USING</span> PigStorage() <span class="synSpecial">AS</span> (name:chararray, age:int, gpa:<span class="synType">float</span>);
filter_raw2 = FILTER raw2 <span class="synSpecial">BY</span> age == <span class="synConstant">18</span>;
union_data = <span class="synStatement">UNION</span> raw1, filter_raw2;
order_data = <span class="synSpecial">ORDER</span> union_data <span class="synSpecial">by</span> age <span class="synSpecial">DESC</span>;
limit_data = LIMIT order_data <span class="synConstant">2</span>;
DUMP limit_data;
</pre><pre class="code" data-lang="" data-unlink>(Bill,20,3.9)
(Mary,19,3.8)</pre>
</div>
<div class="section">
<h5>ランダムサンプリングを取得したい時は<span class="deco" style="color:#FF0000;">SAMPLE</span>を使う</h5>
<p>取得したいランダムサンプルの割合を<span class="deco" style="color:#FF0000;">SAMPLE</span>で指定します。指定方法はSAMPLE 変数名 割合実数です。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>raw1 = LOAD <span class="synConstant">'student'</span> <span class="synSpecial">USING</span> PigStorage() <span class="synSpecial">AS</span> (name:chararray, age:int, gpa:<span class="synType">float</span>);
raw2 = LOAD <span class="synConstant">'student'</span> <span class="synSpecial">USING</span> PigStorage() <span class="synSpecial">AS</span> (name:chararray, age:int, gpa:<span class="synType">float</span>);
filter_raw2 = FILTER raw2 <span class="synSpecial">BY</span> age == <span class="synConstant">18</span>;
union_data = <span class="synStatement">UNION</span> raw1, filter_raw2;
sample_data = SAMPLE union_data <span class="synConstant">0.1</span>;
DUMP sample_data;
</pre><pre class="code" data-lang="" data-unlink>(John,18,4.0)</pre>
</div>
<div class="section">
<h5>データを条件で分割したい場合は<span class="deco" style="color:#FF0000;">SPLIT</span>を使う</h5>
<p>データを特定の条件で<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%A3%BF%F4">複数</a>の変数に分割したい場合は<span class="deco" style="color:#FF0000;">SPLIT</span>を利用します。SPLITは<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%A3%BF%F4">複数</a>の変数における条件を1行で表現できますが、動作内容としてはFILTERと同様でFILTERでも表記することが出来ます。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>raw1 = LOAD <span class="synConstant">'student'</span> <span class="synSpecial">USING</span> PigStorage() <span class="synSpecial">AS</span> (name:chararray, age:int, gpa:<span class="synType">float</span>);
raw2 = LOAD <span class="synConstant">'student'</span> <span class="synSpecial">USING</span> PigStorage() <span class="synSpecial">AS</span> (name:chararray, age:int, gpa:<span class="synType">float</span>);
filter_raw2 = FILTER raw2 <span class="synSpecial">BY</span> age == <span class="synConstant">18</span>;
union_data = <span class="synStatement">UNION</span> raw1, filter_raw2;
SPLIT union_data <span class="synSpecial">INTO</span> x_data <span class="synSpecial">IF</span> age > <span class="synConstant">19</span>, y_data <span class="synSpecial">IF</span> age == <span class="synConstant">19</span>, z_data <span class="synSpecial">IF</span> age < <span class="synConstant">19</span>;
DUMP y_data;
</pre><pre class="code" data-lang="" data-unlink>(Mary,19,3.8)</pre>
</div>
<div class="section">
<h5>Nativeの<a class="keyword" href="http://d.hatena.ne.jp/keyword/MapReduce">MapReduce</a>を実行するには<span class="deco" style="color:#FF0000;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/MAPREDUCE">MAPREDUCE</a></span>を使う</h5>
<p>こちら実行を試していませんが、Nativeの<a class="keyword" href="http://d.hatena.ne.jp/keyword/MapReduce">MapReduce</a>を実行したい時には<span class="deco" style="color:#FF0000;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/MAPREDUCE">MAPREDUCE</a></span>を利用します。以下の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>にinputDir,outputDirを指定して実行します。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>A = LOAD <span class="synConstant">'WordcountInput.txt'</span>;
B = MAPREDUCE <span class="synConstant">'wordcount.jar'</span> STORE A <span class="synSpecial">INTO</span> <span class="synConstant">'inputDir'</span> LOAD <span class="synConstant">'outputDir'</span> <span class="synSpecial">AS</span> (word:chararray, count: int) `org.myorg.WordCount inputDir outputDir`;
</pre>
</div>
<div class="section">
<h5>データを外部<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>に渡すには<span class="deco" style="color:#FF0000;">STREAM</span>を使う</h5>
<p>こちらは実行していませんが、外部の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>にデータを渡したい場合は<span class="deco" style="color:#FF0000;">STREAM</span>を使います。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>A = LOAD <span class="synConstant">'data'</span>;
B = <span class="synSpecial">GROUP</span> A <span class="synSpecial">BY</span> $<span class="synConstant">1</span>;
C = FOREACH B FLATTEN(A);
D = STREAM C THROUGH `stream.pl`;
</pre>
</div>
</blockquote>

</div>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://yutakikuchi.github.io/post/201301030718/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://yutakikuchi.github.io/post/201301030718/">無駄無駄無駄無駄無駄ァ！ - The Lean StartUpから学ぶ無駄の無い起業プロセス - </a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://yutakikuchi.github.io/post/201301150833/">スタートアップを目指す人は必読！起業成功マニュアルの前半を読んでまとめを書きました</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://yutakikuchi.github.io/post/201301150833/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>

</div>
</div>
<script src="https://yutakikuchi.github.io/js/ui.js"></script>
<script src="https://yutakikuchi.github.io/js/menus.js"></script>


<script>
  
  if (window.location.hostname != "localhost") {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-20616165-3', 'auto');
    ga('send', 'pageview');
  }
</script>





</body>
</html>

