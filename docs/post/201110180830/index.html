<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="canonical" href="http://yut.hatenablog.com/entry/20111018/1318894258" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.55.4" />

  <title>Apacheのチューニング &middot; Y&#39;s note</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://yutakikuchi.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://yutakikuchi.github.io/img/favicon.ico" type="image/x-icon" />

  
    
        <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/my.css">
    
  
  
    
        <script src="https://yutakikuchi.github.io/blog/js/my.js"></script>
    
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://yutakikuchi.github.io/">Y's note</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/yutakikuchi_" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://facebook.com/yuta.kikuchi.007" target="_blank"><i class="fa fa-facebook-square fa-fw"></i>Facebook</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="http://slideshare.net/https://www.slideshare.net/yutakikuchi58/" target="_blank"><i class="fa fa-slideshare fa-fw"></i>SlideShare</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/https://www.linkedin.com/in/%E4%BD%91%E5%A4%AA-%E8%8F%8A%E6%B1%A0-36291a44/" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/yutakikuchi" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2019. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Apacheのチューニング</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2011 Oct 18, 08:30</time>
  </div>

  

  

  

</div>

  

<h2 id="apache-apacheのチューニング">[Apache] : Apacheのチューニング</h2>

<p><img src='http://httpd.apache.org/images/httpd_logo_wide.gif' width='350' height='40'/></p><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>をより有効的に利用するためのノウハウメモです。設定に用いたマシンは<a class="keyword" href="http://d.hatena.ne.jp/keyword/MacOSX">MacOSX</a>、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>のバージョンは2.2としています。</p>

<div class="section">
<h4><span class="deco" style="font-size:large;"><span class="deco" style="color:#FF0000;">http headers</span></span></h4>
<pre class="code" data-lang="" data-unlink>http://www.yahoo.co.jp/

GET / HTTP/1.1
Host: www.yahoo.co.jp
User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows CE; IEMobile 8.12; MSIEMobile 6.5) KDDI-TS01 Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; KDDI-TS01; Windows Phone 6.5.3.5)
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: ja,en-us;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Accept-Charset: Shift_JIS,utf-8;q=0.7,*;q=0.7
Connection: keep-alive
Cookie: B=XXXXXXXXXXX

HTTP/1.1 200 OK
Date: Sun, 09 Oct 2011 03:16:08 GMT
P3P: policyref="http://privacy.yahoo.co.jp/w3c/p3p.xml", CP="CAO DSP COR CUR ADM DEV TAI PSA PSD IVAi IVDi CONi TELo OTPi OUR DELi SAMi OTRi UNRi PUBi IND PHY ONL UNI PUR FIN COM NAV INT DEM CNT STA POL HEA PRE GOV"
Expires: -1
Pragma: no-cache
Cache-Control: no-cache, private, no-store, must-revalidate
X-XRDS-Location: http://open.login.yahoo.co.jp/openid20/www.yahoo.co.jp/xrds
Vary: Accept-Encoding
Connection: close
Transfer-Encoding: chunked
Content-Type: text/html; charset=utf-8
Content-Encoding: gzip
----------------------------------------------------------
http://news.c.yimg.jp/images/topics/20111009-00000003-sph-000-thumb.jpg

GET /images/topics/20111009-00000003-sph-000-thumb.jpg HTTP/1.1
Host: news.c.yimg.jp
User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows CE; IEMobile 8.12; MSIEMobile 6.5) KDDI-TS01 Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; KDDI-TS01; Windows Phone 6.5.3.5)
Accept: image/png,image/*;q=0.8,*/*;q=0.5
Accept-Language: ja,en-us;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Accept-Charset: Shift_JIS,utf-8;q=0.7,*;q=0.7
Connection: keep-alive
Referer: http://www.yahoo.co.jp/

HTTP/1.1 200 OK
Date: Sat, 08 Oct 2011 23:58:52 GMT
Cache-Control: max-age=2592000
Expires: Mon, 07 Nov 2011 23:58:52 GMT
Last-Modified: Sat, 08 Oct 2011 23:58:51 GMT
Accept-Ranges: bytes
Content-Length: 4013
Content-Type: image/jpeg
Age: 11836
Via: HTTP/1.1 l7cache4047.img.bbt.yahoo.co.jp (YahooTrafficServer/1.18.6 [cHs f ]), HTTP/1.1 l7switch4008.img.bbt.yahoo.co.jp (YahooTrafficServer/1.19.8 [cHs f ])
Server: YTS/1.19.8
Connection: keep-alive</pre>
<ul>
<li>yahooのTopページにアクセスした時のHttp Request/Response Headerの情報。</li>
<li>サイトにアクセスした時のHttpHeaderでサーバサイドの設定をなんとなく理解する事が可能。Cacheの設定、KeepAliveの有効期限、動的コンテンツと静的コンテンツの切り分けなど。</li>
<li>yahooでは動的コンテンツ配信するサーバと静的な画像や<a class="keyword" href="http://d.hatena.ne.jp/keyword/CSS">CSS</a>を配信するサーバを別<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C9%A5%E1%A5%A4%A5%F3">ドメイン</a>で構えていて、それぞれに対して設定を分けている様子。<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C9%A5%E1%A5%A4%A5%F3">ドメイン</a>を分けるとブラウザは並列してリクエストが可能。また画像配信のサーバは間にキャッシュ専用の<a class="keyword" href="http://d.hatena.ne.jp/keyword/Proxy%A5%B5%A1%BC%A5%D0">Proxyサーバ</a>を挟んでいるみたい。</li>
<li>現在Yahooのトップページにアクセスすると402ms(onload :1.56s)でコンテンツの閲覧が可能。とても早い。</li>
<li>今日の記事では<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>のチューニング/http header周りについて記録する。</li>
</ul>
</div>
<div class="section">
<h4><span class="deco" style="font-size:large;"><span class="deco" style="color:#FF0000;">preforkとworkerモデル</span></span></h4>

<ul>
<li>Apache2.0以降、サーバでリクエストする処理がモジュール化(MPM:マルチプロセッシングモジュール)され数種類から選ぶ事が可能になった。代表的なものとしてpreforkとworkerがある。</li>
<li>preforkとはクライアントからのリクエストを子プロセスで起動し、子プロセスがフリーズしても他のプロセスには影響しないモデル。</li>
<li>workerは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>の子プロセスがマルチスレッドで動作。クライアントに対してはスレッドが応答。１つのプロセスがマルチスレッドを利用して<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%A3%BF%F4">複数</a>の通信を受け付ける。preforkと比較して子プロセスの起動を少なくできるのでメモリの使用量を減らす事が可能。</li>
<li>場合にもよるがworkerモデルを扱う場合は注意が必要。不安定という話もある。(<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>のいくつかのモジュールが動かない)workerモデルがテストして問題なければメリットはある。</li>
</ul><pre class="code" data-lang="" data-unlink>vailable, but does not work with some modules (such as PHP).</pre>
<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/apache">apache</a>のバージョン/状態をを確認するには<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a> -V</li>
</ul><pre class="code" data-lang="" data-unlink>$ httpd -V
Server version: Apache/2.2.17 (Unix)
Server built:   Dec  1 2010 09:58:15
Server's Module Magic Number: 20051115:25
Server loaded:  APR 1.3.8, APR-Util 1.3.9
Compiled using: APR 1.3.8, APR-Util 1.3.9
Architecture:   64-bit
Server MPM:     Prefork
  threaded:     no
forked:     yes (variable process count)
Server compiled with....
 -D APACHE_MPM_DIR="server/mpm/prefork"
 -D APR_HAS_SENDFILE
 -D APR_HAS_MMAP
 -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)
 -D APR_USE_FLOCK_SERIALIZE
 -D APR_USE_PTHREAD_SERIALIZE
 -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT
 -D APR_HAS_OTHER_CHILD
 -D AP_HAVE_RELIABLE_PIPED_LOGS
 -D DYNAMIC_MODULE_LIMIT=128
 -D HTTPD_ROOT="/usr"
 -D SUEXEC_BIN="/usr/bin/suexec"
 -D DEFAULT_PIDLOG="/private/var/run/httpd.pid"
 -D DEFAULT_SCOREBOARD="logs/apache_runtime_status"
 -D DEFAULT_LOCKFILE="/private/var/run/accept.lock"
 -D DEFAULT_ERRORLOG="logs/error_log"
 -D AP_TYPES_CONFIG_FILE="/private/etc/apache2/mime.types"
 -D SERVER_CONFIG_FILE="/private/etc/apache2/httpd.conf"</pre>
<ul>
<li>読み込まれているモジュールを確認するのは<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a> -l prefork.cが設定されているのが分かる。</li>
</ul><pre class="code" data-lang="" data-unlink>$ httpd -l
Compiled in modules:
  core.c
  prefork.c
  http_core.c
  mod_so.c</pre>
<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/MacOSX">MacOSX</a>の場合、以下のようにport installコマンドを実行するとworkerモデルに設定し、起動してくれる。起動時に切り替えれると便利だなと思っているのだが、やり方を現在調査中。</li>
</ul><pre class="code" data-lang="" data-unlink>$ port variants apache2
apache2 has the variants:
   eventmpm: Use event MPM (experimental)
 * conflicts with preforkmpm workermpm
   no_startupitem: Do not create a startup item
   openldap: Enable LDAP support through OpenLDAP
[+]preforkmpm: Use prefork MPM
 * conflicts with eventmpm workermpm
   universal: Build for multiple architectures
   workermpm: Use worker MPM
 * conflicts with eventmpm preforkmpm
$ sudo port install apache2 +workermpm
$ port installed | grep apache
  apache2 @2.2.21_0+workermpm (active</pre>
<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/CentOS">CentOS</a>の場合だと<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>の設定ファイルを書き換えてリスタートすればprefork/workerモデルの切り替えが可能。defaultはpreforkモデルの設定の様子。</li>
</ul><pre class="code" data-lang="" data-unlink>$ sudo vim /etc/sysconfig/httpd
HTTPD=/usr/sbin/httpd.worker  #これを指定する
$ sudo /etc/init.d/httpd restart</pre>
<ul>
<li>prefork,workerの切り替えでStartServersなどのパラメータを変更できるような仕組みになっている。</li>
</ul><pre class="code" data-lang="" data-unlink>$ vi -R /private/etc/apache2/extra/httpd-mpm.conf
# prefork MPM
# StartServers: number of server processes to start
# MinSpareServers: minimum number of server processes which are kept spare
# MaxSpareServers: maximum number of server processes which are kept spare
# MaxClients: maximum number of server processes allowed to start
# MaxRequestsPerChild: maximum number of requests a server process serves
<IfModule mpm_prefork_module>
StartServers          1
MinSpareServers       1
MaxSpareServers      10
MaxClients          150
MaxRequestsPerChild   0
</IfModule>

# worker MPM
# StartServers: initial number of server processes to start
# MaxClients: maximum number of simultaneous client connections
# MinSpareThreads: minimum number of worker threads which are kept spare
# MaxSpareThreads: maximum number of worker threads which are kept spare
# ThreadsPerChild: constant number of worker threads in each server process
# MaxRequestsPerChild: maximum number of requests a server process serves
<IfModule mpm_worker_module>
StartServers          2
MaxClients          150
MinSpareThreads      25
MaxSpareThreads      75
ThreadsPerChild      25
MaxRequestsPerChild   0
</IfModule></pre>
</div>
<div class="section">
<h4><span class="deco" style="font-size:large;"><span class="deco" style="color:#FF0000;">設定ファイルチューニング</span></span></h4>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>.confに設定するパラメータをチューニングする。パラメータの説明は次の通り</p>

<table>
<tr>
<th> パラメータ </th>
<th> 説明 </th>
</tr>
<tr>
<td> StartServers </td>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>起動時のプロセス数 </td>
</tr>
<tr>
<td> MinSpareServers </td>
<td> 予め待機させておくプロセス起動の最小値 </td>
</tr>
<tr>
<td> MaxSpareServers </td>
<td> 予め待機させておくプロセス起動の最大値 </td>
</tr>
<tr>
<td> MaxRequestsPerChild </td>
<td> プロセスの処理数が値を超えたらプロセスを終了させる </td>
</tr>
<tr>
<td> ThreadsPerChild </td>
<td> プロセスあたりのスレッド数 </td>
</tr>
<tr>
<td> ServerLimit </td>
<td> プロセスの最大数 </td>
<td> </td>
</tr>
<tr>
<td> ThreadLimit </td>
<td> スレッドの最大数 </td>
<td> </td>
</tr>
<tr>
<td> MaxClients  </td>
<td> 同時接続可能数 </td>
</tr>
<tr>
<td> Timeout </td>
<td> システム処理のTimeout </td>
</tr>
<tr>
<td> KeepAlive </td>
<td> 通信状態を保持する機能 </td>
</tr>
<tr>
<td> MaxKeepAliveRequests </td>
<td> KeepAliveで接続している間に処理するリクエスト数 </td>
</tr>
<tr>
<td> KeepAliveTimeout </td>
<td> KeepAliveの有効時間 </td>
</tr>
</table><p>設定値サンプル</p>
<pre class="code" data-lang="" data-unlink>StartServers 2
ServerLimit 32
ThreadLimit  128
MaxClients 4096
ThreadsPerChild 128
MinSpareServers 25
MaxSpareServers 75
MaxRequestsPerChild 0
Timeout 60
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 5</pre>
<ul>
<li>重要な項目はThreadsPerChild,MaxClients,KeepAlive,ServerLimit,ThreadLimit</li>
<li>ThreadsPerChild,MaxClientsはサーバのリソース消費量に影響は与えない。</li>
<li>ServerLimit,ThreadLimitは共有メモリのサイズに依存。</li>
<li>パラメータの算出式は MaxClients = プロセス数 × ThreadsPerChild。上の例の場合 4096 = 32 × 128 </li>
<li>メモリが充実しているマシン(4GBとか)なら10000クライアント接続ぐらい可能。(リバース<a class="keyword" href="http://d.hatena.ne.jp/keyword/Proxy%A5%B5%A1%BC%A5%D0">Proxyサーバ</a>なら)</li>
</ul>
</div>
<div class="section">
<h4><span class="deco" style="color:#FF0000;">mod_ほにゃらら</span></h4>
<p>以下<a class="keyword" href="http://d.hatena.ne.jp/keyword/apache">apache</a>のモジュールで導入するとよりシステム処理がより高速になったりセキュリティレベルを高める事ができる。</p>

<table>
<tr>
<th> モジュール名 </th>
<th> 役割 </th>
</tr>
<tr>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/mod_rewrite">mod_rewrite</a> </td>
<td> 特定の条件を指定し、アクセスを振り分ける事ができる。Redirect/Rewrite等が可能 </td>
</tr>
<tr>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/mod_perl">mod_perl</a>/mod_<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> </td>
<td> サーバ内部でプロセスを常駐 </td>
</tr>
<tr>
<td> mod_<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>/mod_deflate </td>
<td> クライアント側への転送データを圧縮し、データ通信量を削減 </td>
<td> </td>
</tr>
<tr>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/mod_dosdetector">mod_dosdetector</a> </td>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/Dos%B9%B6%B7%E2">Dos攻撃</a>を判定。特定のIPから<a class="keyword" href="http://d.hatena.ne.jp/keyword/%EF%E7%C3%CD">閾値</a>以上のアクセス等をabuse </td>
</tr>
<tr>
<td> mod_proxy </td>
<td> リバースProxyの設定が可能 </td>
</tr>
<tr>
<td> mod_<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssl">ssl</a> </td>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>を<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSL">SSL</a>対応にする事が可能 </td>
</tr>
</table>
</div>
<div class="section">
<h4><span class="deco" style="font-size:large;"><span class="deco" style="color:#FF0000;">keepAlive</span></span></h4>

<ul>
<li>httpの仕様でサーバとのConnectionをまとめる事ができる。例えばHTMLの内部に多数の画像を取得するタグが埋め込まれている時に都度同じサーバに対してConnectionを確立してしまうと接続のOverHeadが発生し処理が遅くなってしまう。それを回避するために一度確立したConnectionを特定の時間内で再利用することが出来る仕組み。</li>
<li>KeepAliveをONにするとWebサーバ側に負担がかかる。なぜならば特定クライアントとの接続を占有してしまうから。</li>
<li>リバースProxyを使う場合、クライアント-リバースProxy間はKeepAliveをOnに設定し、リーバスProxy-Webサーバ間はKeepAliveをOffにする。これはリバース<a class="keyword" href="http://d.hatena.ne.jp/keyword/Proxy%A5%B5%A1%BC%A5%D0">Proxyサーバ</a>内部のメモリ使用率は低く、Webサーバはメモリ負荷が高くなるという処理の特性を考えての設定。</li>
<li>KeepAliveの設定例</li>
</ul><pre class="code" data-lang="" data-unlink>KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 5</pre>
</div>
<div class="section">
<h4><span class="deco" style="font-size:large;"><span class="deco" style="color:#FF0000;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>,deflate</span></span></h4>

<ul>
<li>Apache1.3系ならmod_<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>,2系ならmod_deflateを利用し、データ転送量を圧縮する。</li>
<li>データ転送量を抑える反面、サーバサイドのCPUが高負荷になる可能性がある。</li>
<li>設定は簡単で<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>.confにLoadModuleとどのファイルにdeflate処理をかけるかを記述するだけ。</li>
<li>deflateの設定例</li>
</ul><pre class="code" data-lang="" data-unlink>LoadModule deflate_module libexec/apache2/mod_deflate.so
AddOutputFilterByType DEFLATE text/html text/plain text/xml</pre>
<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>の設定例</li>
</ul><pre class="code" data-lang="" data-unlink>LoadModule gzip_module libexec/mod_gzip.so
AddModule mod_gzip.c
mod_gzip_on Yes
mod_gzip_keep_workfiles No
mod_gzip_minimum_file_size  1002
mod_gzip_maximum_file_size  0
mod_gzip_maximum_inmem_size 60000
mod_gzip_dechunk Yes
mod_gzip_temp_dir "/tmp"（注1）
mod_gzip_item_include  mime "application/x-httpd-cgi"
mod_gzip_item_include  mime "application/x-httpd-php"
mod_gzip_item_include  mime text/*
mod_gzip_item_include  mime "httpd/unix-directory"
mod_gzip_item_include  file "\.shtml$"
mod_gzip_item_include  file "\.htm$"
mod_gzip_item_include  file "\.html$"
mod_gzip_item_include  file "\.php$"
mod_gzip_item_include  file "\.pl$"
mod_gzip_item_include  file "\.cgi$"
mod_gzip_item_exclude  file "\.css$"
mod_gzip_item_exclude  file "\.js$"
mod_gzip_item_exclude  mime "image/.*"
mod_gzip_min_http 1001</pre>
</div>
<div class="section">
<h4><span class="deco" style="font-size:large;"><span class="deco" style="color:#FF0000;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a> Bench</span></span></h4>

<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>のBenchマーク<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>(ab)を使う。</li>
<li>abを得た結果から重たいページが一目瞭然となる。</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>のcodeのパフォーマンス状態を解析したいのであれば<a class="keyword" href="http://d.hatena.ne.jp/keyword/xdebug">xdebug</a> + webgrindという方法もある。</li>
<li>abの使い方</li>
</ul><pre class="code" data-lang="" data-unlink>$ ab -option URL</pre>
<ul>
<li>オプション一覧</li>
</ul>
<table>
<tr>
<th> オプション </th>
<th> 説明 </th>
</tr>
<tr>
<td> -n int </td>
<td> リクエストする総数 </td>
</tr>
<tr>
<td> -c int </td>
<td> 同時リクエスト数 </td>
</tr>
<tr>
<td> -t int </td>
<td> レスポンスの待ち時間を秒で指定 </td>
</tr>
<tr>
<td> -p filename </td>
<td> ファイル送信名を指定 </td>
</tr>
<tr>
<td> -T content-type </td>
<td> Content-Typeを指定 </td>
</tr>
<tr>
<td> -v int </td>
<td> 動作情報を表示 </td>
</tr>
<tr>
<td> -w </td>
<td> テスト結果をHTMLで出力 </td>
</tr>
<tr>
<td> -x attribute </td>
<td> HTML出力のtableタグに属性を追加 </td>
</tr>
<tr>
<td> -y attribute </td>
<td> HTML出力のtrタグに属性を追加 </td>
</tr>
<tr>
<td> -z attribute </td>
<td> HTML出力のtd/thタグに属性を追加 </td>
</tr>
<tr>
<td> -C CookieName=value </td>
<td> <a class="keyword" href="http://d.hatena.ne.jp/keyword/Cookie">Cookie</a>を送信 </td>
</tr>
<tr>
<td> -A UserName:Pass </td>
<td> ベーシック認証を特定のUser/Passで通過させる </td>
</tr>
<tr>
<td> -P UserName:Pass </td>
<td> 認証の必要なプロキシを通してテストさせる </td>
</tr>
<tr>
<td> -X ProxyServer:Port </td>
<td> プロキシ経由でのリクエスト </td>
</tr>
<tr>
<td> -V </td>
<td> abバージョン番号表示 </td>
</tr>
<tr>
<td> -k </td>
<td> KeepAliveを有効化 </td>
<td>  </td>
</tr>
</table>
<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Yahoo%21">Yahoo!</a>のサイトに10×10のRequestをしてみたが、ほとんど失敗している。(おそらく<a class="keyword" href="http://d.hatena.ne.jp/keyword/DOS%B9%B6%B7%E2">DOS攻撃</a>を防いでいる)</li>
</ul><pre class="code" data-lang="" data-unlink>$ ab -n 100 -c 10 http://www.yahoo.co.jp/
This is ApacheBench, Version 2.3 <$Revision: 655654 $>
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking www.yahoo.co.jp (be patient).....done


Server Software:        
Server Hostname:        www.yahoo.co.jp
Server Port:            80

Document Path:          /
Document Length:        25674 bytes

Concurrency Level:      10
Time taken for tests:   2.956 seconds
Complete requests:      100
Failed requests:        92
   (Connect: 0, Receive: 0, Length: 92, Exceptions: 0)
Write errors:           0
Total transferred:      2625836 bytes
HTML transferred:       2570936 bytes
Requests per second:    33.83 [#/sec] (mean)
Time per request:       295.561 [ms] (mean)
Time per request:       29.556 [ms] (mean, across all concurrent requests)
Transfer rate:          867.60 [Kbytes/sec] received

Connection Times (ms)
          min  mean[+/-sd] median   max
Connect:       28   42  11.8     38      66
Processing:   212  250  18.8    249     299
Waiting:       33   49   9.2     49      82
Total:        240  292  19.1    290     337

Percentage of the requests served within a certain time (ms)
  50%    290
  66%    301
  75%    302
  80%    303
  90%    330
  95%    335
  98%    336
  99%    337
 100%    337 (longest request)</pre>
<ul>
<li>パフォーマンスの重要となる指標はRequests per second(秒間あたりの処理数),Time per request(1リクエストあたりの処理時間)。rpsは数値が大きい方が良いし、tprは少ない方がより良い。</li>
</ul>
</div>
<div class="section">
<h4><span class="deco" style="font-size:large;"><span class="deco" style="color:#FF0000;">リバースProxyを使う</span></span></h4>

<ul>
<li>リバースProxyとはクライアントとWebサーバ間に設置して、事前/事後処理を行う<a class="keyword" href="http://d.hatena.ne.jp/keyword/Proxy%A5%B5%A1%BC%A5%D0">Proxyサーバ</a>。リバースProxyはWebサーバ間の処理振り分けが可能。</li>
<li>リーバスの意味はWAN→LANの流れで処理を要求するから(通常の<a class="keyword" href="http://d.hatena.ne.jp/keyword/Proxy%A5%B5%A1%BC%A5%D0">Proxyサーバ</a>LAN→WANで働くから)。</li>
<li>httpリクエスト処理の振り分け、メモリの効率的な使用、データのバッファリング、キャッシュなどが導入のメリット</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>,<a class="keyword" href="http://d.hatena.ne.jp/keyword/lighttpd">lighttpd</a>,<a class="keyword" href="http://d.hatena.ne.jp/keyword/squid">squid</a>を利用することで実現が可能。</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>の場合はmod_proxyを利用する。</li>
<li>静的/動的コンテンツを含むページの場合は導入した方が良い。コンテンツの特性によりリクエスト先を分ける等。</li>
</ul>
</div>
<div class="section">
<h4><span class="deco" style="font-size:large;"><span class="deco" style="color:#FF0000;">mod_proxy</span></span></h4>

<ul>
<li>mod_proxyの簡単な設定について記述する。</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>.confにモジュールを追加する。</li>
</ul><pre class="code" data-lang="" data-unlink>LoadModule proxy_module libexec/apache2/mod_proxy.so</pre>
<ul>
<li>覚えておくべきディレクティブ</li>
</ul>
<table>
<tr>
<th> 名前 </th>
<th> 説明 </th>
</tr>
<tr>
<td> ProxyRequests </td>
<td> フォワードプロキシサーバとしての動作の有効/無効の設定 </td>
</tr>
<tr>
<td> ProxyPass </td>
<td> リモートサーバをローカルサーバの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CC%BE%C1%B0%B6%F5%B4%D6">名前空間</a>に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%C3%A5%D4%A5%F3%A5%B0">マッピング</a> </td>
<td> </td>
</tr>
<tr>
<td> ProxyPassReverse </td>
<td>  HTTP リダイレクト応答の Location, Content-Location, <a class="keyword" href="http://d.hatena.ne.jp/keyword/URI">URI</a> ヘッダの調整 </td>
</tr>
<tr>
<td> ProxyPassReverseCookieDomain </td>
<td> リバース<a class="keyword" href="http://d.hatena.ne.jp/keyword/Proxy%A5%B5%A1%BC%A5%D0">Proxyサーバ</a>からのSet-<a class="keyword" href="http://d.hatena.ne.jp/keyword/Cookie">Cookie</a>ヘッダのDomain文字列を調整 </td>
</tr>
<tr>
<td> ProxyPassReverseCookiePath </td>
<td>リバース<a class="keyword" href="http://d.hatena.ne.jp/keyword/Proxy%A5%B5%A1%BC%A5%D0">Proxyサーバ</a>からのSet-<a class="keyword" href="http://d.hatena.ne.jp/keyword/Cookie">Cookie</a> ヘッダの Path 文字列を調整 </td>
</tr>
</table>
<ul>
<li>ProxyPassを使っている場合はProxyRequestsのディレクティブはoffにすべき。</li>
<li>単純なディレクティブ設定例</li>
</ul><pre class="code" data-lang="" data-unlink>ProxyRequests Off
ProxyPass /foo http://www.example.com
ProxyPassReverse /foo http://www.example.com
ProxyPassReverseCookieDomain www.example.com www.example1.com
ProxyPassReverseCookiePath / /proxy/</pre>
<ul>
<li>
<ul>
<li>/fooへのアクセスをwww.<a class="keyword" href="http://d.hatena.ne.jp/keyword/example.com">example.com</a>にプロキシリクエストに変換(ProxyPass)。</li>
<li>/fooへのアクセスでwww.<a class="keyword" href="http://d.hatena.ne.jp/keyword/example.com">example.com</a>がリダイレクトした時にリダイレクト先の情報をHttpHeaderに書き込む(ProxyPassReverse)</li>
<li>ヘッダのURLの代わりにSet-<a class="keyword" href="http://d.hatena.ne.jp/keyword/Cookie">Cookie</a>ヘッダのDomain文字列を書き換え。www.<a class="keyword" href="http://d.hatena.ne.jp/keyword/example.com">example.com</a>をwww.example1.comに変更 (ProxyPassReverseCookieDomain)。</li>
<li>ヘッダのURLの代わりにSet-<a class="keyword" href="http://d.hatena.ne.jp/keyword/Cookie">Cookie</a>ヘッダのpath文字列を書き換え。 / を/proxyに変更(ProxyPassReverseCookiePath)</li>
</ul></li>
</ul>
</div>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://yutakikuchi.github.io/post/201110150812/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://yutakikuchi.github.io/post/201110150812/">Date/Timestamp変換のまとめ</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://yutakikuchi.github.io/post/201111100831/">AES暗号のまとめ</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://yutakikuchi.github.io/post/201111100831/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>

</div>
</div>
<script src="https://yutakikuchi.github.io/js/ui.js"></script>
<script src="https://yutakikuchi.github.io/js/menus.js"></script>


<script>
  
  if (window.location.hostname != "localhost") {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-20616165-3', 'auto');
    ga('send', 'pageview');
  }
</script>





</body>
</html>

