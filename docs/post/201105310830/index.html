<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="canonical" href="http://yut.hatenablog.com/entry/20110531/1306798231" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="google-site-verification" content="haibt4AEKoLJlBFYmXsLiGTEe4PSc23sIiAIeez8nJM">
  <meta name="generator" content="Hugo 0.55.4" />

  <title>Node.jsでWebSocketを試してみる &middot; Y&#39;s note</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://yutakikuchi.github.io/blog/img/favicon.ico" type="image/x-icon" />

  
    
        <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/my.css">
    
  
  
    
        <script src="https://yutakikuchi.github.io/blog/js/my.js"></script>
    
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://yutakikuchi.github.io/blog/">Y's note</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/yutakikuchi_" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://facebook.com/yuta.kikuchi.007" target="_blank"><i class="fa fa-facebook-square fa-fw"></i>Facebook</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="http://slideshare.net/https://www.slideshare.net/yutakikuchi58/" target="_blank"><i class="fa fa-slideshare fa-fw"></i>SlideShare</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/https://www.linkedin.com/in/%E4%BD%91%E5%A4%AA-%E8%8F%8A%E6%B1%A0-36291a44/" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/yutakikuchi" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2019. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Node.jsでWebSocketを試してみる</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2011 May 31, 08:30</time>
  </div>

  

  

  

</div>

  

<h2 id="javascript-node-jsでwebsocketを試してみる">[javascript] : Node.jsでWebSocketを試してみる</h2>

<div class="section">
<h4><span class="deco" style="font-size:large;">Nodejs</span></h4>

<blockquote>
    
<ul>
<li>サーバサイド<a class="keyword" href="http://d.hatena.ne.jp/keyword/Javascript">Javascript</a>。</li>
<li>V8 <a class="keyword" href="http://d.hatena.ne.jp/keyword/Javascript">Javascript</a>を利用。</li>
<li>シングルスレッドの非同期処理環境。</li>
<li>処理を待たずにcallbackを実行するイベントループ、ノン<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D6%A5%ED%A5%C3%A5%AD%A5%F3%A5%B0">ブロッキング</a>I/Oを実装。</li>
<li>nodejsの設定は簡単。パッケージ化されているし、buildしてもそれほど時間がかからない。</li>
</ul>
</blockquote>

</div>
<div class="section">
<h4><span class="deco" style="font-size:large;">設定</span></h4>

<blockquote>
    <p><a class="keyword" href="http://d.hatena.ne.jp/keyword/mac">mac</a>でinstallしてみる。<span class="deco" style="color:#FF0000;">以下のどちらか一方を行えば設定は可能だがportのversionは0.2.0、buildの最新は0.4.8。</span>post installは少し時間がかかる。</p>

<div class="section">
<h5>port install</h5>
<pre class="code" data-lang="" data-unlink>$ sudo port install nodejs
$ node -v
v0.2.0</pre>
</div>
<div class="section">
<h5>make install</h5>
<pre class="code" data-lang="" data-unlink>$ fetch http://nodejs.org/dist/node-v0.4.8.tar.gz
$ tar -xzf node-v0.4.8.tar.gz
$ cd node-v0.4.8
$ ./configure
$ sudo make install
$ ./node -v
v0.4.8</pre>
</div>
</blockquote>

</div>
<div class="section">
<h4><span class="deco" style="font-size:large;">実行</span></h4>

<blockquote>
    <p>日本語ドキュメントにあるサンプルをそのまま実行してみる。サンプルはHttp,Socketサーバ。以下のそれぞれの<a class="keyword" href="http://d.hatena.ne.jp/keyword/Javascript">Javascript</a>っぽいコードをsample.jsなどのファイルとして保存してnodeコマンドにより実行する。</p>

<div class="section">
<h5><span class="deco" style="font-weight:bold;">Http</span></h5>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a></p>
<pre class="hljs javascript" data-lang="javascript" data-unlink><span class="synIdentifier">var</span> http = require(<span class="synConstant">'http'</span>);
http.createServer(<span class="synIdentifier">function</span> (req, res) <span class="synIdentifier">{</span>
  res.writeHead(200, <span class="synIdentifier">{</span><span class="synConstant">'Content-Type'</span>: <span class="synConstant">'text/plain'</span><span class="synIdentifier">}</span>);
  res.end(<span class="synConstant">'Hello World</span><span class="synSpecial">\n</span><span class="synConstant">'</span>);
<span class="synIdentifier">}</span>).listen(1337, <span class="synConstant">"127.0.0.1"</span>);
console.log(<span class="synConstant">'Server running at http://127.0.0.1:1337/'</span>);
</pre><p>起動</p>
<pre class="code" data-lang="" data-unlink>$ node http.js</pre><p>アクセス<br />
ブラウザで<a href="http://127.0.0.1:1337/">http://127.0.0.1:1337/</a>にアクセスしてみると <a class="keyword" href="http://d.hatena.ne.jp/keyword/Hello%20World">Hello World</a>が表示される。<br />
<br />
</p>

</div>
<div class="section">
<h5><span class="deco" style="font-weight:bold;">Socket</span></h5>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a></p>
<pre class="hljs javascript" data-lang="javascript" data-unlink><span class="synIdentifier">var</span> net = require(<span class="synConstant">'net'</span>);

<span class="synIdentifier">var</span> server = net.createServer(<span class="synIdentifier">function</span> (socket) <span class="synIdentifier">{</span>
  socket.write(<span class="synConstant">"Echo server</span><span class="synSpecial">\r\n</span><span class="synConstant">"</span>);
  socket.pipe(socket);
<span class="synIdentifier">}</span>);

server.listen(1337, <span class="synConstant">"127.0.0.1"</span>);
</pre><p>起動</p>
<pre class="code" data-lang="" data-unlink>$ node socket.js</pre><p>アクセス<br />
<a class="keyword" href="http://d.hatena.ne.jp/keyword/telnet">telnet</a>コマンドによりlistenしているポートにアクセスし、文字列を打つとechoされる。</p>
<pre class="code" data-lang="" data-unlink>$ telnet 127.0.0.1 1337 
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
Echo server
NodeJS Test
NodeJS Test</pre>
</div>
</blockquote>

</div>
<div class="section">
<h4><span class="deco" style="font-size:large;">npm</span></h4>

<blockquote>
    
<ul>
<li>npmとはNode.js用のパッケージマネージャ。<a class="keyword" href="http://d.hatena.ne.jp/keyword/Python">Python</a>のeasy_installみたいなもの。</li>
<li>npmコマンドによりnode.jsのパッケージをinstallできる。</li>
</ul>
<div class="section">
<h5>npmのinstall</h5>
<p>まずはnpmコマンドのinstall。</p>
<pre class="code" data-lang="" data-unlink>$ fetch http://npmjs.org/install.sh
$ chmod +x ./install.sh
$ sudo ./install.sh
$ npm -v
1.0.6</pre>
</div>
<div class="section">
<h5>パッケージのinstall</h5>
<p>npmコマンドによりWebSocket実装可能なパッケージ(Socket.io)をinstallする。</p>
<pre class="code" data-lang="" data-unlink>$ sudo npm install socket.io</pre>
</div>
</blockquote>

</div>
<div class="section">
<h4><span class="deco" style="font-size:large;">WebSocket</span></h4>

<blockquote>
    <p>nodejsをつかってWebSocketを試してみる。</p>

<div class="section">
<h5>WebSocketとは</h5>

<ul>
<li>Cometに取って代わる技術と言われており、専用<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D7%A5%ED%A5%C8%A5%B3%A5%EB">プロトコル</a>でクライアント/サーバ間のConnectionを張りっぱなしにできる。</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/HTML5">HTML5</a>の仕様に組み込まれる予定だったが、現在では独自の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D7%A5%ED%A5%C8%A5%B3%A5%EB">プロトコル</a>として仕様が策定されている。</li>
<li>対応ブラウザ:FF4、safari5、Chrome4、Opera11、<a class="keyword" href="http://d.hatena.ne.jp/keyword/IE">IE</a>(HTML5Labs)</li>
<li>nodejsだけでなく<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>でもWebSocketサーバは設定できる。<a href="http://code.google.com/p/phpwebsocket/">http://code.google.com/p/phpwebsocket/</a></li>
</ul>
</div>
<div class="section">
<h5>Socket.ioのサンプルを見てみる</h5>
<p>npmによりinstallしたsocket.ioパッケージのsampleはnode_modules/socket.io/example/に配置される。node_modules/socket.io/example/server.jsというサーバのサンプルプログラムを見てみる。初心者で全くnodejsに詳しくないが、だいたい以下のような感じだと思う。</p>

<ul>
<li>http.createServerでサーバオブジェクト作成。</li>
<li>server.listen(8080)でポートを指定して起動。</li>
<li>client.sendでclientにメッセージを送信。</li>
<li>client.broadcastで全てのclientにメッセージを送信。</li>
</ul><pre class="hljs javascript" data-lang="javascript" data-unlink><span class="synComment">/**</span>
<span class="synComment"> * Important note: this application is not suitable for benchmarks!</span>
<span class="synComment"> */</span>

<span class="synComment">// 必要なモジュールのrequire</span>
<span class="synIdentifier">var</span> http = require(<span class="synConstant">'http'</span>)
  , url = require(<span class="synConstant">'url'</span>)
  , fs = require(<span class="synConstant">'fs'</span>)
  , io = require(<span class="synConstant">'../'</span>)
  , sys = require(process.binding(<span class="synConstant">'natives'</span>).util ? <span class="synConstant">'util'</span> : <span class="synConstant">'sys'</span>)
  , server;

<span class="synComment">//serverのcreate</span>
server = http.createServer(<span class="synIdentifier">function</span>(req, res)<span class="synIdentifier">{</span>
  <span class="synComment">// your normal server code</span>
  <span class="synIdentifier">var</span> path = url.parse(req.url).pathname;
  <span class="synStatement">switch</span> (path)<span class="synIdentifier">{</span>
<span class="synStatement">case</span> <span class="synConstant">'/'</span>:
  res.writeHead(200, <span class="synIdentifier">{</span><span class="synConstant">'Content-Type'</span>: <span class="synConstant">'text/html'</span><span class="synIdentifier">}</span>);
  res.write(<span class="synConstant">'<h1>Welcome. Try the <a href="https://yutakikuchi.github.io/blog/chat.html">chat</a> example.</h1>'</span>);
  res.end();
  <span class="synStatement">break</span>;
  
<span class="synStatement">case</span> <span class="synConstant">'/json.js'</span>:
<span class="synStatement">case</span> <span class="synConstant">'/chat.html'</span>:
  fs.readFile(__dirname + path, <span class="synIdentifier">function</span>(err, data)<span class="synIdentifier">{</span>
    <span class="synStatement">if</span> (err) <span class="synStatement">return</span> send404(res);
    res.writeHead(200, <span class="synIdentifier">{</span><span class="synConstant">'Content-Type'</span>: path == <span class="synConstant">'json.js'</span> ? <span class="synConstant">'text/javascript'</span> : <span class="synConstant">'text/html'</span><span class="synIdentifier">}</span>)
    res.write(data, <span class="synConstant">'utf8'</span>);
    res.end();
  <span class="synIdentifier">}</span>);
  <span class="synStatement">break</span>;
  
<span class="synStatement">default</span>: send404(res);
  <span class="synIdentifier">}</span>
<span class="synIdentifier">}</span>),

<span class="synComment">//caseに当てはまらなかった時の404処理</span>
send404 = <span class="synIdentifier">function</span>(res)<span class="synIdentifier">{</span>
  res.writeHead(404);
  res.write(<span class="synConstant">'404'</span>);
  res.end();
<span class="synIdentifier">}</span>;

<span class="synComment">//8080ポートで起動</span>
server.listen(8080);

<span class="synComment">// socket.io, I choose you</span>
<span class="synComment">// simplest chat application evar</span>
<span class="synIdentifier">var</span> io = io.listen(server)
  , buffer = <span class="synIdentifier">[]</span>;
 
<span class="synComment">//clientとconnectionが張られているとき</span>
io.on(<span class="synConstant">'connection'</span>, <span class="synIdentifier">function</span>(client)<span class="synIdentifier">{</span>
  <span class="synComment">//clientにbufferを送信</span>
  client.send(<span class="synIdentifier">{</span> buffer: buffer <span class="synIdentifier">}</span>);
  <span class="synComment">//全てのclientにclientidとつながっていることをアナウンス</span>
  client.broadcast(<span class="synIdentifier">{</span> announcement: client.sessionId + <span class="synConstant">' connected'</span> <span class="synIdentifier">}</span>);
  
  <span class="synComment">//clientからメッセ時を受け取ったとき</span>
  client.on(<span class="synConstant">'message'</span>, <span class="synIdentifier">function</span>(message)<span class="synIdentifier">{</span>
<span class="synComment">//メッセージ情報をbufferに格納。</span>
<span class="synIdentifier">var</span> msg = <span class="synIdentifier">{</span> message: <span class="synIdentifier">[</span>client.sessionId, message<span class="synIdentifier">]</span> <span class="synIdentifier">}</span>;
buffer.push(msg);
<span class="synStatement">if</span> (buffer.length > 15) buffer.shift();
<span class="synComment">//メッセージをその他clientにブロードキャストする</span>
client.broadcast(msg);
  <span class="synIdentifier">}</span>);

  <span class="synComment">//clientとの接続が切れたとき</span>
  client.on(<span class="synConstant">'disconnect'</span>, <span class="synIdentifier">function</span>()<span class="synIdentifier">{</span>
<span class="synComment">//clientが切断されたことをその他clientにブロードキャストする。</span>
client.broadcast(<span class="synIdentifier">{</span> announcement: client.sessionId + <span class="synConstant">' disconnected'</span> <span class="synIdentifier">}</span>);
  <span class="synIdentifier">}</span>);
<span class="synIdentifier">}</span>);
</pre>
</div>
<div class="section">
<h5>クライアントhtml</h5>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a>.jsとsocket.io/socket.io.jsを読み込む必要がある。以下はおれおれ解説。</p>

<ul>
<li>new io.SocketでSocketオブジェクト作成。</li>
<li>socket.connectでサーバとのconnectionを確立。</li>
<li>socket.on('connect',(省略)でサーバとconnectionが確立されたらハンドリングする。</li>
<li>socket.on('message',(省略)でサーバからメッセージを受信した時にハンドリングする。</li>
<li>socket.onのその他 disconnect(切断)、reconnect(再接続後)、reconnecting(再接続中)の時のハンドリング。</li>
</ul><pre class="hljs html" data-lang="html" data-unlink><span class="synComment"><!doctype html></span>
<span class="synIdentifier"><</span><span class="synStatement">html</span><span class="synIdentifier">></span>
  <span class="synIdentifier"><</span><span class="synStatement">head</span><span class="synIdentifier">></span>
<span class="synPreProc">    </span><span class="synIdentifier"><</span><span class="synStatement">title</span><span class="synIdentifier">></span>socket.io client test<span class="synIdentifier"></</span><span class="synStatement">title</span><span class="synIdentifier">></span>
<span class="synPreProc">        </span>
<span class="synPreProc">    </span><span class="synIdentifier"><</span><span class="synStatement">script</span><span class="synIdentifier"> </span><span class="synType">src</span><span class="synIdentifier">=</span><span class="synConstant">"/json.js"</span><span class="synIdentifier">></</span><span class="synStatement">script</span><span class="synIdentifier">></span><span class="synPreProc"> </span><span class="synComment"><!-- for ie --></span>
<span class="synPreProc">    </span><span class="synIdentifier"><</span><span class="synStatement">script</span><span class="synIdentifier"> </span><span class="synType">src</span><span class="synIdentifier">=</span><span class="synConstant">"/socket.io/socket.io.js"</span><span class="synIdentifier">></</span><span class="synStatement">script</span><span class="synIdentifier">></span>
<span class="synPreProc">  </span><span class="synIdentifier"></</span><span class="synStatement">head</span><span class="synIdentifier">></span>
  <span class="synIdentifier"><</span><span class="synStatement">body</span><span class="synIdentifier">></span>

<span class="synIdentifier"><</span><span class="synStatement">script</span><span class="synIdentifier">></span>
<span class="synSpecial">      </span><span class="synComment">//メッセージ出力関数。</span>
<span class="synSpecial">      </span><span class="synIdentifier">function</span><span class="synSpecial"> message</span>(<span class="synSpecial">obj</span>)<span class="synIdentifier">{</span>
<span class="synSpecial">        </span><span class="synIdentifier">var</span><span class="synSpecial"> el = </span><span class="synStatement">document</span><span class="synSpecial">.createElement</span>(<span class="synConstant">'p'</span>)<span class="synSpecial">;</span>
<span class="synSpecial">        </span><span class="synStatement">if</span><span class="synSpecial"> </span>(<span class="synConstant">'announcement'</span><span class="synSpecial"> </span><span class="synStatement">in</span><span class="synSpecial"> obj</span>)<span class="synSpecial"> el.innerHTML = </span><span class="synConstant">'<em>'</span><span class="synSpecial"> + esc</span>(<span class="synSpecial">obj.announcement</span>)<span class="synSpecial"> + </span><span class="synConstant">'</em>'</span><span class="synSpecial">;</span>
<span class="synSpecial">        </span><span class="synStatement">else</span><span class="synSpecial"> </span><span class="synStatement">if</span><span class="synSpecial"> </span>(<span class="synConstant">'message'</span><span class="synSpecial"> </span><span class="synStatement">in</span><span class="synSpecial"> obj</span>)<span class="synSpecial"> el.innerHTML = </span><span class="synConstant">'<b>'</span><span class="synSpecial"> + esc</span>(<span class="synSpecial">obj.message</span><span class="synIdentifier">[</span>0<span class="synIdentifier">]</span>)<span class="synSpecial"> + </span><span class="synConstant">':</b> '</span><span class="synSpecial"> + esc</span>(<span class="synSpecial">obj.message</span><span class="synIdentifier">[</span>1<span class="synIdentifier">]</span>)<span class="synSpecial">;</span>
<span class="synSpecial">        </span>
<span class="synSpecial">        </span><span class="synStatement">if</span>(<span class="synSpecial"> obj.message && </span><span class="synStatement">window</span><span class="synSpecial">.console && console.log </span>)<span class="synSpecial"> console.log</span>(<span class="synSpecial">obj.message</span><span class="synIdentifier">[</span>0<span class="synIdentifier">]</span><span class="synSpecial">, obj.message</span><span class="synIdentifier">[</span>1<span class="synIdentifier">]</span>)<span class="synSpecial">;</span>
<span class="synSpecial">        </span><span class="synStatement">document</span><span class="synSpecial">.getElementById</span>(<span class="synConstant">'chat'</span>)<span class="synSpecial">.appendChild</span>(<span class="synSpecial">el</span>)<span class="synSpecial">;</span>
<span class="synSpecial">        </span><span class="synStatement">document</span><span class="synSpecial">.getElementById</span>(<span class="synConstant">'chat'</span>)<span class="synSpecial">.scrollTop = </span>1000000<span class="synSpecial">;</span>
<span class="synSpecial">      </span><span class="synIdentifier">}</span>
<span class="synSpecial">      </span>
<span class="synSpecial">      </span><span class="synComment">//メッセージ送信</span>
<span class="synSpecial">      </span><span class="synIdentifier">function</span><span class="synSpecial"> send</span>()<span class="synIdentifier">{</span>
<span class="synSpecial">        </span><span class="synIdentifier">var</span><span class="synSpecial"> val = </span><span class="synStatement">document</span><span class="synSpecial">.getElementById</span>(<span class="synConstant">'text'</span>)<span class="synSpecial">.value;</span>
<span class="synSpecial">        socket.send</span>(<span class="synSpecial">val</span>)<span class="synSpecial">;</span>
<span class="synSpecial">        message</span>(<span class="synIdentifier">{</span><span class="synSpecial"> message: </span><span class="synIdentifier">[</span><span class="synConstant">'you'</span><span class="synSpecial">, val</span><span class="synIdentifier">]</span><span class="synSpecial"> </span><span class="synIdentifier">}</span>)<span class="synSpecial">;</span>
<span class="synSpecial">        </span><span class="synStatement">document</span><span class="synSpecial">.getElementById</span>(<span class="synConstant">'text'</span>)<span class="synSpecial">.value = </span><span class="synConstant">''</span><span class="synSpecial">;</span>
<span class="synSpecial">      </span><span class="synIdentifier">}</span>
<span class="synSpecial">      </span>
<span class="synSpecial">      </span><span class="synComment">//HTML escape</span>
<span class="synSpecial">      </span><span class="synIdentifier">function</span><span class="synSpecial"> esc</span>(<span class="synSpecial">msg</span>)<span class="synIdentifier">{</span>
<span class="synSpecial">        </span><span class="synStatement">return</span><span class="synSpecial"> msg.replace</span>(<span class="synConstant">/</g</span><span class="synSpecial">, </span><span class="synConstant">'&lt;'</span>)<span class="synSpecial">.replace</span>(<span class="synConstant">/>/g</span><span class="synSpecial">, </span><span class="synConstant">'&gt;'</span>)<span class="synSpecial">;</span>
<span class="synSpecial">      </span><span class="synIdentifier">}</span><span class="synSpecial">;</span>
<span class="synSpecial">      </span>
<span class="synSpecial">      </span><span class="synComment">// socketオブジェクト作成</span>
<span class="synSpecial">      </span><span class="synIdentifier">var</span><span class="synSpecial"> socket = </span><span class="synStatement">new</span><span class="synSpecial"> io.Socket</span>(<span class="synStatement">null</span><span class="synSpecial">, </span><span class="synIdentifier">{</span><span class="synSpecial">port: </span>8080<span class="synSpecial">, rememberTransport: </span><span class="synConstant">false</span><span class="synIdentifier">}</span>)<span class="synSpecial">;</span>
<span class="synSpecial">      </span><span class="synComment">// サーバとのconnection確立</span>
<span class="synSpecial">      socket.connect</span>()<span class="synSpecial">;</span>
<span class="synSpecial">      </span><span class="synComment">//メッセージ受信ハンドリング</span>
<span class="synSpecial">      socket.on</span>(<span class="synConstant">'message'</span><span class="synSpecial">, </span><span class="synIdentifier">function</span>(<span class="synSpecial">obj</span>)<span class="synIdentifier">{</span>
<span class="synSpecial">        </span><span class="synStatement">if</span><span class="synSpecial"> </span>(<span class="synConstant">'buffer'</span><span class="synSpecial"> </span><span class="synStatement">in</span><span class="synSpecial"> obj</span>)<span class="synIdentifier">{</span>
<span class="synSpecial">          </span><span class="synStatement">document</span><span class="synSpecial">.getElementById</span>(<span class="synConstant">'form'</span>)<span class="synSpecial">.style.display=</span><span class="synConstant">'block'</span><span class="synSpecial">;</span>
<span class="synSpecial">          </span><span class="synStatement">document</span><span class="synSpecial">.getElementById</span>(<span class="synConstant">'chat'</span>)<span class="synSpecial">.innerHTML = </span><span class="synConstant">''</span><span class="synSpecial">;</span>
<span class="synSpecial">          </span>
<span class="synSpecial">          </span><span class="synStatement">for</span><span class="synSpecial"> </span>(<span class="synIdentifier">var</span><span class="synSpecial"> i </span><span class="synStatement">in</span><span class="synSpecial"> obj.buffer</span>)<span class="synSpecial"> message</span>(<span class="synSpecial">obj.buffer</span><span class="synIdentifier">[</span><span class="synSpecial">i</span><span class="synIdentifier">]</span>)<span class="synSpecial">;</span>
<span class="synSpecial">        </span><span class="synIdentifier">}</span><span class="synSpecial"> </span><span class="synStatement">else</span><span class="synSpecial"> message</span>(<span class="synSpecial">obj</span>)<span class="synSpecial">;</span>
<span class="synSpecial">      </span><span class="synIdentifier">}</span>)<span class="synSpecial">;</span>
<span class="synSpecial">      </span>
<span class="synSpecial">      </span><span class="synComment">//connection確立ハンドリング</span>
<span class="synSpecial">      socket.on</span>(<span class="synConstant">'connect'</span><span class="synSpecial">, </span><span class="synIdentifier">function</span>()<span class="synIdentifier">{</span><span class="synSpecial"> message</span>(<span class="synIdentifier">{</span><span class="synSpecial"> message: </span><span class="synIdentifier">[</span><span class="synConstant">'System'</span><span class="synSpecial">, </span><span class="synConstant">'Connected'</span><span class="synIdentifier">]}</span>)<span class="synIdentifier">}</span>)<span class="synSpecial">;</span>
<span class="synSpecial">      </span><span class="synComment">//connection切断ハンドリング</span>
<span class="synSpecial">      socket.on</span>(<span class="synConstant">'disconnect'</span><span class="synSpecial">, </span><span class="synIdentifier">function</span>()<span class="synIdentifier">{</span><span class="synSpecial"> message</span>(<span class="synIdentifier">{</span><span class="synSpecial"> message: </span><span class="synIdentifier">[</span><span class="synConstant">'System'</span><span class="synSpecial">, </span><span class="synConstant">'Disconnected'</span><span class="synIdentifier">]}</span>)<span class="synIdentifier">}</span>)<span class="synSpecial">;</span>
<span class="synSpecial">      </span><span class="synComment">//connection再確立ハンドリング</span>
<span class="synSpecial">      socket.on</span>(<span class="synConstant">'reconnect'</span><span class="synSpecial">, </span><span class="synIdentifier">function</span>()<span class="synIdentifier">{</span><span class="synSpecial"> message</span>(<span class="synIdentifier">{</span><span class="synSpecial"> message: </span><span class="synIdentifier">[</span><span class="synConstant">'System'</span><span class="synSpecial">, </span><span class="synConstant">'Reconnected to server'</span><span class="synIdentifier">]}</span>)<span class="synIdentifier">}</span>)<span class="synSpecial">;</span>
<span class="synSpecial">      </span><span class="synComment">//connection再接続中ハンドリング</span>
<span class="synSpecial">      socket.on</span>(<span class="synConstant">'reconnecting'</span><span class="synSpecial">, </span><span class="synIdentifier">function</span>(<span class="synSpecial"> nextRetry </span>)<span class="synIdentifier">{</span><span class="synSpecial"> message</span>(<span class="synIdentifier">{</span><span class="synSpecial"> message: </span><span class="synIdentifier">[</span><span class="synConstant">'System'</span><span class="synSpecial">, </span><span class="synConstant">'Attempting to re-connect to the server, next attempt in '</span><span class="synSpecial"> + nextRetry + </span><span class="synConstant">'ms'</span><span class="synIdentifier">]}</span>)<span class="synIdentifier">}</span>)<span class="synSpecial">;</span>
<span class="synSpecial">      socket.on</span>(<span class="synConstant">'reconnect_failed'</span><span class="synSpecial">, </span><span class="synIdentifier">function</span>()<span class="synIdentifier">{</span><span class="synSpecial"> message</span>(<span class="synIdentifier">{</span><span class="synSpecial"> message: </span><span class="synIdentifier">[</span><span class="synConstant">'System'</span><span class="synSpecial">, </span><span class="synConstant">'Reconnected to server FAILED.'</span><span class="synIdentifier">]}</span>)<span class="synIdentifier">}</span>)<span class="synSpecial">;</span>
<span class="synSpecial">    </span><span class="synIdentifier"></</span><span class="synStatement">script</span><span class="synIdentifier">></span>

<span class="synIdentifier"><</span><span class="synStatement">h1</span><span class="synIdentifier">></span>Sample chat client<span class="synIdentifier"></</span><span class="synStatement">h1</span><span class="synIdentifier">></span>
<span class="synIdentifier"><</span><span class="synStatement">div</span><span class="synIdentifier"> </span><span class="synType">id</span><span class="synIdentifier">=</span><span class="synConstant">"chat"</span><span class="synIdentifier">><</span><span class="synStatement">p</span><span class="synIdentifier">></span>Connecting...<span class="synIdentifier"></</span><span class="synStatement">p</span><span class="synIdentifier">></</span><span class="synStatement">div</span><span class="synIdentifier">></span>
<span class="synIdentifier"><</span><span class="synStatement">form</span><span class="synIdentifier"> </span><span class="synType">id</span><span class="synIdentifier">=</span><span class="synConstant">"form"</span><span class="synIdentifier"> </span><span class="synSpecial">onSubmit="send</span>()<span class="synSpecial">; </span><span class="synStatement">return</span><span class="synSpecial"> </span><span class="synConstant">false</span><span class="synSpecial">"</span><span class="synIdentifier">></span>
  <span class="synIdentifier"><</span><span class="synStatement">input</span><span class="synIdentifier"> </span><span class="synType">type</span><span class="synIdentifier">=</span><span class="synConstant">"text"</span><span class="synIdentifier"> autocomplete=</span><span class="synConstant">"off"</span><span class="synIdentifier"> </span><span class="synType">id</span><span class="synIdentifier">=</span><span class="synConstant">"text"</span><span class="synIdentifier">><</span><span class="synStatement">input</span><span class="synIdentifier"> </span><span class="synType">type</span><span class="synIdentifier">=</span><span class="synConstant">"submit"</span><span class="synIdentifier"> </span><span class="synType">value</span><span class="synIdentifier">=</span><span class="synConstant">"Send"</span><span class="synIdentifier">></span>
<span class="synIdentifier"></</span><span class="synStatement">form</span><span class="synIdentifier">></span>

<span class="synIdentifier"><</span><span class="synStatement">style</span><span class="synIdentifier">></span>
  <span class="synIdentifier">#chat</span> <span class="synIdentifier">{</span> <span class="synType">height</span>: <span class="synConstant">300px</span>; <span class="synType">overflow</span>: <span class="synType">auto</span>; <span class="synType">width</span>: <span class="synConstant">800px</span>; <span class="synType">border</span>: <span class="synConstant">1px</span> <span class="synType">solid</span> <span class="synConstant">#eee</span>; <span class="synType">font</span>: <span class="synConstant">13px</span> Helvetica, Arial; <span class="synIdentifier">}</span>
  <span class="synIdentifier">#chat</span> <span class="synStatement">p</span> <span class="synIdentifier">{</span> <span class="synType">padding</span>: <span class="synConstant">8px</span>; <span class="synType">margin</span>: <span class="synConstant">0</span>; <span class="synIdentifier">}</span>
  <span class="synIdentifier">#chat</span> <span class="synStatement">p</span>:nth-child(odd) <span class="synIdentifier">{</span> <span class="synType">background</span>: <span class="synConstant">#F6F6F6</span>; <span class="synIdentifier">}</span>
  <span class="synIdentifier">#form</span> <span class="synIdentifier">{</span> <span class="synType">width</span>: <span class="synConstant">782px</span>; <span class="synType">background</span>: <span class="synConstant">#333</span>; <span class="synType">padding</span>: <span class="synConstant">5px</span> <span class="synConstant">10px</span>; <span class="synType">display</span>: <span class="synType">none</span>; <span class="synIdentifier">}</span>
  <span class="synIdentifier">#form</span> <span class="synStatement">input</span><span class="synSpecial">[</span>type<span class="synSpecial">=</span>text<span class="synSpecial">]</span> <span class="synIdentifier">{</span> <span class="synType">width</span>: <span class="synConstant">700px</span>; <span class="synType">padding</span>: <span class="synConstant">5px</span>; <span class="synType">background</span>: <span class="synConstant">#fff</span>; <span class="synType">border</span>: <span class="synConstant">1px</span> <span class="synType">solid</span> <span class="synConstant">#fff</span>; <span class="synIdentifier">}</span>
  <span class="synIdentifier">#form</span> <span class="synStatement">input</span><span class="synSpecial">[</span>type<span class="synSpecial">=</span>submit<span class="synSpecial">]</span> <span class="synIdentifier">{</span> <span class="synType">cursor</span>: <span class="synType">pointer</span>; <span class="synType">background</span>: <span class="synConstant">#999</span>; <span class="synType">border</span>: <span class="synType">none</span>; <span class="synType">padding</span>: <span class="synConstant">6px</span> <span class="synConstant">8px</span>; -moz-<span class="synType">border</span>-radius: <span class="synConstant">8px</span>; -webkit-<span class="synType">border</span>-radius: <span class="synConstant">8px</span>; <span class="synType">margin-left</span>: <span class="synConstant">5px</span>; <span class="synType">text-shadow</span>: <span class="synConstant">0</span> <span class="synConstant">1px</span> <span class="synConstant">0</span> <span class="synConstant">#fff</span>; <span class="synIdentifier">}</span>
  <span class="synIdentifier">#form</span> <span class="synStatement">input</span><span class="synSpecial">[</span>type<span class="synSpecial">=</span>submit<span class="synSpecial">]</span>:<span class="synPreProc">hover</span> <span class="synIdentifier">{</span> <span class="synType">background</span>: <span class="synConstant">#A2A2A2</span>; <span class="synIdentifier">}</span>
  <span class="synIdentifier">#form</span> <span class="synStatement">input</span><span class="synSpecial">[</span>type<span class="synSpecial">=</span>submit<span class="synSpecial">]</span>:<span class="synPreProc">active</span> <span class="synIdentifier">{</span> <span class="synType">position</span>: <span class="synType">relative</span>; <span class="synType">top</span>: <span class="synConstant">2px</span>; <span class="synIdentifier">}</span>
<span class="synIdentifier"></</span><span class="synStatement">style</span><span class="synIdentifier">></span>

  <span class="synIdentifier"></</span><span class="synStatement">body</span><span class="synIdentifier">></span>
<span class="synIdentifier"></</span><span class="synStatement">html</span><span class="synIdentifier">></span>
</pre><p>サンプルのSocketサーバの起動</p>
<pre class="code" data-lang="" data-unlink>$ node node_modules/socket.io/example/server.js</pre><p>アクセス<br />
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%A3%BF%F4">複数</a>のWebブラウザでアクセスしてコメントを投稿してみるとWebSocketのチャットが利用可能。<br />
<a href="http://127.0.0.1:8080/chat.html">http://127.0.0.1:8080/chat.html</a><br />
<span itemscope itemtype="http://schema.org/Photograph"><a href="http://f.hatena.ne.jp/yutakikuchi/20110531000921" class="hatena-fotolife" itemprop="url"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/y/yutakikuchi/20110531/20110531000921.png" alt="f:id:yutakikuchi:20110531000921p:image:h200:w400" title="f:id:yutakikuchi:20110531000921p:image:h200:w400" class="hatena-fotolife" style="height:200px;width:400px" itemprop="image"></a></span></p>

</div>
</blockquote>

</div>
<div class="section">
<h4><span class="deco" style="font-size:large;">リファレンス</span></h4>

<blockquote>
    
<ul>
<li>日本語ドキュメント</li>
</ul><p><a href="http://nodejs.jp/nodejs.org_ja/">http://nodejs.jp/nodejs.org_ja/</a></p>

<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>日本語マニュアル</li>
</ul><p><a href="http://nodejs.jp/nodejs.org_ja/api/index.html">http://nodejs.jp/nodejs.org_ja/api/index.html</a></p>

<ul>
<li>Node.jsでサーバサイド<a class="keyword" href="http://d.hatena.ne.jp/keyword/JavaScript">JavaScript</a>開発入門</li>
</ul><p><a href="http://www.atmarkit.co.jp/fwcr/index/index_nodejs.html">http://www.atmarkit.co.jp/fwcr/index/index_nodejs.html</a></p>

<ul>
<li>npm registry</li>
</ul><p><a href="http://search.npmjs.org/#/_browse/all">http://search.npmjs.org/#/_browse/all</a></p>

</blockquote>

</div>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://yutakikuchi.github.io/blog/post/201105230950/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://yutakikuchi.github.io/blog/post/201105230950/">ackコマンド</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://yutakikuchi.github.io/blog/post/201106020845/">WebSocket対応状況のまとめ</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://yutakikuchi.github.io/blog/post/201106020845/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>

</div>
</div>
<script src="https://yutakikuchi.github.io/blog/js/ui.js"></script>
<script src="https://yutakikuchi.github.io/blog/js/menus.js"></script>


<script>
  
  if (window.location.hostname != "localhost") {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-20616165-3', 'auto');
    ga('send', 'pageview');
  }
</script>





</body>
</html>

