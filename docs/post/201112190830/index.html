<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="canonical" href="http://yut.hatenablog.com/entry/20111219/1324251034" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="google-site-verification" content="haibt4AEKoLJlBFYmXsLiGTEe4PSc23sIiAIeez8nJM">
  <meta name="generator" content="Hugo 0.55.4" />

  <title>Hadoopをより便利に使う！HiveでのMapReduceまとめ &middot; Y&#39;s note</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://yutakikuchi.github.io/blog/img/favicon.ico" type="image/x-icon" />

  
    
        <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/my.css">
    
  
  
    
        <script src="https://yutakikuchi.github.io/blog/js/my.js"></script>
    
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://yutakikuchi.github.io/blog/">Y's note</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/yutakikuchi_" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://facebook.com/yuta.kikuchi.007" target="_blank"><i class="fa fa-facebook-square fa-fw"></i>Facebook</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="http://slideshare.net/https://www.slideshare.net/yutakikuchi58/" target="_blank"><i class="fa fa-slideshare fa-fw"></i>SlideShare</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/https://www.linkedin.com/in/%E4%BD%91%E5%A4%AA-%E8%8F%8A%E6%B1%A0-36291a44/" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/yutakikuchi" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2019. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Hadoopをより便利に使う！HiveでのMapReduceまとめ</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2011 Dec 19, 08:30</time>
  </div>

  

  

  

</div>

  

<h2 id="hadoop-hadoopをより便利に使う-hiveでのmapreduceまとめ">[Hadoop] : Hadoopをより便利に使う！HiveでのMapReduceまとめ</h2>

<p><span itemscope itemtype="http://schema.org/Photograph"><a href="http://f.hatena.ne.jp/yutakikuchi/20111213234850" class="hatena-fotolife" itemprop="url"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/y/yutakikuchi/20111213/20111213234850.png" alt="f:id:yutakikuchi:20111213234850p:image" title="f:id:yutakikuchi:20111213234850p:image" class="hatena-fotolife" itemprop="image"></a></span><br />
</p>

<div class="section">
<h4>目次</h4>

<blockquote>
    
<ol>
<li><span class="deco" style="font-size:large;">Hiveとは</span></li>
<li><span class="deco" style="font-size:large;">Hiveの設定</span></li>
<li><span class="deco" style="font-size:large;">HiveQL構文(<a class="keyword" href="http://d.hatena.ne.jp/keyword/DDL">DDL</a>)</span>
<ol>
<li>DataBase/SCHEMAの作成</li>
<li>Database/SCHEMAの削除</li>
<li>Tableの作成</li>
<li>Tableの削除</li>
<li>Table名変更</li>
<li>Partition作成</li>
<li>Partitionの削除</li>
<li>Columnの変更</li>
<li>Columnの追加/置き換え</li>
<li>TableのProperty変更</li>
<li>SerDe Propertyの追加</li>
</ol></li>
<li><span class="deco" style="font-size:large;">HiveQL構文(<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>)</span>
<ol>
<li>テーブル一覧表示</li>
<li>テーブルの内容を表示</li>
<li>基本的なSELECT文</li>
<li>WHERE句(条件指定)</li>
<li>DISTINCT(重複削除)</li>
<li>ORDER BY / SORT BY句(ソート)</li>
<li>GROUP BY句(グループ化)</li>
<li>HAVING句(グループ化後の条件)</li>
<li>LIMIT句</li>
<li>JOIN(テーブル結合)</li>
<li>抽出カラムを<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C0%B5%B5%AC%C9%BD%B8%BD">正規表現</a>で指定</li>
<li>UNION(結果の結合)</li>
<li>SUBQUERY</li>
<li>LOAD(データの読み込み)</li>
</ol></li>
<li><span class="deco" style="font-size:large;">Hiveを使う</span>
<ol>
<li>事前準備</li>
<li>起動と終了</li>
<li>テーブルの定義</li>
<li>データの読み込み</li>
<li>Tableの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>定義</li>
<li>検索/<a class="keyword" href="http://d.hatena.ne.jp/keyword/MapReduce">MapReduce</a></li>
<li>SELECT結果をINSERT</li>
<li>ローカルファイルとして保存</li>
</ol></li>
<li><span class="deco" style="font-size:large;">まとめ</span></li>
<li><span class="deco" style="font-size:large;">リンク</span></li>
</ol>
</blockquote>

</div>
<div class="section">
<h4><span class="deco" style="font-weight:bold;"><span class="deco" style="font-size:large;">Hiveとは</span></span></h4>

<blockquote>
    
<ul>
<li>2008年に<a class="keyword" href="http://d.hatena.ne.jp/keyword/FaceBook">FaceBook</a>で開発さえて<a class="keyword" href="http://d.hatena.ne.jp/keyword/Hadoop">Hadoop</a>プロジェクトに寄贈される。</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Yahoo%21">Yahoo!</a>で開発しているPigのライバルプロジェクト？</li>
<li>一言で表すと<a class="keyword" href="http://d.hatena.ne.jp/keyword/Hadoop">Hadoop</a>上で動作するデータ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A6%A5%A8%A5%A2%A5%CF%A5%A6%A5%B9">ウエアハウス</a>。</li>
<li><span class="deco" style="font-weight:bold;">HiveQL</span>という<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>のような言語で<a class="keyword" href="http://d.hatena.ne.jp/keyword/HDFS">HDFS</a>などの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%AC%BB%B6%A5%D5%A5%A1%A5%A4%A5%EB%A5%B7%A5%B9%A5%C6%A5%E0">分散ファイルシステム</a>上のデータを操作できる。</li>
<li>HiveQLの実行でMap/Reduce処理が完了する。</li>
<li>私見だが複雑なデータの<a class="keyword" href="http://d.hatena.ne.jp/keyword/MapReduce">MapReduce</a>から特定のデータを抽出したい場合には便利かも。</li>
</ul>
</blockquote>

</div>
<div class="section">
<h4><span class="deco" style="font-weight:bold;"><span class="deco" style="font-size:large;">Hiveの設定</span></span></h4>

<blockquote>
    
<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/CentOS">CentOS</a>でのHiveの設定は<a href="http://d.hatena.ne.jp/yutakikuchi/20111205/1323041424">CentOSでHadoopを使ってみる - Yuta.Kikuchiの日記</a> <a href="http://b.hatena.ne.jp/entry/d.hatena.ne.jp/yutakikuchi/20111205/1323041424"><img src="http://b.hatena.ne.jp/entry/image/http://d.hatena.ne.jp/yutakikuchi/20111205/1323041424" alt="はてなブックマーク - CentOSでHadoopを使ってみる - Yuta.Kikuchiの日記" border="0" /></a>を参照して欲しい。</li>
</ul>
</blockquote>

</div>
<div class="section">
<h4><span class="deco" style="font-weight:bold;"><span class="deco" style="font-size:large;">HiveQL構文(<a class="keyword" href="http://d.hatena.ne.jp/keyword/DDL">DDL</a>)</span></span></h4>

<blockquote>
    
<ul>
<li>HiveQLは<a class="keyword" href="http://d.hatena.ne.jp/keyword/RDB">RDB</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>と似た構文となっているので理解がしやすい。</li>
</ul>
<div class="section">
<h5>DataBase/SCHEMAの作成</h5>

<ul>
<li>構文</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">CREATE</span> (DATABASE|SCHEMA) [<span class="synSpecial">IF</span> <span class="synStatement">NOT</span> <span class="synStatement">EXISTS</span>] database_name
  [<span class="synStatement">COMMENT</span> database_comment]
  [LOCATION hdfs_path]
  [<span class="synSpecial">WITH</span> DBPROPERTIES (property_name=property_value, ...)];
</pre>
<ul>
<li>サンプル</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">CREATE</span> DATABASE <span class="synSpecial">IF</span> <span class="synStatement">NOT</span> <span class="synStatement">EXISTS</span> logs;
</pre>
</div>
<div class="section">
<h5>Database/SCHEMAの削除</h5>

<ul>
<li>構文</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">DROP</span> (DATABASE|SCHEMA) [<span class="synSpecial">IF</span> <span class="synStatement">EXISTS</span>] database_name [RESTRICT|CASCADE];
</pre>
<ul>
<li>サンプル</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">DROP</span> DATABASE <span class="synSpecial">IF</span> <span class="synStatement">EXISTS</span> logs;
</pre>
</div>
<div class="section">
<h5>Tableの作成</h5>

<ul>
<li>構文</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">CREATE</span> [EXTERNAL] <span class="synSpecial">TABLE</span> [<span class="synSpecial">IF</span> <span class="synStatement">NOT</span> <span class="synStatement">EXISTS</span>] [db_name.]table_name
  [(col_name data_type [<span class="synStatement">COMMENT</span> col_comment], ...)]
  [<span class="synStatement">COMMENT</span> table_comment]
  [PARTITIONED <span class="synSpecial">BY</span> (col_name data_type [<span class="synStatement">COMMENT</span> col_comment], ...)]
  [CLUSTERED <span class="synSpecial">BY</span> (col_name, col_name, ...) [SORTED <span class="synSpecial">BY</span> (col_name [<span class="synSpecial">ASC</span>|<span class="synSpecial">DESC</span>], ...)] <span class="synSpecial">INTO</span> num_buckets BUCKETS]
  [
   [<span class="synSpecial">ROW</span> FORMAT row_format] [STORED <span class="synSpecial">AS</span> file_format]
   | STORED <span class="synSpecial">BY</span> <span class="synConstant">'storage.handler.class.name'</span> [<span class="synSpecial">WITH</span> SERDEPROPERTIES (...)]  (Note:  only available starting <span class="synSpecial">with</span> <span class="synConstant">0.6</span>.<span class="synConstant">0</span>)
  ]
  [LOCATION hdfs_path]
  [TBLPROPERTIES (property_name=property_value, ...)]  (Note:  only available starting <span class="synSpecial">with</span> <span class="synConstant">0.6</span>.<span class="synConstant">0</span>)
  [<span class="synSpecial">AS</span> select_statement]  (Note: this feature <span class="synSpecial">is</span> only available starting <span class="synSpecial">with</span> <span class="synConstant">0.5</span>.<span class="synConstant">0</span>, <span class="synStatement">and</span> <span class="synSpecial">is</span> <span class="synStatement">not</span> supported when creating external tables.)

<span class="synStatement">CREATE</span> [EXTERNAL] <span class="synSpecial">TABLE</span> [<span class="synSpecial">IF</span> <span class="synStatement">NOT</span> <span class="synStatement">EXISTS</span>] [db_name.]table_name
  <span class="synStatement">LIKE</span> existing_table_or_view_name
  [LOCATION hdfs_path]

data_type
  : primitive_type
  | array_type
  | map_type
  | struct_type

primitive_type
  : TINYINT
  | <span class="synSpecial">SMALLINT</span>
  | INT
  | BIGINT
  | <span class="synType">BOOLEAN</span>
  | <span class="synType">FLOAT</span>
  | DOUBLE
  | STRING

array_type
  : ARRAY < data_type >

map_type
  : MAP < primitive_type, data_type >

struct_type
  : STRUCT < col_name : data_type [<span class="synStatement">COMMENT</span> col_comment], ...>

row_format
  : DELIMITED [FIELDS TERMINATED <span class="synSpecial">BY</span> <span class="synType">char</span>] [COLLECTION ITEMS TERMINATED <span class="synSpecial">BY</span> <span class="synType">char</span>]
    [MAP KEYS TERMINATED <span class="synSpecial">BY</span> <span class="synType">char</span>] [LINES TERMINATED <span class="synSpecial">BY</span> <span class="synType">char</span>]
  | SERDE serde_name [<span class="synSpecial">WITH</span> SERDEPROPERTIES (property_name=property_value, property_name=property_value, ...)]

file_format:
  : SEQUENCEFILE
  | TEXTFILE
  | RCFILE     (Note:  only available starting <span class="synSpecial">with</span> <span class="synConstant">0.6</span>.<span class="synConstant">0</span>)
  | INPUTFORMAT input_format_classname OUTPUTFORMAT output_format_classname
</pre>
<ul>
<li>サンプル
<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/csv">csv</a>ファイルを改行コードで1行として扱い、カンマで区切った値を格納する。</li>
</ul></li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">CREATE</span> <span class="synSpecial">TABLE</span> logs(id INT, created_at STRING) <span class="synSpecial">row</span> format delimited fields terminated <span class="synSpecial">by</span> <span class="synConstant">','</span> lines terminated <span class="synSpecial">by</span> <span class="synConstant">'\n'</span>;
</pre>
<ul>
<li>
<ul>
<li>date項目でPartisionを設定する。(Partitionを設定するとそのカラムでの項目ごとの集計が簡単にできる。)</li>
</ul></li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">CREATE</span> <span class="synSpecial">TABLE</span> logs(id INT, created_at STRING) PARTITIONED <span class="synSpecial">BY</span>(<span class="synType">date</span> STRING) <span class="synSpecial">row</span> format delimited fields terminated <span class="synSpecial">by</span> <span class="synConstant">','</span> lines terminated <span class="synSpecial">by</span> <span class="synConstant">'\n'</span>;
</pre>
</div>
<div class="section">
<h5>Tableの削除</h5>

<ul>
<li>構文</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">DROP</span> <span class="synSpecial">TABLE</span> [<span class="synSpecial">IF</span> <span class="synStatement">EXISTS</span>] table_name
</pre>
<ul>
<li>サンプル</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">DROP</span> <span class="synSpecial">TABLE</span> logs;
</pre>
</div>
<div class="section">
<h5>Table名変更</h5>

<ul>
<li>構文</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">ALTER</span> <span class="synSpecial">TABLE</span> table_name <span class="synStatement">RENAME</span> <span class="synSpecial">TO</span> new_table_name
</pre>
<ul>
<li>サンプル</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">ALTER</span> <span class="synSpecial">TABLE</span> logs <span class="synStatement">RENAME</span> <span class="synSpecial">TO</span> logs_yesterday;
</pre>
</div>
<div class="section">
<h5>Partition作成</h5>

<ul>
<li>構文</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">ALTER</span> <span class="synSpecial">TABLE</span> table_name <span class="synSpecial">ADD</span> [<span class="synSpecial">IF</span> <span class="synStatement">NOT</span> <span class="synStatement">EXISTS</span>] PARTITION partition_spec [LOCATION <span class="synConstant">'location1'</span>] partition_spec [LOCATION <span class="synConstant">'location2'</span>] ...

partition_spec:
  : (partition_col = partition_col_value, partition_col = partiton_col_value, ...)
</pre>
<ul>
<li>サンプル</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">ALTER</span> <span class="synSpecial">TABLE</span> logs <span class="synSpecial">ADD</span> PARTITION (<span class="synType">date</span> = <span class="synConstant">'2011-12-14'</span>) location <span class="synConstant">'/path/to/part111214'</span>;
</pre>
</div>
<div class="section">
<h5>Partitionの削除</h5>

<ul>
<li>構文</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">ALTER</span> <span class="synSpecial">TABLE</span> table_name <span class="synStatement">DROP</span> [<span class="synSpecial">IF</span> <span class="synStatement">EXISTS</span>] partition_spec, partition_spec,...
</pre>
<ul>
<li>サンプル</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">ALTER</span> <span class="synSpecial">TABLE</span> logs <span class="synStatement">DROP</span> PARTITION (<span class="synType">date</span> = <span class="synConstant">'2011-12-14'</span>);
</pre>
</div>
<div class="section">
<h5>Columnの変更</h5>

<ul>
<li>構文</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">ALTER</span> <span class="synSpecial">TABLE</span> table_name CHANGE [<span class="synSpecial">COLUMN</span>] col_old_name col_new_name column_type [<span class="synStatement">COMMENT</span> col_comment] [FIRST|AFTER column_name]
</pre>
<ul>
<li>サンプル
<ul>
<li>Columnの名前を変更</li>
</ul></li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">ALTER</span> <span class="synSpecial">TABLE</span> logs CHANGE <span class="synSpecial">COLUMN</span> created_at created_date;
</pre>
</div>
<div class="section">
<h5>Columnの追加/置き換え</h5>

<ul>
<li>構文</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">ALTER</span> <span class="synSpecial">TABLE</span> table_name <span class="synSpecial">ADD</span>|REPLACE COLUMNS (col_name data_type [<span class="synStatement">COMMENT</span> col_comment], ...)
</pre>
<ul>
<li>サンプル</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">ALTER</span> <span class="synSpecial">TABLE</span> logs <span class="synSpecial">ADD</span> update_date STRING;
</pre>
</div>
<div class="section">
<h5>TableのProperty変更</h5>

<ul>
<li>構文</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">ALTER</span> <span class="synSpecial">TABLE</span> table_name <span class="synStatement">SET</span> TBLPROPERTIES table_properties

table_properties:
  : (property_name = property_value, property_name = property_value, ... )
</pre>
<ul>
<li>サンプル
<ul>
<li>外部テーブルに変更</li>
</ul></li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">ALTER</span> <span class="synSpecial">TABLE</span> logs <span class="synStatement">SET</span> TBLPROPERTIES (<span class="synConstant">'EXTERNAL'</span>=<span class="synSpecial">true</span>);
</pre>
</div>
<div class="section">
<h5>SerDe Propertyの追加</h5>

<ul>
<li>SerDeとはHiveの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B7%A5%EA%A5%A2%A5%E9%A5%A4%A5%BA">シリアライズ</a>/デ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B7%A5%EA%A5%A2%A5%E9%A5%A4%A5%BA">シリアライズ</a>データを作るクラスの事。</li>
<li>行フォーマットを定義するために使う。(行と行のフィールドがどのように保存されるかを示す。)</li>
<li>構文</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">ALTER</span> <span class="synSpecial">TABLE</span> table_name <span class="synStatement">SET</span> SERDE serde_class_name [<span class="synSpecial">WITH</span> SERDEPROPERTIES serde_properties]
<span class="synStatement">ALTER</span> <span class="synSpecial">TABLE</span> table_name <span class="synStatement">SET</span> SERDEPROPERTIES serde_properties

serde_properties:
  : (property_name = property_value, property_name = property_value, ... )
</pre>
<ul>
<li>サンプル</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">ALTER</span> <span class="synSpecial">TABLE</span> logs <span class="synStatement">SET</span> SERDEPROPERTIES ( <span class="synConstant">'field.delim'</span> = <span class="synConstant">','</span> );
</pre>
</div>
</blockquote>

</div>
<div class="section">
<h4><span class="deco" style="font-weight:bold;"><span class="deco" style="font-size:large;">HiveQL構文(<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>)</span></span></h4>

<blockquote>
    
<ul>
<li>これも<a class="keyword" href="http://d.hatena.ne.jp/keyword/RDB">RDB</a>と同じような構文。SELECTなど。</li>
</ul>
<div class="section">
<h5>テーブルの一覧を表示</h5>

<ul>
<li>一覧</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink>SHOW TABLES;
</pre>
<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>を表示</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink>SHOW PARTITIONS logs;
</pre>
</div>
<div class="section">
<h5>テーブルの内容を表示</h5>
<pre class="hljs sql" data-lang="sql" data-unlink>DESCRIBE logs;
</pre>
</div>
<div class="section">
<h5>基本的なSELECT文</h5>

<ul>
<li>構文</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">SELECT</span> [<span class="synStatement">ALL</span> | <span class="synStatement">DISTINCT</span>] select_expr, select_expr, ...
<span class="synSpecial">FROM</span> table_reference
[<span class="synSpecial">WHERE</span> where_condition]
[<span class="synSpecial">GROUP</span> <span class="synSpecial">BY</span> col_list]
[<span class="synSpecial">CLUSTER</span> <span class="synSpecial">BY</span> col_list
  | [DISTRIBUTE <span class="synSpecial">BY</span> col_list] [SORT <span class="synSpecial">BY</span> col_list]
]
[LIMIT <span class="synType">number</span>]
</pre>
<ul>
<li>サンプル</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">SELECT</span> * <span class="synSpecial">FROM</span> logs;
</pre>
</div>
<div class="section">
<h5>WHERE句(条件指定)</h5>
<pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">SELECT</span> * <span class="synSpecial">FROM</span> logs <span class="synSpecial">WHERE</span> id > <span class="synConstant">10</span> <span class="synStatement">AND</span> created_at = <span class="synConstant">"US"</span>;
</pre>
</div>
<div class="section">
<h5>DISTINCT(重複削除)</h5>
<pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">SELECT</span> <span class="synStatement">DISTINCT</span> created_at <span class="synSpecial">FROM</span> logs;
</pre>
</div>
<div class="section">
<h5>ORDER BY / SORT BY(ソート)</h5>

<ul>
<li>ORDER BY構文</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink>colOrder: ( <span class="synSpecial">ASC</span> | <span class="synSpecial">DESC</span> )
orderBy: <span class="synSpecial">ORDER</span> <span class="synSpecial">BY</span> colName colOrder? (<span class="synConstant">','</span> colName colOrder?)*
query: <span class="synStatement">SELECT</span> expression (<span class="synConstant">','</span> expression)* <span class="synSpecial">FROM</span> src orderBy
</pre>
<ul>
<li>SORT BY構文</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink>colOrder: ( <span class="synSpecial">ASC</span> | <span class="synSpecial">DESC</span> )
sortBy: SORT <span class="synSpecial">BY</span> colName colOrder? (<span class="synConstant">','</span> colName colOrder?)*
query: <span class="synStatement">SELECT</span> expression (<span class="synConstant">','</span> expression)* <span class="synSpecial">FROM</span> src sortBy
</pre>
<ul>
<li>サンプル</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">SELECT</span> * <span class="synSpecial">FROM</span> logs SORT <span class="synSpecial">BY</span> <span class="synType">date</span> <span class="synSpecial">ASC</span>, created_at <span class="synSpecial">DESC</span>;
</pre>
</div>
<div class="section">
<h5>GROUP BY句(グループ化)</h5>

<ul>
<li>構文</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink>groupByClause: <span class="synSpecial">GROUP</span> <span class="synSpecial">BY</span> groupByExpression (, groupByExpression)*

groupByExpression: expression

groupByQuery: <span class="synStatement">SELECT</span> expression (, expression)* <span class="synSpecial">FROM</span> src groupByClause?
</pre>
<ul>
<li>サンプル</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">SELECT</span> * <span class="synSpecial">FROM</span> logs <span class="synSpecial">GROUP</span> <span class="synSpecial">BY</span> created_at;
</pre>
</div>
<div class="section">
<h5>HAVING句(グループ化後の条件)</h5>
<pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">SELECT</span> * <span class="synSpecial">FROM</span> logs <span class="synSpecial">GROUP</span> <span class="synSpecial">BY</span> created_at <span class="synSpecial">HAVING</span> COUNT( id ) > <span class="synConstant">10</span>;
</pre>
</div>
<div class="section">
<h5>LIMIT句</h5>
<pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">SELECT</span> * <span class="synSpecial">FROM</span> logs LIMIT <span class="synConstant">5</span>;
</pre>
</div>
<div class="section">
<h5>JOIN(テーブル結合)</h5>

<ul>
<li>構文</li>
</ul><pre class="code" data-lang="" data-unlink>join_table:
table_reference JOIN table_factor [join_condition]
  | table_reference {LEFT|RIGHT|FULL} [OUTER] JOIN table_reference join_condition
  | table_reference LEFT SEMI JOIN table_reference join_condition

table_reference:
table_factor
  | join_table

table_factor:
tbl_name [alias]
  | table_subquery alias
  | ( table_references )

join_condition:
ON equality_expression ( AND equality_expression )*

equality_expression:
expression = expression</pre>
<ul>
<li>サンプル</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">SELECT</span> logs.* <span class="synSpecial">FROM</span> logs JOIN logs2 <span class="synSpecial">ON</span> ( logs.id = logs2.id );
</pre>
</div>
<div class="section">
<h5>抽出カラムを<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C0%B5%B5%AC%C9%BD%B8%BD">正規表現</a>で指定</h5>
<pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">SELECT</span> <REGEX> <span class="synSpecial">FROM</span> logs;
</pre>
</div>
<div class="section">
<h5>UNION(結果の結合)</h5>

<ul>
<li>構文</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink>select_statement <span class="synStatement">UNION</span> <span class="synStatement">ALL</span> select_statement <span class="synStatement">UNION</span> <span class="synStatement">ALL</span> select_statement ...
</pre>
<ul>
<li>サンプル</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">SELECT</span> id,created_at <span class="synSpecial">FROM</span> logs <span class="synSpecial">WHERE</span>  <span class="synType">date</span> = <span class="synConstant">'2011-12-15'</span> <span class="synStatement">UNION</span> <span class="synStatement">ALL</span> <span class="synStatement">SELECT</span> id,created <span class="synSpecial">FROM</span> logs2 <span class="synSpecial">WHERE</span> <span class="synType">date</span> = <span class="synConstant">'2011-12-15'</span> ; 
</pre>
</div>
<div class="section">
<h5>SUBQUERY</h5>

<ul>
<li>構文</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">SELECT</span> ... <span class="synSpecial">FROM</span> (subquery) name ...
</pre>
<ul>
<li>サンプル</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink><span class="synStatement">SELECT</span> col <span class="synSpecial">FROM</span> ( <span class="synStatement">SELECT</span> a+b <span class="synSpecial">AS</span> col <span class="synSpecial">FROM</span> logs2 ) logs; 
</pre>
</div>
<div class="section">
<h5>LOAD(データの読み込み)</h5>

<ul>
<li>構文</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink>LOAD DATA [LOCAL] INPATH <span class="synConstant">'filepath'</span> [OVERWRITE] <span class="synSpecial">INTO</span> <span class="synSpecial">TABLE</span> tablename [PARTITION (partcol1=val1, partcol2=val2 ...)]
</pre>
<ul>
<li>サンプル</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink>LOAD DATA INPATH <span class="synConstant">'/user/data/pv_2011-12-15_us.txt'</span> <span class="synSpecial">INTO</span> <span class="synSpecial">TABLE</span> logs PARTITION(<span class="synType">date</span>=<span class="synConstant">'2011-12-15'</span>, created_at=<span class="synConstant">'US'</span>);
</pre>
</div>
</blockquote>

</div>
<div class="section">
<h4><span class="deco" style="font-weight:bold;"><span class="deco" style="font-size:large;">Hiveを使う</span></span></h4>

<blockquote>
    
<ul>
<li><a href="http://www.atmarkit.co.jp/fdb/single/s_hive/hive_02.html">http://www.atmarkit.co.jp/fdb/single/s_hive/hive_02.html</a> ここに掲載差入れている実験データを元にHiveを動かす。</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/%C5%D4%C6%BB">都道</a>府県番号、郵便番号のデータを<a class="keyword" href="http://d.hatena.ne.jp/keyword/MapReduce">MapReduce</a>することが目的。</li>
</ul>
<div class="section">
<h5>事前準備</h5>

<ul>
<li>ファイルダウンロード</li>
</ul><pre class="code" data-lang="" data-unlink>$ wget wget http://www.atmarkit.co.jp/fdb/single/s_hive/dl/data.tar.gz
$ tar -xzf data.tar.gz</pre>
<ul>
<li>解凍フォルダの確認
<ul>
<li>ファイル一覧</li>
</ul></li>
</ul><pre class="code" data-lang="" data-unlink>$ tree
|-- pref.csv
|-- zip20081128.csv
`-- zip20081226.csv</pre>
<ul>
<li>
<ul>
<li>pref.<a class="keyword" href="http://d.hatena.ne.jp/keyword/csv">csv</a>は<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C5%D4%C6%BB">都道</a>府県番号と<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C5%D4%C6%BB">都道</a>府県名をカンマ区切りで格納。</li>
</ul></li>
</ul><pre class="code" data-lang="" data-unlink>1,北海道
2,青森県
3,岩手県
4,宮城県
5,秋田県
6,山形県
7,福島県
8,茨城県
(略)</pre>
<ul>
<li>
<ul>
<li>zipYYYYMMDD.<a class="keyword" href="http://d.hatena.ne.jp/keyword/csv">csv</a>は郵便番号と住所をカンマ区切りで格納。</li>
</ul></li>
</ul><pre class="code" data-lang="" data-unlink>0600000,1,札幌市中央区,
0640941,1,札幌市中央区,旭ケ丘
0600041,1,札幌市中央区,大通東
0600042,1,札幌市中央区,大通西（１〜１９丁目）
0640820,1,札幌市中央区,大通西（２０〜２８丁目）
0600031,1,札幌市中央区,北一条東
0600001,1,札幌市中央区,北一条西（１〜１９丁目）
0640821,1,札幌市中央区,北一条西（２０〜２８丁目）
0600032,1,札幌市中央区,北二条東
0600002,1,札幌市中央区,北二条西（１〜１９丁目）</pre>
</div>
<div class="section">
<h5><span class="deco" style="font-weight:bold;">起動と終了</span></h5>

<ul>
<li>起動</li>
</ul><pre class="code" data-lang="" data-unlink>$ /usr/bin/hive 
Hive history file=/tmp/yuta/hive_job_log_yuta_201112140914_1577424059.txt
hive> </pre>
<ul>
<li>終了</li>
</ul><pre class="code" data-lang="" data-unlink>hive> exit;</pre>
</div>
<div class="section">
<h5>テーブルの定義</h5>

<ul>
<li>pref.<a class="keyword" href="http://d.hatena.ne.jp/keyword/csv">csv</a>を行内でカンマ区切りでデータを格納するための定義。</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink>hive> <span class="synStatement">CREATE</span> <span class="synSpecial">TABLE</span> pref (id int, pref STRING) <span class="synSpecial">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="synSpecial">BY</span> <span class="synConstant">','</span> LINES TERMINATED <span class="synSpecial">BY</span> <span class="synConstant">'\n'</span>;
OK
Time taken: <span class="synConstant">11</span>.<span class="synConstant">761</span> seconds
</pre>
</div>
<div class="section">
<h5>データの読み込み</h5>

<ul>
<li>読み込み</li>
</ul><pre class="code" data-lang="" data-unlink>hive> LOAD DATA LOCAL INPATH '/home/yuta/work/dev/hadoop/hive/localfiles/pref.csv' OVERWRITE INTO TABLE pref;
Copying data from file:/home/yuta/work/dev/hadoop/hive/localfiles/pref.csv
Copying file: file:/home/yuta/work/dev/hadoop/hive/localfiles/pref.csv
Loading data to table default.pref
Deleted hdfs://localhost/user/hive/warehouse/pref
OK
Time taken: 0.919 seconds</pre>
<ul>
<li>確認</li>
</ul><pre class="code" data-lang="" data-unlink>hive> SELECT * FROM pref;
OK
1   北海道
2   青森県
3   岩手県
4   宮城県
5   秋田県
6   山形県
7   福島県
8   茨城県
(略)</pre>
</div>
<div class="section">
<h5>Tableの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>定義</h5>

<ul>
<li>YYYYMMDD.<a class="keyword" href="http://d.hatena.ne.jp/keyword/csv">csv</a>ファイルを一つの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>として扱うためのTable定義</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink>hive> <span class="synStatement">CREATE</span> <span class="synSpecial">TABLE</span> zip (zip STRING, pref INT, city STRING, town STRING) PARTITIONED <span class="synSpecial">BY</span> (ver <span class="synType">DATE</span>) <span class="synSpecial">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="synSpecial">BY</span> <span class="synConstant">','</span> LINES TERMINATED <span class="synSpecial">BY</span> <span class="synConstant">'\n'</span>;
</pre><p>※どうもDATE,DATETIME,TIMESTAMPがまだサポートされていないバージョンのようだ。指示通りSTRINGに変えて試してみる。</p>
<pre class="hljs sql" data-lang="sql" data-unlink>hive> <span class="synStatement">CREATE</span> <span class="synSpecial">TABLE</span> zip (zip STRING, pref INT, city STRING, town STRING) PARTITIONED <span class="synSpecial">BY</span> (ver STRING) <span class="synSpecial">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="synSpecial">BY</span> <span class="synConstant">','</span> LINES TERMINATED <span class="synSpecial">BY</span> <span class="synConstant">'\n'</span>;
OK
Time taken: <span class="synConstant">0</span>.<span class="synConstant">098</span> seconds
</pre>
<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>情報を指定してデータの読み込み</li>
</ul><pre class="code" data-lang="" data-unlink>hive> LOAD DATA LOCAL INPATH '/home/yuta/work/dev/hadoop/hive/localfiles/zip20081128.csv' OVERWRITE INTO TABLE zip PARTITION (ver = '2008-11-28');
Copying data from file:/home/yuta/work/dev/hadoop/hive/localfiles/zip20081128.csv
Copying file: file:/home/yuta/work/dev/hadoop/hive/localfiles/zip20081128.csv
Loading data to table default.zip partition (ver=2008-11-28)
OK
Time taken: 1.517 seconds

hive> LOAD DATA LOCAL INPATH '/home/yuta/work/dev/hadoop/hive/localfiles/zip20081226.csv' OVERWRITE INTO TABLE zip PARTITION (ver = '2008-12-26');
Copying data from file:/home/yuta/work/dev/hadoop/hive/localfiles/zip20081226.csv
Copying file: file:/home/yuta/work/dev/hadoop/hive/localfiles/zip20081226.csv
Loading data to table default.zip partition (ver=2008-12-26)
OK
Time taken: 0.76 seconds</pre>
<ul>
<li>データの確認</li>
</ul><pre class="code" data-lang="" data-unlink>SELECT * from zip;
OK
0600000 1   札幌市中央区      2008-11-28
0640941 1   札幌市中央区  旭ケ丘 2008-11-28
0600041 1   札幌市中央区  大通東 2008-11-28
0600042 1   札幌市中央区  大通西（１〜１９丁目） 2008-11-28
0640820 1   札幌市中央区  大通西（２０〜２８丁目）    2008-11-28
(略)
071101  47  八重山郡竹富町 竹富  2008-12-26
9071434 47  八重山郡竹富町 南風見 2008-12-26
9071433 47  八重山郡竹富町 南風見仲    2008-12-26
9071751 47  八重山郡竹富町 波照間 2008-12-26
9071544 47  八重山郡竹富町 鳩間  2008-12-26
9071800 47  八重山郡与那国町        2008-12-26
9071801 47  八重山郡与那国町    与那国 2008-12-26</pre>
</div>
<div class="section">
<h5>検索/<a class="keyword" href="http://d.hatena.ne.jp/keyword/MapReduce">MapReduce</a></h5>

<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%C6%A5%A3%A5%B7%A5%E7%A5%F3">パーティション</a>を指定して検索</li>
</ul><pre class="code" data-lang="" data-unlink>hive> SELECT z.zip, z.pref, z.city, z.town FROM zip z WHERE z.ver = '2008-12-26';
Total MapReduce jobs = 1
Launching Job 1 out of 1
Number of reduce tasks is set to 0 since there's no reduce operator
Starting Job = job_201112190030_0001, Tracking URL = http://localhost:50030/jobdetails.jsp?jobid=job_201112190030_0001
Kill Command = /usr/lib/hadoop/bin/hadoop job  -Dmapred.job.tracker=localhost:8021 -kill job_201112190030_0001
2011-12-19 01:20:21,358 Stage-1 map = 0%,  reduce = 0%
2011-12-19 01:20:27,532 Stage-1 map = 100%,  reduce = 0%
2011-12-19 01:20:30,933 Stage-1 map = 100%,  reduce = 100%
Ended Job = job_201112190030_0001
OK
0600000 1   札幌市中央区  
0640941 1   札幌市中央区  旭ケ丘
0600041 1   札幌市中央区  大通東
0600042 1   札幌市中央区  大通西（１〜１９丁目）
0640820 1   札幌市中央区  大通西（２０〜２８丁目）
0600031 1   札幌市中央区  北一条東
(略)</pre>
<ul>
<li>条件を指定して検索</li>
</ul><pre class="code" data-lang="" data-unlink>hive> SELECT z.zip, z.pref, z.city, z.town FROM zip z WHERE z.ver = '2008-12-26' AND z.town LIKE '銀座';
Total MapReduce jobs = 1
Launching Job 1 out of 1
Number of reduce tasks is set to 0 since there's no reduce operator
Starting Job = job_201112190030_0002, Tracking URL = http://localhost:50030/jobdetails.jsp?jobid=job_201112190030_0002
Kill Command = /usr/lib/hadoop/bin/hadoop job  -Dmapred.job.tracker=localhost:8021 -kill job_201112190030_0002
2011-12-19 01:25:34,289 Stage-1 map = 0%,  reduce = 0%
2011-12-19 01:25:39,419 Stage-1 map = 100%,  reduce = 0%
2011-12-19 01:25:43,562 Stage-1 map = 100%,  reduce = 100%
Ended Job = job_201112190030_0002
OK
0691331 1   夕張郡長沼町  銀座
3220052 9   鹿沼市 銀座
3600032 11  熊谷市 銀座
3670052 11  本庄市 銀座
1040061 13  中央区 銀座
3940022 20  岡谷市 銀座
3950031 20  飯田市 銀座
4240817 22  静岡市清水区  銀座
4480845 23  刈谷市 銀座
7450032 35  周南市 銀座
7700916 36  徳島市 銀座
8040076 40  北九州市戸畑区 銀座
Time taken: 17.508 seconds</pre>
<ul>
<li>TableのJOIN</li>
</ul><pre class="code" data-lang="" data-unlink>hive> SELECT z.zip, p.pref, z.city, z.town FROM zip z LEFT OUTER JOIN pref p ON (p.id = z.pref) WHERE z.ver = '2008-12-26' AND z.town REGEXP '銀座';
Total MapReduce jobs = 1
Launching Job 1 out of 1
Number of reduce tasks not specified. Estimated from input data size: 1
In order to change the average load for a reducer (in bytes):
  set hive.exec.reducers.bytes.per.reducer=<number>
In order to limit the maximum number of reducers:
  set hive.exec.reducers.max=<number>
In order to set a constant number of reducers:
  set mapred.reduce.tasks=<number>
Starting Job = job_201112190030_0003, Tracking URL = http://localhost:50030/jobdetails.jsp?jobid=job_201112190030_0003
Kill Command = /usr/lib/hadoop/bin/hadoop job  -Dmapred.job.tracker=localhost:8021 -kill job_201112190030_0003
2011-12-19 01:27:54,253 Stage-1 map = 0%,  reduce = 0%
2011-12-19 01:28:06,828 Stage-1 map = 50%,  reduce = 0%
2011-12-19 01:28:08,983 Stage-1 map = 100%,  reduce = 0%
2011-12-19 01:28:25,878 Stage-1 map = 100%,  reduce = 100%
Ended Job = job_201112190030_0003
OK
0691331 北海道 夕張郡長沼町  銀座
3220052 栃木県 鹿沼市 銀座
3600032 埼玉県 熊谷市 銀座
3670052 埼玉県 本庄市 銀座
1040061 東京都 中央区 銀座
9300991 富山県 富山市 新庄銀座
3940022 長野県 岡谷市 銀座
3940023 長野県 岡谷市 東銀座
3950031 長野県 飯田市 銀座
4130013 静岡県 熱海市 銀座町
4240817 静岡県 静岡市清水区  銀座
4140028 静岡県 伊東市 銀座元町
4750874 愛知県 半田市 銀座本町
4480845 愛知県 刈谷市 銀座
5220088 滋賀県 彦根市 銀座町
6128089 京都府 京都市伏見区  銀座町
7450032 山口県 周南市 銀座
7450033 山口県 周南市 みなみ銀座
7700916 徳島県 徳島市 銀座
8040076 福岡県 北九州市戸畑区 銀座
Time taken: 43.692 seconds</pre>
</div>
<div class="section">
<h5>SELECT結果をINSERT</h5>

<ul>
<li>結果を格納するテーブルの定義</li>
</ul><pre class="hljs sql" data-lang="sql" data-unlink>hive> <span class="synStatement">CREATE</span> <span class="synSpecial">TABLE</span> ginza_zip (zip STRING, pref INT, city STRING, town STRING) <span class="synSpecial">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="synSpecial">BY</span> <span class="synConstant">','</span> LINES TERMINATED <span class="synSpecial">BY</span> <span class="synConstant">'\n'</span>;
OK
Time taken: <span class="synConstant">0</span>.<span class="synConstant">175</span> seconds
</pre>
<ul>
<li>SELECT結果を格納</li>
</ul><pre class="code" data-lang="" data-unlink>hive> FROM zip z INSERT OVERWRITE TABLE ginza_zip SELECT z.zip, z.pref, z.city, z.town WHERE z.ver = '2008-12-26' AND z.town REGEXP '銀座';
Total MapReduce jobs = 2
Launching Job 1 out of 2
Number of reduce tasks is set to 0 since there's no reduce operator
Starting Job = job_201112190030_0004, Tracking URL = http://localhost:50030/jobdetails.jsp?jobid=job_201112190030_0004
Kill Command = /usr/lib/hadoop/bin/hadoop job  -Dmapred.job.tracker=localhost:8021 -kill job_201112190030_0004
2011-12-19 01:36:02,015 Stage-1 map = 0%,  reduce = 0%
2011-12-19 01:36:09,245 Stage-1 map = 100%,  reduce = 0%
2011-12-19 01:36:12,383 Stage-1 map = 100%,  reduce = 100%
Ended Job = job_201112190030_0004
Ended Job = -346086037, job is filtered out (removed at runtime).
Moving data to: hdfs://localhost/tmp/hive-yuta/hive_2011-12-19_01-35-54_464_2238504209915921606/-ext-10000
Loading data to table default.ginza_zip
Deleted hdfs://localhost/user/hive/warehouse/ginza_zip
Table default.ginza_zip stats: [num_partitions: 0, num_files: 1, num_rows: 0, total_size: 636]
20 Rows loaded to ginza_zip
OK
Time taken: 18.43 seconds</pre>
<ul>
<li>データの確認</li>
</ul><pre class="code" data-lang="" data-unlink>hive> SELECT g.* FROM ginza_zip g;
OK
0691331 1   夕張郡長沼町  銀座
3220052 9   鹿沼市 銀座
3600032 11  熊谷市 銀座
3670052 11  本庄市 銀座
1040061 13  中央区 銀座
9300991 16  富山市 新庄銀座
3940022 20  岡谷市 銀座
3940023 20  岡谷市 東銀座
3950031 20  飯田市 銀座
4240817 22  静岡市清水区  銀座
4130013 22  熱海市 銀座町
4140028 22  伊東市 銀座元町
4750874 23  半田市 銀座本町
4480845 23  刈谷市 銀座
5220088 25  彦根市 銀座町
6128089 26  京都市伏見区  銀座町
7450032 35  周南市 銀座
7450033 35  周南市 みなみ銀座
7700916 36  徳島市 銀座
8040076 40  北九州市戸畑区 銀座
Time taken: 0.257 seconds</pre>
</div>
<div class="section">
<h5><a class="keyword" href="http://d.hatena.ne.jp/keyword/HDFS">HDFS</a>に結果を保存</h5>

<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/HDFS">HDFS</a>に保存</li>
</ul><pre class="code" data-lang="" data-unlink>hive> FROM zip z INSERT OVERWRITE DIRECTORY '/user/yuta/ginza'  SELECT z.zip, z.pref, z.city, z.town WHERE z.ver = '2008-12-26' AND z.town REGEXP '銀座';
Total MapReduce jobs = 2
Launching Job 1 out of 2
Number of reduce tasks is set to 0 since there's no reduce operator
Starting Job = job_201112190030_0005, Tracking URL = http://localhost:50030/jobdetails.jsp?jobid=job_201112190030_0005
Kill Command = /usr/lib/hadoop/bin/hadoop job  -Dmapred.job.tracker=localhost:8021 -kill job_201112190030_0005
2011-12-19 01:45:36,429 Stage-1 map = 0%,  reduce = 0%
2011-12-19 01:45:43,743 Stage-1 map = 100%,  reduce = 0%
2011-12-19 01:45:47,863 Stage-1 map = 100%,  reduce = 100%
Ended Job = job_201112190030_0005
Ended Job = 897426408, job is filtered out (removed at runtime).
Moving data to: hdfs://localhost/tmp/hive-yuta/hive_2011-12-19_01-45-24_734_5088617359163695965/-ext-10000
Moving data to: /user/yuta/ginza
20 Rows loaded to /user/yuta/ginza
OK
Time taken: 23.314 seconds</pre>
<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/HDFS">HDFS</a>上の結果を確認</li>
</ul><pre class="code" data-lang="" data-unlink>$ hdfs -ls /user/yuta/ginza
Found 1 items
-rw-r--r--   1 yuta supergroup        636 2011-12-19 01:45 /user/yuta/ginza/000000_0

$ hdfs -cat /user/yuta/ginza/000000_0
06913311夕張郡長沼町銀座
32200529鹿沼市銀座
360003211熊谷市銀座
367005211本庄市銀座
104006113中央区銀座
930099116富山市新庄銀座
394002220岡谷市銀座
394002320岡谷市東銀座
395003120飯田市銀座
424081722静岡市清水区銀座
413001322熱海市銀座町
414002822伊東市銀座元町
475087423半田市銀座本町
448084523刈谷市銀座
522008825彦根市銀座町
612808926京都市伏見区銀座町
745003235周南市銀座
745003335周南市みなみ銀座
770091636徳島市銀座
804007640北九州市戸畑区銀座</pre>
</div>
<div class="section">
<h5>ローカルファイルとして保存</h5>

<ul>
<li>ローカルファイルに保存</li>
</ul><pre class="code" data-lang="" data-unlink>hive> FROM zip z INSERT OVERWRITE LOCAL DIRECTORY '/home/yuta/work/dev/hadoop/hive/localfiles/ginza'  SELECT z.zip, z.pref, z.city, z.town WHERE z.ver = '2008-12-26' AND z.town REGEXP '銀座';
Total MapReduce jobs = 1
Launching Job 1 out of 1
Number of reduce tasks is set to 0 since there's no reduce operator
Starting Job = job_201112190030_0006, Tracking URL = http://localhost:50030/jobdetails.jsp?jobid=job_201112190030_0006
Kill Command = /usr/lib/hadoop/bin/hadoop job  -Dmapred.job.tracker=localhost:8021 -kill job_201112190030_0006
2011-12-19 01:51:56,101 Stage-1 map = 0%,  reduce = 0%
2011-12-19 01:52:03,369 Stage-1 map = 100%,  reduce = 0%
2011-12-19 01:52:08,816 Stage-1 map = 100%,  reduce = 100%
Ended Job = job_201112190030_0006
Copying data to local directory /home/yuta/work/dev/hadoop/hive/localfiles/ginza
Copying data to local directory /home/yuta/work/dev/hadoop/hive/localfiles/ginza
20 Rows loaded to /home/yuta/work/dev/hadoop/hive/localfiles/ginza
OK
Time taken: 19.987 seconds</pre>
<ul>
<li>保存したファイルの確認</li>
</ul><pre class="code" data-lang="" data-unlink>$ cat /home/yuta/work/dev/hadoop/hive/localfiles/ginza/000000_0 
06913311夕張郡長沼町銀座
32200529鹿沼市銀座
360003211熊谷市銀座
367005211本庄市銀座
104006113中央区銀座
930099116富山市新庄銀座
394002220岡谷市銀座
394002320岡谷市東銀座
395003120飯田市銀座
424081722静岡市清水区銀座
413001322熱海市銀座町
414002822伊東市銀座元町
475087423半田市銀座本町
448084523刈谷市銀座
522008825彦根市銀座町
612808926京都市伏見区銀座町
745003235周南市銀座
745003335周南市みなみ銀座
770091636徳島市銀座
804007640北九州市戸畑区銀座</pre>
</div>
</blockquote>

</div>
<div class="section">
<h4><span class="deco" style="font-weight:bold;font-size:large;">まとめ</span></h4>

<blockquote>
    
<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/RDB">RDB</a>のように<a class="keyword" href="http://d.hatena.ne.jp/keyword/MapReduce">MapReduce</a>をQLで操作できるのは魅力。(<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D7%A5%ED%A5%B0%A5%E9%A5%DF%A5%F3%A5%B0%B8%C0%B8%EC">プログラミング言語</a>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/MapReduce">MapReduce</a>を書く必要がない。)</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/MapReduce">MapReduce</a>した結果を<a class="keyword" href="http://d.hatena.ne.jp/keyword/HDFS">HDFS</a>やローカルファイルに落とす等比較的柔軟に利用ができる。</li>
<li>今回は1台でしか試していないが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%A3%BF%F4">複数</a>サーバに分散させた時の効果もちゃんと測定する必要がある。</li>
<li>hiveという単語で検索しても日本語のドキュメントが多く存在しないので、導入はこれからという感じか。</li>
</ul>
</blockquote>

</div>
<div class="section">
<h4><span class="deco" style="font-weight:bold;font-size:large;">リンク</span></h4>

<blockquote>
    
<ul>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/Home">Apache Hive</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/GettingStarted">GettingStarted</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/Tutorial">Tutorial</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual">LanguageManual</a></li>
<li><a href="http://www.atmarkit.co.jp/fdb/single/s_hive/hive_01.html">Hadoop＋Hive検証環境を構築してみる</a></li>
<li><a href="http://ameblo.jp/principia-ca/entry-10635727790.html">Hadoop/Hiveを用いたログ解析基盤の構築</a></li>
<li><a href="http://www.atmarkit.co.jp/fjava/special/cloudera/01.html">次世代Hadoopの特徴は、MapReduce 2とGiraph</a></li>
<li><a href="http://www.larsgeorge.com/2009/10/hive-vs-pig.html:Hive-vs-Pig">http://www.larsgeorge.com/2009/10/hive-vs-pig.html:Hive-vs-Pig</a></li>
</ul>
</blockquote>

</div>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://yutakikuchi.github.io/blog/post/201112121517/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://yutakikuchi.github.io/blog/post/201112121517/">NLP(自然言語処理)用語まとめ</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://yutakikuchi.github.io/blog/post/201112231435/">Introduction to Computational Advertising - Stanford大学資料から学ぶオンライン広告知識</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://yutakikuchi.github.io/blog/post/201112231435/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>

</div>
</div>
<script src="https://yutakikuchi.github.io/blog/js/ui.js"></script>
<script src="https://yutakikuchi.github.io/blog/js/menus.js"></script>


<script>
  
  if (window.location.hostname != "localhost") {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-20616165-3', 'auto');
    ga('send', 'pageview');
  }
</script>





</body>
</html>

