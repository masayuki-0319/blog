<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <link rel="canonical" href="http://yut.hatenablog.com/entry/20130520/1369006349" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.55.4" />

  <title>10分でFuelPHPの基礎を理解する &middot; Y&#39;s note</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://yutakikuchi.github.io/blog/img/favicon.ico" type="image/x-icon" />

  
    
        <link rel="stylesheet" href="https://yutakikuchi.github.io/blog/css/my.css">
    
  
  
    
        <script src="https://yutakikuchi.github.io/blog/js/my.js"></script>
    
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://yutakikuchi.github.io/blog/">Y's note</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://yutakikuchi.github.io/blog/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/yutakikuchi_" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://facebook.com/yuta.kikuchi.007" target="_blank"><i class="fa fa-facebook-square fa-fw"></i>Facebook</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="http://slideshare.net/https://www.slideshare.net/yutakikuchi58/" target="_blank"><i class="fa fa-slideshare fa-fw"></i>SlideShare</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/https://www.linkedin.com/in/%E4%BD%91%E5%A4%AA-%E8%8F%8A%E6%B1%A0-36291a44/" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/yutakikuchi" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2019. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>10分でFuelPHPの基礎を理解する</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2013 May 20, 08:32</time>
  </div>

  

  

  

</div>

  

<h2 id="php-10分でfuelphpの基礎を理解する">[PHP] : 10分でFuelPHPの基礎を理解する</h2>

<p><div class="amazlet-box"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4881669419/yutakikuchi-22/"><img src="http://ecx.images-amazon.com/images/I/511wN5khDHL._SL160_.jpg" class="hatena-asin-detail-image" alt="FuelPHP入門" title="FuelPHP入門"></a><div class="hatena-asin-detail-info"><p class="hatena-asin-detail-title"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4881669419/yutakikuchi-22/">FuelPHP入門</a></p><ul><li><span class="hatena-asin-detail-label">作者:</span> 早川聖司</li><li><span class="hatena-asin-detail-label">出版社/メーカー:</span> <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%C6%A5%C3%A5%AF%BC%D2">ソーテック社</a></li><li><span class="hatena-asin-detail-label">発売日:</span> 2012/06/02</li><li><span class="hatena-asin-detail-label">メディア:</span> 単行本</li><li><span class="hatena-asin-detail-label">購入</span>: 10人 <span class="hatena-asin-detail-label">クリック</span>: 192回</li><li><a href="http://d.hatena.ne.jp/asin/4881669419/yutakikuchi-22" target="_blank">この商品を含むブログ (9件) を見る</a></li></ul></div><div class="hatena-asin-detail-foot"></div></div></p>

<div class="section">
<h4>様々な技術を求められる開発現場</h4>

<blockquote>
    <p><a href="http://d.hatena.ne.jp/yutakikuchi/20130507/1367863440">じゃあ、いつRails始めるの？... 今でしょ！ - Yuta.Kikuchiの日記</a> <a href="http://b.hatena.ne.jp/entry/d.hatena.ne.jp/yutakikuchi/20130507/1367863440"><img src="http://b.hatena.ne.jp/entry/image/http://d.hatena.ne.jp/yutakikuchi/20130507/1367863440" alt="はてなブックマーク - じゃあ、いつRails始めるの？... 今でしょ！ - Yuta.Kikuchiの日記" border="0" /></a><br />
様々な開発現場でそこに必要な技術を求められていて四苦八苦中の<a href='https://twitter.com/'>@yutakikuc</a>です。ついこの前<a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>のエントリーを書いたばかりなのに今度は<a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a>について調べなければいけなかったり...僕の体はいつ休まるんだろうか。<a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a>も<a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>と似ているところが多いので<a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>を学習した記憶が新しいうちに<a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a>について学んだことをどんどん書いていこうと思います。<a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>に比べると少し設定が面倒なんで、ハマった方の少しでも参考になればと思います。</p>

</blockquote>

</div>
<div class="section">
<h4>Index</h4>

<blockquote>
    
<ol>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a> Setting
<ol>
<li>Nginx WebServer</li>
<li>oil Install / oil create</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Error">Error</a> - date_default_timezone_get()</li>
<li>DB設定</li>
<li>Scaffoldで雛形を作る</li>
<li>Routingの設定</li>
<li>Crypt Key <a class="keyword" href="http://d.hatena.ne.jp/keyword/Error">Error</a></li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a>に接続</li>
</ol></li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a>
<ol>
<li>Coreのライブラリのautoload</li>
<li>Controller</li>
<li>Model</li>
<li>View</li>
<li>Security/htmlentities</li>
</ol></li>
</ol>
</blockquote>

</div>
<div class="section">
<h4><a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a> Setting</h4>

<blockquote>
    
<div class="section">
<h5>Nginx WebServer</h5>
<p><a href="http://d.hatena.ne.jp/yutakikuchi/20130220/1361316293">CentOSでNginxのログをFluentdを使ってMongodbにリアルタイムで格納する - Yuta.Kikuchiの日記</a> <a href="http://b.hatena.ne.jp/entry/d.hatena.ne.jp/yutakikuchi/20130220/1361316293"><img src="http://b.hatena.ne.jp/entry/image/http://d.hatena.ne.jp/yutakikuchi/20130220/1361316293" alt="はてなブックマーク - CentOSでNginxのログをFluentdを使ってMongodbにリアルタイムで格納する - Yuta.Kikuchiの日記" border="0" /></a><br />
<a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a>を動かす環境をNginxを利用します。<a class="keyword" href="http://d.hatena.ne.jp/keyword/CentOS">CentOS</a>でのNginxの設定は上のエントリーを確認しながらやってみてください。ここではProcessが立ち上がっていることの確認と<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-fpmの<a class="keyword" href="http://d.hatena.ne.jp/keyword/CGI">CGI</a>設定について記述します。プロセスの確認はpsコマンドで、<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-fpmはWebで<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>を利用するための<a class="keyword" href="http://d.hatena.ne.jp/keyword/CGI">CGI</a>パッケージで<a class="keyword" href="http://d.hatena.ne.jp/keyword/yum">yum</a>にて最初にinstallしておくと良いでしょう。<br />
先にエントリポイントについて少し説明をしていおくとnginxの設定でrootを/usr/share/nginx/html/fuel_sample/publicとし、fuelのエントリポイントとなるパスを指定します。fuel_sampleは後で定義するプロジェクト名です。/usr/share/nginx/html/fuel_sample/public直下に<a class="keyword" href="http://d.hatena.ne.jp/keyword/.htaccess">.htaccess</a>ファイルが生成されそちらでも<a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>の設定が編集できますが、今回はnginx側で全て対応させます。<br />
<a class="keyword" href="http://d.hatena.ne.jp/keyword/fastcgi">fastcgi</a>_param  FUEL_ENV  development;の箇所でFuelの環境に合わせた設定変更ができます。FUEL_ENVをアプリケーション側が自動で読み込んで、fuel/app/config/<FUEL_ENV>/config.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>のような設定ファイルを切り替えます。設定を変更したらnginx/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-fpmの両方を再起動します。またnginx/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-fpm/mysqldを全て<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BC%AB%C6%B0%B5%AF%C6%B0">自動起動</a>設定を入れておきます。</p>
<pre class="code" data-lang="" data-unlink>$ /usr/share/nginx# ps auxw | grep nginx
root      1879  0.0  0.0  44688   848 ?        Ss   01:05   0:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf
nginx     1881  0.0  0.1  45096  1548 ?        S    01:05   0:00 nginx: worker process     </pre><pre class="code" data-lang="" data-unlink>$ sudo yum install php-fpm -y
$ sudo vim /etc/nginx/conf.d/default.conf</pre><pre class="code" data-lang="" data-unlink>server {
listen       80;
server_name  localhost;

root   /usr/share/nginx/html/fuel_sample/public;
index index.php;
location / {
    try_files $uri /index.php?$uri&$args;
}

error_page   500 502 503 504  /50x.html;
location = /50x.html {
    root   /usr/share/nginx/html;
}

location ~ \.php$ {
    fastcgi_pass   127.0.0.1:9000;
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
    fastcgi_param  FUEL_ENV  development;
    include        fastcgi_params;
}
}</pre><pre class="code" data-lang="" data-unlink>$ sudo vim /etc/php-fpm.d/www.conf</pre><pre class="code" data-lang="" data-unlink>; user,groupをapacheからnginxに変更
; RPM: apache Choosed to be able to access some dir as httpd
user = nginx 
; RPM: Keep a group allowed to write in log dir.
group = nginx</pre><pre class="code" data-lang="" data-unlink>$ sudo /etc/init.d/nginx restart
nginx を停止中:                                            [  OK  ]
nginx を起動中:                                            [  OK  ]

$ sudo /etc/init.d/php-fpm restart 
php-fpm を停止中:                                          [  OK  ]
php-fpm を起動中:                                          [  OK  ]

$ sudo /sbin/chkconfig nginx on
$ sudo /sbin/chkconfig php-fpm on
$ sudo /sbin/chkconfig mysqld on</pre>
</div>
<div class="section">
<h5>oil Install / oil create</h5>
<p>gitをinstallしておきます。<a class="keyword" href="http://d.hatena.ne.jp/keyword/Centos">Centos</a>のgit-install時にPackageの依存関係のエラーがでるので--disablerepo=epelのオプションを指定してinstallします。その次にoilコマンドをダウンロードします。oilは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>で言うrakeコマンドのようなものです。Projectを作成したりModel/View/Controllerを生成したり、Scaffoldができたり、DBMigrationができます。oilのダウンロードが完了したらoil create でfuel_sampleというProjectを作成します。NginxのDocumentRootはDefaultでは/usr/share/nginx/html</p>
<pre class="code" data-lang="" data-unlink>$ sudo yum install git --disablerepo=epel -y
$ curl get.fuelphp.com/oil | sh
$ cd /usr/share/nginx/html
$ sudo oil create fuel_sample</pre>
</div>
<div class="section">
<h5><a class="keyword" href="http://d.hatena.ne.jp/keyword/Error">Error</a> - date_default_timezone_get()</h5>
<p>/etc/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.iniでdefaultのtimezoneが指定されていない場合は修正します。</p>
<pre class="hljs php" data-lang="php" data-unlink>[Date]
; Defines the default timezone used by the date functions
; http://www.php.net/manual/en/datetime.configuration.php#ini.date.timezone
;date.timezone =
date.timezone = "Asia/Tokyo"
</pre>
</div>
<div class="section">
<h5>DB設定</h5>
<p>fuel_sample/fuel/app/config/<env>/db.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>として生成されているdbの設定ファイルを修正します。接続username、passwordを自分の環境に合わせて適宜設定をする必要があります。FuelはORMというDB接続クラスを用意しているのでORMを使えるようにcoreのconfig.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>をormをコメントインします。またoil refineコマンドでmigrationをしようとすると<a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>が出てしまうので、先に環境に合わせたdbをcreateしておきます。ここでは開発環境のdevelopmentの説明を前提に記述します。<br />
fuel_sample/fuel/app/config/development/db.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a></p>
<pre class="hljs php" data-lang="php" data-unlink><span class="synSpecial"><?php</span>
<span class="synComment">/**</span>
<span class="synComment"> * The development database settings. These get merged with the global settings.</span>
<span class="synComment"> */</span>

<span class="synStatement">return</span> <span class="synType">array</span><span class="synSpecial">(</span>
    '<span class="synConstant">default</span>' <span class="synStatement">=></span> <span class="synType">array</span><span class="synSpecial">(</span>
            '<span class="synConstant">connection</span>'  <span class="synStatement">=></span> <span class="synType">array</span><span class="synSpecial">(</span>
                    '<span class="synConstant">dsn</span>'        <span class="synStatement">=></span> '<span class="synConstant">mysql:host=localhost;dbname=fuel_dev</span>',
                    '<span class="synConstant">username</span>'   <span class="synStatement">=></span> '<span class="synConstant">root</span>',
                    '<span class="synConstant">password</span>'   <span class="synStatement">=></span> '',
            <span class="synSpecial">)</span>,
    <span class="synSpecial">)</span>,
<span class="synSpecial">)</span>;
</pre><p>fuel_sample/fuel/core/config/config.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a></p>
<pre class="hljs php" data-lang="php" data-unlink><span class="synSpecial"><?php</span>

    <span class="synComment">/**************************************************************************/</span>
    <span class="synComment">/* Always Load                                                            */</span>
    <span class="synComment">/**************************************************************************/</span>
    '<span class="synConstant">always_load</span>'  <span class="synStatement">=></span> <span class="synType">array</span><span class="synSpecial">(</span>

            <span class="synComment">/**</span>
<span class="synComment">                 * These packages are loaded on Fuel's startup.</span>
<span class="synComment">                 * You can specify them in the following manner:</span>
<span class="synComment">                 *</span>
<span class="synComment">                 * array('auth'); // This will assume the packages are in PKGPATH</span>
<span class="synComment">                 *</span>
<span class="synComment">                 * // Use this format to specify the path to the package explicitly</span>
<span class="synComment">                 * array(</span>
<span class="synComment">                 *     array('auth'     => PKGPATH.'auth/')</span>
<span class="synComment">                 * );</span>
<span class="synComment">                 */</span>
            '<span class="synConstant">packages</span>'  <span class="synStatement">=></span> <span class="synType">array</span><span class="synSpecial">(</span>
                    '<span class="synConstant">orm</span>',
            <span class="synSpecial">)</span>,
</pre><pre class="hljs sql" data-lang="sql" data-unlink>mysql> <span class="synStatement">create</span> database fuel_dev;
Query OK, <span class="synConstant">1</span> <span class="synSpecial">row</span> affected (<span class="synConstant">0</span>.<span class="synConstant">00</span> sec)
</pre>
</div>
<div class="section">
<h5>Scaffoldで雛形を作る</h5>
<p>今回はnoteを作成/編集/詳細表示/一覧表示することを考えます。Scaffoldでは特定のURL/Directoryのルールに従ってコードを自動生成してくれます。noteで扱うデータはtitle/descriptionの2種類を定義します。oil generate sfaffold module <DB columname> : <datatype>のような文法です。生成される名前のルールとしてDBはnotesのような名詞の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%A3%BF%F4">複数</a>形になります。</p>
<pre class="code" data-lang="" data-unlink>$ sudo oil generate scaffold note title:varchar[255] description:text
Creating migration: /usr/share/nginx/html/fuel_sample/fuel/app/migrations/001_create_notes.php
Creating model: /usr/share/nginx/html/fuel_sample/fuel/app/classes/model/note.php
Creating controller: /usr/share/nginx/html/fuel_sample/fuel/app/classes/controller/note.php
Creating view: /usr/share/nginx/html/fuel_sample/fuel/app/views/note/index.php
Creating view: /usr/share/nginx/html/fuel_sample/fuel/app/views/note/view.php
Creating view: /usr/share/nginx/html/fuel_sample/fuel/app/views/note/create.php
Creating view: /usr/share/nginx/html/fuel_sample/fuel/app/views/note/edit.php
Creating view: /usr/share/nginx/html/fuel_sample/fuel/app/views/note/_form.php
Creating view: /usr/share/nginx/html/fuel_sample/fuel/app/views/template.php</pre><p>migraionファイルはDBの初期設定を行うためのものです。oil refine migrateでDBの設定を行います。念のためmigraionファイルがどのようなものかを確認します。またoil refine migrateを行った後はDBのtableが作成されたかどうかを見ます。<br />
fuel_sample/fuel/app/migrations/001_create_notes.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a></p>
<pre class="hljs php" data-lang="php" data-unlink><span class="synSpecial"><?php</span>

<span class="synType">namespace</span> Fuel\Migrations;

<span class="synType">class</span> Create_notes
<span class="synSpecial">{</span>
<span class="synType">public</span> <span class="synPreProc">function</span> up<span class="synSpecial">()</span>
<span class="synSpecial">{</span>
    \DBUtil<span class="synStatement">::</span>create_table<span class="synSpecial">(</span>'<span class="synConstant">notes</span>', <span class="synType">array</span><span class="synSpecial">(</span>
        '<span class="synConstant">id</span>' <span class="synStatement">=></span> <span class="synType">array</span><span class="synSpecial">(</span>'<span class="synConstant">constraint</span>' <span class="synStatement">=></span> <span class="synConstant">11</span>, '<span class="synConstant">type</span>' <span class="synStatement">=></span> '<span class="synConstant">int</span>', '<span class="synConstant">auto_increment</span>' <span class="synStatement">=></span> <span class="synConstant">true</span>, '<span class="synConstant">unsigned</span>' <span class="synStatement">=></span> <span class="synConstant">true</span><span class="synSpecial">)</span>,
        '<span class="synConstant">title</span>' <span class="synStatement">=></span> <span class="synType">array</span><span class="synSpecial">(</span>'<span class="synConstant">constraint</span>' <span class="synStatement">=></span> <span class="synConstant">255</span>, '<span class="synConstant">type</span>' <span class="synStatement">=></span> '<span class="synConstant">varchar</span>'<span class="synSpecial">)</span>,
        '<span class="synConstant">description</span>' <span class="synStatement">=></span> <span class="synType">array</span><span class="synSpecial">(</span>'<span class="synConstant">type</span>' <span class="synStatement">=></span> '<span class="synConstant">text</span>'<span class="synSpecial">)</span>,
        '<span class="synConstant">created_at</span>' <span class="synStatement">=></span> <span class="synType">array</span><span class="synSpecial">(</span>'<span class="synConstant">constraint</span>' <span class="synStatement">=></span> <span class="synConstant">11</span>, '<span class="synConstant">type</span>' <span class="synStatement">=></span> '<span class="synConstant">int</span>', '<span class="synConstant">null</span>' <span class="synStatement">=></span> <span class="synConstant">true</span><span class="synSpecial">)</span>,
        '<span class="synConstant">updated_at</span>' <span class="synStatement">=></span> <span class="synType">array</span><span class="synSpecial">(</span>'<span class="synConstant">constraint</span>' <span class="synStatement">=></span> <span class="synConstant">11</span>, '<span class="synConstant">type</span>' <span class="synStatement">=></span> '<span class="synConstant">int</span>', '<span class="synConstant">null</span>' <span class="synStatement">=></span> <span class="synConstant">true</span><span class="synSpecial">)</span>,

    <span class="synSpecial">)</span>, <span class="synType">array</span><span class="synSpecial">(</span>'<span class="synConstant">id</span>'<span class="synSpecial">))</span>;
<span class="synSpecial">}</span>

<span class="synType">public</span> <span class="synPreProc">function</span> down<span class="synSpecial">()</span>
<span class="synSpecial">{</span>
    \DBUtil<span class="synStatement">::</span>drop_table<span class="synSpecial">(</span>'<span class="synConstant">notes</span>'<span class="synSpecial">)</span>;
<span class="synSpecial">}</span>
<span class="synSpecial">}</span>
</pre><pre class="code" data-lang="" data-unlink>$ sudo oil refine migrate
Performed migrations for app:default:
001_create_notes

$ mysql -u root -p
mysql> use fuel_dev;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> show tables;
+--------------------+
| Tables_in_fuel_dev |
+--------------------+
| migration          |
| notes              |
+--------------------+
2 rows in set (0.00 sec)

mysql> show create table notes;
+-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                                                                                                                                                                                |
+-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| notes | CREATE TABLE `notes` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `title` varchar(255) NOT NULL,
  `description` text NOT NULL,
  `created_at` int(11) DEFAULT NULL,
  `updated_at` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 |
+-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)</pre><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Mysql">Mysql</a>の設定にもよりますがmigrationを実行すると残念ながらDefaultではENGINE = <a class="keyword" href="http://d.hatena.ne.jp/keyword/MyISAM">MyISAM</a>として設定されてしまうようです。migraionファイルを修正することによってENGINEやCHASETを自由に書き換えることができます。下はmigrationファイルから呼び出しているDBUtilクラスのcreate_table<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>です。５/6番目の引数でENGINEとCHARSETが指定出来ます。<br />
fuel_sample/fuel/core/classes/dbutil.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a></p>
<pre class="hljs php" data-lang="php" data-unlink><span class="synSpecial"><?php</span>

<span class="synComment">/**     * Creates a table.</span>
<span class="synComment">     *</span>
<span class="synComment">     * @throws   \Database_Exception</span>
<span class="synComment">     * @param    string    $table          the table name</span>
<span class="synComment">     * @param    array     $fields         the fields array</span>
<span class="synComment">     * @param    array     $primary_keys   an array of primary keys</span>
<span class="synComment">     * @param    boolean   $if_not_exists  whether to add an IF NOT EXISTS statement.     * @param    string    $engine         storage engine overwrite</span>
<span class="synComment">     * @param    string    $charset        default charset overwrite</span>
<span class="synComment">     * @param    array     $foreign_keys   an array of foreign keys</span>
<span class="synComment">     * @return   int       number of affected rows.</span>
<span class="synComment">     */</span>
<span class="synType">public</span> <span class="synType">static</span> <span class="synPreProc">function</span> create_table<span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">table</span>, <span class="synStatement">$</span><span class="synIdentifier">fields</span>, <span class="synStatement">$</span><span class="synIdentifier">primary_keys</span> <span class="synStatement">=</span> <span class="synType">array</span><span class="synSpecial">()</span>, <span class="synStatement">$</span><span class="synIdentifier">if_not_exists</span> <span class="synStatement">=</span> <span class="synConstant">true</span>, <span class="synStatement">$</span><span class="synIdentifier">engine</span> <span class="synStatement">=</span> <span class="synConstant">false</span>, <span class="synStatement">$</span><span class="synIdentifier">c</span>
harset <span class="synStatement">=</span> <span class="synType">null</span>, <span class="synStatement">$</span><span class="synIdentifier">foreign_keys</span> <span class="synStatement">=</span> <span class="synType">array</span><span class="synSpecial">()</span>, <span class="synStatement">$</span><span class="synIdentifier">db</span> <span class="synStatement">=</span> <span class="synType">null</span><span class="synSpecial">)</span> 
</pre>
</div>
<div class="section">
<h5>Routingの設定</h5>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/URI">URI</a>の規則で重要な役割を果たしているのがroutes.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>です。ここでアクセスした<a class="keyword" href="http://d.hatena.ne.jp/keyword/URI">URI</a>と呼び出したいControllerと<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>を指定することができます。_root_はBaseURIになります。下の例でいうと<a href="http://localhost/hello">http://localhost/hello</a>にアクセスすると内部的には<a href="http://localhost/welcome/hello">http://localhost/welcome/hello</a>を呼び出していることになります。</p>
<pre class="hljs php" data-lang="php" data-unlink><span class="synSpecial"><?php</span>
<span class="synStatement">return</span> <span class="synType">array</span><span class="synSpecial">(</span>
'<span class="synConstant">_root_</span>'  <span class="synStatement">=></span> '<span class="synConstant">welcome/index</span>',  <span class="synComment">// The default route</span>
'<span class="synConstant">_404_</span>'   <span class="synStatement">=></span> '<span class="synConstant">welcome/404</span>',    <span class="synComment">// The main 404 route</span>

'<span class="synConstant">hello(/:name)?</span>' <span class="synStatement">=></span> <span class="synType">array</span><span class="synSpecial">(</span>'<span class="synConstant">welcome/hello</span>', '<span class="synConstant">name</span>' <span class="synStatement">=></span> '<span class="synConstant">hello</span>'<span class="synSpecial">)</span>,
<span class="synSpecial">)</span>;
</pre>
</div>
<div class="section">
<h5>Crypt Key <a class="keyword" href="http://d.hatena.ne.jp/keyword/Error">Error</a></h5>
<p><span itemscope itemtype="http://schema.org/Photograph"><a href="http://f.hatena.ne.jp/yutakikuchi/20130518161702" class="hatena-fotolife" itemprop="url"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/y/yutakikuchi/20130518/20130518161702.png" alt="f:id:yutakikuchi:20130518161702p:image:w360" title="f:id:yutakikuchi:20130518161702p:image:w360" class="hatena-fotolife" style="width:360px" itemprop="image"></a></span><br />
ここまで設定できたらScaffoldで作成されたnoteにアクセスしてみます。<a href="http://localhost/note/create">http://localhost/note/create</a>にアクセスすると、Crypt Key <a class="keyword" href="http://d.hatena.ne.jp/keyword/Error">Error</a>という画面が出てしまいます。暗証Keyをどうやら手動で設定する必要があるようです。画面に出力された<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>コードをconfig直下に配置します。<br />
fuel_sample/fuel/app/config/crypt.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a></p>
<pre class="hljs php" data-lang="php" data-unlink><span class="synSpecial"><?php</span>
<span class="synComment">/**</span>
<span class="synComment"> * Part of the Fuel framework.</span>
<span class="synComment"> *</span>
<span class="synComment"> * @package     Fuel</span>
<span class="synComment"> * @version     1.6</span>
<span class="synComment"> * @author      Fuel Development Team</span>
<span class="synComment"> * @license     MIT License</span>
<span class="synComment"> * @copyright   2010 - 2013 Fuel Development Team</span>
<span class="synComment"> * @link        http://fuelphp.com</span>
<span class="synComment"> */</span>

<span class="synStatement">return</span> <span class="synType">array</span> <span class="synSpecial">(</span>
'<span class="synConstant">crypto_key</span>' <span class="synStatement">=></span> '<span class="synConstant">Leg2Qg73448k594xBob-s-wc</span>',
'<span class="synConstant">crypto_iv</span>' <span class="synStatement">=></span> '<span class="synConstant">j2w-MchSEx7IZUES3QBfkKAQ</span>',
'<span class="synConstant">crypto_hmac</span>' <span class="synStatement">=></span> '<span class="synConstant">KUQ9hEL6wLsMw1MMKIqDAJ_U</span>',
<span class="synSpecial">)</span>;
</pre>
</div>
<div class="section">
<h5><a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a>に接続</h5>
<p><a href="http://localhost/note/create">http://localhost/note/create</a>に再度アクセスをすると以下の様な画面が出力されると思います。<a class="keyword" href="http://d.hatena.ne.jp/keyword/URI">URI</a>の規則は呼び出したいController名/<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>名という感じになります。ここではnote/createとするとnoteを入力する画面が表示されます。これでNginx上でのFuel設定は完了です。<br />
<span itemscope itemtype="http://schema.org/Photograph"><a href="http://f.hatena.ne.jp/yutakikuchi/20130518161703" class="hatena-fotolife" itemprop="url"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/y/yutakikuchi/20130518/20130518161703.png" alt="f:id:yutakikuchi:20130518161703p:image:w360" title="f:id:yutakikuchi:20130518161703p:image:w360" class="hatena-fotolife" style="width:360px" itemprop="image"></a></span></p>

</div>
</blockquote>

</div>
<div class="section">
<h4><a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a></h4>

<blockquote>
    <p>以下ではscaffoldされたnoteの<a class="keyword" href="http://d.hatena.ne.jp/keyword/MVC">MVC</a>を例に<a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a>の内部構造を少し説明しようと思います。</p>

<div class="section">
<h5>Coreのライブラリのautoload</h5>
<p>fuel/core/classes以下に様々なライブラリがoilでcreateされます。createされたclassesはautoloadされます。autoloadしているファイルはfuel/core/bootstrap.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>のsetup_autoloader()<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>になります。このautoload機能により様々なファイルで利用されているSession、Input、Viewクラスなどが利用できる事になります。</p>
<pre class="code" data-lang="" data-unlink>/usr/share/nginx/html/fuel_sample/fuel/core/classes# tree
├── agent.php
├── arr.php
├── asset
│&#160;&#160; └── instance.php
├── asset.php
├── autoloader.php
├── cache
│&#160;&#160; ├── handler
│&#160;&#160; │&#160;&#160; ├── driver.php
│&#160;&#160; │&#160;&#160; ├── json.php
│&#160;&#160; │&#160;&#160; ├── serialized.php
│&#160;&#160; │&#160;&#160; └── string.php
│&#160;&#160; ├── notfound.php
│&#160;&#160; └── storage
│&#160;&#160;     ├── apc.php
│&#160;&#160;     ├── driver.php
│&#160;&#160;     ├── file.php
│&#160;&#160;     ├── memcached.php
│&#160;&#160;     └── redis.php
├── cache.php
├── cli.php
├── config
│&#160;&#160; ├── file.php
│&#160;&#160; ├── ini.php
│&#160;&#160; ├── interface.php
│&#160;&#160; ├── json.php
│&#160;&#160; ├── php.php
│&#160;&#160; └── yml.php
├── config.php
├── controller
│&#160;&#160; ├── hybrid.php
│&#160;&#160; ├── rest.php
│&#160;&#160; └── template.php
├── controller.php
├── cookie.php
├── crypt.php</pre><p>fuel/core/bootstrap.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a></p>
<pre class="hljs php" data-lang="php" data-unlink><span class="synSpecial"><?php</span>

<span class="synPreProc">function</span> setup_autoloader<span class="synSpecial">()</span>
<span class="synSpecial">{</span>
Autoloader<span class="synStatement">::</span>add_namespace<span class="synSpecial">(</span>'<span class="synConstant">Fuel</span><span class="synSpecial">\\</span><span class="synConstant">Core</span>', COREPATH<span class="synStatement">.</span>'<span class="synConstant">classes/</span>'<span class="synSpecial">)</span>;

Autoloader<span class="synStatement">::</span>add_namespace<span class="synSpecial">(</span>'<span class="synConstant">PHPSecLib</span>', COREPATH<span class="synStatement">.</span>'<span class="synConstant">vendor</span>'<span class="synStatement">.</span>DS<span class="synStatement">.</span>'<span class="synConstant">phpseclib</span>'<span class="synStatement">.</span>DS, <span class="synConstant">true</span><span class="synSpecial">)</span>;

Autoloader<span class="synStatement">::</span>add_classes<span class="synSpecial">(</span><span class="synType">array</span><span class="synSpecial">(</span>
    '<span class="synConstant">Fuel</span><span class="synSpecial">\\</span><span class="synConstant">Core</span><span class="synSpecial">\\</span><span class="synConstant">Agent</span>'           <span class="synStatement">=></span> COREPATH<span class="synStatement">.</span>'<span class="synConstant">classes/agent.php</span>',

    '<span class="synConstant">Fuel</span><span class="synSpecial">\\</span><span class="synConstant">Core</span><span class="synSpecial">\\</span><span class="synConstant">Arr</span>'             <span class="synStatement">=></span> COREPATH<span class="synStatement">.</span>'<span class="synConstant">classes/arr.php</span>',

    '<span class="synConstant">Fuel</span><span class="synSpecial">\\</span><span class="synConstant">Core</span><span class="synSpecial">\\</span><span class="synConstant">Asset</span>'           <span class="synStatement">=></span> COREPATH<span class="synStatement">.</span>'<span class="synConstant">classes/asset.php</span>',
    '<span class="synConstant">Fuel</span><span class="synSpecial">\\</span><span class="synConstant">Core</span><span class="synSpecial">\\</span><span class="synConstant">Asset_Instance</span>'  <span class="synStatement">=></span> COREPATH<span class="synStatement">.</span>'<span class="synConstant">classes/asset/instance.php</span>',

    '<span class="synConstant">Fuel</span><span class="synSpecial">\\</span><span class="synConstant">Core</span><span class="synSpecial">\\</span><span class="synConstant">Cache</span>'                     <span class="synStatement">=></span> COREPATH<span class="synStatement">.</span>'<span class="synConstant">classes/cache.php</span>',
    '<span class="synConstant">Fuel</span><span class="synSpecial">\\</span><span class="synConstant">Core</span><span class="synSpecial">\\</span><span class="synConstant">CacheNotFoundException</span>'    <span class="synStatement">=></span> COREPATH<span class="synStatement">.</span>'<span class="synConstant">classes/cache/notfound.php</span>',
    '<span class="synConstant">Fuel</span><span class="synSpecial">\\</span><span class="synConstant">Core</span><span class="synSpecial">\\</span><span class="synConstant">CacheExpiredException</span>'     <span class="synStatement">=></span> COREPATH<span class="synStatement">.</span>'<span class="synConstant">classes/cache.php</span>',
</pre>
</div>
<div class="section">
<h5>Controller</h5>
<p>Fuelの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D3%A5%B8%A5%CD%A5%B9%A5%ED%A5%B8%A5%C3%A5%AF">ビジネスロジック</a>はControllerがメインです。Controllerの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>名はaction_<<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>名>として定義されます。<br />
Controllerの役割は当然Modelとのデータのやり取りとViewへの流しこみを担います。データを保存する流れとしてはModelクラスで定義したValidateを呼び出し、Validate結果が問題なければModelのsave<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>を使ってデータを保存します。<br />
Controller/Viewのルールとして覚えておきたいことは$this->template->content = View::forge('note/index', $data);の箇所でViewに渡すデータの設定を行います。$data[key]は<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CF%A2%C1%DB%C7%DB%CE%F3">連想配列</a>として渡すことによりView側でkey名の変数で呼び出す事が可能です。例えばaction_indexで$data['notes'] = Model_Note::find('all');$this->template->content = View::forge('note/index', $data);されたデータはnote/indexのView側で$notesとして呼び出すことができます。<br />
fuel/app/classes/controller/note.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a></p>
<pre class="hljs php" data-lang="php" data-unlink><span class="synSpecial"><?php</span>
<span class="synType">class</span> Controller_Note <span class="synType">extends</span> Controller_Template<span class="synSpecial">{</span>

<span class="synType">public</span> <span class="synPreProc">function</span> action_index<span class="synSpecial">()</span>
<span class="synSpecial">{</span>
<span class="synStatement">$</span><span class="synIdentifier">data</span><span class="synSpecial">[</span>'<span class="synConstant">notes</span>'<span class="synSpecial">]</span> <span class="synStatement">=</span> Model_Note<span class="synStatement">::</span>find<span class="synSpecial">(</span>'<span class="synConstant">all</span>'<span class="synSpecial">)</span>;
<span class="synStatement">$</span><span class="synIdentifier">this</span><span class="synType">-></span>template<span class="synType">-></span><span class="synIdentifier">title</span> <span class="synStatement">=</span> "<span class="synConstant">Notes</span>";
<span class="synStatement">$</span><span class="synIdentifier">this</span><span class="synType">-></span>template<span class="synType">-></span><span class="synIdentifier">content</span> <span class="synStatement">=</span> View<span class="synStatement">::</span>forge<span class="synSpecial">(</span>'<span class="synConstant">note/index</span>', <span class="synStatement">$</span><span class="synIdentifier">data</span><span class="synSpecial">)</span>;

<span class="synSpecial">}</span>

<span class="synType">public</span> <span class="synPreProc">function</span> action_view<span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">id</span> <span class="synStatement">=</span> <span class="synType">null</span><span class="synSpecial">)</span>
<span class="synSpecial">{</span>
<span class="synIdentifier">is_null</span><span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">id</span><span class="synSpecial">)</span> <span class="synStatement">and</span> Response<span class="synStatement">::</span>redirect<span class="synSpecial">(</span>'<span class="synConstant">note</span>'<span class="synSpecial">)</span>;

<span class="synStatement">if</span> <span class="synSpecial">(</span> <span class="synStatement">!</span> <span class="synStatement">$</span><span class="synIdentifier">data</span><span class="synSpecial">[</span>'<span class="synConstant">note</span>'<span class="synSpecial">]</span> <span class="synStatement">=</span> Model_Note<span class="synStatement">::</span>find<span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">id</span><span class="synSpecial">))</span>
<span class="synSpecial">{</span>
Session<span class="synStatement">::</span>set_flash<span class="synSpecial">(</span>'<span class="synConstant">error</span>', '<span class="synConstant">Could not find note #</span>'<span class="synStatement">.$</span><span class="synIdentifier">id</span><span class="synSpecial">)</span>;
Response<span class="synStatement">::</span>redirect<span class="synSpecial">(</span>'<span class="synConstant">note</span>'<span class="synSpecial">)</span>;
<span class="synSpecial">}</span>

<span class="synStatement">$</span><span class="synIdentifier">this</span><span class="synType">-></span>template<span class="synType">-></span><span class="synIdentifier">title</span> <span class="synStatement">=</span> "<span class="synConstant">Note</span>";
<span class="synStatement">$</span><span class="synIdentifier">this</span><span class="synType">-></span>template<span class="synType">-></span><span class="synIdentifier">content</span> <span class="synStatement">=</span> View<span class="synStatement">::</span>forge<span class="synSpecial">(</span>'<span class="synConstant">note/view</span>', <span class="synStatement">$</span><span class="synIdentifier">data</span><span class="synSpecial">)</span>;

<span class="synSpecial">}</span>

<span class="synType">public</span> <span class="synPreProc">function</span> action_create<span class="synSpecial">()</span>
<span class="synSpecial">{</span>
<span class="synStatement">if</span> <span class="synSpecial">(</span>Input<span class="synStatement">::</span>method<span class="synSpecial">()</span> <span class="synStatement">==</span> '<span class="synConstant">POST</span>'<span class="synSpecial">)</span>
<span class="synSpecial">{</span>
<span class="synStatement">$</span><span class="synIdentifier">val</span> <span class="synStatement">=</span> Model_Note<span class="synStatement">::</span>validate<span class="synSpecial">(</span>'<span class="synConstant">create</span>'<span class="synSpecial">)</span>;

<span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">val</span><span class="synType">-></span>run<span class="synSpecial">())</span>
<span class="synSpecial">{</span>
<span class="synStatement">$</span><span class="synIdentifier">note</span> <span class="synStatement">=</span> Model_Note<span class="synStatement">::</span>forge<span class="synSpecial">(</span><span class="synType">array</span><span class="synSpecial">(</span>
'<span class="synConstant">title</span>' <span class="synStatement">=></span> Input<span class="synStatement">::</span>post<span class="synSpecial">(</span>'<span class="synConstant">title</span>'<span class="synSpecial">)</span>,
'<span class="synConstant">description</span>' <span class="synStatement">=></span> Input<span class="synStatement">::</span>post<span class="synSpecial">(</span>'<span class="synConstant">description</span>'<span class="synSpecial">)</span>,
<span class="synSpecial">))</span>;

<span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">note</span> <span class="synStatement">and</span> <span class="synStatement">$</span><span class="synIdentifier">note</span><span class="synType">-></span><span class="synIdentifier">save</span><span class="synSpecial">())</span>
<span class="synSpecial">{</span>
Session<span class="synStatement">::</span>set_flash<span class="synSpecial">(</span>'<span class="synConstant">success</span>', '<span class="synConstant">Added note #</span>'<span class="synStatement">.$</span><span class="synIdentifier">note</span><span class="synType">-></span>id<span class="synStatement">.</span>'<span class="synConstant">.</span>'<span class="synSpecial">)</span>;

Response<span class="synStatement">::</span>redirect<span class="synSpecial">(</span>'<span class="synConstant">note</span>'<span class="synSpecial">)</span>;
<span class="synSpecial">}</span>

<span class="synStatement">else</span>
<span class="synSpecial">{</span>
Session<span class="synStatement">::</span>set_flash<span class="synSpecial">(</span>'<span class="synConstant">error</span>', '<span class="synConstant">Could not save note.</span>'<span class="synSpecial">)</span>;
<span class="synSpecial">}</span>
<span class="synSpecial">}</span>
<span class="synStatement">else</span>
<span class="synSpecial">{</span>
Session<span class="synStatement">::</span>set_flash<span class="synSpecial">(</span>'<span class="synConstant">error</span>', <span class="synStatement">$</span><span class="synIdentifier">val</span><span class="synType">-></span>error<span class="synSpecial">())</span>;
<span class="synSpecial">}</span>
<span class="synSpecial">}</span>

<span class="synStatement">$</span><span class="synIdentifier">this</span><span class="synType">-></span>template<span class="synType">-></span><span class="synIdentifier">title</span> <span class="synStatement">=</span> "<span class="synConstant">Notes</span>";
<span class="synStatement">$</span><span class="synIdentifier">this</span><span class="synType">-></span>template<span class="synType">-></span><span class="synIdentifier">content</span> <span class="synStatement">=</span> View<span class="synStatement">::</span>forge<span class="synSpecial">(</span>'<span class="synConstant">note/create</span>'<span class="synSpecial">)</span>;

<span class="synSpecial">}</span>
</pre>
</div>
<div class="section">
<h5>Model</h5>
<p>ModelはDataのやり取りをするための仕組みです。ここではDataSourceをDBとしているのでDBModelになります。<br />
Modelの仕組みはとてもシンプルで固有のValidate<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>を定義するぐらいでDBとのやり取りが出来てしまいます。Modelのルールとしてはprotected static $_propertiesにてDBのカラムを定義、public static function validateとしてどの種別のValidateを掛けるかを定義します。Validationの細かいルールは<a href="http://fuelphp.com/docs/classes/validation/validation.html">Validation - Classes - FuelPHP Documentation</a> <a href="http://b.hatena.ne.jp/entry/fuelphp.com/docs/classes/validation/validation.html"><img src="http://b.hatena.ne.jp/entry/image/http://fuelphp.com/docs/classes/validation/validation.html" alt="はてなブックマーク - Validation - Classes - FuelPHP Documentation" border="0" /></a>こちらを参照して下さい。Validationファイルはcore以下のfuel/core/classes/validation.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>になります。noteのModelでは必須とMaxLengthだけをチェックしています。<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%A3%BF%F4">複数</a>の条件してはrequired|max_length[255]のようにパイプでつなぎます。$val->add_fieldの引数は第一引数がValidationしたい<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AB%A5%E9%A5%E0%CC%BE">カラム名</a>、第二引数がValidationのLabel名、第三引数がRuleになります。</p><p>fuel/app/classes/model/note.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> </p>
<pre class="hljs php" data-lang="php" data-unlink><span class="synSpecial"><?php</span>
<span class="synPreProc">use</span> Orm\Model;

<span class="synType">class</span> Model_Note <span class="synType">extends</span> Model
<span class="synSpecial">{</span>
<span class="synType">protected</span> <span class="synType">static</span> <span class="synStatement">$</span><span class="synIdentifier">_properties</span> <span class="synStatement">=</span> <span class="synType">array</span><span class="synSpecial">(</span>
    '<span class="synConstant">id</span>',
    '<span class="synConstant">title</span>',
    '<span class="synConstant">description</span>',
    '<span class="synConstant">created_at</span>',
    '<span class="synConstant">updated_at</span>',
<span class="synSpecial">)</span>;

<span class="synType">protected</span> <span class="synType">static</span> <span class="synStatement">$</span><span class="synIdentifier">_observers</span> <span class="synStatement">=</span> <span class="synType">array</span><span class="synSpecial">(</span>
    '<span class="synConstant">Orm\Observer_CreatedAt</span>' <span class="synStatement">=></span> <span class="synType">array</span><span class="synSpecial">(</span>
        '<span class="synConstant">events</span>' <span class="synStatement">=></span> <span class="synType">array</span><span class="synSpecial">(</span>'<span class="synConstant">before_insert</span>'<span class="synSpecial">)</span>,
        '<span class="synConstant">mysql_timestamp</span>' <span class="synStatement">=></span> <span class="synConstant">false</span>,
    <span class="synSpecial">)</span>,
    '<span class="synConstant">Orm\Observer_UpdatedAt</span>' <span class="synStatement">=></span> <span class="synType">array</span><span class="synSpecial">(</span>
        '<span class="synConstant">events</span>' <span class="synStatement">=></span> <span class="synType">array</span><span class="synSpecial">(</span>'<span class="synConstant">before_save</span>'<span class="synSpecial">)</span>,
        '<span class="synConstant">mysql_timestamp</span>' <span class="synStatement">=></span> <span class="synConstant">false</span>,
    <span class="synSpecial">)</span>,
<span class="synSpecial">)</span>;

<span class="synType">public</span> <span class="synType">static</span> <span class="synPreProc">function</span> validate<span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">factory</span><span class="synSpecial">)</span>
<span class="synSpecial">{</span>
    <span class="synStatement">$</span><span class="synIdentifier">val</span> <span class="synStatement">=</span> Validation<span class="synStatement">::</span>forge<span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">factory</span><span class="synSpecial">)</span>;
    <span class="synStatement">$</span><span class="synIdentifier">val</span><span class="synType">-></span>add_field<span class="synSpecial">(</span>'<span class="synConstant">title</span>', '<span class="synConstant">Title</span>', '<span class="synConstant">required|max_length[255]</span>'<span class="synSpecial">)</span>;
    <span class="synStatement">$</span><span class="synIdentifier">val</span><span class="synType">-></span>add_field<span class="synSpecial">(</span>'<span class="synConstant">description</span>', '<span class="synConstant">Description</span>', '<span class="synConstant">required</span>'<span class="synSpecial">)</span>;

    <span class="synStatement">return</span> <span class="synStatement">$</span><span class="synIdentifier">val</span>;
<span class="synSpecial">}</span>

<span class="synSpecial">}</span>
</pre>
</div>
<div class="section">
<h5>View</h5>
<p>Viewはとてもシンプルです。覚えておくべきことはcoreライブラリのViewクラスで定義された<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>を呼び出している箇所がありますが、ViewHelperとしての機能だと思ってもらえれば問題ありません。その他for/foreach/ifなどの制御コードをif ($notes): 〜 endif; やforeach ($notes as $note): 〜endforeach; のように定義するところだけを覚えておけばいいと思います。</p>
<pre class="hljs php" data-lang="php" data-unlink><span class="synIdentifier"><</span><span class="synStatement">h2</span><span class="synIdentifier">></span>Listing <span class="synIdentifier"><</span><span class="synStatement">span</span><span class="synIdentifier"> </span><span class="synType">class</span><span class="synIdentifier">=</span><span class="synConstant">'muted'</span><span class="synIdentifier">></span>Notes<span class="synIdentifier"></</span><span class="synStatement">span</span><span class="synIdentifier">></</span><span class="synStatement">h2</span><span class="synIdentifier">></span>
<span class="synIdentifier"><</span><span class="synStatement">br</span><span class="synIdentifier">></span>
<span class="synSpecial"><?php</span> <span class="synStatement">if</span> <span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">notes</span><span class="synSpecial">)</span><span class="synStatement">:</span> <span class="synSpecial">?></span>
<span class="synIdentifier"><</span><span class="synStatement">table</span><span class="synIdentifier"> </span><span class="synType">class</span><span class="synIdentifier">=</span><span class="synConstant">"table table-striped"</span><span class="synIdentifier">></span>
<span class="synIdentifier"><</span><span class="synStatement">thead</span><span class="synIdentifier">></span>
<span class="synIdentifier"><</span><span class="synStatement">tr</span><span class="synIdentifier">></span>
<span class="synIdentifier"><</span><span class="synStatement">th</span><span class="synIdentifier">></span>Title<span class="synIdentifier"></</span><span class="synStatement">th</span><span class="synIdentifier">></span>
<span class="synIdentifier"><</span><span class="synStatement">th</span><span class="synIdentifier">></span>Description<span class="synIdentifier"></</span><span class="synStatement">th</span><span class="synIdentifier">></span>
<span class="synIdentifier"><</span><span class="synStatement">th</span><span class="synIdentifier">></span><span class="synSpecial">&nbsp;</span><span class="synIdentifier"></</span><span class="synStatement">th</span><span class="synIdentifier">></span>
<span class="synIdentifier"></</span><span class="synStatement">tr</span><span class="synIdentifier">></span>
<span class="synIdentifier"></</span><span class="synStatement">thead</span><span class="synIdentifier">></span>
<span class="synIdentifier"><</span><span class="synStatement">tbody</span><span class="synIdentifier">></span>
<span class="synSpecial"><?php</span> <span class="synStatement">foreach</span> <span class="synSpecial">(</span><span class="synStatement">$</span><span class="synIdentifier">notes</span> <span class="synStatement">as</span> <span class="synStatement">$</span><span class="synIdentifier">note</span><span class="synSpecial">)</span><span class="synStatement">:</span> <span class="synSpecial">?></span>     <span class="synIdentifier"><</span><span class="synStatement">tr</span><span class="synIdentifier">></span>

<span class="synIdentifier"><</span><span class="synStatement">td</span><span class="synIdentifier">></span><span class="synSpecial"><?php</span> <span class="synPreProc">echo</span> <span class="synStatement">$</span><span class="synIdentifier">note</span><span class="synType">-></span><span class="synIdentifier">title</span>; <span class="synSpecial">?></span><span class="synIdentifier"></</span><span class="synStatement">td</span><span class="synIdentifier">></span>
<span class="synIdentifier"><</span><span class="synStatement">td</span><span class="synIdentifier">></span><span class="synSpecial"><?php</span> <span class="synPreProc">echo</span> <span class="synStatement">$</span><span class="synIdentifier">note</span><span class="synType">-></span><span class="synIdentifier">description</span>; <span class="synSpecial">?></span><span class="synIdentifier"></</span><span class="synStatement">td</span><span class="synIdentifier">></span>
<span class="synIdentifier"><</span><span class="synStatement">td</span><span class="synIdentifier">></span>
<span class="synSpecial"><?php</span> <span class="synPreProc">echo</span> Html<span class="synStatement">::</span>anchor<span class="synSpecial">(</span>'<span class="synConstant">note/view/</span>'<span class="synStatement">.$</span><span class="synIdentifier">note</span><span class="synType">-></span>id, '<span class="synConstant"><i class="icon-eye-open" title="View"></i></span>'<span class="synSpecial">)</span>; <span class="synSpecial">?></span> |
<span class="synSpecial"><?php</span> <span class="synPreProc">echo</span> Html<span class="synStatement">::</span>anchor<span class="synSpecial">(</span>'<span class="synConstant">note/edit/</span>'<span class="synStatement">.$</span><span class="synIdentifier">note</span><span class="synType">-></span>id, '<span class="synConstant"><i class="icon-wrench" title="Edit"></i></span>'<span class="synSpecial">)</span>; <span class="synSpecial">?></span> |
<span class="synSpecial"><?php</span> <span class="synPreProc">echo</span> Html<span class="synStatement">::</span>anchor<span class="synSpecial">(</span>'<span class="synConstant">note/delete/</span>'<span class="synStatement">.$</span><span class="synIdentifier">note</span><span class="synType">-></span>id, '<span class="synConstant"><i class="icon-trash" title="Delete"></i></span>', <span class="synType">array</span><span class="synSpecial">(</span>'<span class="synConstant">onclick</span>' <span class="synStatement">=></span> "<span class="synConstant">return confirm('Are you sure?')</span>"<span class="synSpecial">))</span>; <span class="synSpecial">?></span>

<span class="synIdentifier"></</span><span class="synStatement">td</span><span class="synIdentifier">></span>
<span class="synIdentifier"></</span><span class="synStatement">tr</span><span class="synIdentifier">></span>
<span class="synSpecial"><?php</span> <span class="synStatement">endforeach</span>; <span class="synSpecial">?></span>  <span class="synIdentifier"></</span><span class="synStatement">tbody</span><span class="synIdentifier">></span>
<span class="synIdentifier"></</span><span class="synStatement">table</span><span class="synIdentifier">></span>

<span class="synSpecial"><?php</span> <span class="synStatement">else:</span> <span class="synSpecial">?></span>
<span class="synIdentifier"><</span><span class="synStatement">p</span><span class="synIdentifier">></span>No Notes.<span class="synIdentifier"></</span><span class="synStatement">p</span><span class="synIdentifier">></span>

<span class="synSpecial"><?php</span> <span class="synStatement">endif</span>; <span class="synSpecial">?></span><span class="synIdentifier"><</span><span class="synStatement">p</span><span class="synIdentifier">></span>
<span class="synSpecial"><?php</span> <span class="synPreProc">echo</span> Html<span class="synStatement">::</span>anchor<span class="synSpecial">(</span>'<span class="synConstant">note/create</span>', '<span class="synConstant">Add new Note</span>', <span class="synType">array</span><span class="synSpecial">(</span>'<span class="synConstant">class</span>' <span class="synStatement">=></span> '<span class="synConstant">btn btn-success</span>'<span class="synSpecial">))</span>; <span class="synSpecial">?></span>

<span class="synIdentifier"></</span><span class="synStatement">p</span><span class="synIdentifier">></span>
</pre>
</div>
<div class="section">
<h5>Security/htmlentities</h5>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/FuelPHP">FuelPHP</a>では出力時にhtmlentitiesの関数を使って<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%CB%A5%BF%A5%A4%A5%B8%A5%F3%A5%B0">サニタイジング</a>を行なっています。これはControllerでView::forgeにてデータをセットした時に自動的に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%CB%A5%BF%A5%A4%A5%B8%A5%F3%A5%B0">サニタイジング</a>処理が走ります。呼び出しの定義はfuel/app/config/config.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>で定義されています。<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%CB%A5%BF%A5%A4%A5%B8%A5%F3%A5%B0">サニタイジング</a>せずにsafedataとして出力したい場合はController側で$this->template->set_safe<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>により格納することができます。<br />
fuel/app/config/config.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a></p>
<pre class="hljs php" data-lang="php" data-unlink><span class="synSpecial"><?php</span>
    <span class="synComment">/**</span>
<span class="synComment">         * This output filter can be any normal PHP function as well as 'xss_clean'</span>
<span class="synComment">         *</span>
<span class="synComment">         * WARNING: Using xss_clean will cause a performance hit.</span>
<span class="synComment">         * How much is dependant on how much input data there is.</span>
<span class="synComment">         */</span>
    '<span class="synConstant">output_filter</span>'  <span class="synStatement">=></span> <span class="synType">array</span><span class="synSpecial">(</span>'<span class="synConstant">Security::htmlentities</span>'<span class="synSpecial">)</span>,
</pre>
</div>
</blockquote>

</div>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://yutakikuchi.github.io/blog/post/201305070304/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://yutakikuchi.github.io/blog/post/201305070304/">じゃあ、いつRails始めるの？... 今でしょ！</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://yutakikuchi.github.io/blog/post/201305220839/">Fluentdを使ってNginxLogをMysqlにリアルタイムで格納する</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://yutakikuchi.github.io/blog/post/201305220839/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>

</div>
</div>
<script src="https://yutakikuchi.github.io/blog/js/ui.js"></script>
<script src="https://yutakikuchi.github.io/blog/js/menus.js"></script>


<script>
  
  if (window.location.hostname != "localhost") {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-20616165-3', 'auto');
    ga('send', 'pageview');
  }
</script>





</body>
</html>

